{"file_contents":{"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-10 px-2 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\n      \"p-2 align-middle [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]\",\n      className\n    )}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","path":null,"size_bytes":2859,"size_tokens":null},"shared/schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { pgTable, text, varchar, integer, real, jsonb, timestamp, vector, uniqueIndex } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  username: text(\"username\").notNull().unique(),\n  password: text(\"password\").notNull(),\n});\n\nexport const practices = pgTable(\"practices\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  budget: integer(\"budget\").notNull().default(50000),\n  layoutScalePxPerMeter: integer(\"layout_scale_px_per_meter\").notNull().default(50),\n  ownerId: varchar(\"owner_id\").references(() => users.id),\n});\n\nexport const rooms = pgTable(\"rooms\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  practiceId: varchar(\"practice_id\").notNull().references(() => practices.id, { onDelete: \"cascade\" }),\n  type: text(\"type\").notNull(),\n  name: text(\"name\").notNull(),\n  x: integer(\"x\").notNull(),\n  y: integer(\"y\").notNull(),\n  width: integer(\"width\").notNull(),\n  height: integer(\"height\").notNull(),\n  floor: integer(\"floor\").notNull().default(0),\n});\n\nexport const staff = pgTable(\"staff\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  practiceId: varchar(\"practice_id\").notNull().references(() => practices.id, { onDelete: \"cascade\" }),\n  name: text(\"name\").notNull(),\n  role: text(\"role\").notNull(),\n  avatar: text(\"avatar\").notNull(),\n  experienceLevel: integer(\"experience_level\").notNull().default(3),\n  specializations: text(\"specializations\").array().notNull().default([]),\n});\n\nexport const simulations = pgTable(\"simulations\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  practiceId: varchar(\"practice_id\").notNull().references(() => practices.id, { onDelete: \"cascade\" }),\n  efficiencyScore: real(\"efficiency_score\").notNull(),\n  harmonyScore: real(\"harmony_score\").notNull(),\n  waitTime: real(\"wait_time\").notNull(),\n  patientCapacity: integer(\"patient_capacity\").notNull(),\n  parameters: jsonb(\"parameters\").notNull(),\n  timestamp: timestamp(\"timestamp\").notNull().defaultNow(),\n});\n\nexport const knowledgeSources = pgTable(\"knowledge_sources\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  title: text(\"title\").notNull(),\n  fileName: text(\"file_name\").notNull(),\n  fileHash: text(\"file_hash\"),\n  category: text(\"category\").notNull(),\n  tags: text(\"tags\").array().notNull(),\n  description: text(\"description\"),\n  uploadedAt: timestamp(\"uploaded_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\nexport const knowledgeChunks = pgTable(\"knowledge_chunks\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  sourceId: varchar(\"source_id\").notNull().references(() => knowledgeSources.id, { onDelete: \"cascade\" }),\n  headingPath: text(\"heading_path\"),\n  chunkIndex: integer(\"chunk_index\").notNull(),\n  content: text(\"content\").notNull(),\n  contentHash: text(\"content_hash\"),\n  tokens: integer(\"tokens\").notNull(),\n  embedding: vector(\"embedding\", { dimensions: 1536 }),\n  keyPoints: text(\"key_points\").array(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const knowledgeArtifacts = pgTable(\"knowledge_artifacts\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tenantId: varchar(\"tenant_id\"),\n  artifactType: text(\"artifact_type\").notNull(),\n  module: text(\"module\").notNull(),\n  topic: text(\"topic\").notNull(),\n  payloadJson: jsonb(\"payload_json\").notNull(),\n  sourceCitations: jsonb(\"source_citations\").notNull(),\n  confidence: real(\"confidence\").notNull().default(0.8),\n  version: integer(\"version\").notNull().default(1),\n  sourceHash: text(\"source_hash\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const WORKFLOW_ACTOR_TYPES = [\"patient\", \"staff\", \"instruments\"] as const;\nexport type WorkflowActorType = typeof WORKFLOW_ACTOR_TYPES[number];\n\nexport const WORKFLOW_SOURCES = [\"builtin\", \"custom\", \"knowledge\"] as const;\nexport type WorkflowSource = typeof WORKFLOW_SOURCES[number];\n\nexport const workflows = pgTable(\"workflows\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  practiceId: varchar(\"practice_id\").notNull().references(() => practices.id, { onDelete: \"cascade\" }),\n  slug: text(\"slug\").notNull(),\n  name: text(\"name\").notNull(),\n  actorType: text(\"actor_type\").notNull().$type<WorkflowActorType>(),\n  source: text(\"source\").notNull().$type<WorkflowSource>().default(\"custom\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => [\n  uniqueIndex(\"workflows_practice_slug_idx\").on(table.practiceId, table.slug),\n]);\n\nexport const CONNECTION_KINDS = [\"patient\", \"staff\"] as const;\nexport type ConnectionKind = typeof CONNECTION_KINDS[number];\n\nexport const DISTANCE_CLASSES = [\"auto\", \"short\", \"medium\", \"long\"] as const;\nexport type DistanceClass = typeof DISTANCE_CLASSES[number];\n\nexport const workflowConnections = pgTable(\"workflow_connections\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  practiceId: varchar(\"practice_id\").notNull().references(() => practices.id, { onDelete: \"cascade\" }),\n  fromRoomId: varchar(\"from_room_id\").notNull().references(() => rooms.id, { onDelete: \"cascade\" }),\n  toRoomId: varchar(\"to_room_id\").notNull().references(() => rooms.id, { onDelete: \"cascade\" }),\n  kind: text(\"kind\").notNull().$type<ConnectionKind>().default(\"patient\"),\n  weight: integer(\"weight\").notNull().default(1),\n  distanceClass: text(\"distance_class\").notNull().$type<DistanceClass>().default(\"auto\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const workflowSteps = pgTable(\"workflow_steps\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  workflowId: varchar(\"workflow_id\").notNull().references(() => workflows.id, { onDelete: \"cascade\" }),\n  stepIndex: integer(\"step_index\").notNull(),\n  fromRoomId: varchar(\"from_room_id\").notNull().references(() => rooms.id, { onDelete: \"cascade\" }),\n  toRoomId: varchar(\"to_room_id\").notNull().references(() => rooms.id, { onDelete: \"cascade\" }),\n  weight: real(\"weight\").notNull().default(1),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nexport const insertUserSchema = createInsertSchema(users).pick({\n  username: true,\n  password: true,\n});\n\nexport const insertPracticeSchema = createInsertSchema(practices).omit({\n  id: true,\n});\n\nexport const insertRoomSchema = createInsertSchema(rooms).omit({\n  id: true,\n});\n\nexport const insertStaffSchema = createInsertSchema(staff).omit({\n  id: true,\n});\n\nexport const insertSimulationSchema = createInsertSchema(simulations).omit({\n  id: true,\n  timestamp: true,\n});\n\nexport const insertKnowledgeSourceSchema = createInsertSchema(knowledgeSources).omit({\n  id: true,\n  uploadedAt: true,\n});\n\nexport const insertKnowledgeChunkSchema = createInsertSchema(knowledgeChunks).omit({\n  id: true,\n});\n\nexport const insertKnowledgeArtifactSchema = createInsertSchema(knowledgeArtifacts).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertWorkflowSchema = createInsertSchema(workflows).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertWorkflowConnectionSchema = createInsertSchema(workflowConnections).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const updateWorkflowConnectionSchema = insertWorkflowConnectionSchema.partial().omit({\n  practiceId: true,\n  fromRoomId: true,\n  toRoomId: true,\n});\n\nexport const insertWorkflowStepSchema = createInsertSchema(workflowSteps).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type InsertUser = z.infer<typeof insertUserSchema>;\nexport type User = typeof users.$inferSelect;\n\nexport type InsertPractice = z.infer<typeof insertPracticeSchema>;\nexport type Practice = typeof practices.$inferSelect;\n\nexport type InsertRoom = z.infer<typeof insertRoomSchema>;\nexport type Room = typeof rooms.$inferSelect;\n\nexport type InsertStaff = z.infer<typeof insertStaffSchema>;\nexport type Staff = typeof staff.$inferSelect;\n\nexport type InsertSimulation = z.infer<typeof insertSimulationSchema>;\nexport type Simulation = typeof simulations.$inferSelect;\n\nexport type InsertKnowledgeSource = z.infer<typeof insertKnowledgeSourceSchema>;\nexport type KnowledgeSource = typeof knowledgeSources.$inferSelect;\n\nexport type InsertKnowledgeChunk = z.infer<typeof insertKnowledgeChunkSchema>;\nexport type KnowledgeChunk = typeof knowledgeChunks.$inferSelect;\n\nexport type InsertKnowledgeArtifact = z.infer<typeof insertKnowledgeArtifactSchema>;\nexport type KnowledgeArtifact = typeof knowledgeArtifacts.$inferSelect;\n\nexport type InsertWorkflow = z.infer<typeof insertWorkflowSchema>;\nexport type Workflow = typeof workflows.$inferSelect;\n\nexport type InsertWorkflowConnection = z.infer<typeof insertWorkflowConnectionSchema>;\nexport type WorkflowConnection = typeof workflowConnections.$inferSelect;\n\nexport type InsertWorkflowStep = z.infer<typeof insertWorkflowStepSchema>;\nexport type WorkflowStep = typeof workflowSteps.$inferSelect;\n","path":null,"size_bytes":9144,"size_tokens":null},"client/src/components/ui/calendar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport {\n  ChevronDownIcon,\n  ChevronLeftIcon,\n  ChevronRightIcon,\n} from \"lucide-react\"\nimport { DayButton, DayPicker, getDefaultClassNames } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button, buttonVariants } from \"@/components/ui/button\"\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  captionLayout = \"label\",\n  buttonVariant = \"ghost\",\n  formatters,\n  components,\n  ...props\n}: React.ComponentProps<typeof DayPicker> & {\n  buttonVariant?: React.ComponentProps<typeof Button>[\"variant\"]\n}) {\n  const defaultClassNames = getDefaultClassNames()\n\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\n        \"bg-background group/calendar p-3 [--cell-size:2rem] [[data-slot=card-content]_&]:bg-transparent [[data-slot=popover-content]_&]:bg-transparent\",\n        String.raw`rtl:**:[.rdp-button\\_next>svg]:rotate-180`,\n        String.raw`rtl:**:[.rdp-button\\_previous>svg]:rotate-180`,\n        className\n      )}\n      captionLayout={captionLayout}\n      formatters={{\n        formatMonthDropdown: (date) =>\n          date.toLocaleString(\"default\", { month: \"short\" }),\n        ...formatters,\n      }}\n      classNames={{\n        root: cn(\"w-fit\", defaultClassNames.root),\n        months: cn(\n          \"relative flex flex-col gap-4 md:flex-row\",\n          defaultClassNames.months\n        ),\n        month: cn(\"flex w-full flex-col gap-4\", defaultClassNames.month),\n        nav: cn(\n          \"absolute inset-x-0 top-0 flex w-full items-center justify-between gap-1\",\n          defaultClassNames.nav\n        ),\n        button_previous: cn(\n          buttonVariants({ variant: buttonVariant }),\n          \"h-[--cell-size] w-[--cell-size] select-none p-0 aria-disabled:opacity-50\",\n          defaultClassNames.button_previous\n        ),\n        button_next: cn(\n          buttonVariants({ variant: buttonVariant }),\n          \"h-[--cell-size] w-[--cell-size] select-none p-0 aria-disabled:opacity-50\",\n          defaultClassNames.button_next\n        ),\n        month_caption: cn(\n          \"flex h-[--cell-size] w-full items-center justify-center px-[--cell-size]\",\n          defaultClassNames.month_caption\n        ),\n        dropdowns: cn(\n          \"flex h-[--cell-size] w-full items-center justify-center gap-1.5 text-sm font-medium\",\n          defaultClassNames.dropdowns\n        ),\n        dropdown_root: cn(\n          \"has-focus:border-ring border-input shadow-xs has-focus:ring-ring/50 has-focus:ring-[3px] relative rounded-md border\",\n          defaultClassNames.dropdown_root\n        ),\n        dropdown: cn(\n          \"bg-popover absolute inset-0 opacity-0\",\n          defaultClassNames.dropdown\n        ),\n        caption_label: cn(\n          \"select-none font-medium\",\n          captionLayout === \"label\"\n            ? \"text-sm\"\n            : \"[&>svg]:text-muted-foreground flex h-8 items-center gap-1 rounded-md pl-2 pr-1 text-sm [&>svg]:size-3.5\",\n          defaultClassNames.caption_label\n        ),\n        table: \"w-full border-collapse\",\n        weekdays: cn(\"flex\", defaultClassNames.weekdays),\n        weekday: cn(\n          \"text-muted-foreground flex-1 select-none rounded-md text-[0.8rem] font-normal\",\n          defaultClassNames.weekday\n        ),\n        week: cn(\"mt-2 flex w-full\", defaultClassNames.week),\n        week_number_header: cn(\n          \"w-[--cell-size] select-none\",\n          defaultClassNames.week_number_header\n        ),\n        week_number: cn(\n          \"text-muted-foreground select-none text-[0.8rem]\",\n          defaultClassNames.week_number\n        ),\n        day: cn(\n          \"group/day relative aspect-square h-full w-full select-none p-0 text-center [&:first-child[data-selected=true]_button]:rounded-l-md [&:last-child[data-selected=true]_button]:rounded-r-md\",\n          defaultClassNames.day\n        ),\n        range_start: cn(\n          \"bg-accent rounded-l-md\",\n          defaultClassNames.range_start\n        ),\n        range_middle: cn(\"rounded-none\", defaultClassNames.range_middle),\n        range_end: cn(\"bg-accent rounded-r-md\", defaultClassNames.range_end),\n        today: cn(\n          \"bg-accent text-accent-foreground rounded-md data-[selected=true]:rounded-none\",\n          defaultClassNames.today\n        ),\n        outside: cn(\n          \"text-muted-foreground aria-selected:text-muted-foreground\",\n          defaultClassNames.outside\n        ),\n        disabled: cn(\n          \"text-muted-foreground opacity-50\",\n          defaultClassNames.disabled\n        ),\n        hidden: cn(\"invisible\", defaultClassNames.hidden),\n        ...classNames,\n      }}\n      components={{\n        Root: ({ className, rootRef, ...props }) => {\n          return (\n            <div\n              data-slot=\"calendar\"\n              ref={rootRef}\n              className={cn(className)}\n              {...props}\n            />\n          )\n        },\n        Chevron: ({ className, orientation, ...props }) => {\n          if (orientation === \"left\") {\n            return (\n              <ChevronLeftIcon className={cn(\"size-4\", className)} {...props} />\n            )\n          }\n\n          if (orientation === \"right\") {\n            return (\n              <ChevronRightIcon\n                className={cn(\"size-4\", className)}\n                {...props}\n              />\n            )\n          }\n\n          return (\n            <ChevronDownIcon className={cn(\"size-4\", className)} {...props} />\n          )\n        },\n        DayButton: CalendarDayButton,\n        WeekNumber: ({ children, ...props }) => {\n          return (\n            <td {...props}>\n              <div className=\"flex size-[--cell-size] items-center justify-center text-center\">\n                {children}\n              </div>\n            </td>\n          )\n        },\n        ...components,\n      }}\n      {...props}\n    />\n  )\n}\n\nfunction CalendarDayButton({\n  className,\n  day,\n  modifiers,\n  ...props\n}: React.ComponentProps<typeof DayButton>) {\n  const defaultClassNames = getDefaultClassNames()\n\n  const ref = React.useRef<HTMLButtonElement>(null)\n  React.useEffect(() => {\n    if (modifiers.focused) ref.current?.focus()\n  }, [modifiers.focused])\n\n  return (\n    <Button\n      ref={ref}\n      variant=\"ghost\"\n      size=\"icon\"\n      data-day={day.date.toLocaleDateString()}\n      data-selected-single={\n        modifiers.selected &&\n        !modifiers.range_start &&\n        !modifiers.range_end &&\n        !modifiers.range_middle\n      }\n      data-range-start={modifiers.range_start}\n      data-range-end={modifiers.range_end}\n      data-range-middle={modifiers.range_middle}\n      className={cn(\n        \"data-[selected-single=true]:bg-primary data-[selected-single=true]:text-primary-foreground data-[range-middle=true]:bg-accent data-[range-middle=true]:text-accent-foreground data-[range-start=true]:bg-primary data-[range-start=true]:text-primary-foreground data-[range-end=true]:bg-primary data-[range-end=true]:text-primary-foreground group-data-[focused=true]/day:border-ring group-data-[focused=true]/day:ring-ring/50 flex aspect-square h-auto w-full min-w-[--cell-size] flex-col gap-1 font-normal leading-none data-[range-end=true]:rounded-md data-[range-middle=true]:rounded-none data-[range-start=true]:rounded-md group-data-[focused=true]/day:relative group-data-[focused=true]/day:z-10 group-data-[focused=true]/day:ring-[3px] [&>span]:text-xs [&>span]:opacity-70\",\n        defaultClassNames.day,\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport { Calendar, CalendarDayButton }\n","path":null,"size_bytes":7569,"size_tokens":null},"server/simulation.ts":{"content":"import type { Room, Staff } from \"@shared/schema\";\nimport {\n  ROOM_SIZE_STANDARDS,\n  STAFFING_RATIOS,\n  PATIENT_FLOW_METRICS,\n  evaluateRoomSizeM,\n  evaluateStaffingRatios\n} from \"./ai/benchmarks\";\nimport {\n  getKnowledgePoweredScheduling,\n  getKnowledgePoweredStaffing,\n  getKnowledgePoweredLayout,\n  type KnowledgePoweredLayout\n} from \"./ai/artifactBenchmarks\";\nimport { computeLayoutEfficiency } from \"./ai/layoutEfficiency\";\nimport { normalizeRoomType } from \"@shared/roomTypes\";\nimport { pxToM } from \"@shared/units\";\n\nexport interface SimulationParameters {\n  patientVolume: number;\n  operatingHours: number;\n}\n\nexport interface SimulationResult {\n  efficiencyScore: number;\n  harmonyScore: number;\n  waitTime: number;\n  patientCapacity: number;\n  parameters: SimulationParameters;\n}\n\nexport interface LayoutEfficiencyBreakdown {\n  overallScore: number;\n  categories: {\n    patientFlow: {\n      score: number;\n      maxScore: number;\n      items: EfficiencyItem[];\n    };\n    roomSizing: {\n      score: number;\n      maxScore: number;\n      items: EfficiencyItem[];\n    };\n    essentialRooms: {\n      score: number;\n      maxScore: number;\n      items: EfficiencyItem[];\n    };\n    staffAccess: {\n      score: number;\n      maxScore: number;\n      items: EfficiencyItem[];\n    };\n  };\n  tips: string[];\n}\n\nexport interface EfficiencyItem {\n  label: string;\n  status: \"optimal\" | \"acceptable\" | \"needs_work\" | \"missing\";\n  points: number;\n  maxPoints: number;\n  detail?: string;\n}\n\nfunction calculateDistanceM(x1: number, y1: number, x2: number, y2: number): number {\n  return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));\n}\n\nfunction getRoomCenter(room: { x: number; y: number; width: number; height: number }): { x: number; y: number } {\n  return {\n    x: room.x + room.width / 2,\n    y: room.y + room.height / 2,\n  };\n}\n\nasync function calculateEfficiencyScore(\n  rooms: Room[], \n  layoutConfig?: KnowledgePoweredLayout\n): Promise<number> {\n  if (rooms.length === 0) return 0;\n  \n  const flowResult = computeLayoutEfficiency(rooms);\n  return flowResult.score;\n}\n\nfunction calculateHarmonyScore(staff: Staff[], rooms: Room[]): number {\n  if (staff.length === 0) return 50;\n\n  const doctors = staff.filter(s => s.role === \"doctor\" || s.role === \"dentist\").length;\n  const nurses = staff.filter(s => s.role === \"nurse\").length;\n  const receptionists = staff.filter(s => s.role === \"receptionist\").length;\n  const examRooms = rooms.filter(r => r.type === \"exam\").length;\n\n  const staffingAnalysis = evaluateStaffingRatios(\n    doctors, \n    nurses, \n    receptionists, \n    staff.length, \n    examRooms\n  );\n\n  let score = staffingAnalysis.overallScore;\n\n  const avgExperience = staff.reduce((sum, s) => sum + s.experienceLevel, 0) / staff.length;\n  score += (avgExperience - 3) * 5;\n\n  return Math.max(0, Math.min(100, score));\n}\n\ninterface SchedulingDefaults {\n  avgServiceTime: number;\n  bufferMinutes: number;\n  maxWaitTime: number;\n}\n\nconst DEFAULT_SCHEDULING: SchedulingDefaults = {\n  avgServiceTime: 30,\n  bufferMinutes: 5,\n  maxWaitTime: 15\n};\n\nasync function loadSchedulingDefaults(): Promise<SchedulingDefaults> {\n  try {\n    const scheduling = await getKnowledgePoweredScheduling();\n    const serviceTimes = Object.values(scheduling.serviceTimes);\n    const avgServiceTime = serviceTimes.length > 0\n      ? serviceTimes.reduce((sum, s) => sum + (typeof s.value === 'number' ? s.value : 30), 0) / serviceTimes.length\n      : DEFAULT_SCHEDULING.avgServiceTime;\n    \n    const bufferMinutes = scheduling.bufferMinutes?.value != null && typeof scheduling.bufferMinutes.value === 'number'\n      ? scheduling.bufferMinutes.value\n      : DEFAULT_SCHEDULING.bufferMinutes;\n    \n    const maxWaitTime = scheduling.maxWaitTime?.value != null && typeof scheduling.maxWaitTime.value === 'number'\n      ? scheduling.maxWaitTime.value\n      : DEFAULT_SCHEDULING.maxWaitTime;\n    \n    return {\n      avgServiceTime: Math.max(5, Math.min(120, avgServiceTime)),\n      bufferMinutes: Math.max(0, Math.min(30, bufferMinutes)),\n      maxWaitTime: Math.max(5, Math.min(60, maxWaitTime))\n    };\n  } catch (error) {\n    return DEFAULT_SCHEDULING;\n  }\n}\n\nfunction calculatePatientCapacity(\n  rooms: Room[], \n  staff: Staff[], \n  operatingHours: number,\n  schedulingDefaults?: SchedulingDefaults\n): number {\n  const examRooms = rooms.filter(r => r.type === \"exam\");\n  const doctors = staff.filter(s => s.role === \"doctor\" || s.role === \"dentist\").length;\n  \n  const patientsPerRoomPerDay = PATIENT_FLOW_METRICS.patientsPerExamRoomPerDay.acceptable;\n  \n  let throughputPerHour = PATIENT_FLOW_METRICS.patientThroughputPerHour.acceptable;\n  if (schedulingDefaults) {\n    const totalServiceTime = schedulingDefaults.avgServiceTime + schedulingDefaults.bufferMinutes;\n    throughputPerHour = Math.max(1, Math.round(60 / Math.max(1, totalServiceTime)));\n  }\n  \n  const roomBasedCapacity = examRooms.length * patientsPerRoomPerDay;\n  const providerBasedCapacity = doctors * throughputPerHour * operatingHours;\n  \n  let capacity = Math.min(roomBasedCapacity, providerBasedCapacity);\n  \n  if (capacity === 0 && examRooms.length > 0) {\n    capacity = examRooms.length * Math.floor(patientsPerRoomPerDay * 0.6);\n  }\n\n  const avgExperience = staff.length > 0 \n    ? staff.reduce((sum, s) => sum + s.experienceLevel, 0) / staff.length \n    : 3;\n  const experienceMultiplier = 0.7 + (avgExperience / 5) * 0.6;\n  capacity = Math.floor(capacity * experienceMultiplier);\n\n  return Math.max(1, capacity);\n}\n\nfunction calculateWaitTime(\n  patientCapacity: number, \n  patientVolume: number, \n  efficiencyScore: number,\n  staff: Staff[],\n  schedulingDefaults?: SchedulingDefaults\n): number {\n  const excellentWaitTime = PATIENT_FLOW_METRICS.waitTime.excellent;\n  const acceptableWaitTime = schedulingDefaults?.maxWaitTime || PATIENT_FLOW_METRICS.waitTime.acceptable;\n  const poorWaitTime = PATIENT_FLOW_METRICS.waitTime.poor;\n  \n  const volumeRatio = patientVolume / Math.max(1, patientCapacity);\n  \n  let baseWaitTime: number;\n  if (volumeRatio <= 0.7) {\n    baseWaitTime = excellentWaitTime;\n  } else if (volumeRatio <= 1.0) {\n    baseWaitTime = acceptableWaitTime;\n  } else {\n    baseWaitTime = poorWaitTime + (volumeRatio - 1) * 15;\n  }\n\n  const efficiencyFactor = 1 + ((100 - efficiencyScore) / 100) * 0.5;\n  let waitTime = baseWaitTime * efficiencyFactor;\n\n  if (staff.length > 0) {\n    const avgExperience = staff.reduce((sum, s) => sum + s.experienceLevel, 0) / staff.length;\n    const experienceFactor = 1.3 - (avgExperience / 5) * 0.3;\n    waitTime *= experienceFactor;\n  }\n\n  return Math.max(5, Math.min(60, Math.round(waitTime)));\n}\n\ninterface RoomInMeters {\n  id: string;\n  name: string;\n  type: string;\n  x: number;\n  y: number;\n  width: number;\n  height: number;\n  floor: number;\n}\n\nfunction convertRoomToMeters(room: Room): RoomInMeters {\n  return {\n    id: room.id,\n    name: room.name,\n    type: room.type,\n    x: pxToM(room.x),\n    y: pxToM(room.y),\n    width: pxToM(room.width),\n    height: pxToM(room.height),\n    floor: room.floor,\n  };\n}\n\nexport async function calculateLayoutEfficiencyBreakdown(\n  rooms: Room[]\n): Promise<LayoutEfficiencyBreakdown> {\n  const layout = await getKnowledgePoweredLayout();\n  \n  const roomsM = rooms.map(convertRoomToMeters);\n  \n  const roomsByType = new Map<string, RoomInMeters[]>();\n  roomsM.forEach(room => {\n    const normalizedType = normalizeRoomType(room.type);\n    if (!roomsByType.has(normalizedType)) {\n      roomsByType.set(normalizedType, []);\n    }\n    roomsByType.get(normalizedType)!.push(room);\n  });\n\n  const reception = roomsByType.get(\"reception\")?.[0];\n  const waiting = roomsByType.get(\"waiting\")?.[0];\n  const examRooms = roomsByType.get(\"exam\") || [];\n  const lab = roomsByType.get(\"lab\")?.[0];\n  const office = roomsByType.get(\"office\")?.[0];\n\n  const patientFlowItems: EfficiencyItem[] = [];\n  const roomSizingItems: EfficiencyItem[] = [];\n  const essentialRoomsItems: EfficiencyItem[] = [];\n  const staffAccessItems: EfficiencyItem[] = [];\n  const tips: string[] = [];\n\n  let patientFlowScore = 0;\n  const patientFlowMax = 27;\n  let roomSizingScore = 0;\n  let roomSizingMax = 0;\n  let essentialRoomsScore = 0;\n  const essentialRoomsMax = 45;\n  let staffAccessScore = 0;\n  const staffAccessMax = 5;\n\n  if (reception) {\n    essentialRoomsScore += 15;\n    essentialRoomsItems.push({\n      label: \"Reception\",\n      status: \"optimal\",\n      points: 15,\n      maxPoints: 15,\n      detail: \"Reception area present\"\n    });\n  } else {\n    essentialRoomsItems.push({\n      label: \"Reception\",\n      status: \"missing\",\n      points: 0,\n      maxPoints: 15,\n      detail: \"Add a reception area\"\n    });\n    tips.push(\"Add a reception area for patient check-in.\");\n  }\n\n  if (waiting) {\n    essentialRoomsScore += 10;\n    essentialRoomsItems.push({\n      label: \"Waiting Room\",\n      status: \"optimal\",\n      points: 10,\n      maxPoints: 10,\n      detail: \"Waiting area present\"\n    });\n  } else {\n    essentialRoomsItems.push({\n      label: \"Waiting Room\",\n      status: \"missing\",\n      points: 0,\n      maxPoints: 10,\n      detail: \"Add a waiting area\"\n    });\n    tips.push(\"Add a waiting room for patients.\");\n  }\n\n  if (examRooms.length > 0) {\n    essentialRoomsScore += 20;\n    essentialRoomsItems.push({\n      label: \"Exam Rooms\",\n      status: \"optimal\",\n      points: 20,\n      maxPoints: 20,\n      detail: `${examRooms.length} exam room(s) present`\n    });\n  } else {\n    essentialRoomsItems.push({\n      label: \"Exam Rooms\",\n      status: \"missing\",\n      points: 0,\n      maxPoints: 20,\n      detail: \"Add at least one exam room\"\n    });\n    tips.push(\"Add exam rooms for patient consultations.\");\n  }\n\n  if (reception && waiting) {\n    const recCenter = getRoomCenter(reception);\n    const waitCenter = getRoomCenter(waiting);\n    const distanceM = calculateDistanceM(recCenter.x, recCenter.y, waitCenter.x, waitCenter.y);\n    const benchmark = layout.distanceGuidelines.receptionToWaiting;\n    \n    if (distanceM <= benchmark.optimal) {\n      patientFlowScore += 12;\n      patientFlowItems.push({\n        label: \"Reception → Waiting\",\n        status: \"optimal\",\n        points: 12,\n        maxPoints: 12,\n        detail: `${distanceM.toFixed(1)}m (optimal: ≤${benchmark.optimal}m)`\n      });\n    } else if (distanceM <= benchmark.maxMeters) {\n      patientFlowScore += 8;\n      patientFlowItems.push({\n        label: \"Reception → Waiting\",\n        status: \"acceptable\",\n        points: 8,\n        maxPoints: 12,\n        detail: `${distanceM.toFixed(1)}m (acceptable: ≤${benchmark.maxMeters}m)`\n      });\n    } else {\n      patientFlowItems.push({\n        label: \"Reception → Waiting\",\n        status: \"needs_work\",\n        points: 0,\n        maxPoints: 12,\n        detail: `${distanceM.toFixed(1)}m (max: ${benchmark.maxMeters}m)`\n      });\n      tips.push(\"Move waiting room closer to reception.\");\n    }\n  }\n\n  if (waiting && examRooms.length > 0) {\n    const waitCenter = getRoomCenter(waiting);\n    const avgDistanceM = examRooms.reduce((sum, exam) => {\n      const examCenter = getRoomCenter(exam);\n      return sum + calculateDistanceM(waitCenter.x, waitCenter.y, examCenter.x, examCenter.y);\n    }, 0) / examRooms.length;\n    const benchmark = layout.distanceGuidelines.waitingToExam;\n    \n    if (avgDistanceM <= benchmark.optimal) {\n      patientFlowScore += 15;\n      patientFlowItems.push({\n        label: \"Waiting → Exam Rooms\",\n        status: \"optimal\",\n        points: 15,\n        maxPoints: 15,\n        detail: `Avg ${avgDistanceM.toFixed(1)}m (optimal: ≤${benchmark.optimal}m)`\n      });\n    } else if (avgDistanceM <= benchmark.maxMeters) {\n      patientFlowScore += 8;\n      patientFlowItems.push({\n        label: \"Waiting → Exam Rooms\",\n        status: \"acceptable\",\n        points: 8,\n        maxPoints: 15,\n        detail: `Avg ${avgDistanceM.toFixed(1)}m (acceptable: ≤${benchmark.maxMeters}m)`\n      });\n    } else {\n      patientFlowItems.push({\n        label: \"Waiting → Exam Rooms\",\n        status: \"needs_work\",\n        points: 0,\n        maxPoints: 15,\n        detail: `Avg ${avgDistanceM.toFixed(1)}m (max: ${benchmark.maxMeters}m)`\n      });\n      tips.push(\"Position exam rooms closer to the waiting area.\");\n    }\n  }\n\n  roomsM.forEach(room => {\n    const normalizedType = normalizeRoomType(room.type);\n    const standard = ROOM_SIZE_STANDARDS[normalizedType];\n    if (standard) {\n      roomSizingMax += 3;\n      const areaM = room.width * room.height;\n      const evaluation = evaluateRoomSizeM(normalizedType, room.width, room.height);\n      \n      if (evaluation.assessment === \"optimal\") {\n        roomSizingScore += 3;\n        roomSizingItems.push({\n          label: room.name || normalizedType,\n          status: \"optimal\",\n          points: 3,\n          maxPoints: 3,\n          detail: `${areaM.toFixed(1)}m² (optimal: ${standard.optimalSqM}m²)`\n        });\n      } else if (evaluation.assessment === \"undersized\") {\n        roomSizingItems.push({\n          label: room.name || normalizedType,\n          status: \"needs_work\",\n          points: 0,\n          maxPoints: 3,\n          detail: `${areaM.toFixed(1)}m² (min: ${standard.minSqM}m²)`\n        });\n        tips.push(`Increase size of ${room.name || normalizedType} (currently ${areaM.toFixed(1)}m², min: ${standard.minSqM}m²).`);\n      } else {\n        roomSizingScore += 1;\n        roomSizingItems.push({\n          label: room.name || normalizedType,\n          status: \"acceptable\",\n          points: 1,\n          maxPoints: 3,\n          detail: `${areaM.toFixed(1)}m² (oversized, max: ${standard.maxSqM}m²)`\n        });\n      }\n    }\n  });\n\n  if (office && reception) {\n    const officeCenter = getRoomCenter(office);\n    const recCenter = getRoomCenter(reception);\n    const distanceM = calculateDistanceM(officeCenter.x, officeCenter.y, recCenter.x, recCenter.y);\n    \n    if (distanceM < 6) {\n      staffAccessScore += 5;\n      staffAccessItems.push({\n        label: \"Office → Reception\",\n        status: \"optimal\",\n        points: 5,\n        maxPoints: 5,\n        detail: `${distanceM.toFixed(1)}m (optimal: <6m)`\n      });\n    } else if (distanceM < 10) {\n      staffAccessScore += 3;\n      staffAccessItems.push({\n        label: \"Office → Reception\",\n        status: \"acceptable\",\n        points: 3,\n        maxPoints: 5,\n        detail: `${distanceM.toFixed(1)}m (acceptable: <10m)`\n      });\n    } else {\n      staffAccessItems.push({\n        label: \"Office → Reception\",\n        status: \"needs_work\",\n        points: 0,\n        maxPoints: 5,\n        detail: `${distanceM.toFixed(1)}m (optimal: <6m)`\n      });\n      tips.push(\"Consider placing doctor's office closer to reception for quick access.\");\n    }\n  }\n\n  const totalScore = patientFlowScore + roomSizingScore + essentialRoomsScore + staffAccessScore;\n  const totalMax = patientFlowMax + Math.max(roomSizingMax, 9) + essentialRoomsMax + staffAccessMax;\n  const overallScore = totalMax > 0 ? Math.round((totalScore / totalMax) * 100) : 0;\n\n  return {\n    overallScore: Math.max(0, Math.min(100, overallScore)),\n    categories: {\n      patientFlow: {\n        score: patientFlowScore,\n        maxScore: patientFlowMax,\n        items: patientFlowItems\n      },\n      roomSizing: {\n        score: roomSizingScore,\n        maxScore: roomSizingMax || 9,\n        items: roomSizingItems\n      },\n      essentialRooms: {\n        score: essentialRoomsScore,\n        maxScore: essentialRoomsMax,\n        items: essentialRoomsItems\n      },\n      staffAccess: {\n        score: staffAccessScore,\n        maxScore: staffAccessMax,\n        items: staffAccessItems\n      }\n    },\n    tips: tips.slice(0, 5)\n  };\n}\n\nexport async function runSimulation(\n  rooms: Room[],\n  staff: Staff[],\n  parameters: SimulationParameters\n): Promise<SimulationResult> {\n  const [schedulingDefaults, layoutConfig] = await Promise.all([\n    loadSchedulingDefaults(),\n    getKnowledgePoweredLayout()\n  ]);\n  \n  const efficiencyScore = await calculateEfficiencyScore(rooms, layoutConfig);\n  const harmonyScore = calculateHarmonyScore(staff, rooms);\n  const patientCapacity = calculatePatientCapacity(rooms, staff, parameters.operatingHours, schedulingDefaults);\n  const waitTime = calculateWaitTime(\n    patientCapacity,\n    parameters.patientVolume,\n    efficiencyScore,\n    staff,\n    schedulingDefaults\n  );\n\n  return {\n    efficiencyScore: Math.round(efficiencyScore * 10) / 10,\n    harmonyScore: Math.round(harmonyScore * 10) / 10,\n    waitTime,\n    patientCapacity,\n    parameters,\n  };\n}\n","path":null,"size_bytes":16519,"size_tokens":null},"server/vite.ts":{"content":"import { type Express } from \"express\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport async function setupVite(server: Server, app: Express) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server, path: \"/vite-hmr\" },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n","path":null,"size_bytes":1534,"size_tokens":null},"client/src/components/ui/kbd.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Kbd({ className, ...props }: React.ComponentProps<\"kbd\">) {\n  return (\n    <kbd\n      data-slot=\"kbd\"\n      className={cn(\n        \"bg-muted text-muted-foreground pointer-events-none inline-flex h-5 w-fit min-w-5 select-none items-center justify-center gap-1 rounded-sm px-1 font-sans text-xs font-medium\",\n        \"[&_svg:not([class*='size-'])]:size-3\",\n        \"[[data-slot=tooltip-content]_&]:bg-background/20 [[data-slot=tooltip-content]_&]:text-background dark:[[data-slot=tooltip-content]_&]:bg-background/10\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction KbdGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <kbd\n      data-slot=\"kbd-group\"\n      className={cn(\"inline-flex items-center gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Kbd, KbdGroup }\n","path":null,"size_bytes":862,"size_tokens":null},"client/src/lib/api.ts":{"content":"import type { InsertPractice, Practice, InsertRoom, Room, InsertStaff, Staff, InsertSimulation, Simulation, KnowledgeSource, KnowledgeChunk, Workflow, WorkflowConnection, WorkflowActorType, WorkflowStep } from \"@shared/schema\";\n\nconst API_BASE = \"\";\n\nasync function fetchAPI<T>(endpoint: string, options?: RequestInit): Promise<T> {\n  const response = await fetch(`${API_BASE}${endpoint}`, {\n    ...options,\n    credentials: \"include\",\n    headers: {\n      \"Content-Type\": \"application/json\",\n      ...options?.headers,\n    },\n  });\n\n  if (!response.ok) {\n    const error = await response.text();\n    throw new Error(error || `API Error: ${response.statusText}`);\n  }\n\n  return response.json();\n}\n\nexport interface AuthUser {\n  id: string;\n  username: string;\n}\n\nexport const api = {\n  auth: {\n    register: (data: { username: string; password: string }) =>\n      fetchAPI<AuthUser>(\"/api/auth/register\", {\n        method: \"POST\",\n        body: JSON.stringify(data),\n      }),\n    login: (data: { username: string; password: string }) =>\n      fetchAPI<AuthUser>(\"/api/auth/login\", {\n        method: \"POST\",\n        body: JSON.stringify(data),\n      }),\n    logout: () =>\n      fetchAPI<{ success: boolean }>(\"/api/auth/logout\", {\n        method: \"POST\",\n      }),\n    me: () => fetchAPI<AuthUser>(\"/api/auth/me\"),\n  },\n\n  practices: {\n    get: (id: string) => fetchAPI<Practice & { rooms: Room[]; staff: Staff[] }>(`/api/practices/${id}`),\n    create: (data: InsertPractice) => fetchAPI<Practice>(\"/api/practices\", {\n      method: \"POST\",\n      body: JSON.stringify(data),\n    }),\n    updateBudget: (id: string, budget: number) => fetchAPI<Practice>(`/api/practices/${id}/budget`, {\n      method: \"PUT\",\n      body: JSON.stringify({ budget }),\n    }),\n  },\n  \n  rooms: {\n    list: (practiceId: string) => fetchAPI<Room[]>(`/api/practices/${practiceId}/rooms`),\n    create: (practiceId: string, data: InsertRoom) => fetchAPI<Room>(`/api/practices/${practiceId}/rooms`, {\n      method: \"POST\",\n      body: JSON.stringify(data),\n    }),\n    update: (id: string, data: Partial<InsertRoom>) => fetchAPI<Room>(`/api/rooms/${id}`, {\n      method: \"PUT\",\n      body: JSON.stringify(data),\n    }),\n    delete: (id: string) => fetchAPI<void>(`/api/rooms/${id}`, {\n      method: \"DELETE\",\n    }),\n  },\n\n  staff: {\n    list: (practiceId: string) => fetchAPI<Staff[]>(`/api/practices/${practiceId}/staff`),\n    create: (practiceId: string, data: InsertStaff) => fetchAPI<Staff>(`/api/practices/${practiceId}/staff`, {\n      method: \"POST\",\n      body: JSON.stringify(data),\n    }),\n    update: (id: string, data: Partial<InsertStaff>) => fetchAPI<Staff>(`/api/staff/${id}`, {\n      method: \"PUT\",\n      body: JSON.stringify(data),\n    }),\n    delete: (id: string) => fetchAPI<void>(`/api/staff/${id}`, {\n      method: \"DELETE\",\n    }),\n  },\n\n  simulations: {\n    run: (data: { practiceId: string; patientVolume: number; operatingHours: number }) =>\n      fetchAPI<{\n        efficiencyScore: number;\n        harmonyScore: number;\n        waitTime: number;\n        patientCapacity: number;\n      }>(\"/api/simulations/run\", {\n        method: \"POST\",\n        body: JSON.stringify(data),\n      }),\n    save: (data: InsertSimulation) => fetchAPI<Simulation>(\"/api/simulations\", {\n      method: \"POST\",\n      body: JSON.stringify(data),\n    }),\n    list: (practiceId: string) => fetchAPI<Simulation[]>(`/api/practices/${practiceId}/simulations`),\n  },\n\n  ai: {\n    analyzeLayout: (data: { practiceId: string; operatingHours?: number }) =>\n      fetchAPI<LayoutAnalysis>(\"/api/ai/analyze-layout\", {\n        method: \"POST\",\n        body: JSON.stringify(data),\n      }),\n    getRecommendation: (data: { practiceId: string; question?: string }) =>\n      fetchAPI<{ recommendation: string }>(\"/api/ai/recommend\", {\n        method: \"POST\",\n        body: JSON.stringify(data),\n      }),\n    analyzeWorkflows: (data: { practiceId: string; includeRAG?: boolean }) =>\n      fetchAPI<WorkflowEfficiencyResult>(\"/api/ai/analyze-workflows\", {\n        method: \"POST\",\n        body: JSON.stringify(data),\n      }),\n  },\n\n  layout: {\n    efficiency: (practiceId: string) =>\n      fetchAPI<LayoutEfficiencyResult>(\"/api/layout/efficiency\", {\n        method: \"POST\",\n        body: JSON.stringify({ practiceId }),\n      }),\n  },\n\n  knowledge: {\n    list: () => fetchAPI<KnowledgeSource[]>(\"/api/knowledge\"),\n    get: (id: string) => fetchAPI<{ source: KnowledgeSource; chunks: KnowledgeChunk[] }>(`/api/knowledge/${id}`),\n    search: (query: string, limit?: number) => fetchAPI<Array<KnowledgeChunk & { source: KnowledgeSource; similarity: number }>>(\"/api/knowledge/search\", {\n      method: \"POST\",\n      body: JSON.stringify({ query, limit }),\n    }),\n  },\n\n  workflows: {\n    list: (practiceId: string) => fetchAPI<Workflow[]>(`/api/practices/${practiceId}/workflows`),\n    create: (practiceId: string, data: { name: string; slug: string; actorType: WorkflowActorType; source?: \"builtin\" | \"custom\" | \"knowledge\" }) =>\n      fetchAPI<Workflow>(`/api/practices/${practiceId}/workflows`, {\n        method: \"POST\",\n        body: JSON.stringify(data),\n      }),\n    upsert: (practiceId: string, data: { name: string; slug: string; actorType: WorkflowActorType; source?: \"builtin\" | \"custom\" | \"knowledge\" }) =>\n      fetchAPI<Workflow>(`/api/practices/${practiceId}/workflows`, {\n        method: \"PUT\",\n        body: JSON.stringify(data),\n      }),\n    delete: (id: string) => fetchAPI<void>(`/api/workflows/${id}`, {\n      method: \"DELETE\",\n    }),\n  },\n\n  connections: {\n    listByPractice: (practiceId: string) => fetchAPI<WorkflowConnection[]>(`/api/practices/${practiceId}/workflow-connections`),\n    create: (practiceId: string, data: { fromRoomId: string; toRoomId: string; kind?: \"patient\" | \"staff\"; weight?: number; distanceClass?: \"auto\" | \"short\" | \"medium\" | \"long\" }) =>\n      fetchAPI<WorkflowConnection>(`/api/practices/${practiceId}/workflow-connections`, {\n        method: \"POST\",\n        body: JSON.stringify(data),\n      }),\n    update: (id: string, data: Partial<{ kind: \"patient\" | \"staff\"; weight: number; distanceClass: \"auto\" | \"short\" | \"medium\" | \"long\" }>) =>\n      fetchAPI<WorkflowConnection>(`/api/workflow-connections/${id}`, {\n        method: \"PUT\",\n        body: JSON.stringify(data),\n      }),\n    delete: (id: string) => fetchAPI<void>(`/api/workflow-connections/${id}`, {\n      method: \"DELETE\",\n    }),\n  },\n\n  workflowSteps: {\n    list: (workflowId: string) => fetchAPI<WorkflowStep[]>(`/api/workflows/${workflowId}/steps`),\n    create: (workflowId: string, data: { fromRoomId: string; toRoomId: string; weight?: number }) =>\n      fetchAPI<WorkflowStep>(`/api/workflows/${workflowId}/steps`, {\n        method: \"POST\",\n        body: JSON.stringify(data),\n      }),\n    delete: (id: string) => fetchAPI<void>(`/api/workflow-steps/${id}`, {\n      method: \"DELETE\",\n    }),\n  },\n};\n\nexport interface WorkflowAnalysis {\n  workflowCostTotal: number;\n  workflowScore: number;\n  topConnections: Array<{\n    fromName: string;\n    toName: string;\n    distance: number;\n    distanceClass: \"short\" | \"medium\" | \"long\";\n    weight: number;\n    cost: number;\n  }>;\n  recommendations: string[];\n}\n\nexport interface LayoutAnalysis {\n  overallScore: number;\n  efficiencyScore: number;\n  staffingScore: number;\n  spaceUtilizationScore: number;\n  roomAnalyses: RoomAnalysis[];\n  staffingAnalysis: StaffingAnalysis;\n  capacityAnalysis: CapacityAnalysis;\n  recommendations: string[];\n  aiInsights: string;\n  workflowAnalysis?: WorkflowAnalysis;\n}\n\nexport interface RoomAnalysis {\n  roomId: string;\n  roomName: string;\n  roomType: string;\n  sizeScore: number;\n  sizeAssessment: \"undersized\" | \"optimal\" | \"oversized\";\n  actualSqM: number;\n  recommendation: string;\n}\n\nexport interface StaffingAnalysis {\n  overallScore: number;\n  ratios: Record<string, {\n    actual: number;\n    optimal: number;\n    score: number;\n    recommendation: string;\n  }>;\n}\n\nexport interface CapacityAnalysis {\n  estimatedCapacity: number;\n  capacityScore: number;\n  benchmarkComparison: string;\n}\n\nexport interface WorkflowMetrics {\n  totalDistanceMeters: number;\n  avgStepDistanceMeters: number;\n  backtrackingCount: number;\n  longestConnections: Array<{ fromName: string; toName: string; distanceMeters: number }>;\n  motionWasteScore: number;\n}\n\nexport interface LayoutEfficiencyResult {\n  score: number;\n  breakdown: {\n    patientFlowMeters: number;\n    staffMotionMeters: number;\n    steriLoopMeters: number;\n    labLoopMeters: number;\n    crossFloorPenaltyMeters: number;\n    privacyRisk: boolean;\n  };\n  issues: Array<{\n    severity: \"critical\" | \"high\" | \"medium\" | \"low\";\n    code: string;\n    title: string;\n    detail: string;\n    current: number;\n    target?: number;\n    unit: string;\n  }>;\n  tips: string[];\n  workflowMetrics?: WorkflowMetrics;\n  workflowAnalysis?: WorkflowAnalysis;\n}\n\nexport interface StepAnalysis {\n  stepIndex: number;\n  stepId: string;\n  fromRoomId: string;\n  toRoomId: string;\n  fromRoomName: string;\n  toRoomName: string;\n  distanceM: number;\n  distanceBand: \"short\" | \"medium\" | \"long\";\n  isFloorChange: boolean;\n  frictionScore: number;\n}\n\nexport interface WorkflowAnalysisDetail {\n  workflowId: string;\n  workflowName: string;\n  actorType: string;\n  totalDistanceM: number;\n  distanceBandCounts: {\n    short: number;\n    medium: number;\n    long: number;\n  };\n  floorChangeCount: number;\n  frictionIndex: number;\n  score: number;\n  top3ExpensiveSteps: StepAnalysis[];\n  allSteps: StepAnalysis[];\n}\n\nexport interface WorkflowRecommendation {\n  id: string;\n  priority: \"high\" | \"medium\" | \"low\";\n  title: string;\n  description: string;\n  category: \"backtracking\" | \"distance\" | \"floor\" | \"process\" | \"digital\";\n}\n\nexport interface WorkflowEfficiencyResult {\n  practiceId: string;\n  workflows: WorkflowAnalysisDetail[];\n  overallScore: number;\n  overallFrictionIndex: number;\n  recommendations: WorkflowRecommendation[];\n  knowledgeInsight?: {\n    answer: string;\n    sources: Array<{ docName: string; headingPath: string }>;\n  };\n}\n","path":null,"size_bytes":10027,"size_tokens":null},"client/src/pages/Simulation.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { \n  PlayCircle, \n  RotateCcw, \n  TrendingUp, \n  Clock, \n  Users, \n  Activity,\n  Loader2,\n  CheckCircle,\n  AlertTriangle,\n  AlertCircle,\n  Sparkles,\n  Target,\n  Heart,\n  Zap,\n  Lightbulb,\n  BarChart3\n} from \"lucide-react\";\nimport { useState } from \"react\";\nimport { useTranslation } from \"react-i18next\";\nimport { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { api, type LayoutAnalysis } from \"@/lib/api\";\nimport { usePractice } from \"@/contexts/PracticeContext\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { cn } from \"@/lib/utils\";\n\ninterface SimulationResult {\n  efficiencyScore: number;\n  harmonyScore: number;\n  waitTime: number;\n  patientCapacity: number;\n}\n\nfunction ScoreRing({ score, label, size = 100 }: { score: number; label: string; size?: number }) {\n  const safeScore = typeof score === 'number' && !isNaN(score) ? Math.max(0, Math.min(100, score)) : 0;\n  const strokeWidth = 6;\n  const radius = (size - strokeWidth) / 2;\n  const circumference = radius * 2 * Math.PI;\n  const offset = circumference - (safeScore / 100) * circumference;\n  \n  const getColor = (s: number) => {\n    if (s >= 80) return { stroke: \"#22c55e\", text: \"text-green-600\" };\n    if (s >= 60) return { stroke: \"#eab308\", text: \"text-yellow-600\" };\n    return { stroke: \"#ef4444\", text: \"text-red-600\" };\n  };\n  \n  const colors = getColor(safeScore);\n  \n  return (\n    <div className=\"flex flex-col items-center gap-2\">\n      <div className=\"relative flex items-center justify-center\" style={{ width: size, height: size }}>\n        <svg width={size} height={size} className=\"absolute -rotate-90\">\n          <circle\n            cx={size / 2}\n            cy={size / 2}\n            r={radius}\n            fill=\"none\"\n            stroke=\"currentColor\"\n            strokeWidth={strokeWidth}\n            className=\"text-muted/20\"\n          />\n          <motion.circle\n            cx={size / 2}\n            cy={size / 2}\n            r={radius}\n            fill=\"none\"\n            stroke={colors.stroke}\n            strokeWidth={strokeWidth}\n            strokeLinecap=\"round\"\n            initial={{ strokeDasharray: circumference, strokeDashoffset: circumference }}\n            animate={{ strokeDashoffset: offset }}\n            transition={{ duration: 1, ease: \"easeOut\" }}\n          />\n        </svg>\n        <div className=\"text-center z-10\">\n          <motion.div \n            className={cn(\"text-2xl font-bold\", colors.text)}\n            initial={{ opacity: 0, scale: 0.5 }}\n            animate={{ opacity: 1, scale: 1 }}\n            transition={{ duration: 0.5, delay: 0.3 }}\n          >\n            {safeScore.toFixed(1)}\n          </motion.div>\n        </div>\n      </div>\n      <span className=\"text-xs font-medium text-muted-foreground\">{label}</span>\n    </div>\n  );\n}\n\nfunction MetricCard({ \n  icon: Icon, \n  label, \n  value, \n  unit, \n  color,\n  benchmark,\n  status\n}: { \n  icon: React.ElementType; \n  label: string; \n  value: number | string; \n  unit?: string;\n  color: string;\n  benchmark?: string;\n  status?: \"good\" | \"warning\" | \"poor\";\n}) {\n  const statusColors = {\n    good: \"border-green-200 bg-green-50\",\n    warning: \"border-yellow-200 bg-yellow-50\",\n    poor: \"border-red-200 bg-red-50\"\n  };\n\n  const statusIcons = {\n    good: CheckCircle,\n    warning: AlertTriangle,\n    poor: AlertCircle\n  };\n\n  const StatusIcon = status ? statusIcons[status] : null;\n\n  return (\n    <motion.div \n      className={cn(\n        \"p-4 rounded-xl border transition-all\",\n        status ? statusColors[status] : \"bg-white border-slate-200\"\n      )}\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n      transition={{ duration: 0.4 }}\n      data-testid={`metric-card-${label.toLowerCase().replace(/\\s+/g, '-')}`}\n    >\n      <div className=\"flex items-start justify-between mb-3\">\n        <div className={cn(\"p-2 rounded-lg\", color)}>\n          <Icon className=\"h-4 w-4 text-white\" />\n        </div>\n        {StatusIcon && (\n          <StatusIcon className={cn(\n            \"h-4 w-4\",\n            status === \"good\" && \"text-green-600\",\n            status === \"warning\" && \"text-yellow-600\",\n            status === \"poor\" && \"text-red-600\"\n          )} />\n        )}\n      </div>\n      <div className=\"space-y-1\">\n        <p className=\"text-2xl font-bold\">\n          {value}\n          {unit && <span className=\"text-sm font-normal text-muted-foreground ml-1\">{unit}</span>}\n        </p>\n        <p className=\"text-xs font-medium text-muted-foreground\">{label}</p>\n        {benchmark && (\n          <p className=\"text-[10px] text-slate-500 mt-1\">{benchmark}</p>\n        )}\n      </div>\n    </motion.div>\n  );\n}\n\nfunction InsightCard({ \n  icon: Icon, \n  title, \n  description, \n  priority \n}: { \n  icon: React.ElementType; \n  title: string; \n  description: string;\n  priority: \"high\" | \"medium\" | \"low\";\n}) {\n  const colors = {\n    high: \"border-red-200 bg-red-50 text-red-800\",\n    medium: \"border-yellow-200 bg-yellow-50 text-yellow-800\",\n    low: \"border-green-200 bg-green-50 text-green-800\"\n  };\n\n  return (\n    <motion.div \n      className={cn(\"p-3 rounded-lg border\", colors[priority])}\n      initial={{ opacity: 0, x: -20 }}\n      animate={{ opacity: 1, x: 0 }}\n      transition={{ duration: 0.3 }}\n      data-testid={`insight-card-${priority}`}\n    >\n      <div className=\"flex items-start gap-2\">\n        <Icon className=\"h-4 w-4 shrink-0 mt-0.5\" />\n        <div>\n          <p className=\"text-xs font-semibold\">{title}</p>\n          <p className=\"text-xs mt-0.5 opacity-80\">{description}</p>\n        </div>\n      </div>\n    </motion.div>\n  );\n}\n\nexport default function Simulation() {\n  const { t } = useTranslation();\n  const { practiceId, practice } = usePractice();\n  const queryClient = useQueryClient();\n  const [patientVolume, setPatientVolume] = useState([50]);\n  const [operatingHours, setOperatingHours] = useState([8]);\n  const [randomEvents, setRandomEvents] = useState(true);\n  const [simulationResult, setSimulationResult] = useState<SimulationResult | null>(null);\n\n  const { data: analysis, isLoading: isAnalysisLoading } = useQuery({\n    queryKey: [\"ai-analysis\", practiceId],\n    queryFn: () => api.ai.analyzeLayout({ practiceId: practiceId!, operatingHours: operatingHours[0] }),\n    enabled: !!practiceId,\n    staleTime: 30000,\n  });\n\n  const runSimulationMutation = useMutation({\n    mutationFn: (params: { patientVolume: number; operatingHours: number }) => api.simulations.run({\n      practiceId: practiceId!,\n      patientVolume: params.patientVolume,\n      operatingHours: params.operatingHours\n    }),\n    onSuccess: (result) => {\n      setSimulationResult(result);\n      queryClient.invalidateQueries({ queryKey: [\"ai-analysis\", practiceId] });\n    }\n  });\n\n  const handleRunSimulation = () => {\n    if (practiceId) {\n      runSimulationMutation.mutate({\n        patientVolume: patientVolume[0],\n        operatingHours: operatingHours[0]\n      });\n    }\n  };\n\n  const handleReset = () => {\n    setSimulationResult(null);\n    setPatientVolume([50]);\n    setOperatingHours([8]);\n  };\n\n  const getWaitTimeStatus = (waitTime: number): \"good\" | \"warning\" | \"poor\" => {\n    if (waitTime <= 15) return \"good\";\n    if (waitTime <= 30) return \"warning\";\n    return \"poor\";\n  };\n\n  const getScoreStatus = (score: number): \"good\" | \"warning\" | \"poor\" => {\n    if (score >= 80) return \"good\";\n    if (score >= 60) return \"warning\";\n    return \"poor\";\n  };\n\n  const generateInsights = (result: SimulationResult, analysis?: LayoutAnalysis): Array<{\n    icon: React.ElementType;\n    title: string;\n    description: string;\n    priority: \"high\" | \"medium\" | \"low\";\n  }> => {\n    const insights: Array<{\n      icon: React.ElementType;\n      title: string;\n      description: string;\n      priority: \"high\" | \"medium\" | \"low\";\n    }> = [];\n\n    if (result.waitTime > 30) {\n      insights.push({\n        icon: Clock,\n        title: t(\"sim.highWaitTimes\"),\n        description: t(\"sim.highWaitTimesDesc\", { time: result.waitTime }),\n        priority: \"high\"\n      });\n    } else if (result.waitTime > 15) {\n      insights.push({\n        icon: Clock,\n        title: t(\"sim.waitAboveTarget\"),\n        description: t(\"sim.waitAboveTargetDesc\", { time: result.waitTime }),\n        priority: \"medium\"\n      });\n    }\n\n    if (result.efficiencyScore < 60) {\n      insights.push({\n        icon: Activity,\n        title: t(\"sim.layoutEfficiencyIssue\"),\n        description: t(\"sim.layoutEfficiencyIssueDesc\"),\n        priority: \"high\"\n      });\n    }\n\n    if (result.harmonyScore < 70) {\n      insights.push({\n        icon: Heart,\n        title: t(\"sim.staffBalanceAlert\"),\n        description: t(\"sim.staffBalanceAlertDesc\"),\n        priority: result.harmonyScore < 60 ? \"high\" : \"medium\"\n      });\n    }\n\n    const capacityUtilization = (patientVolume[0] / Math.max(1, result.patientCapacity)) * 100;\n    if (capacityUtilization > 90) {\n      insights.push({\n        icon: Users,\n        title: t(\"sim.nearCapacity\"),\n        description: t(\"sim.nearCapacityDesc\"),\n        priority: \"high\"\n      });\n    } else if (capacityUtilization < 50) {\n      insights.push({\n        icon: Target,\n        title: t(\"sim.underutilized\"),\n        description: t(\"sim.underutilizedDesc\", { percent: capacityUtilization.toFixed(0) }),\n        priority: \"low\"\n      });\n    }\n\n    if (analysis?.recommendations && analysis.recommendations.length > 0 && insights.length < 4) {\n      insights.push({\n        icon: Lightbulb,\n        title: t(\"sim.aiRecommendation\"),\n        description: analysis.recommendations[0],\n        priority: \"medium\"\n      });\n    }\n\n    return insights.slice(0, 4);\n  };\n\n  const roomCount = practice?.rooms?.length ?? 0;\n  const staffCount = practice?.staff?.length ?? 0;\n\n  return (\n    <div className=\"flex-1 overflow-y-auto p-8\">\n      <div className=\"flex items-center justify-between mb-8\">\n        <div>\n          <h2 className=\"text-3xl font-bold tracking-tight text-primary\" data-testid=\"text-simulation-title\">\n            {t(\"sim.title\")}\n          </h2>\n          <p className=\"text-muted-foreground\">{t(\"sim.subtitle\")}</p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Badge variant=\"outline\" className=\"text-xs\" data-testid=\"badge-room-count\">\n            {roomCount} {roomCount === 1 ? t(\"rooms.room\") : t(\"rooms.rooms\")}\n          </Badge>\n          <Badge variant=\"outline\" className=\"text-xs\" data-testid=\"badge-staff-count\">\n            {staffCount} {t(\"common.staff\")}\n          </Badge>\n        </div>\n      </div>\n\n      <div className=\"grid gap-6 lg:grid-cols-3\">\n        <Card className=\"lg:col-span-2\">\n          <CardHeader className=\"pb-4\">\n            <CardTitle className=\"flex items-center gap-2\">\n              <BarChart3 className=\"h-5 w-5 text-primary\" />\n              {t(\"sim.results\")}\n            </CardTitle>\n            <CardDescription>\n              {t(\"sim.resultsDesc\")}\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <AnimatePresence mode=\"wait\">\n              {runSimulationMutation.isPending ? (\n                <motion.div \n                  key=\"loading\"\n                  initial={{ opacity: 0 }}\n                  animate={{ opacity: 1 }}\n                  exit={{ opacity: 0 }}\n                  className=\"flex flex-col items-center justify-center py-16\"\n                >\n                  <div className=\"relative\">\n                    <div className=\"absolute inset-0 rounded-full bg-primary/20 animate-ping\" />\n                    <Loader2 className=\"h-12 w-12 animate-spin text-primary relative\" />\n                  </div>\n                  <p className=\"mt-4 text-muted-foreground font-medium\">{t(\"sim.running\")}</p>\n                  <p className=\"text-xs text-muted-foreground mt-1\">{t(\"sim.analyzing\", { patients: patientVolume[0], hours: operatingHours[0] })}</p>\n                </motion.div>\n              ) : simulationResult ? (\n                <motion.div\n                  key=\"results\"\n                  initial={{ opacity: 0 }}\n                  animate={{ opacity: 1 }}\n                  exit={{ opacity: 0 }}\n                  className=\"space-y-6\"\n                >\n                  <div className=\"flex justify-center gap-8 py-4\">\n                    <ScoreRing score={simulationResult.efficiencyScore} label={t(\"sim.efficiency\")} />\n                    <ScoreRing score={simulationResult.harmonyScore} label={t(\"sim.harmony\")} />\n                  </div>\n\n                  <Separator />\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <MetricCard\n                      icon={Clock}\n                      label={t(\"sim.avgWaitTime\")}\n                      value={simulationResult.waitTime}\n                      unit={t(\"common.min\")}\n                      color=\"bg-blue-500\"\n                      status={getWaitTimeStatus(simulationResult.waitTime)}\n                      benchmark={t(\"sim.industryTarget\")}\n                    />\n                    <MetricCard\n                      icon={Users}\n                      label={t(\"sim.patientCapacity\")}\n                      value={simulationResult.patientCapacity}\n                      unit={t(\"common.perDay\")}\n                      color=\"bg-emerald-500\"\n                      status={simulationResult.patientCapacity >= patientVolume[0] ? \"good\" : \"warning\"}\n                      benchmark={t(\"sim.simulated\", { count: patientVolume[0] })}\n                    />\n                    <MetricCard\n                      icon={Activity}\n                      label={t(\"sim.layoutScore\")}\n                      value={simulationResult.efficiencyScore.toFixed(1)}\n                      unit=\"%\"\n                      color=\"bg-purple-500\"\n                      status={getScoreStatus(simulationResult.efficiencyScore)}\n                    />\n                    <MetricCard\n                      icon={Heart}\n                      label={t(\"sim.staffHarmony\")}\n                      value={simulationResult.harmonyScore.toFixed(1)}\n                      unit=\"%\"\n                      color=\"bg-pink-500\"\n                      status={getScoreStatus(simulationResult.harmonyScore)}\n                    />\n                  </div>\n\n                  <Separator />\n\n                  <div>\n                    <div className=\"flex items-center gap-2 mb-3\">\n                      <Sparkles className=\"h-4 w-4 text-amber-500\" />\n                      <span className=\"text-sm font-semibold\">{t(\"sim.aiInsights\")}</span>\n                    </div>\n                    <div className=\"space-y-2\">\n                      {generateInsights(simulationResult, analysis).map((insight, i) => (\n                        <InsightCard key={i} {...insight} />\n                      ))}\n                    </div>\n                    {analysis?.aiInsights && (\n                      <div className=\"mt-4 p-3 rounded-lg bg-purple-50 border border-purple-100\">\n                        <div className=\"flex items-start gap-2\">\n                          <Zap className=\"h-4 w-4 text-purple-600 shrink-0 mt-0.5\" />\n                          <p className=\"text-xs text-purple-800 leading-relaxed\" data-testid=\"text-simulation-ai-insights\">\n                            {analysis.aiInsights}\n                          </p>\n                        </div>\n                      </div>\n                    )}\n                  </div>\n                </motion.div>\n              ) : (\n                <motion.div \n                  key=\"empty\"\n                  initial={{ opacity: 0 }}\n                  animate={{ opacity: 1 }}\n                  exit={{ opacity: 0 }}\n                  className=\"flex flex-col items-center justify-center py-16\"\n                >\n                  <div className=\"w-20 h-20 rounded-full border-4 border-primary/20 flex items-center justify-center mb-4 bg-primary/5\">\n                    <PlayCircle className=\"w-10 h-10 text-primary/60\" />\n                  </div>\n                  <p className=\"text-muted-foreground font-medium\">{t(\"sim.readyToSimulate\")}</p>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    {t(\"sim.configureParams\")}\n                  </p>\n                  {roomCount === 0 && (\n                    <p className=\"text-xs text-amber-600 mt-3 flex items-center gap-1\">\n                      <AlertTriangle className=\"h-3 w-3\" />\n                      {t(\"sim.addRoomsHint\")}\n                    </p>\n                  )}\n                </motion.div>\n              )}\n            </AnimatePresence>\n          </CardContent>\n        </Card>\n\n        <div className=\"space-y-6\">\n          <Card>\n            <CardHeader className=\"pb-4\">\n              <CardTitle className=\"text-base\">{t(\"sim.params\")}</CardTitle>\n              <CardDescription className=\"text-xs\">{t(\"sim.paramsDesc\")}</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              <div className=\"space-y-3\">\n                <div className=\"flex justify-between text-sm\">\n                  <span className=\"font-medium\">{t(\"sim.patientVolume\")}</span>\n                  <span className=\"text-muted-foreground font-mono\">{patientVolume[0]}</span>\n                </div>\n                <Slider \n                  value={patientVolume} \n                  onValueChange={setPatientVolume} \n                  max={200} \n                  min={10}\n                  step={5}\n                  className=\"py-2\"\n                  data-testid=\"slider-patient-volume\"\n                />\n                <p className=\"text-[10px] text-muted-foreground\">{t(\"sim.typical\")}</p>\n              </div>\n\n              <div className=\"space-y-3\">\n                <div className=\"flex justify-between text-sm\">\n                  <span className=\"font-medium\">{t(\"sim.operatingHours\")}</span>\n                  <span className=\"text-muted-foreground font-mono\">{operatingHours[0]}h</span>\n                </div>\n                <Slider \n                  value={operatingHours} \n                  onValueChange={setOperatingHours} \n                  max={12} \n                  min={4}\n                  step={1}\n                  className=\"py-2\"\n                  data-testid=\"slider-operating-hours\"\n                />\n                <p className=\"text-[10px] text-muted-foreground\">{t(\"sim.standard\")}</p>\n              </div>\n              \n              <div className=\"pt-2 border-t\">\n                <div className=\"flex justify-between items-center\">\n                  <div>\n                    <span className=\"text-sm font-medium\">{t(\"sim.randomEvents\")}</span>\n                    <p className=\"text-[10px] text-muted-foreground mt-0.5\">{t(\"sim.randomEventsDesc\")}</p>\n                  </div>\n                  <Switch \n                    checked={randomEvents} \n                    onCheckedChange={setRandomEvents}\n                    data-testid=\"switch-random-events\"\n                  />\n                </div>\n              </div>\n\n              <div className=\"flex gap-2 pt-2\">\n                <Button \n                  className=\"flex-1\"\n                  onClick={handleRunSimulation}\n                  disabled={runSimulationMutation.isPending || !practiceId}\n                  data-testid=\"button-run-simulation\"\n                >\n                  {runSimulationMutation.isPending ? (\n                    <Loader2 className=\"h-4 w-4 animate-spin mr-2\" />\n                  ) : (\n                    <PlayCircle className=\"h-4 w-4 mr-2\" />\n                  )}\n                  {t(\"sim.runSimulation\")}\n                </Button>\n                <Button \n                  variant=\"outline\" \n                  size=\"icon\"\n                  onClick={handleReset}\n                  disabled={runSimulationMutation.isPending}\n                  data-testid=\"button-reset-simulation\"\n                >\n                  <RotateCcw className=\"h-4 w-4\" />\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card className=\"bg-gradient-to-br from-blue-50 to-purple-50 border-blue-100\">\n            <CardHeader className=\"pb-3\">\n              <CardTitle className=\"text-blue-900 text-base flex items-center gap-2\">\n                <TrendingUp className=\"h-4 w-4\" />\n                {t(\"sim.activeScenario\")}\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <p className=\"text-sm text-blue-800 font-medium mb-2\">\n                \"{patientVolume[0]} {t(\"sim.patientVolume\")} / {operatingHours[0]}h\"\n              </p>\n              <p className=\"text-xs text-blue-600\">\n                {t(\"sim.testingEfficiency\", { patients: patientVolume[0], hours: operatingHours[0] })}\n              </p>\n              {analysis && (\n                <div className=\"mt-3 pt-3 border-t border-blue-200\">\n                  <div className=\"flex items-center justify-between text-xs\">\n                    <span className=\"text-blue-700\">{t(\"sim.currentPracticeScore\")}</span>\n                    <Badge \n                      variant=\"secondary\" \n                      className={cn(\n                        \"font-bold\",\n                        (analysis.overallScore ?? 0) >= 80 ? \"bg-green-100 text-green-700\" :\n                        (analysis.overallScore ?? 0) >= 60 ? \"bg-yellow-100 text-yellow-700\" :\n                        \"bg-red-100 text-red-700\"\n                      )}\n                      data-testid=\"badge-practice-score\"\n                    >\n                      {analysis.overallScore ?? 0}/100\n                    </Badge>\n                  </div>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":22125,"size_tokens":null},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n\nexport function dedupeByKey<T>(items: T[], getKey: (item: T) => string): T[] {\n  const seen = new Set<string>();\n  return items.filter(item => {\n    const key = getKey(item);\n    if (seen.has(key)) return false;\n    seen.add(key);\n    return true;\n  });\n}\n\nexport function slugify(text: string): string {\n  return text\n    .toLowerCase()\n    .replace(/[^a-z0-9]+/g, '-')\n    .replace(/^-|-$/g, '');\n}\n","path":null,"size_bytes":568,"size_tokens":null},"client/src/pages/LayoutEditor.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Slider } from \"@/components/ui/slider\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { Plus, Undo, Info, Trash2, RotateCw, X, Settings2, Pencil, Building2, ShieldAlert, Gauge, Lightbulb, ArrowRight, Link2, Footprints, MoreHorizontal, Layers, Activity, AlertTriangle, CheckCircle, Loader2 } from \"lucide-react\";\nimport { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger, DropdownMenuSeparator } from \"@/components/ui/dropdown-menu\";\nimport { Tooltip, TooltipContent, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useState, useRef, useEffect, useCallback, useMemo } from \"react\";\nimport { useTranslation } from \"react-i18next\";\nimport { cn, dedupeByKey, slugify } from \"@/lib/utils\";\nimport { usePractice } from \"@/contexts/PracticeContext\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { api } from \"@/lib/api\";\nimport type { Room, Workflow, WorkflowStep } from \"@shared/schema\";\nimport type { LayoutEfficiencyResult, WorkflowEfficiencyResult } from \"@/lib/api\";\nimport { PX_PER_METER, pxToM, mToPx, GRID_M, snapToGridM, clampM, normalizeToMeters, sqM } from \"@shared/units\";\nimport { METERS_PER_TILE, classifyRoomSize, roomSizeBucketLabel, roomSizeBucketColor } from \"@shared/layoutUnits\";\n\nfunction computeBezierPath(fromRoom: Room, toRoom: Room, offset: number = 0): { path: string; startX: number; startY: number; endX: number; endY: number; arrowPoints: Array<{x: number; y: number; angle: number}> } {\n  const fromCenterX = mToPx(fromRoom.x + fromRoom.width / 2);\n  const fromCenterY = mToPx(fromRoom.y + fromRoom.height / 2);\n  const toCenterX = mToPx(toRoom.x + toRoom.width / 2);\n  const toCenterY = mToPx(toRoom.y + toRoom.height / 2);\n  \n  const dx = toCenterX - fromCenterX;\n  const dy = toCenterY - fromCenterY;\n  \n  let baseStartX: number, baseStartY: number, baseEndX: number, baseEndY: number;\n  let c1x: number, c1y: number, c2x: number, c2y: number;\n  \n  if (Math.abs(dx) >= Math.abs(dy)) {\n    baseStartX = mToPx(fromRoom.x + (dx > 0 ? fromRoom.width : 0));\n    baseStartY = mToPx(fromRoom.y + fromRoom.height / 2);\n    baseEndX = mToPx(toRoom.x + (dx > 0 ? 0 : toRoom.width));\n    baseEndY = mToPx(toRoom.y + toRoom.height / 2);\n  } else {\n    baseStartX = mToPx(fromRoom.x + fromRoom.width / 2);\n    baseStartY = mToPx(fromRoom.y + (dy > 0 ? fromRoom.height : 0));\n    baseEndX = mToPx(toRoom.x + toRoom.width / 2);\n    baseEndY = mToPx(toRoom.y + (dy > 0 ? 0 : toRoom.height));\n  }\n  \n  const segDx = baseEndX - baseStartX;\n  const segDy = baseEndY - baseStartY;\n  const segLen = Math.sqrt(segDx * segDx + segDy * segDy) || 1;\n  const perpX = -segDy / segLen;\n  const perpY = segDx / segLen;\n  \n  const startX = baseStartX + perpX * offset;\n  const startY = baseStartY + perpY * offset;\n  const endX = baseEndX + perpX * offset;\n  const endY = baseEndY + perpY * offset;\n  \n  if (Math.abs(dx) >= Math.abs(dy)) {\n    const baseC1x = baseStartX + (baseEndX - baseStartX) * 0.5;\n    const baseC1y = baseStartY;\n    const baseC2x = baseEndX - (baseEndX - baseStartX) * 0.5;\n    const baseC2y = baseEndY;\n    c1x = baseC1x + perpX * offset;\n    c1y = baseC1y + perpY * offset;\n    c2x = baseC2x + perpX * offset;\n    c2y = baseC2y + perpY * offset;\n  } else {\n    const baseC1x = baseStartX;\n    const baseC1y = baseStartY + (baseEndY - baseStartY) * 0.5;\n    const baseC2x = baseEndX;\n    const baseC2y = baseEndY - (baseEndY - baseStartY) * 0.5;\n    c1x = baseC1x + perpX * offset;\n    c1y = baseC1y + perpY * offset;\n    c2x = baseC2x + perpX * offset;\n    c2y = baseC2y + perpY * offset;\n  }\n  \n  const path = `M ${startX} ${startY} C ${c1x} ${c1y} ${c2x} ${c2y} ${endX} ${endY}`;\n  \n  const bezierPoint = (t: number) => {\n    const u = 1 - t;\n    const x = u*u*u*startX + 3*u*u*t*c1x + 3*u*t*t*c2x + t*t*t*endX;\n    const y = u*u*u*startY + 3*u*u*t*c1y + 3*u*t*t*c2y + t*t*t*endY;\n    return { x, y };\n  };\n  \n  const bezierTangent = (t: number) => {\n    const u = 1 - t;\n    const tx = 3*u*u*(c1x - startX) + 6*u*t*(c2x - c1x) + 3*t*t*(endX - c2x);\n    const ty = 3*u*u*(c1y - startY) + 6*u*t*(c2y - c1y) + 3*t*t*(endY - c2y);\n    return Math.atan2(ty, tx) * (180 / Math.PI);\n  };\n  \n  const arrowPoints = [0.5].map(t => ({\n    ...bezierPoint(t),\n    angle: bezierTangent(t)\n  }));\n  \n  return { path, startX, startY, endX, endY, arrowPoints };\n}\n\nfunction computePreviewPath(fromRoom: Room, mouseX: number, mouseY: number): string {\n  const fromCenterX = mToPx(fromRoom.x + fromRoom.width / 2);\n  const fromCenterY = mToPx(fromRoom.y + fromRoom.height / 2);\n  \n  const dx = mouseX - fromCenterX;\n  const dy = mouseY - fromCenterY;\n  \n  let startX: number, startY: number;\n  let c1x: number, c1y: number, c2x: number, c2y: number;\n  \n  if (Math.abs(dx) >= Math.abs(dy)) {\n    startX = mToPx(fromRoom.x + (dx > 0 ? fromRoom.width : 0));\n    startY = mToPx(fromRoom.y + fromRoom.height / 2);\n    c1x = startX + dx * 0.5;\n    c1y = startY;\n    c2x = mouseX - dx * 0.5;\n    c2y = mouseY;\n  } else {\n    startX = mToPx(fromRoom.x + fromRoom.width / 2);\n    startY = mToPx(fromRoom.y + (dy > 0 ? fromRoom.height : 0));\n    c1x = startX;\n    c1y = startY + dy * 0.5;\n    c2x = mouseX;\n    c2y = mouseY - dy * 0.5;\n  }\n  \n  return `M ${startX} ${startY} C ${c1x} ${c1y} ${c2x} ${c2y} ${mouseX} ${mouseY}`;\n}\n\nexport default function LayoutEditor() {\n  const { t } = useTranslation();\n  const { practiceId } = usePractice();\n  const queryClient = useQueryClient();\n  const [selectedRoomId, setSelectedRoomId] = useState<string | null>(null);\n  const [currentFloor, setCurrentFloor] = useState<number>(0);\n  \n  const [roomNameDraft, setRoomNameDraft] = useState(\"\");\n  const [widthDraft, setWidthDraft] = useState<number>(2);\n  const [heightDraft, setHeightDraft] = useState<number>(2);\n  \n  const [connectMode, setConnectMode] = useState(false);\n  const [pendingFromRoomId, setPendingFromRoomId] = useState<string | null>(null);\n  const [mousePos, setMousePos] = useState<{ x: number; y: number } | null>(null);\n  const [hoverRoomId, setHoverRoomId] = useState<string | null>(null);\n  const [selectedWorkflowId, setSelectedWorkflowId] = useState<string | null>(null);\n  const [showEdgePanel, setShowEdgePanel] = useState(false);\n  const [showAnalysisModal, setShowAnalysisModal] = useState(false);\n  const [highlightedStepIds, setHighlightedStepIds] = useState<Set<string>>(new Set());\n  \n  const canvasRef = useRef<HTMLDivElement>(null);\n  const analysisDebounceRef = useRef<ReturnType<typeof setTimeout> | undefined>(undefined);\n  const aiInvalidateTimer = useRef<ReturnType<typeof setTimeout> | undefined>(undefined);\n  const nameDebounceTimer = useRef<ReturnType<typeof setTimeout> | undefined>(undefined);\n  const widthDebounceTimer = useRef<ReturnType<typeof setTimeout> | undefined>(undefined);\n  const heightDebounceTimer = useRef<ReturnType<typeof setTimeout> | undefined>(undefined);\n  const pendingRoomIdRef = useRef<string | null>(null);\n  const hasCreatedDefaultWorkflow = useRef(false);\n  \n  const ROOM_TYPES = [\n    { id: \"reception\", label: t(\"rooms.reception\"), color: \"bg-blue-100 border-blue-300\", w: 3, h: 2 },\n    { id: \"waiting\", label: t(\"rooms.waiting\"), color: \"bg-green-100 border-green-300\", w: 4, h: 3 },\n    { id: \"exam\", label: t(\"rooms.exam\"), color: \"bg-white border-gray-300\", w: 2.4, h: 2.4 },\n    { id: \"xray\", label: t(\"rooms.xray\"), color: \"bg-indigo-100 border-indigo-300\", w: 3, h: 3 },\n    { id: \"office\", label: t(\"rooms.office\"), color: \"bg-orange-100 border-orange-300\", w: 2.4, h: 2.4 },\n    { id: \"sterilization\", label: t(\"rooms.sterilization\"), color: \"bg-sky-100 border-sky-300\", w: 3.5, h: 3 },\n    { id: \"lab\", label: t(\"rooms.lab\"), color: \"bg-purple-100 border-purple-300\", w: 2, h: 2 },\n    { id: \"storage\", label: t(\"rooms.storage\"), color: \"bg-amber-100 border-amber-300\", w: 3, h: 2 },\n    { id: \"toilet\", label: t(\"rooms.toilet\"), color: \"bg-cyan-100 border-cyan-300\", w: 2.2, h: 2 },\n    { id: \"kitchen\", label: t(\"rooms.kitchen\"), color: \"bg-lime-100 border-lime-300\", w: 3, h: 2.5 },\n    { id: \"changing\", label: t(\"rooms.changing\"), color: \"bg-rose-100 border-rose-300\", w: 3, h: 2.2 },\n  ];\n\n  const { data: rooms = [] } = useQuery({\n    queryKey: [\"rooms\", practiceId],\n    queryFn: () => api.rooms.list(practiceId!),\n    enabled: !!practiceId,\n    select: (data) => data.map((room) => ({\n      ...room,\n      x: normalizeToMeters(room.x),\n      y: normalizeToMeters(room.y),\n      width: normalizeToMeters(room.width),\n      height: normalizeToMeters(room.height),\n    })),\n  });\n\n  const { data: efficiencyData } = useQuery<LayoutEfficiencyResult>({\n    queryKey: [\"layout-efficiency\", practiceId],\n    queryFn: () => api.layout.efficiency(practiceId!),\n    enabled: !!practiceId && rooms.length > 0,\n    staleTime: 2000,\n    refetchOnWindowFocus: false,\n  });\n\n  const { data: rawWorkflows = [], isLoading: isWorkflowsLoading } = useQuery({\n    queryKey: [\"workflows\", practiceId],\n    queryFn: () => api.workflows.list(practiceId!),\n    enabled: !!practiceId,\n  });\n  \n  const workflows = useMemo(() => {\n    const deduped = dedupeByKey(rawWorkflows, wf => wf.name);\n    if (process.env.NODE_ENV === 'development' && rawWorkflows.length !== deduped.length) {\n      console.warn('[Workflow Dedup]', {\n        total: rawWorkflows.length,\n        unique: deduped.length,\n        duplicates: rawWorkflows.length - deduped.length,\n      });\n    }\n    return deduped;\n  }, [rawWorkflows]);\n\n  const activeWorkflow = workflows.find(w => w.id === selectedWorkflowId) || workflows[0];\n  \n  useEffect(() => {\n    if (workflows.length > 0 && !selectedWorkflowId) {\n      setSelectedWorkflowId(workflows[0].id);\n    }\n  }, [workflows, selectedWorkflowId]);\n\n  const { data: connections = [] } = useQuery({\n    queryKey: [\"connections\", practiceId],\n    queryFn: () => api.connections.listByPractice(practiceId!),\n    enabled: !!practiceId,\n  });\n\n  const { data: workflowSteps = [] } = useQuery({\n    queryKey: [\"workflowSteps\", selectedWorkflowId],\n    queryFn: () => api.workflowSteps.list(selectedWorkflowId!),\n    enabled: !!selectedWorkflowId,\n  });\n\n  const { data: workflowAnalysis, isLoading: isAnalysisLoading, refetch: refetchAnalysis } = useQuery<WorkflowEfficiencyResult>({\n    queryKey: [\"workflow-analysis\", practiceId],\n    queryFn: () => api.ai.analyzeWorkflows({ practiceId: practiceId!, includeRAG: false }),\n    enabled: false,\n    staleTime: 30000,\n  });\n\n  const triggerAnalysis = useCallback(() => {\n    clearTimeout(analysisDebounceRef.current);\n    analysisDebounceRef.current = setTimeout(() => {\n      refetchAnalysis();\n      setShowAnalysisModal(true);\n    }, 300);\n  }, [refetchAnalysis]);\n\n  useEffect(() => {\n    if (workflowAnalysis?.workflows) {\n      const expensiveIds = new Set<string>();\n      for (const wf of workflowAnalysis.workflows) {\n        for (const step of wf.top3ExpensiveSteps) {\n          expensiveIds.add(step.stepId);\n        }\n      }\n      setHighlightedStepIds(expensiveIds);\n    }\n  }, [workflowAnalysis]);\n\n  const upsertWorkflowMutation = useMutation({\n    mutationFn: (data: { name: string; slug: string; actorType: \"patient\" | \"staff\" | \"instruments\"; source?: \"builtin\" | \"custom\" | \"knowledge\" }) =>\n      api.workflows.upsert(practiceId!, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"workflows\", practiceId] });\n    },\n  });\n\n  const createConnectionMutation = useMutation({\n    mutationFn: (data: { fromRoomId: string; toRoomId: string; kind?: \"patient\" | \"staff\" }) =>\n      api.connections.create(practiceId!, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"connections\", practiceId] });\n      queryClient.invalidateQueries({ queryKey: [\"layout-efficiency\", practiceId] });\n    },\n  });\n\n  const deleteConnectionMutation = useMutation({\n    mutationFn: (id: string) => api.connections.delete(id),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"connections\", practiceId] });\n      queryClient.invalidateQueries({ queryKey: [\"layout-efficiency\", practiceId] });\n    },\n  });\n\n  const createWorkflowStepMutation = useMutation({\n    mutationFn: (data: { fromRoomId: string; toRoomId: string; weight?: number }) =>\n      api.workflowSteps.create(selectedWorkflowId!, data),\n    onSuccess: (_data, variables) => {\n      queryClient.invalidateQueries({ queryKey: [\"workflowSteps\", selectedWorkflowId] });\n      queryClient.invalidateQueries({ queryKey: [\"layout-efficiency\", practiceId] });\n      setPendingFromRoomId(variables.toRoomId);\n    },\n  });\n\n  const deleteWorkflowStepMutation = useMutation({\n    mutationFn: (id: string) => api.workflowSteps.delete(id),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"workflowSteps\", selectedWorkflowId] });\n      queryClient.invalidateQueries({ queryKey: [\"layout-efficiency\", practiceId] });\n    },\n  });\n\n  const lastSeededPracticeId = useRef<string | null>(null);\n  \n  useEffect(() => {\n    if (practiceId !== lastSeededPracticeId.current) {\n      hasCreatedDefaultWorkflow.current = false;\n    }\n    \n    if (\n      practiceId && \n      !isWorkflowsLoading &&\n      rawWorkflows.length === 0 && \n      !upsertWorkflowMutation.isPending &&\n      !hasCreatedDefaultWorkflow.current\n    ) {\n      hasCreatedDefaultWorkflow.current = true;\n      lastSeededPracticeId.current = practiceId;\n      upsertWorkflowMutation.mutate({ \n        name: \"Neupatient (Patient Flow)\", \n        slug: \"neupatient-patient-flow\",\n        actorType: \"patient\",\n        source: \"builtin\"\n      });\n    }\n  }, [practiceId, rawWorkflows.length, isWorkflowsLoading, upsertWorkflowMutation.isPending]);\n\n  const getCanvasBoundsM = useCallback(() => {\n    if (canvasRef.current) {\n      const rect = canvasRef.current.getBoundingClientRect();\n      return { width: pxToM(rect.width), height: pxToM(rect.height) };\n    }\n    return { width: pxToM(1200), height: pxToM(800) };\n  }, []);\n\n  const scheduleAIInvalidation = useCallback(() => {\n    clearTimeout(aiInvalidateTimer.current);\n    aiInvalidateTimer.current = setTimeout(() => {\n      queryClient.invalidateQueries({ queryKey: [\"ai-analysis\", practiceId] });\n      queryClient.invalidateQueries({ queryKey: [\"layout-efficiency\", practiceId] });\n    }, 2000);\n  }, [queryClient, practiceId]);\n\n  const createRoomMutation = useMutation({\n    mutationFn: (data: { type: string; name: string; x: number; y: number; width: number; height: number; floor: number }) =>\n      api.rooms.create(practiceId!, { \n        ...data, \n        practiceId: practiceId!,\n        x: Math.round(mToPx(data.x)),\n        y: Math.round(mToPx(data.y)),\n        width: Math.round(mToPx(data.width)),\n        height: Math.round(mToPx(data.height)),\n      }),\n    onSuccess: (newRoom) => {\n      queryClient.invalidateQueries({ queryKey: [\"rooms\", practiceId] });\n      scheduleAIInvalidation();\n      setSelectedRoomId(newRoom.id);\n    },\n  });\n\n  const updateRoomMutation = useMutation({\n    mutationFn: ({ id, updates }: { id: string; updates: Partial<Room> }) => {\n      const apiUpdates: Partial<Room> = { ...updates };\n      if (apiUpdates.x !== undefined) apiUpdates.x = Math.round(mToPx(apiUpdates.x));\n      if (apiUpdates.y !== undefined) apiUpdates.y = Math.round(mToPx(apiUpdates.y));\n      if (apiUpdates.width !== undefined) apiUpdates.width = Math.round(mToPx(apiUpdates.width));\n      if (apiUpdates.height !== undefined) apiUpdates.height = Math.round(mToPx(apiUpdates.height));\n      return api.rooms.update(id, apiUpdates);\n    },\n    onMutate: async ({ id, updates }) => {\n      await queryClient.cancelQueries({ queryKey: [\"rooms\", practiceId] });\n      const previous = queryClient.getQueryData<Room[]>([\"rooms\", practiceId]);\n      queryClient.setQueryData<Room[]>([\"rooms\", practiceId], (old) =>\n        old?.map((r) => (r.id === id ? { ...r, ...updates } : r)) ?? []\n      );\n      return { previous };\n    },\n    onError: (_err, _vars, context) => {\n      if (context?.previous) {\n        queryClient.setQueryData([\"rooms\", practiceId], context.previous);\n      }\n    },\n    onSuccess: (serverRoom) => {\n      queryClient.setQueryData<Room[]>([\"rooms\", practiceId], (old) =>\n        old?.map((r) => (r.id === serverRoom.id ? serverRoom : r)) ?? []\n      );\n      scheduleAIInvalidation();\n    },\n  });\n\n  const deleteRoomMutation = useMutation({\n    mutationFn: (id: string) => api.rooms.delete(id),\n    onMutate: async (id) => {\n      await queryClient.cancelQueries({ queryKey: [\"rooms\", practiceId] });\n      const previous = queryClient.getQueryData<Room[]>([\"rooms\", practiceId]);\n      queryClient.setQueryData<Room[]>([\"rooms\", practiceId], (old) =>\n        old?.filter((r) => r.id !== id) ?? []\n      );\n      if (selectedRoomId === id) {\n        setSelectedRoomId(null);\n      }\n      return { previous };\n    },\n    onError: (_err, _vars, context) => {\n      if (context?.previous) {\n        queryClient.setQueryData([\"rooms\", practiceId], context.previous);\n      }\n    },\n    onSuccess: () => {\n      scheduleAIInvalidation();\n    },\n  });\n\n  const selectedRoom = rooms.find(r => r.id === selectedRoomId);\n  const selectedRoomType = selectedRoom ? ROOM_TYPES.find(t => t.id === selectedRoom.type) : null;\n\n  useEffect(() => {\n    clearTimeout(nameDebounceTimer.current);\n    clearTimeout(widthDebounceTimer.current);\n    clearTimeout(heightDebounceTimer.current);\n    \n    if (selectedRoom) {\n      setRoomNameDraft(selectedRoom.name);\n      setWidthDraft(selectedRoom.width);\n      setHeightDraft(selectedRoom.height);\n      pendingRoomIdRef.current = selectedRoom.id;\n    }\n  }, [selectedRoom?.id]);\n\n  useEffect(() => {\n    if (selectedRoom) {\n      if (roomNameDraft !== selectedRoom.name && pendingRoomIdRef.current === selectedRoom.id) {\n        setRoomNameDraft(selectedRoom.name);\n      }\n      if (widthDraft !== selectedRoom.width && pendingRoomIdRef.current === selectedRoom.id) {\n        setWidthDraft(selectedRoom.width);\n      }\n      if (heightDraft !== selectedRoom.height && pendingRoomIdRef.current === selectedRoom.id) {\n        setHeightDraft(selectedRoom.height);\n      }\n    }\n  }, [selectedRoom?.name, selectedRoom?.width, selectedRoom?.height]);\n\n  useEffect(() => {\n    return () => {\n      clearTimeout(aiInvalidateTimer.current);\n      clearTimeout(nameDebounceTimer.current);\n      clearTimeout(widthDebounceTimer.current);\n      clearTimeout(heightDebounceTimer.current);\n    };\n  }, []);\n\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      if (e.key === \"Escape\" && connectMode) {\n        if (pendingFromRoomId) {\n          setPendingFromRoomId(null);\n          setMousePos(null);\n          setHoverRoomId(null);\n        } else {\n          setConnectMode(false);\n        }\n      }\n    };\n    \n    window.addEventListener(\"keydown\", handleKeyDown);\n    return () => window.removeEventListener(\"keydown\", handleKeyDown);\n  }, [connectMode, pendingFromRoomId]);\n\n  const handleCanvasMouseMove = useCallback((e: React.MouseEvent<HTMLDivElement>) => {\n    if (!connectMode || !pendingFromRoomId || !canvasRef.current) return;\n    const rect = canvasRef.current.getBoundingClientRect();\n    setMousePos({ x: e.clientX - rect.left, y: e.clientY - rect.top });\n  }, [connectMode, pendingFromRoomId]);\n\n  const handleNameChange = (value: string) => {\n    const targetRoomId = selectedRoomId;\n    if (!targetRoomId) return;\n    \n    setRoomNameDraft(value);\n    clearTimeout(nameDebounceTimer.current);\n    nameDebounceTimer.current = setTimeout(() => {\n      const room = rooms.find(r => r.id === targetRoomId);\n      if (room && value !== room.name) {\n        updateRoomMutation.mutate({ id: targetRoomId, updates: { name: value } });\n      }\n    }, 500);\n  };\n\n  const handleNameBlur = () => {\n    clearTimeout(nameDebounceTimer.current);\n    if (selectedRoom && roomNameDraft !== selectedRoom.name) {\n      updateRoomMutation.mutate({ id: selectedRoom.id, updates: { name: roomNameDraft } });\n    }\n  };\n\n  const handleWidthChange = (valM: number) => {\n    const targetRoomId = selectedRoomId;\n    if (!targetRoomId) return;\n    \n    setWidthDraft(valM);\n    clearTimeout(widthDebounceTimer.current);\n    widthDebounceTimer.current = setTimeout(() => {\n      const room = rooms.find(r => r.id === targetRoomId);\n      if (room) {\n        const bounds = getCanvasBoundsM();\n        const clampedX = clampM(room.x, 0, bounds.width - valM);\n        const updates: Partial<Room> = { width: valM };\n        if (clampedX !== room.x) {\n          updates.x = clampedX;\n        }\n        updateRoomMutation.mutate({ id: targetRoomId, updates });\n      }\n    }, 300);\n  };\n\n  const handleHeightChange = (valM: number) => {\n    const targetRoomId = selectedRoomId;\n    if (!targetRoomId) return;\n    \n    setHeightDraft(valM);\n    clearTimeout(heightDebounceTimer.current);\n    heightDebounceTimer.current = setTimeout(() => {\n      const room = rooms.find(r => r.id === targetRoomId);\n      if (room) {\n        const bounds = getCanvasBoundsM();\n        const clampedY = clampM(room.y, 0, bounds.height - valM);\n        const updates: Partial<Room> = { height: valM };\n        if (clampedY !== room.y) {\n          updates.y = clampedY;\n        }\n        updateRoomMutation.mutate({ id: targetRoomId, updates });\n      }\n    }, 300);\n  };\n\n  const addRoom = (typeId: string) => {\n    const typeDef = ROOM_TYPES.find(t => t.id === typeId);\n    if (!typeDef) return;\n\n    createRoomMutation.mutate({ \n      type: typeId,\n      name: \"\", \n      x: 2,\n      y: 2,\n      width: typeDef.w,\n      height: typeDef.h,\n      floor: currentFloor\n    });\n  };\n\n  const updateRoom = (id: string, updates: Partial<Room>) => {\n    updateRoomMutation.mutate({ id, updates });\n  };\n\n  const handleRotate = () => {\n    if (!selectedRoom) return;\n    const bounds = getCanvasBoundsM();\n    const newWidth = selectedRoom.height;\n    const newHeight = selectedRoom.width;\n    const clampedX = clampM(selectedRoom.x, 0, bounds.width - newWidth);\n    const clampedY = clampM(selectedRoom.y, 0, bounds.height - newHeight);\n    updateRoom(selectedRoom.id, { \n      width: newWidth, \n      height: newHeight,\n      x: clampedX,\n      y: clampedY\n    });\n  };\n\n  const deleteRoom = (id: string) => {\n    deleteRoomMutation.mutate(id);\n  };\n\n  const clearAllRooms = () => {\n    rooms.forEach(room => {\n      deleteRoomMutation.mutate(room.id);\n    });\n  };\n\n  const handleDragEnd = (room: Room, info: { offset: { x: number; y: number } }, shiftPressed: boolean) => {\n    const bounds = getCanvasBoundsM();\n    let newX = room.x + pxToM(info.offset.x);\n    let newY = room.y + pxToM(info.offset.y);\n    \n    if (!shiftPressed) {\n      newX = snapToGridM(newX);\n      newY = snapToGridM(newY);\n    }\n    \n    newX = clampM(newX, 0, bounds.width - room.width);\n    newY = clampM(newY, 0, bounds.height - room.height);\n    \n    updateRoom(room.id, { x: newX, y: newY });\n  };\n\n  const handleRoomClickInConnectMode = (roomId: string) => {\n    if (!connectMode || !activeWorkflow) return;\n    \n    if (!pendingFromRoomId) {\n      setPendingFromRoomId(roomId);\n    } else if (pendingFromRoomId !== roomId) {\n      createWorkflowStepMutation.mutate({ fromRoomId: pendingFromRoomId, toRoomId: roomId });\n    }\n  };\n\n  const toggleConnectMode = () => {\n    setConnectMode(prev => !prev);\n    setPendingFromRoomId(null);\n    if (connectMode) {\n      setSelectedRoomId(null);\n    }\n  };\n\n  const connectionArrows = useMemo(() => {\n    const floorRooms = rooms.filter(r => r.floor === currentFloor);\n    const roomMap = new Map(floorRooms.map(r => [r.id, r]));\n    const validSteps = workflowSteps.filter(step => roomMap.has(step.fromRoomId) && roomMap.has(step.toRoomId));\n    \n    const pairSet = new Set(validSteps.map(s => `${s.fromRoomId}|${s.toRoomId}`));\n    const bidirectionalPairs = new Set<string>();\n    for (const step of validSteps) {\n      const reverseKey = `${step.toRoomId}|${step.fromRoomId}`;\n      if (pairSet.has(reverseKey)) {\n        bidirectionalPairs.add(`${step.fromRoomId}|${step.toRoomId}`);\n        bidirectionalPairs.add(reverseKey);\n      }\n    }\n    \n    return validSteps\n      .map((step, index) => {\n        const fromRoom = roomMap.get(step.fromRoomId)!;\n        const toRoom = roomMap.get(step.toRoomId)!;\n        \n        const pairKey = `${step.fromRoomId}|${step.toRoomId}`;\n        const isBidirectional = bidirectionalPairs.has(pairKey);\n        let offset = 0;\n        if (isBidirectional) {\n          offset = step.fromRoomId < step.toRoomId ? 6 : -6;\n        }\n        \n        const { path, startX, startY, endX, endY, arrowPoints } = computeBezierPath(fromRoom, toRoom, offset);\n        \n        const fromCenterX = fromRoom.x + fromRoom.width / 2;\n        const fromCenterY = fromRoom.y + fromRoom.height / 2;\n        const toCenterX = toRoom.x + toRoom.width / 2;\n        const toCenterY = toRoom.y + toRoom.height / 2;\n        \n        const dx = Math.abs(toCenterX - fromCenterX);\n        const dy = Math.abs(toCenterY - fromCenterY);\n        const halfWidths = (fromRoom.width + toRoom.width) / 2;\n        const halfHeights = (fromRoom.height + toRoom.height) / 2;\n        \n        let distanceM: number;\n        if (dx <= halfWidths && dy <= halfHeights) {\n          distanceM = 0;\n        } else if (dx <= halfWidths) {\n          distanceM = Math.max(0, dy - halfHeights);\n        } else if (dy <= halfHeights) {\n          distanceM = Math.max(0, dx - halfWidths);\n        } else {\n          const gapX = dx - halfWidths;\n          const gapY = dy - halfHeights;\n          distanceM = Math.sqrt(gapX * gapX + gapY * gapY);\n        }\n        \n        let distanceClass: \"short\" | \"medium\" | \"long\" = \"short\";\n        let distanceColor = \"rgb(34, 197, 94)\";\n        if (distanceM > 7) {\n          distanceClass = \"long\";\n          distanceColor = \"rgb(239, 68, 68)\";\n        } else if (distanceM > 2) {\n          distanceClass = \"medium\";\n          distanceColor = \"rgb(245, 158, 11)\";\n        }\n        \n        const distanceLabel = distanceClass === \"short\" ? \"Kurz\" : distanceClass === \"medium\" ? \"Mittel\" : \"Lang\";\n        \n        return {\n          id: step.id,\n          stepIndex: step.stepIndex,\n          path,\n          midX: (startX + endX) / 2,\n          midY: (startY + endY) / 2,\n          arrowPoints,\n          fromRoomId: step.fromRoomId,\n          toRoomId: step.toRoomId,\n          fromRoomName: fromRoom.name || ROOM_TYPES.find(t => t.id === fromRoom.type)?.label || fromRoom.type,\n          toRoomName: toRoom.name || ROOM_TYPES.find(t => t.id === toRoom.type)?.label || toRoom.type,\n          distanceM: Math.round(distanceM * 10) / 10,\n          distanceClass,\n          distanceColor,\n          distanceLabel,\n        };\n      });\n  }, [workflowSteps, rooms, currentFloor, ROOM_TYPES]);\n\n  const previewPath = useMemo(() => {\n    if (!connectMode || !pendingFromRoomId || !mousePos) return null;\n    const fromRoom = rooms.find(r => r.id === pendingFromRoomId);\n    if (!fromRoom) return null;\n    \n    if (hoverRoomId && hoverRoomId !== pendingFromRoomId) {\n      const toRoom = rooms.find(r => r.id === hoverRoomId);\n      if (toRoom) {\n        return computeBezierPath(fromRoom, toRoom).path;\n      }\n    }\n    \n    return computePreviewPath(fromRoom, mousePos.x, mousePos.y);\n  }, [connectMode, pendingFromRoomId, mousePos, hoverRoomId, rooms]);\n\n  return (\n    <div className=\"flex-1 flex flex-col h-full overflow-hidden\">\n      <header className=\"min-h-[4.5rem] py-3 border-b flex items-center justify-between px-8 bg-card z-10 shrink-0 shadow-sm\">\n        <div>\n          <h2 className=\"text-lg font-bold tracking-tight text-primary\">{t(\"layout.title\")}</h2>\n          <p className=\"text-xs text-muted-foreground\">{t(\"layout.subtitle\")}</p>\n        </div>\n        \n        <div className=\"flex items-center gap-2\">\n          {workflows.length > 0 && (\n            <Select value={selectedWorkflowId || \"\"} onValueChange={setSelectedWorkflowId}>\n              <SelectTrigger className=\"h-8 w-[180px] text-xs\" data-testid=\"select-workflow\">\n                <SelectValue placeholder=\"Workflow wählen\" />\n              </SelectTrigger>\n              <SelectContent>\n                {(() => {\n                  const grouped = workflows.reduce((acc, wf) => {\n                    const key = wf.actorType || 'patient';\n                    if (!acc[key]) acc[key] = [];\n                    acc[key].push(wf);\n                    return acc;\n                  }, {} as Record<string, typeof workflows>);\n                  \n                  const sortGroup = (items: typeof workflows) => \n                    [...items].sort((a, b) => {\n                      if (a.source === 'builtin' && b.source !== 'builtin') return -1;\n                      if (a.source !== 'builtin' && b.source === 'builtin') return 1;\n                      return a.name.localeCompare(b.name, 'de');\n                    });\n                  \n                  const groupLabels: Record<string, string> = {\n                    patient: t(\"workflow.groupPatient\", \"Patientenflüsse\"),\n                    staff: t(\"workflow.groupStaff\", \"Mitarbeiterflüsse\"),\n                    instruments: t(\"workflow.groupInstruments\", \"Instrumente/Sterilisation\"),\n                  };\n                  \n                  const groupOrder = ['patient', 'staff', 'instruments'];\n                  \n                  return groupOrder.filter(g => grouped[g]?.length).map((groupKey, gi) => (\n                    <div key={groupKey}>\n                      {gi > 0 && <div className=\"h-px bg-border my-1\" />}\n                      <div className=\"px-2 py-1.5 text-xs font-semibold text-muted-foreground\">\n                        {groupLabels[groupKey]}\n                      </div>\n                      {sortGroup(grouped[groupKey]).map(wf => (\n                        <SelectItem key={wf.id} value={wf.id} className=\"text-xs pl-4\" data-testid={`workflow-item-${wf.slug || wf.id}`}>\n                          {wf.name}\n                          {wf.source === 'builtin' && <span className=\"ml-1 text-[10px] text-muted-foreground\">(Standard)</span>}\n                        </SelectItem>\n                      ))}\n                    </div>\n                  ));\n                })()}\n              </SelectContent>\n            </Select>\n          )}\n          \n          <Select \n            value={currentFloor.toString()} \n            onValueChange={(val) => setCurrentFloor(parseInt(val))}\n          >\n            <SelectTrigger className=\"h-8 w-[140px] text-xs\" data-testid=\"select-floor\">\n              <Layers className=\"h-3.5 w-3.5 mr-1.5 text-muted-foreground\" />\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"-1\" className=\"text-xs\">{t(\"editor.floorUG\")}</SelectItem>\n              <SelectItem value=\"0\" className=\"text-xs\">{t(\"editor.floorEG\")}</SelectItem>\n              <SelectItem value=\"1\" className=\"text-xs\">{t(\"editor.floorOG\")}</SelectItem>\n            </SelectContent>\n          </Select>\n          \n          <Button\n            variant={connectMode ? \"default\" : \"outline\"}\n            size=\"sm\"\n            onClick={toggleConnectMode}\n            className={cn(\n              \"h-8 px-3\",\n              connectMode && \"bg-primary text-primary-foreground\"\n            )}\n            data-testid=\"button-connect-mode\"\n          >\n            <Link2 className=\"h-4 w-4 mr-1.5\" />\n            {connectMode ? t(\"editor.connectModeActive\", \"Aktiv\") : t(\"editor.connectMode\", \"Verbinden\")}\n          </Button>\n          \n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={triggerAnalysis}\n            disabled={isAnalysisLoading}\n            className=\"h-8 px-3\"\n            data-testid=\"button-workflow-analysis\"\n          >\n            {isAnalysisLoading ? (\n              <Loader2 className=\"h-4 w-4 mr-1.5 animate-spin\" />\n            ) : (\n              <Activity className=\"h-4 w-4 mr-1.5\" />\n            )}\n            {t(\"editor.workflowAnalysis\", \"Workflow Analyse\")}\n          </Button>\n          \n          <DropdownMenu>\n            <DropdownMenuTrigger asChild>\n              <Button variant=\"outline\" size=\"icon\" className=\"h-8 w-8\" data-testid=\"button-more-menu\">\n                <MoreHorizontal className=\"h-4 w-4\" />\n              </Button>\n            </DropdownMenuTrigger>\n            <DropdownMenuContent align=\"end\">\n              {connections.length > 0 && (\n                <>\n                  <DropdownMenuItem \n                    onClick={() => setShowEdgePanel(prev => !prev)}\n                    data-testid=\"menu-edge-panel\"\n                  >\n                    <ArrowRight className=\"mr-2 h-4 w-4\" />\n                    {connections.length} {connections.length === 1 ? \"Verbindung\" : \"Verbindungen\"}\n                  </DropdownMenuItem>\n                  <DropdownMenuSeparator />\n                </>\n              )}\n              <DropdownMenuItem \n                onClick={clearAllRooms}\n                className=\"text-destructive\"\n                data-testid=\"menu-reset\"\n              >\n                <Undo className=\"mr-2 h-4 w-4\" />\n                {t(\"layout.reset\")}\n              </DropdownMenuItem>\n            </DropdownMenuContent>\n          </DropdownMenu>\n        </div>\n      </header>\n\n      <div className=\"flex-1 flex overflow-hidden relative\">\n        <div className=\"w-48 border-r bg-card flex flex-col z-10 shadow-sm\">\n          <div className=\"px-3 py-2 border-b bg-muted/10\">\n            <h3 className=\"font-semibold text-[10px] uppercase tracking-wider text-muted-foreground flex items-center gap-1.5\">\n              <Plus className=\"w-3 h-3\" />\n              {t(\"layout.roomTypes\")}\n            </h3>\n          </div>\n          \n          <div className=\"flex-1 overflow-y-auto p-2 space-y-1\">\n            {ROOM_TYPES.map((room) => (\n              <button\n                key={room.id}\n                onClick={() => addRoom(room.id)}\n                className=\"w-full group flex items-center gap-2 px-2 py-1.5 rounded-lg border border-transparent transition-all duration-150 text-left hover:border-primary/20 hover:bg-accent active:scale-[0.98]\"\n                data-testid={`button-add-room-${room.id}`}\n              >\n                <div className={cn(\"w-6 h-6 rounded flex items-center justify-center shrink-0 transition-transform group-hover:scale-105\", room.color)}>\n                  <Plus className=\"w-3 h-3 opacity-40 group-hover:opacity-80 mix-blend-multiply\" />\n                </div>\n                <div className=\"flex-1 min-w-0 flex items-center justify-between gap-1\">\n                  <span className=\"text-[11px] font-medium text-foreground/80 leading-tight\">{room.label}</span>\n                  <span className=\"text-[9px] text-muted-foreground shrink-0\">{room.w.toFixed(1)}×{room.h.toFixed(1)} vM</span>\n                </div>\n              </button>\n            ))}\n          </div>\n\n          <div className=\"px-2 py-2 border-t bg-blue-50/50\">\n            <div className=\"flex items-start gap-2\">\n              <Info className=\"h-3 w-3 text-blue-500 shrink-0 mt-0.5\" />\n              <p className=\"text-[10px] text-blue-600 leading-tight\">\n                {t(\"layout.tipText\")}\n              </p>\n            </div>\n          </div>\n        </div>\n\n        <div \n          ref={canvasRef}\n          className=\"flex-1 bg-[#F0F4F8] relative overflow-hidden cursor-grab active:cursor-grabbing\"\n          onMouseMove={handleCanvasMouseMove}\n          onMouseLeave={() => setMousePos(null)}\n          onClick={(e) => {\n            if (e.target === e.currentTarget) {\n              if (connectMode && pendingFromRoomId) {\n                setPendingFromRoomId(null);\n                setMousePos(null);\n                setHoverRoomId(null);\n              } else {\n                setSelectedRoomId(null);\n              }\n            }\n          }}\n        >\n          <div \n            className=\"absolute inset-0 pointer-events-none opacity-[0.03]\"\n            style={{\n              backgroundImage: `\n                linear-gradient(to right, #000 1px, transparent 1px),\n                linear-gradient(to bottom, #000 1px, transparent 1px)\n              `,\n              backgroundSize: '40px 40px'\n            }}\n          />\n          \n          {connectMode && pendingFromRoomId && (\n            <div \n              className=\"absolute top-4 left-1/2 -translate-x-1/2 bg-green-100 border border-green-300 text-green-800 shadow-lg rounded-lg px-4 py-2 z-50 pointer-events-none flex items-center gap-2\"\n              data-testid=\"hint-cancel-connect\"\n            >\n              <span className=\"text-xs font-medium\">{t(\"editor.selectTarget\", \"Zielraum wählen\")}</span>\n              <span className=\"text-[10px] bg-green-200 rounded px-1.5 py-0.5 font-mono\">ESC</span>\n              <span className=\"text-[10px] text-green-600\">{t(\"editor.orClickCancel\", \"oder Klick = Abbrechen\")}</span>\n            </div>\n          )}\n          \n          <div \n            className=\"absolute bottom-4 left-4 bg-background/90 backdrop-blur-sm shadow-lg rounded-lg border px-3 py-2 z-40 pointer-events-none\"\n            data-testid=\"legend-distance\"\n          >\n            <div className=\"text-[9px] font-bold uppercase tracking-wide text-muted-foreground mb-1.5\">\n              {t(\"layout.distanceLegend\", \"Distanz-Klassen\")}\n            </div>\n            <div className=\"flex items-center gap-3 text-[10px]\">\n              <div className=\"flex items-center gap-1\">\n                <span className=\"w-2.5 h-2.5 rounded-full bg-green-500\" />\n                <span className=\"text-muted-foreground\">Kurz 0–3m</span>\n              </div>\n              <div className=\"flex items-center gap-1\">\n                <span className=\"w-2.5 h-2.5 rounded-full bg-amber-500\" />\n                <span className=\"text-muted-foreground\">Mittel 3–8m</span>\n              </div>\n              <div className=\"flex items-center gap-1\">\n                <span className=\"w-2.5 h-2.5 rounded-full bg-red-500\" />\n                <span className=\"text-muted-foreground\">Lang &gt;8m</span>\n              </div>\n            </div>\n          </div>\n          \n          {efficiencyData && (\n            <div \n              className=\"absolute bottom-4 right-4 w-64 bg-background/95 backdrop-blur-sm shadow-xl rounded-xl border p-3 z-40 pointer-events-auto\"\n              data-testid=\"card-layout-efficiency\"\n            >\n              <div className=\"flex items-center justify-between mb-2\">\n                <div className=\"flex items-center gap-2\">\n                  <Gauge className=\"w-4 h-4 text-primary\" />\n                  <span className=\"text-xs font-bold uppercase tracking-wide text-muted-foreground\">\n                    {t(\"layout.efficiencyScore\", \"Layout-Effizienz\")}\n                  </span>\n                </div>\n                <div className={cn(\n                  \"text-lg font-bold\",\n                  efficiencyData.score >= 70 ? \"text-green-600\" : efficiencyData.score >= 40 ? \"text-amber-600\" : \"text-red-600\"\n                )} data-testid=\"text-efficiency-score\">\n                  {efficiencyData.score}/100\n                </div>\n              </div>\n              \n              {efficiencyData.breakdown.privacyRisk && (\n                <div className=\"flex items-center gap-2 mb-2 px-2 py-1.5 bg-red-50 border border-red-200 rounded-lg\" data-testid=\"badge-privacy-risk\">\n                  <ShieldAlert className=\"w-3.5 h-3.5 text-red-500\" />\n                  <span className=\"text-[10px] font-medium text-red-700\">\n                    {t(\"layout.privacyRisk\", \"Datenschutzrisiko: Empfang zu nah am Wartebereich\")}\n                  </span>\n                </div>\n              )}\n              \n              {efficiencyData.tips.length > 0 && (\n                <div className=\"space-y-1.5\">\n                  {efficiencyData.tips.slice(0, 3).map((tip, i) => (\n                    <div key={i} className=\"flex items-start gap-1.5\">\n                      <Lightbulb className=\"w-3 h-3 text-amber-500 shrink-0 mt-0.5\" />\n                      <p className=\"text-[10px] text-muted-foreground leading-tight\" data-testid={`text-tip-${i}`}>{tip}</p>\n                    </div>\n                  ))}\n                </div>\n              )}\n              \n              {efficiencyData.workflowAnalysis && (\n                <div className=\"mt-2 pt-2 border-t\" data-testid=\"section-workflow-analysis\">\n                  <div className=\"flex items-center justify-between mb-1.5\">\n                    <div className=\"flex items-center gap-1.5\">\n                      <Link2 className=\"w-3.5 h-3.5 text-indigo-500\" />\n                      <span className=\"text-[10px] font-semibold text-muted-foreground uppercase tracking-wide\">\n                        {t(\"layout.workflowScore\", \"Workflow-Effizienz\")}\n                      </span>\n                    </div>\n                    <div className={cn(\n                      \"text-sm font-bold\",\n                      efficiencyData.workflowAnalysis.workflowScore >= 70 ? \"text-green-600\" : \n                      efficiencyData.workflowAnalysis.workflowScore >= 40 ? \"text-amber-600\" : \"text-red-600\"\n                    )} data-testid=\"text-workflow-score\">\n                      {efficiencyData.workflowAnalysis.workflowScore}/100\n                    </div>\n                  </div>\n                  {efficiencyData.workflowAnalysis.topConnections.length > 0 && (\n                    <div className=\"space-y-1 mb-1.5\">\n                      {efficiencyData.workflowAnalysis.topConnections.slice(0, 2).map((conn, i) => (\n                        <div key={i} className=\"flex items-center gap-1 text-[9px]\">\n                          <span className={cn(\n                            \"w-1.5 h-1.5 rounded-full\",\n                            conn.distanceClass === \"short\" ? \"bg-green-500\" :\n                            conn.distanceClass === \"medium\" ? \"bg-amber-500\" : \"bg-red-500\"\n                          )} />\n                          <span className=\"text-muted-foreground truncate\">\n                            {conn.fromName} → {conn.toName}\n                          </span>\n                          <span className=\"ml-auto font-medium\">{conn.distance}m</span>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                </div>\n              )}\n              \n              {efficiencyData.workflowMetrics && (\n                <div className=\"mt-2 pt-2 border-t\" data-testid=\"section-workflow-metrics\">\n                  <div className=\"flex items-center gap-1.5 mb-1.5\">\n                    <Footprints className=\"w-3.5 h-3.5 text-blue-500\" />\n                    <span className=\"text-[10px] font-semibold text-muted-foreground uppercase tracking-wide\">\n                      {t(\"layout.workflowMetrics\", \"Workflow-Laufwege\")}\n                    </span>\n                  </div>\n                  <div className=\"grid grid-cols-3 gap-1 text-center\">\n                    <div className=\"bg-muted/50 rounded px-1 py-0.5\">\n                      <div className=\"text-xs font-bold text-foreground\" data-testid=\"text-total-distance\">\n                        {efficiencyData.workflowMetrics.totalDistanceMeters}m\n                      </div>\n                      <div className=\"text-[8px] text-muted-foreground\">Gesamt</div>\n                    </div>\n                    <div className=\"bg-muted/50 rounded px-1 py-0.5\">\n                      <div className=\"text-xs font-bold text-foreground\" data-testid=\"text-avg-step\">\n                        {efficiencyData.workflowMetrics.avgStepDistanceMeters}m\n                      </div>\n                      <div className=\"text-[8px] text-muted-foreground\">Ø/Schritt</div>\n                    </div>\n                    <div className=\"bg-muted/50 rounded px-1 py-0.5\">\n                      <div className={cn(\n                        \"text-xs font-bold\",\n                        efficiencyData.workflowMetrics.motionWasteScore > 50 ? \"text-red-600\" : \n                        efficiencyData.workflowMetrics.motionWasteScore > 25 ? \"text-amber-600\" : \"text-green-600\"\n                      )} data-testid=\"text-motion-waste\">\n                        {efficiencyData.workflowMetrics.motionWasteScore}\n                      </div>\n                      <div className=\"text-[8px] text-muted-foreground\">Verlust</div>\n                    </div>\n                  </div>\n                </div>\n              )}\n            </div>\n          )}\n          \n          <AnimatePresence>\n            {rooms.filter(r => r.floor === currentFloor).map((room) => {\n              const typeDef = ROOM_TYPES.find(t => t.id === room.type);\n              const isSelected = selectedRoomId === room.id;\n              \n              const isPendingFrom = pendingFromRoomId === room.id;\n              \n              return (\n                <motion.div\n                  key={room.id}\n                  drag={!connectMode}\n                  dragMomentum={false}\n                  initial={{ scale: 0, opacity: 0 }}\n                  animate={{ \n                    x: mToPx(room.x), \n                    y: mToPx(room.y), \n                    scale: isSelected ? 1.02 : 1, \n                    opacity: 1,\n                    width: mToPx(room.width),\n                    height: mToPx(room.height),\n                    zIndex: isSelected ? 50 : 1\n                  }}\n                  onDragEnd={(e, info) => {\n                    if (connectMode) return;\n                    const shiftPressed = (e as MouseEvent).shiftKey;\n                    handleDragEnd(room, info, shiftPressed);\n                  }}\n                  onClick={(e) => {\n                    if (connectMode) {\n                      e.stopPropagation();\n                      handleRoomClickInConnectMode(room.id);\n                    }\n                  }}\n                  onMouseEnter={() => connectMode && setHoverRoomId(room.id)}\n                  onMouseLeave={() => connectMode && setHoverRoomId(null)}\n                  className={cn(\n                    \"absolute rounded-lg border-2 flex flex-col items-center justify-center select-none transition-colors transition-shadow duration-200 will-change-transform group\",\n                    connectMode ? \"cursor-pointer\" : \"cursor-move\",\n                    typeDef?.color,\n                    isSelected ? \"ring-4 ring-primary/20 border-primary shadow-2xl z-50\" : \"hover:shadow-lg hover:border-primary/50\",\n                    connectMode && isPendingFrom && \"ring-4 ring-green-400 border-green-500\",\n                    connectMode && !isPendingFrom && pendingFromRoomId && \"ring-2 ring-blue-300 border-blue-400\"\n                  )}\n                  data-testid={`room-${room.id}`}\n                >\n                  <div className=\"absolute inset-2 border border-black/5 rounded-sm pointer-events-none\" />\n                  \n                  {!connectMode && (\n                    <button\n                      onClick={(e) => {\n                        e.stopPropagation();\n                        setSelectedRoomId(room.id);\n                      }}\n                      className=\"absolute top-1 right-1 p-1.5 rounded-md bg-white/80 hover:bg-white shadow-sm border border-slate-200 opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer z-20\"\n                      data-testid={`button-edit-room-${room.id}`}\n                    >\n                      <Pencil className=\"w-3 h-3 text-slate-600\" />\n                    </button>\n                  )}\n                  \n                  <div className=\"text-center pointer-events-none p-2 w-full overflow-hidden relative z-10\">\n                    <div className=\"font-bold text-xs text-slate-800 truncate px-1\">\n                      {room.name || typeDef?.label}\n                    </div>\n                    {room.name && (\n                      <div className=\"text-[9px] text-slate-500 uppercase tracking-widest scale-75 origin-center opacity-70\">\n                        {typeDef?.label}\n                      </div>\n                    )}\n                    {isSelected && !connectMode && (\n                       <div className=\"text-[9px] text-slate-500 font-mono mt-1 bg-white/50 inline-block px-1.5 rounded\">\n                         {room.width.toFixed(1)} × {room.height.toFixed(1)} vM = {(room.width * room.height).toFixed(1)} vM²\n                       </div>\n                    )}\n                    {connectMode && isPendingFrom && (\n                      <div className=\"text-[9px] text-green-700 font-bold mt-1 bg-green-100 inline-block px-1.5 rounded\">\n                        {t(\"editor.connectFrom\", \"Start →\")}\n                      </div>\n                    )}\n                  </div>\n                  \n                  {connectMode && (\n                    <>\n                      <div className=\"absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1/2 w-3 h-3 rounded-full bg-blue-500 border-2 border-white shadow-sm opacity-60 group-hover:opacity-100 transition-opacity\" />\n                      <div className=\"absolute bottom-0 left-1/2 -translate-x-1/2 translate-y-1/2 w-3 h-3 rounded-full bg-blue-500 border-2 border-white shadow-sm opacity-60 group-hover:opacity-100 transition-opacity\" />\n                      <div className=\"absolute left-0 top-1/2 -translate-x-1/2 -translate-y-1/2 w-3 h-3 rounded-full bg-blue-500 border-2 border-white shadow-sm opacity-60 group-hover:opacity-100 transition-opacity\" />\n                      <div className=\"absolute right-0 top-1/2 translate-x-1/2 -translate-y-1/2 w-3 h-3 rounded-full bg-blue-500 border-2 border-white shadow-sm opacity-60 group-hover:opacity-100 transition-opacity\" />\n                    </>\n                  )}\n                </motion.div>\n              );\n            })}\n          </AnimatePresence>\n          \n          <svg \n            className=\"absolute inset-0 w-full h-full pointer-events-none z-30\"\n            data-testid=\"svg-connections\"\n          >\n            {connectionArrows.map(arrow => (\n              <g key={arrow.id} data-testid={`connection-${arrow.id}`}>\n                <path\n                  d={arrow.path}\n                  stroke={arrow.distanceColor}\n                  strokeWidth=\"3\"\n                  strokeLinecap=\"round\"\n                  fill=\"none\"\n                  className=\"transition-all duration-200\"\n                />\n                {arrow.arrowPoints.map((pt, i) => (\n                  <polygon\n                    key={i}\n                    points=\"-4,-3 4,0 -4,3\"\n                    fill={arrow.distanceColor}\n                    transform={`translate(${pt.x}, ${pt.y}) rotate(${pt.angle})`}\n                    className=\"transition-all duration-200\"\n                  />\n                ))}\n                {connectMode && (\n                  <circle\n                    cx={arrow.midX}\n                    cy={arrow.midY}\n                    r=\"12\"\n                    fill=\"#ef4444\"\n                    className=\"pointer-events-auto cursor-pointer hover:fill-red-600 transition-colors\"\n                    onClick={() => deleteWorkflowStepMutation.mutate(arrow.id)}\n                    data-testid={`button-delete-connection-${arrow.id}`}\n                  />\n                )}\n                {connectMode && (\n                  <text\n                    x={arrow.midX}\n                    y={arrow.midY + 4}\n                    textAnchor=\"middle\"\n                    fill=\"white\"\n                    fontSize=\"14\"\n                    fontWeight=\"bold\"\n                    className=\"pointer-events-none select-none\"\n                  >\n                    ×\n                  </text>\n                )}\n              </g>\n            ))}\n            {previewPath && (\n              <path\n                d={previewPath}\n                stroke=\"#22c55e\"\n                strokeWidth=\"3\"\n                strokeLinecap=\"round\"\n                strokeDasharray=\"8 4\"\n                fill=\"none\"\n                className=\"animate-pulse\"\n                data-testid=\"preview-connection\"\n              />\n            )}\n          </svg>\n        </div>\n\n        {showEdgePanel && connectionArrows.length > 0 && (\n          <div className=\"w-56 border-l bg-card flex flex-col z-10 shadow-sm\" data-testid=\"panel-edges\">\n            <div className=\"px-3 py-2 border-b bg-muted/10\">\n              <h3 className=\"font-semibold text-[10px] uppercase tracking-wider text-muted-foreground flex items-center gap-1.5\">\n                <Link2 className=\"w-3 h-3\" />\n                {t(\"layout.connections\", \"Verbindungen\")}\n              </h3>\n            </div>\n            <ScrollArea className=\"flex-1\">\n              <div className=\"p-2 space-y-1\">\n                {connectionArrows.map(conn => (\n                  <div \n                    key={conn.id} \n                    className=\"flex items-center gap-2 px-2 py-1.5 rounded-lg border bg-background/50 hover:bg-accent/50 transition-colors\"\n                    data-testid={`edge-item-${conn.id}`}\n                  >\n                    <span \n                      className=\"w-2.5 h-2.5 rounded-full shrink-0\" \n                      style={{ backgroundColor: conn.distanceColor }} \n                    />\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"text-[10px] font-medium truncate\">\n                        {conn.fromRoomName}\n                      </div>\n                      <div className=\"text-[9px] text-muted-foreground flex items-center gap-1\">\n                        <ArrowRight className=\"w-2.5 h-2.5\" />\n                        <span className=\"truncate\">{conn.toRoomName}</span>\n                      </div>\n                    </div>\n                    <div className=\"flex items-center gap-1.5 shrink-0\">\n                      <span \n                        className=\"text-[9px] font-mono font-medium px-1 py-0.5 rounded\"\n                        style={{ \n                          backgroundColor: `${conn.distanceColor}20`,\n                          color: conn.distanceColor \n                        }}\n                      >\n                        {conn.distanceM}m\n                      </span>\n                      <Button \n                        variant=\"ghost\" \n                        size=\"icon\"\n                        className=\"h-5 w-5 hover:bg-destructive/10 hover:text-destructive\"\n                        onClick={() => deleteWorkflowStepMutation.mutate(conn.id)}\n                        data-testid={`button-delete-edge-${conn.id}`}\n                      >\n                        <Trash2 className=\"h-3 w-3\" />\n                      </Button>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            </ScrollArea>\n            <div className=\"px-2 py-2 border-t bg-muted/10\">\n              <div className=\"text-[9px] text-muted-foreground text-center\">\n                {connectionArrows.length} {connectionArrows.length === 1 ? \"Verbindung\" : \"Verbindungen\"}\n              </div>\n            </div>\n          </div>\n        )}\n\n        <AnimatePresence>\n          {selectedRoom && (\n            <motion.div\n              initial={{ opacity: 0, x: 20 }}\n              animate={{ opacity: 1, x: 0 }}\n              exit={{ opacity: 0, x: 20 }}\n              className=\"absolute top-4 right-4 w-80 bg-background/95 backdrop-blur-md shadow-2xl rounded-2xl border border-border/50 z-50 overflow-hidden\"\n            >\n              <div className=\"h-8 bg-muted/40 w-full flex items-center justify-center border-b\">\n                  <div className=\"w-12 h-1 rounded-full bg-foreground/10\" />\n              </div>\n\n              <div className=\"p-4 pt-2\">\n                <div className=\"flex items-start justify-between mb-4\">\n                  <div className=\"flex items-center gap-3\">\n                      <div className={cn(\"w-12 h-12 rounded-xl shadow-sm border-2 flex items-center justify-center\", ROOM_TYPES.find(t => t.id === selectedRoom.type)?.color)}>\n                           <Settings2 className=\"w-6 h-6 opacity-50 mix-blend-multiply\" />\n                      </div>\n                      <div>\n                      <h4 className=\"font-bold text-lg leading-none\">{roomNameDraft || selectedRoomType?.label}</h4>\n                      <p className=\"text-xs text-muted-foreground font-mono mt-1 uppercase tracking-wide\">{selectedRoomType?.label}</p>\n                      </div>\n                  </div>\n                  <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8 -mr-2 -mt-2 rounded-full hover:bg-destructive/10 hover:text-destructive\" onClick={() => setSelectedRoomId(null)}>\n                      <X className=\"h-4 w-4\" />\n                  </Button>\n                </div>\n\n                <div className=\"space-y-5\">\n                  <div className=\"space-y-2\">\n                      <Label htmlFor=\"roomName\" className=\"text-xs font-bold uppercase text-muted-foreground\">{t(\"editor.roomName\")}</Label>\n                      <Input \n                          id=\"roomName\"\n                          value={roomNameDraft} \n                          onChange={(e) => handleNameChange(e.target.value)}\n                          onBlur={handleNameBlur}\n                          placeholder={selectedRoomType?.label}\n                          className=\"bg-white/50 border-slate-200 focus:bg-white transition-all\"\n                          data-testid=\"input-room-name\"\n                      />\n                  </div>\n\n                  <Separator className=\"bg-border/50\" />\n\n                  <div className=\"space-y-4\">\n                    <div className=\"space-y-3\">\n                      <div className=\"flex justify-between items-center\">\n                        <Label className=\"text-xs font-bold uppercase text-muted-foreground\">{t(\"editor.width\")}</Label>\n                        <div className=\"flex items-center gap-1.5\">\n                          <span className=\"text-xs font-mono bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded\" data-testid=\"text-width-tiles\">{Math.round(widthDraft / METERS_PER_TILE)} Tiles</span>\n                          <span className=\"text-xs font-mono bg-primary/10 text-primary px-2 py-0.5 rounded-md font-bold\">~{widthDraft.toFixed(1)} vM</span>\n                        </div>\n                      </div>\n                      <Slider \n                        value={[widthDraft]} \n                        min={1} \n                        max={8} \n                        step={0.1} \n                        onValueChange={([val]) => handleWidthChange(val)}\n                        data-testid=\"slider-width\"\n                      />\n                    </div>\n\n                    <div className=\"space-y-3\">\n                      <div className=\"flex justify-between items-center\">\n                         <Label className=\"text-xs font-bold uppercase text-muted-foreground\">{t(\"editor.height\")}</Label>\n                        <div className=\"flex items-center gap-1.5\">\n                          <span className=\"text-xs font-mono bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded\" data-testid=\"text-height-tiles\">{Math.round(heightDraft / METERS_PER_TILE)} Tiles</span>\n                          <span className=\"text-xs font-mono bg-primary/10 text-primary px-2 py-0.5 rounded-md font-bold\">~{heightDraft.toFixed(1)} vM</span>\n                        </div>\n                      </div>\n                      <Slider \n                        value={[heightDraft]} \n                        min={1} \n                        max={8} \n                        step={0.1} \n                        onValueChange={([val]) => handleHeightChange(val)}\n                        data-testid=\"slider-height\"\n                      />\n                    </div>\n                    \n                    <div className=\"flex justify-between items-center pt-2 border-t border-border/30\">\n                      <Label className=\"text-xs font-bold uppercase text-muted-foreground\">{t(\"editor.area\")}</Label>\n                      <div className=\"flex items-center gap-1.5\">\n                        <span className={cn(\"text-xs font-mono px-1.5 py-0.5 rounded font-medium\", roomSizeBucketColor(classifyRoomSize(selectedRoom.type, sqM(widthDraft, heightDraft))))} data-testid=\"text-room-bucket\">\n                          {roomSizeBucketLabel(classifyRoomSize(selectedRoom.type, sqM(widthDraft, heightDraft)))}\n                        </span>\n                        <span className=\"text-xs font-mono bg-green-100 text-green-700 px-2 py-0.5 rounded-md font-bold\" data-testid=\"text-room-area\">\n                          ~{sqM(widthDraft, heightDraft)} vM²\n                        </span>\n                      </div>\n                    </div>\n                    \n                    <div className=\"flex justify-between items-center pt-2\">\n                      <Label className=\"text-xs font-bold uppercase text-muted-foreground\">{t(\"editor.floor\")}</Label>\n                      <Select\n                        value={String(selectedRoom.floor)}\n                        onValueChange={(val) => updateRoom(selectedRoom.id, { floor: parseInt(val, 10) })}\n                      >\n                        <SelectTrigger className=\"w-[140px] h-8 text-xs\" data-testid=\"select-floor\">\n                          <SelectValue />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"-1\">{t(\"editor.floorUG\")}</SelectItem>\n                          <SelectItem value=\"0\">{t(\"editor.floorEG\")}</SelectItem>\n                          <SelectItem value=\"1\">{t(\"editor.floorOG\")}</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n                  </div>\n\n                  <Separator className=\"bg-border/50\" />\n\n                  <div className=\"grid grid-cols-2 gap-3\">\n                     <Button \n                      variant=\"outline\" \n                      className=\"hover:bg-primary/5 hover:text-primary hover:border-primary/30 transition-colors\"\n                      onClick={handleRotate}\n                      data-testid=\"button-rotate\"\n                    >\n                      <RotateCw className=\"mr-2 h-4 w-4\" />\n                      {t(\"editor.rotate\")}\n                    </Button>\n                    <Button \n                      variant=\"destructive\" \n                      className=\"shadow-sm hover:shadow-md transition-all\"\n                      onClick={() => deleteRoom(selectedRoom.id)}\n                      data-testid=\"button-delete\"\n                    >\n                      <Trash2 className=\"mr-2 h-4 w-4\" />\n                      {t(\"editor.delete\")}\n                    </Button>\n                  </div>\n                </div>\n              </div>\n            </motion.div>\n          )}\n        </AnimatePresence>\n      </div>\n\n      <Dialog open={showAnalysisModal} onOpenChange={setShowAnalysisModal}>\n        <DialogContent className=\"max-w-lg max-h-[80vh] overflow-y-auto\" data-testid=\"dialog-workflow-analysis\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Activity className=\"h-5 w-5 text-primary\" />\n              {t(\"editor.workflowAnalysisTitle\", \"Workflow-Analyse\")}\n            </DialogTitle>\n            <DialogDescription>\n              {t(\"editor.workflowAnalysisDesc\", \"Effizienz-Score basierend auf Laufwegen und Prozessabläufen\")}\n            </DialogDescription>\n          </DialogHeader>\n          \n          {isAnalysisLoading ? (\n            <div className=\"flex items-center justify-center py-8\">\n              <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n            </div>\n          ) : workflowAnalysis ? (\n            workflowAnalysis.workflows.length === 0 ? (\n              <div className=\"text-center py-8 space-y-3\" data-testid=\"no-workflow-steps-message\">\n                <div className=\"text-muted-foreground\">\n                  Keine Workflow-Schritte vorhanden\n                </div>\n                <p className=\"text-sm text-muted-foreground max-w-xs mx-auto\">\n                  Um die Workflow-Analyse zu nutzen, verbinden Sie Räume mit dem \"Verbinden\"-Button. Klicken Sie auf einen Raum als Start, dann auf einen anderen als Ziel.\n                </p>\n                <Button \n                  variant=\"outline\" \n                  size=\"sm\" \n                  onClick={() => { setShowAnalysisModal(false); setConnectMode(true); }}\n                  className=\"mt-2\"\n                  data-testid=\"button-start-connecting\"\n                >\n                  <Link2 className=\"h-4 w-4 mr-1.5\" />\n                  Workflow erstellen\n                </Button>\n              </div>\n            ) : (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center justify-between p-4 bg-muted/50 rounded-lg\">\n                <div>\n                  <div className=\"text-sm font-medium text-muted-foreground\">Gesamt-Score</div>\n                  <div className={cn(\n                    \"text-3xl font-bold\",\n                    workflowAnalysis.overallScore >= 70 ? \"text-green-600\" : \n                    workflowAnalysis.overallScore >= 40 ? \"text-amber-600\" : \"text-red-600\"\n                  )} data-testid=\"text-overall-score\">\n                    {workflowAnalysis.overallScore}/100\n                  </div>\n                </div>\n                <div className=\"text-right\">\n                  <div className=\"text-sm font-medium text-muted-foreground\">Friction-Index</div>\n                  <div className=\"text-xl font-semibold\" data-testid=\"text-friction-index\">\n                    {workflowAnalysis.overallFrictionIndex}%\n                  </div>\n                </div>\n              </div>\n\n              {workflowAnalysis.workflows.map((wf) => (\n                <div key={wf.workflowId} className=\"border rounded-lg p-3\" data-testid={`workflow-${wf.workflowId}`}>\n                  <div className=\"flex items-center justify-between mb-2\">\n                    <span className=\"font-medium text-sm\">{wf.workflowName}</span>\n                    <span className={cn(\n                      \"text-sm font-bold\",\n                      wf.score >= 70 ? \"text-green-600\" : wf.score >= 40 ? \"text-amber-600\" : \"text-red-600\"\n                    )}>\n                      {wf.score}/100\n                    </span>\n                  </div>\n                  <div className=\"grid grid-cols-3 gap-2 text-xs text-muted-foreground mb-2\">\n                    <div>Gesamtweg: <span className=\"font-medium text-foreground\">{wf.totalDistanceM}m</span></div>\n                    <div>Etagenwechsel: <span className=\"font-medium text-foreground\">{wf.floorChangeCount}</span></div>\n                    <div className=\"flex gap-1\">\n                      <span className=\"w-2 h-2 rounded-full bg-green-500 mt-1\" />{wf.distanceBandCounts.short}\n                      <span className=\"w-2 h-2 rounded-full bg-amber-500 mt-1 ml-1\" />{wf.distanceBandCounts.medium}\n                      <span className=\"w-2 h-2 rounded-full bg-red-500 mt-1 ml-1\" />{wf.distanceBandCounts.long}\n                    </div>\n                  </div>\n                  \n                  {wf.top3ExpensiveSteps.length > 0 && (\n                    <div className=\"space-y-1 mt-2 pt-2 border-t\">\n                      <div className=\"text-xs font-medium text-muted-foreground flex items-center gap-1\">\n                        <AlertTriangle className=\"h-3 w-3 text-amber-500\" />\n                        Teuerste Schritte:\n                      </div>\n                      {wf.top3ExpensiveSteps.map((step, i) => (\n                        <div \n                          key={step.stepId} \n                          className={cn(\n                            \"text-xs px-2 py-1 rounded flex items-center justify-between\",\n                            step.distanceBand === \"long\" ? \"bg-red-50 text-red-700\" :\n                            step.distanceBand === \"medium\" ? \"bg-amber-50 text-amber-700\" :\n                            \"bg-green-50 text-green-700\"\n                          )}\n                          data-testid={`expensive-step-${i}`}\n                        >\n                          <span>{step.fromRoomName} → {step.toRoomName}</span>\n                          <span className=\"font-medium\">{step.distanceM}m</span>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                </div>\n              ))}\n\n              {workflowAnalysis.recommendations.length > 0 && (\n                <div className=\"space-y-2\">\n                  <div className=\"text-sm font-medium flex items-center gap-1.5\">\n                    <Lightbulb className=\"h-4 w-4 text-amber-500\" />\n                    Empfehlungen\n                  </div>\n                  {workflowAnalysis.recommendations.slice(0, 3).map((rec) => (\n                    <div \n                      key={rec.id} \n                      className={cn(\n                        \"p-3 rounded-lg border text-sm\",\n                        rec.priority === \"high\" ? \"bg-red-50 border-red-200\" :\n                        rec.priority === \"medium\" ? \"bg-amber-50 border-amber-200\" :\n                        \"bg-blue-50 border-blue-200\"\n                      )}\n                      data-testid={`recommendation-${rec.id}`}\n                    >\n                      <div className=\"font-medium flex items-center gap-2\">\n                        {rec.priority === \"high\" ? (\n                          <AlertTriangle className=\"h-4 w-4 text-red-500\" />\n                        ) : rec.priority === \"medium\" ? (\n                          <Info className=\"h-4 w-4 text-amber-500\" />\n                        ) : (\n                          <CheckCircle className=\"h-4 w-4 text-blue-500\" />\n                        )}\n                        {rec.title}\n                      </div>\n                      <p className=\"text-muted-foreground mt-1\">{rec.description}</p>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </div>\n            )\n          ) : (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              Keine Analyse-Daten verfügbar\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":70997,"size_tokens":null},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","path":null,"size_bytes":3895,"size_tokens":null},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-9 items-center justify-center rounded-lg bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","path":null,"size_bytes":1877,"size_tokens":null},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","path":null,"size_bytes":4419,"size_tokens":null},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[60px] w-full rounded-md border border-input bg-transparent px-3 py-2 text-base shadow-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":649,"size_tokens":null},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-4 w-4 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1148,"size_tokens":null},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport session from \"express-session\";\nimport connectPgSimple from \"connect-pg-simple\";\nimport { registerRoutes } from \"./routes\";\nimport { serveStatic } from \"./static\";\nimport { createServer } from \"http\";\nimport { initializeArtifacts } from \"./artifactLoader\";\nimport { pool } from \"./db\";\n\ndeclare module \"express-session\" {\n  interface SessionData {\n    userId?: string;\n    practiceId?: string;\n  }\n}\n\nconst app = express();\nconst httpServer = createServer(app);\n\ndeclare module \"http\" {\n  interface IncomingMessage {\n    rawBody: unknown;\n  }\n}\n\napp.use(\n  express.json({\n    verify: (req, _res, buf) => {\n      req.rawBody = buf;\n    },\n  }),\n);\n\napp.use(express.urlencoded({ extended: false }));\n\nconst PgStore = connectPgSimple(session);\n\nconst sessionSecret = process.env.SESSION_SECRET;\nif (process.env.NODE_ENV === \"production\" && !sessionSecret) {\n  throw new Error(\"SESSION_SECRET environment variable is required in production\");\n}\n\napp.use(session({\n  store: new PgStore({ pool, createTableIfMissing: true }),\n  secret: sessionSecret || \"praxisflow-dev-secret-change-in-prod\",\n  resave: false,\n  saveUninitialized: false,\n  cookie: {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === \"production\",\n    sameSite: \"lax\",\n    maxAge: 7 * 24 * 60 * 60 * 1000,\n  }\n}));\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  await registerRoutes(httpServer, app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (process.env.NODE_ENV === \"production\") {\n    serveStatic(app);\n  } else {\n    const { setupVite } = await import(\"./vite\");\n    await setupVite(httpServer, app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || \"5000\", 10);\n  httpServer.listen(\n    {\n      port,\n      host: \"0.0.0.0\",\n      reusePort: true,\n    },\n    () => {\n      log(`serving on port ${port}`);\n      \n      initializeArtifacts().catch(err => {\n        console.log(\"[startup] Artifact initialization skipped:\", err.message);\n      });\n    },\n  );\n})();\n","path":null,"size_bytes":3571,"size_tokens":null},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center gap-2 rounded-md text-sm font-medium transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent shadow-sm hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-9 px-2 min-w-9\",\n        sm: \"h-8 px-1.5 min-w-8\",\n        lg: \"h-10 px-2.5 min-w-10\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","path":null,"size_bytes":1486,"size_tokens":null},"client/src/components/ui/field.tsx":{"content":"\"use client\"\n\nimport { useMemo } from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\nimport { Separator } from \"@/components/ui/separator\"\n\nfunction FieldSet({ className, ...props }: React.ComponentProps<\"fieldset\">) {\n  return (\n    <fieldset\n      data-slot=\"field-set\"\n      className={cn(\n        \"flex flex-col gap-6\",\n        \"has-[>[data-slot=checkbox-group]]:gap-3 has-[>[data-slot=radio-group]]:gap-3\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldLegend({\n  className,\n  variant = \"legend\",\n  ...props\n}: React.ComponentProps<\"legend\"> & { variant?: \"legend\" | \"label\" }) {\n  return (\n    <legend\n      data-slot=\"field-legend\"\n      data-variant={variant}\n      className={cn(\n        \"mb-3 font-medium\",\n        \"data-[variant=legend]:text-base\",\n        \"data-[variant=label]:text-sm\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"field-group\"\n      className={cn(\n        \"group/field-group @container/field-group flex w-full flex-col gap-7 data-[slot=checkbox-group]:gap-3 [&>[data-slot=field-group]]:gap-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nconst fieldVariants = cva(\n  \"group/field data-[invalid=true]:text-destructive flex w-full gap-3\",\n  {\n    variants: {\n      orientation: {\n        vertical: [\"flex-col [&>*]:w-full [&>.sr-only]:w-auto\"],\n        horizontal: [\n          \"flex-row items-center\",\n          \"[&>[data-slot=field-label]]:flex-auto\",\n          \"has-[>[data-slot=field-content]]:[&>[role=checkbox],[role=radio]]:mt-px has-[>[data-slot=field-content]]:items-start\",\n        ],\n        responsive: [\n          \"@md/field-group:flex-row @md/field-group:items-center @md/field-group:[&>*]:w-auto flex-col [&>*]:w-full [&>.sr-only]:w-auto\",\n          \"@md/field-group:[&>[data-slot=field-label]]:flex-auto\",\n          \"@md/field-group:has-[>[data-slot=field-content]]:items-start @md/field-group:has-[>[data-slot=field-content]]:[&>[role=checkbox],[role=radio]]:mt-px\",\n        ],\n      },\n    },\n    defaultVariants: {\n      orientation: \"vertical\",\n    },\n  }\n)\n\nfunction Field({\n  className,\n  orientation = \"vertical\",\n  ...props\n}: React.ComponentProps<\"div\"> & VariantProps<typeof fieldVariants>) {\n  return (\n    <div\n      role=\"group\"\n      data-slot=\"field\"\n      data-orientation={orientation}\n      className={cn(fieldVariants({ orientation }), className)}\n      {...props}\n    />\n  )\n}\n\nfunction FieldContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"field-content\"\n      className={cn(\n        \"group/field-content flex flex-1 flex-col gap-1.5 leading-snug\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldLabel({\n  className,\n  ...props\n}: React.ComponentProps<typeof Label>) {\n  return (\n    <Label\n      data-slot=\"field-label\"\n      className={cn(\n        \"group/field-label peer/field-label flex w-fit gap-2 leading-snug group-data-[disabled=true]/field:opacity-50\",\n        \"has-[>[data-slot=field]]:w-full has-[>[data-slot=field]]:flex-col has-[>[data-slot=field]]:rounded-md has-[>[data-slot=field]]:border [&>[data-slot=field]]:p-4\",\n        \"has-data-[state=checked]:bg-primary/5 has-data-[state=checked]:border-primary dark:has-data-[state=checked]:bg-primary/10\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldTitle({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"field-label\"\n      className={cn(\n        \"flex w-fit items-center gap-2 text-sm font-medium leading-snug group-data-[disabled=true]/field:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldDescription({ className, ...props }: React.ComponentProps<\"p\">) {\n  return (\n    <p\n      data-slot=\"field-description\"\n      className={cn(\n        \"text-muted-foreground text-sm font-normal leading-normal group-has-[[data-orientation=horizontal]]/field:text-balance\",\n        \"nth-last-2:-mt-1 last:mt-0 [[data-variant=legend]+&]:-mt-1.5\",\n        \"[&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldSeparator({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  children?: React.ReactNode\n}) {\n  return (\n    <div\n      data-slot=\"field-separator\"\n      data-content={!!children}\n      className={cn(\n        \"relative -my-2 h-5 text-sm group-data-[variant=outline]/field-group:-mb-2\",\n        className\n      )}\n      {...props}\n    >\n      <Separator className=\"absolute inset-0 top-1/2\" />\n      {children && (\n        <span\n          className=\"bg-background text-muted-foreground relative mx-auto block w-fit px-2\"\n          data-slot=\"field-separator-content\"\n        >\n          {children}\n        </span>\n      )}\n    </div>\n  )\n}\n\nfunction FieldError({\n  className,\n  children,\n  errors,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  errors?: Array<{ message?: string } | undefined>\n}) {\n  const content = useMemo(() => {\n    if (children) {\n      return children\n    }\n\n    if (!errors) {\n      return null\n    }\n\n    if (errors?.length === 1 && errors[0]?.message) {\n      return errors[0].message\n    }\n\n    return (\n      <ul className=\"ml-4 flex list-disc flex-col gap-1\">\n        {errors.map(\n          (error, index) =>\n            error?.message && <li key={index}>{error.message}</li>\n        )}\n      </ul>\n    )\n  }, [children, errors])\n\n  if (!content) {\n    return null\n  }\n\n  return (\n    <div\n      role=\"alert\"\n      data-slot=\"field-error\"\n      className={cn(\"text-destructive text-sm font-normal\", className)}\n      {...props}\n    >\n      {content}\n    </div>\n  )\n}\n\nexport {\n  Field,\n  FieldLabel,\n  FieldDescription,\n  FieldError,\n  FieldGroup,\n  FieldLegend,\n  FieldSeparator,\n  FieldSet,\n  FieldContent,\n  FieldTitle,\n}\n","path":null,"size_bytes":6044,"size_tokens":null},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary shadow focus:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-3.5 w-3.5 fill-primary\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1410,"size_tokens":null},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-primary/10\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","path":null,"size_bytes":266,"size_tokens":null},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":756,"size_tokens":null},"client/src/components/ui/form.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue | null>(null)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  if (!itemContext) {\n    throw new Error(\"useFormField should be used within <FormItem>\")\n  }\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue | null>(null)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-[0.8rem] text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-[0.8rem] font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","path":null,"size_bytes":4175,"size_tokens":null},"client/src/components/ui/drawer.tsx":{"content":"import * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","path":null,"size_bytes":3007,"size_tokens":null},"server/storage.ts":{"content":"import { \n  type User, \n  type InsertUser,\n  type Practice,\n  type InsertPractice,\n  type Room,\n  type InsertRoom,\n  type Staff,\n  type InsertStaff,\n  type Simulation,\n  type InsertSimulation,\n  type KnowledgeSource,\n  type InsertKnowledgeSource,\n  type KnowledgeChunk,\n  type InsertKnowledgeChunk,\n  type Workflow,\n  type InsertWorkflow,\n  type WorkflowConnection,\n  type InsertWorkflowConnection,\n  type WorkflowStep,\n  type InsertWorkflowStep,\n  users,\n  practices,\n  rooms,\n  staff,\n  simulations,\n  knowledgeSources,\n  knowledgeChunks,\n  knowledgeArtifacts,\n  workflows,\n  workflowConnections,\n  workflowSteps\n} from \"@shared/schema\";\n\nexport interface TableStats {\n  count: number;\n  latestCreatedAt?: string | null;\n  latestUpdatedAt?: string | null;\n}\n\nexport interface DebugStats {\n  tables: {\n    users: TableStats;\n    practices: TableStats;\n    rooms: TableStats;\n    staff: TableStats;\n    simulations: TableStats;\n    knowledgeSources: TableStats;\n    knowledgeChunks: TableStats;\n    knowledgeArtifacts: TableStats;\n    workflows: TableStats;\n    workflowConnections: TableStats;\n    workflowSteps: TableStats;\n  };\n  ragConfig: {\n    embeddingModel: string;\n    vectorDimensions: number;\n    targetChunkTokens: string;\n    overlap: number;\n  };\n  workflowDuplicates: { slug: string; practiceId: string; count: number }[];\n}\nimport { db } from \"./db\";\nimport { eq, sql, desc } from \"drizzle-orm\";\n\nexport interface IStorage {\n  getUser(id: string): Promise<User | undefined>;\n  getUserByUsername(username: string): Promise<User | undefined>;\n  createUser(user: InsertUser): Promise<User>;\n\n  getPractice(id: string): Promise<Practice | undefined>;\n  createPractice(practice: InsertPractice): Promise<Practice>;\n  updatePracticeBudget(id: string, budget: number): Promise<Practice | undefined>;\n  \n  getRoomsByPracticeId(practiceId: string): Promise<Room[]>;\n  createRoom(room: InsertRoom): Promise<Room>;\n  updateRoom(id: string, updates: Partial<Omit<InsertRoom, 'practiceId'>>): Promise<Room | undefined>;\n  deleteRoom(id: string): Promise<void>;\n  deleteRoomsByPracticeId(practiceId: string): Promise<void>;\n  \n  getStaffByPracticeId(practiceId: string): Promise<Staff[]>;\n  createStaff(staffMember: InsertStaff): Promise<Staff>;\n  updateStaff(id: string, updates: Partial<Omit<InsertStaff, 'practiceId'>>): Promise<Staff | undefined>;\n  deleteStaff(id: string): Promise<void>;\n  \n  getSimulationsByPracticeId(practiceId: string): Promise<Simulation[]>;\n  createSimulation(simulation: InsertSimulation): Promise<Simulation>;\n\n  getAllKnowledgeSources(): Promise<KnowledgeSource[]>;\n  getKnowledgeSource(id: string): Promise<KnowledgeSource | undefined>;\n  createKnowledgeSource(source: InsertKnowledgeSource): Promise<KnowledgeSource>;\n  deleteKnowledgeSource(id: string): Promise<void>;\n  \n  getChunksBySourceId(sourceId: string): Promise<KnowledgeChunk[]>;\n  createKnowledgeChunk(chunk: InsertKnowledgeChunk): Promise<KnowledgeChunk>;\n  searchKnowledgeChunks(queryEmbedding: number[], limit?: number): Promise<(KnowledgeChunk & { source: KnowledgeSource; similarity: number })[]>;\n\n  getWorkflowsByPracticeId(practiceId: string): Promise<Workflow[]>;\n  createWorkflow(workflow: InsertWorkflow): Promise<Workflow>;\n  upsertWorkflow(workflow: InsertWorkflow): Promise<Workflow>;\n  deleteWorkflow(id: string): Promise<void>;\n  \n  getConnectionsByPracticeId(practiceId: string): Promise<WorkflowConnection[]>;\n  createConnection(connection: InsertWorkflowConnection): Promise<WorkflowConnection>;\n  updateConnection(id: string, updates: Partial<Omit<InsertWorkflowConnection, 'practiceId' | 'fromRoomId' | 'toRoomId'>>): Promise<WorkflowConnection | undefined>;\n  deleteConnection(id: string): Promise<void>;\n\n  getWorkflowSteps(workflowId: string): Promise<WorkflowStep[]>;\n  createWorkflowStep(step: InsertWorkflowStep): Promise<WorkflowStep>;\n  deleteWorkflowStep(id: string): Promise<void>;\n  getMaxStepIndex(workflowId: string): Promise<number>;\n  \n  getDebugStats(): Promise<DebugStats>;\n\n  getPracticesByOwnerId(ownerId: string): Promise<Practice[]>;\n  getRoomWithPractice(roomId: string): Promise<{room: Room, practice: Practice} | undefined>;\n  getStaffWithPractice(staffId: string): Promise<{staff: Staff, practice: Practice} | undefined>;\n  getWorkflowWithPractice(workflowId: string): Promise<{workflow: Workflow, practice: Practice} | undefined>;\n  getConnectionWithPractice(connectionId: string): Promise<{connection: WorkflowConnection, practice: Practice} | undefined>;\n  getStepWithPractice(stepId: string): Promise<{step: WorkflowStep, practice: Practice} | undefined>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  async getUser(id: string): Promise<User | undefined> {\n    const result = await db.select().from(users).where(eq(users.id, id));\n    return result[0];\n  }\n\n  async getUserByUsername(username: string): Promise<User | undefined> {\n    const result = await db.select().from(users).where(eq(users.username, username));\n    return result[0];\n  }\n\n  async createUser(insertUser: InsertUser): Promise<User> {\n    const result = await db.insert(users).values(insertUser).returning();\n    return result[0];\n  }\n\n  async getPractice(id: string): Promise<Practice | undefined> {\n    const result = await db.select().from(practices).where(eq(practices.id, id));\n    return result[0];\n  }\n\n  async createPractice(practice: InsertPractice): Promise<Practice> {\n    const result = await db.insert(practices).values(practice).returning();\n    return result[0];\n  }\n\n  async updatePracticeBudget(id: string, budget: number): Promise<Practice | undefined> {\n    const result = await db\n      .update(practices)\n      .set({ budget })\n      .where(eq(practices.id, id))\n      .returning();\n    return result[0];\n  }\n\n  async getRoomsByPracticeId(practiceId: string): Promise<Room[]> {\n    return await db.select().from(rooms).where(eq(rooms.practiceId, practiceId));\n  }\n\n  async createRoom(room: InsertRoom): Promise<Room> {\n    const result = await db.insert(rooms).values(room).returning();\n    return result[0];\n  }\n\n  async updateRoom(id: string, updates: Partial<Omit<InsertRoom, 'practiceId'>>): Promise<Room | undefined> {\n    const result = await db\n      .update(rooms)\n      .set(updates)\n      .where(eq(rooms.id, id))\n      .returning();\n    return result[0];\n  }\n\n  async deleteRoom(id: string): Promise<void> {\n    await db.delete(rooms).where(eq(rooms.id, id));\n  }\n\n  async deleteRoomsByPracticeId(practiceId: string): Promise<void> {\n    await db.delete(rooms).where(eq(rooms.practiceId, practiceId));\n  }\n\n  async getStaffByPracticeId(practiceId: string): Promise<Staff[]> {\n    return await db.select().from(staff).where(eq(staff.practiceId, practiceId));\n  }\n\n  async createStaff(staffMember: InsertStaff): Promise<Staff> {\n    const result = await db.insert(staff).values(staffMember).returning();\n    return result[0];\n  }\n\n  async updateStaff(id: string, updates: Partial<Omit<InsertStaff, 'practiceId'>>): Promise<Staff | undefined> {\n    const result = await db\n      .update(staff)\n      .set(updates)\n      .where(eq(staff.id, id))\n      .returning();\n    return result[0];\n  }\n\n  async deleteStaff(id: string): Promise<void> {\n    await db.delete(staff).where(eq(staff.id, id));\n  }\n\n  async getSimulationsByPracticeId(practiceId: string): Promise<Simulation[]> {\n    return await db.select().from(simulations).where(eq(simulations.practiceId, practiceId));\n  }\n\n  async createSimulation(simulation: InsertSimulation): Promise<Simulation> {\n    const result = await db.insert(simulations).values(simulation).returning();\n    return result[0];\n  }\n\n  async getAllKnowledgeSources(): Promise<KnowledgeSource[]> {\n    return await db.select().from(knowledgeSources).orderBy(desc(knowledgeSources.uploadedAt));\n  }\n\n  async getKnowledgeSource(id: string): Promise<KnowledgeSource | undefined> {\n    const result = await db.select().from(knowledgeSources).where(eq(knowledgeSources.id, id));\n    return result[0];\n  }\n\n  async createKnowledgeSource(source: InsertKnowledgeSource): Promise<KnowledgeSource> {\n    const result = await db.insert(knowledgeSources).values(source).returning();\n    return result[0];\n  }\n\n  async deleteKnowledgeSource(id: string): Promise<void> {\n    await db.delete(knowledgeSources).where(eq(knowledgeSources.id, id));\n  }\n\n  async getChunksBySourceId(sourceId: string): Promise<KnowledgeChunk[]> {\n    return await db.select().from(knowledgeChunks).where(eq(knowledgeChunks.sourceId, sourceId));\n  }\n\n  async createKnowledgeChunk(chunk: InsertKnowledgeChunk): Promise<KnowledgeChunk> {\n    const result = await db.insert(knowledgeChunks).values(chunk).returning();\n    return result[0];\n  }\n\n  async searchKnowledgeChunks(queryEmbedding: number[], limit: number = 10): Promise<(KnowledgeChunk & { source: KnowledgeSource; similarity: number })[]> {\n    const embeddingStr = `[${queryEmbedding.join(',')}]`;\n    \n    const results = await db.execute(sql`\n      SELECT \n        kc.id,\n        kc.source_id as \"sourceId\",\n        kc.chunk_index as \"chunkIndex\",\n        kc.content,\n        kc.tokens,\n        kc.key_points as \"keyPoints\",\n        ks.id as \"source_id\",\n        ks.title as \"source_title\",\n        ks.file_name as \"source_fileName\",\n        ks.category as \"source_category\",\n        ks.tags as \"source_tags\",\n        ks.description as \"source_description\",\n        ks.uploaded_at as \"source_uploadedAt\",\n        1 - (kc.embedding <=> ${embeddingStr}::vector) as similarity\n      FROM knowledge_chunks kc\n      JOIN knowledge_sources ks ON kc.source_id = ks.id\n      WHERE kc.embedding IS NOT NULL\n      ORDER BY kc.embedding <=> ${embeddingStr}::vector\n      LIMIT ${limit}\n    `);\n\n    return (results.rows as any[]).map(row => ({\n      id: row.id,\n      sourceId: row.sourceId,\n      headingPath: row.headingPath || null,\n      chunkIndex: row.chunkIndex,\n      content: row.content,\n      contentHash: row.contentHash || null,\n      tokens: row.tokens,\n      embedding: null,\n      keyPoints: row.keyPoints,\n      createdAt: row.createdAt || new Date(),\n      source: {\n        id: row.source_id,\n        title: row.source_title,\n        fileName: row.source_fileName,\n        fileHash: row.source_fileHash || null,\n        category: row.source_category,\n        tags: row.source_tags,\n        description: row.source_description,\n        uploadedAt: row.source_uploadedAt,\n        updatedAt: row.source_updatedAt || row.source_uploadedAt\n      },\n      similarity: parseFloat(row.similarity)\n    }));\n  }\n\n  async getWorkflowsByPracticeId(practiceId: string): Promise<Workflow[]> {\n    return await db.select().from(workflows).where(eq(workflows.practiceId, practiceId));\n  }\n\n  async createWorkflow(workflow: InsertWorkflow): Promise<Workflow> {\n    const result = await db.insert(workflows).values(workflow as any).returning();\n    return result[0];\n  }\n\n  async upsertWorkflow(workflow: InsertWorkflow): Promise<Workflow> {\n    const result = await db.execute(sql`\n      INSERT INTO workflows (practice_id, slug, name, actor_type, source)\n      VALUES (${workflow.practiceId}, ${workflow.slug}, ${workflow.name}, ${workflow.actorType}, ${workflow.source || 'custom'})\n      ON CONFLICT (practice_id, slug) DO UPDATE SET \n        name = EXCLUDED.name,\n        actor_type = EXCLUDED.actor_type,\n        source = EXCLUDED.source\n      RETURNING *\n    `);\n    \n    const row = result.rows[0] as any;\n    return {\n      id: row.id,\n      practiceId: row.practice_id,\n      slug: row.slug,\n      name: row.name,\n      actorType: row.actor_type,\n      source: row.source,\n      createdAt: row.created_at,\n    };\n  }\n\n  async deleteWorkflow(id: string): Promise<void> {\n    await db.delete(workflows).where(eq(workflows.id, id));\n  }\n\n  async getConnectionsByPracticeId(practiceId: string): Promise<WorkflowConnection[]> {\n    return await db.select().from(workflowConnections).where(eq(workflowConnections.practiceId, practiceId));\n  }\n\n  async createConnection(connection: InsertWorkflowConnection): Promise<WorkflowConnection> {\n    const result = await db.insert(workflowConnections).values(connection as any).returning();\n    return result[0];\n  }\n\n  async updateConnection(id: string, updates: Partial<Omit<InsertWorkflowConnection, 'practiceId' | 'fromRoomId' | 'toRoomId'>>): Promise<WorkflowConnection | undefined> {\n    const result = await db\n      .update(workflowConnections)\n      .set(updates as any)\n      .where(eq(workflowConnections.id, id))\n      .returning();\n    return result[0];\n  }\n\n  async deleteConnection(id: string): Promise<void> {\n    await db.delete(workflowConnections).where(eq(workflowConnections.id, id));\n  }\n\n  async getWorkflowSteps(workflowId: string): Promise<WorkflowStep[]> {\n    return await db\n      .select()\n      .from(workflowSteps)\n      .where(eq(workflowSteps.workflowId, workflowId))\n      .orderBy(workflowSteps.stepIndex);\n  }\n\n  async createWorkflowStep(step: InsertWorkflowStep): Promise<WorkflowStep> {\n    const result = await db.insert(workflowSteps).values(step).returning();\n    return result[0];\n  }\n\n  async deleteWorkflowStep(id: string): Promise<void> {\n    await db.delete(workflowSteps).where(eq(workflowSteps.id, id));\n  }\n\n  async getMaxStepIndex(workflowId: string): Promise<number> {\n    const result = await db.execute(sql`\n      SELECT COALESCE(MAX(step_index), -1) as max_index \n      FROM workflow_steps \n      WHERE workflow_id = ${workflowId}\n    `);\n    return Number((result.rows[0] as any)?.max_index ?? -1);\n  }\n\n  async getDebugStats(): Promise<DebugStats> {\n    const parseTableStats = (row: any): TableStats => ({\n      count: Number(row?.c ?? 0),\n      latestCreatedAt: row?.latest_created ?? null,\n      latestUpdatedAt: row?.latest_updated ?? null,\n    });\n\n    const [\n      usersStats,\n      practicesStats,\n      roomsStats,\n      staffStats,\n      simsStats,\n      ksStats,\n      kcStats,\n      kaStats,\n      wfStats,\n      wcStats,\n      wsStats,\n      duplicates\n    ] = await Promise.all([\n      db.execute(sql`SELECT COUNT(*) as c FROM users`),\n      db.execute(sql`SELECT COUNT(*) as c FROM practices`),\n      db.execute(sql`SELECT COUNT(*) as c FROM rooms`),\n      db.execute(sql`SELECT COUNT(*) as c FROM staff`),\n      db.execute(sql`SELECT COUNT(*) as c, MAX(timestamp) as latest_created FROM simulations`),\n      db.execute(sql`SELECT COUNT(*) as c, MAX(uploaded_at) as latest_created, MAX(updated_at) as latest_updated FROM knowledge_sources`),\n      db.execute(sql`SELECT COUNT(*) as c, MAX(created_at) as latest_created FROM knowledge_chunks`),\n      db.execute(sql`SELECT COUNT(*) as c, MAX(created_at) as latest_created FROM knowledge_artifacts`),\n      db.execute(sql`SELECT COUNT(*) as c, MAX(created_at) as latest_created FROM workflows`),\n      db.execute(sql`SELECT COUNT(*) as c, MAX(created_at) as latest_created FROM workflow_connections`),\n      db.execute(sql`SELECT COUNT(*) as c, MAX(created_at) as latest_created FROM workflow_steps`),\n      db.execute(sql`\n        SELECT slug, practice_id as \"practiceId\", COUNT(*) as count\n        FROM workflows\n        GROUP BY slug, practice_id\n        HAVING COUNT(*) > 1\n      `),\n    ]);\n\n    return {\n      tables: {\n        users: parseTableStats(usersStats.rows[0]),\n        practices: parseTableStats(practicesStats.rows[0]),\n        rooms: parseTableStats(roomsStats.rows[0]),\n        staff: parseTableStats(staffStats.rows[0]),\n        simulations: parseTableStats(simsStats.rows[0]),\n        knowledgeSources: parseTableStats(ksStats.rows[0]),\n        knowledgeChunks: parseTableStats(kcStats.rows[0]),\n        knowledgeArtifacts: parseTableStats(kaStats.rows[0]),\n        workflows: parseTableStats(wfStats.rows[0]),\n        workflowConnections: parseTableStats(wcStats.rows[0]),\n        workflowSteps: parseTableStats(wsStats.rows[0]),\n      },\n      ragConfig: {\n        embeddingModel: \"text-embedding-3-small\",\n        vectorDimensions: 1536,\n        targetChunkTokens: \"600-900 (optimal: 750)\",\n        overlap: 100,\n      },\n      workflowDuplicates: (duplicates.rows as any[]).map(row => ({\n        slug: row.slug,\n        practiceId: row.practiceId,\n        count: Number(row.count),\n      })),\n    };\n  }\n\n  async getPracticesByOwnerId(ownerId: string): Promise<Practice[]> {\n    return await db.select().from(practices).where(eq(practices.ownerId, ownerId));\n  }\n\n  async getRoomWithPractice(roomId: string): Promise<{room: Room, practice: Practice} | undefined> {\n    const result = await db.select().from(rooms).where(eq(rooms.id, roomId));\n    if (!result[0]) return undefined;\n    const practice = await this.getPractice(result[0].practiceId);\n    if (!practice) return undefined;\n    return { room: result[0], practice };\n  }\n\n  async getStaffWithPractice(staffId: string): Promise<{staff: Staff, practice: Practice} | undefined> {\n    const result = await db.select().from(staff).where(eq(staff.id, staffId));\n    if (!result[0]) return undefined;\n    const practice = await this.getPractice(result[0].practiceId);\n    if (!practice) return undefined;\n    return { staff: result[0], practice };\n  }\n\n  async getWorkflowWithPractice(workflowId: string): Promise<{workflow: Workflow, practice: Practice} | undefined> {\n    const result = await db.select().from(workflows).where(eq(workflows.id, workflowId));\n    if (!result[0]) return undefined;\n    const practice = await this.getPractice(result[0].practiceId);\n    if (!practice) return undefined;\n    return { workflow: result[0], practice };\n  }\n\n  async getConnectionWithPractice(connectionId: string): Promise<{connection: WorkflowConnection, practice: Practice} | undefined> {\n    const result = await db.select().from(workflowConnections).where(eq(workflowConnections.id, connectionId));\n    if (!result[0]) return undefined;\n    const practice = await this.getPractice(result[0].practiceId);\n    if (!practice) return undefined;\n    return { connection: result[0], practice };\n  }\n\n  async getStepWithPractice(stepId: string): Promise<{step: WorkflowStep, practice: Practice} | undefined> {\n    const result = await db.select().from(workflowSteps).where(eq(workflowSteps.id, stepId));\n    if (!result[0]) return undefined;\n    const workflow = await db.select().from(workflows).where(eq(workflows.id, result[0].workflowId));\n    if (!workflow[0]) return undefined;\n    const practice = await this.getPractice(workflow[0].practiceId);\n    if (!practice) return undefined;\n    return { step: result[0], practice };\n  }\n}\n\nexport const storage = new DatabaseStorage();\n","path":null,"size_bytes":18518,"size_tokens":null},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","path":null,"size_bytes":1723,"size_tokens":null},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root> & { indicatorClassName?: string }\n>(({ className, value, indicatorClassName, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-2 w-full overflow-hidden rounded-full bg-primary/20\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className={cn(\"h-full w-full flex-1 bg-primary transition-all\", indicatorClassName)}\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","path":null,"size_bytes":872,"size_tokens":null},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Portal>\n    <TooltipPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 overflow-hidden rounded-md bg-primary px-3 py-1.5 text-xs text-primary-foreground animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </TooltipPrimitive.Portal>\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1267,"size_tokens":null},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationLink,\n  PaginationItem,\n  PaginationPrevious,\n  PaginationNext,\n  PaginationEllipsis,\n}\n","path":null,"size_bytes":2751,"size_tokens":null},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 text-sm font-medium transition-all hover:underline text-left [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 text-muted-foreground transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","path":null,"size_bytes":2001,"size_tokens":null},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","path":null,"size_bytes":1753,"size_tokens":null},"client/src/components/ui/spinner.tsx":{"content":"import { Loader2Icon } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction Spinner({ className, ...props }: React.ComponentProps<\"svg\">) {\n  return (\n    <Loader2Icon\n      role=\"status\"\n      aria-label=\"Loading\"\n      className={cn(\"size-4 animate-spin\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Spinner }\n","path":null,"size_bytes":331,"size_tokens":null},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-4 w-4 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","path":null,"size_bytes":7406,"size_tokens":null},"client/src/components/layout/Sidebar.tsx":{"content":"import { Link, useLocation } from \"wouter\";\nimport { cn } from \"@/lib/utils\";\nimport { LayoutDashboard, PenTool, Users, PlayCircle, Settings, Activity, Brain, BookOpen } from \"lucide-react\";\nimport { useTranslation } from \"react-i18next\";\nimport { LanguageToggle } from \"./LanguageToggle\";\n\nexport function Sidebar() {\n  const [location] = useLocation();\n  const { t } = useTranslation();\n\n  const navItems = [\n    { icon: LayoutDashboard, label: t(\"nav.dashboard\"), href: \"/\" },\n    { icon: PenTool, label: t(\"nav.layout\"), href: \"/editor\" },\n    { icon: Users, label: t(\"nav.staff\"), href: \"/staff\" },\n    { icon: PlayCircle, label: t(\"nav.simulation\"), href: \"/simulation\" },\n    { icon: Brain, label: t(\"nav.knowledge\", \"Coach-Wissen\"), href: \"/knowledge\" },\n    { icon: BookOpen, label: t(\"nav.playbooks\", \"Playbooks\"), href: \"/playbooks\" },\n  ];\n\n  return (\n    <div className=\"flex h-screen w-64 flex-col border-r bg-sidebar text-sidebar-foreground\">\n      <div className=\"flex h-16 items-center border-b px-6\">\n        <Activity className=\"mr-2 h-6 w-6 text-primary\" />\n        <span className=\"text-lg font-bold tracking-tight\">{t(\"app.title\")}</span>\n      </div>\n      <div className=\"flex-1 overflow-auto py-4\">\n        <nav className=\"space-y-1 px-2\">\n          {navItems.map((item) => {\n            const isActive = location === item.href;\n            return (\n              <Link \n                key={item.href} \n                href={item.href}\n                className={cn(\n                  \"flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium transition-colors hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n                  isActive ? \"bg-sidebar-accent text-sidebar-accent-foreground\" : \"text-muted-foreground\"\n                )}\n              >\n                <item.icon className=\"h-4 w-4\" />\n                {item.label}\n              </Link>\n            );\n          })}\n        </nav>\n      </div>\n      <div className=\"border-t p-4 space-y-2\">\n        <LanguageToggle />\n        <div className=\"flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium text-muted-foreground hover:bg-sidebar-accent hover:text-sidebar-accent-foreground cursor-pointer\">\n          <Settings className=\"h-4 w-4\" />\n          {t(\"nav.settings\")}\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":2339,"size_tokens":null},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\" +\n\" hover-elevate active-elevate-2\",\n  {\n    variants: {\n      variant: {\n        default:\n           // @replit: no hover, and add primary border\n           \"bg-primary text-primary-foreground border border-primary-border\",\n        destructive:\n          \"bg-destructive text-destructive-foreground shadow-sm border-destructive-border\",\n        outline:\n          // @replit Shows the background color of whatever card / sidebar / accent background it is inside of.\n          // Inherits the current text color. Uses shadow-xs. no shadow on active\n          // No hover state\n          \" border [border-color:var(--button-outline)] shadow-xs active:shadow-none \",\n        secondary:\n          // @replit border, no hover, no shadow, secondary border.\n          \"border bg-secondary text-secondary-foreground border border-secondary-border \",\n        // @replit no hover, transparent border\n        ghost: \"border border-transparent\",\n        link: \"text-primary underline-offset-4 hover:underline\",\n      },\n      size: {\n        // @replit changed sizes\n        default: \"min-h-9 px-4 py-2\",\n        sm: \"min-h-8 rounded-md px-3 text-xs\",\n        lg: \"min-h-10 rounded-md px-8\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":2356,"size_tokens":null},"client/src/contexts/PracticeContext.tsx":{"content":"import { createContext, useContext, useState, useEffect, useRef, ReactNode } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { api, type AuthUser } from \"@/lib/api\";\nimport type { Practice, Room, Staff } from \"@shared/schema\";\n\ninterface PracticeContextType {\n  practiceId: string | null;\n  practice: (Practice & { rooms: Room[]; staff: Staff[] }) | undefined;\n  isLoading: boolean;\n  error: Error | null;\n  user: AuthUser | null;\n  isAuthChecking: boolean;\n  logout: () => void;\n}\n\nconst PracticeContext = createContext<PracticeContextType | undefined>(undefined);\n\nexport function PracticeProvider({ children }: { children: ReactNode }) {\n  const [practiceId, setPracticeId] = useState<string | null>(null);\n  const [user, setUser] = useState<AuthUser | null>(null);\n  const [isAuthChecking, setIsAuthChecking] = useState(true);\n  const [, setLocation] = useLocation();\n  const authCheckedRef = useRef(false);\n\n  const createDefaultPractice = useMutation({\n    mutationFn: () => api.practices.create({\n      name: \"My Medical Practice\",\n      budget: 50000,\n    }),\n    onSuccess: (practice) => {\n      setPracticeId(practice.id);\n      localStorage.setItem(\"practiceId\", practice.id);\n    },\n  });\n\n  const { data: practice, isLoading, error } = useQuery({\n    queryKey: [\"practice\", practiceId],\n    queryFn: () => api.practices.get(practiceId!),\n    enabled: !!practiceId && !!user,\n  });\n\n  useEffect(() => {\n    if (authCheckedRef.current) return;\n    authCheckedRef.current = true;\n    \n    const checkAuth = async () => {\n      try {\n        const authUser = await api.auth.me();\n        setUser(authUser);\n        \n        const storedId = localStorage.getItem(\"practiceId\");\n        if (storedId) {\n          setPracticeId(storedId);\n        } else {\n          createDefaultPractice.mutate();\n        }\n        setIsAuthChecking(false);\n      } catch {\n        setLocation(\"/auth\");\n      }\n    };\n\n    checkAuth();\n  }, []);\n\n  const logout = async () => {\n    try {\n      await api.auth.logout();\n    } catch {\n    } finally {\n      setUser(null);\n      setPracticeId(null);\n      localStorage.removeItem(\"practiceId\");\n      setLocation(\"/auth\");\n    }\n  };\n\n  if (isAuthChecking) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"animate-pulse text-gray-500\">Laden...</div>\n      </div>\n    );\n  }\n\n  return (\n    <PracticeContext.Provider value={{ practiceId, practice, isLoading, error: error as Error | null, user, isAuthChecking, logout }}>\n      {children}\n    </PracticeContext.Provider>\n  );\n}\n\nexport function usePractice() {\n  const context = useContext(PracticeContext);\n  if (!context) {\n    throw new Error(\"usePractice must be used within PracticeProvider\");\n  }\n  return context;\n}\n","path":null,"size_bytes":2844,"size_tokens":null},"client/src/components/ui/sidebar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, VariantProps } from \"class-variance-authority\"\nimport { PanelLeftIcon } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nfunction SidebarProvider({\n  defaultOpen = true,\n  open: openProp,\n  onOpenChange: setOpenProp,\n  className,\n  style,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n}) {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback(\n    (value: boolean | ((value: boolean) => boolean)) => {\n      const openState = typeof value === \"function\" ? value(open) : value\n      if (setOpenProp) {\n        setOpenProp(openState)\n      } else {\n        _setOpen(openState)\n      }\n\n      // This sets the cookie to keep the sidebar state.\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n    },\n    [setOpenProp, open]\n  )\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n        (event.metaKey || event.ctrlKey)\n      ) {\n        event.preventDefault()\n        toggleSidebar()\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ? \"expanded\" : \"collapsed\"\n\n  const contextValue = React.useMemo<SidebarContextProps>(\n    () => ({\n      state,\n      open,\n      setOpen,\n      isMobile,\n      openMobile,\n      setOpenMobile,\n      toggleSidebar,\n    }),\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n  )\n\n  return (\n    <SidebarContext.Provider value={contextValue}>\n      <TooltipProvider delayDuration={0}>\n        <div\n          data-slot=\"sidebar-wrapper\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH,\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n              ...style,\n            } as React.CSSProperties\n          }\n          className={cn(\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\n            className\n          )}\n          {...props}\n        >\n          {children}\n        </div>\n      </TooltipProvider>\n    </SidebarContext.Provider>\n  )\n}\n\nfunction Sidebar({\n  side = \"left\",\n  variant = \"sidebar\",\n  collapsible = \"offcanvas\",\n  className,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  side?: \"left\" | \"right\"\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n}) {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible === \"none\") {\n    return (\n      <div\n        data-slot=\"sidebar\"\n        className={cn(\n          \"bg-sidebar text-sidebar-foreground flex h-full w-[var(--sidebar-width)] flex-col\",\n          className\n        )}\n        {...props}\n      >\n        {children}\n      </div>\n    )\n  }\n\n  if (isMobile) {\n    return (\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n        <SheetContent\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar\"\n          data-mobile=\"true\"\n          className=\"bg-sidebar text-sidebar-foreground w-[var(--sidebar-width)] p-0 [&>button]:hidden\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n            } as React.CSSProperties\n          }\n          side={side}\n        >\n          <SheetHeader className=\"sr-only\">\n            <SheetTitle>Sidebar</SheetTitle>\n            <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n          </SheetHeader>\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\n        </SheetContent>\n      </Sheet>\n    )\n  }\n\n  return (\n    <div\n      className=\"group peer text-sidebar-foreground hidden md:block\"\n      data-state={state}\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n      data-variant={variant}\n      data-side={side}\n      data-slot=\"sidebar\"\n    >\n      {/* This is what handles the sidebar gap on desktop */}\n      <div\n        data-slot=\"sidebar-gap\"\n        className={cn(\n          \"relative w-[var(--sidebar-width)] bg-transparent transition-[width] duration-200 ease-linear\",\n          \"group-data-[collapsible=offcanvas]:w-0\",\n          \"group-data-[side=right]:rotate-180\",\n          variant === \"floating\" || variant === \"inset\"\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4))]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)]\"\n        )}\n      />\n      <div\n        data-slot=\"sidebar-container\"\n        className={cn(\n          \"fixed inset-y-0 z-10 hidden h-svh w-[var(--sidebar-width)] transition-[left,right,width] duration-200 ease-linear md:flex\",\n          side === \"left\"\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n          // Adjust the padding for floating and inset variants.\n          variant === \"floating\" || variant === \"inset\"\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4)+2px)]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n          className\n        )}\n        {...props}\n      >\n        <div\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar-inner\"\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\n        >\n          {children}\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction SidebarTrigger({\n  className,\n  onClick,\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      data-sidebar=\"trigger\"\n      data-slot=\"sidebar-trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeftIcon />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n}\n\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\n  const { toggleSidebar } = useSidebar()\n\n  // Note: Tailwind v3.4 doesn't support \"in-\" selectors. So the rail won't work perfectly.\n  return (\n    <button\n      data-sidebar=\"rail\"\n      data-slot=\"sidebar-rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex\",\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\n  return (\n    <main\n      data-slot=\"sidebar-inset\"\n      className={cn(\n        \"bg-background relative flex w-full flex-1 flex-col\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInput({\n  className,\n  ...props\n}: React.ComponentProps<typeof Input>) {\n  return (\n    <Input\n      data-slot=\"sidebar-input\"\n      data-sidebar=\"input\"\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-header\"\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-footer\"\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"sidebar-separator\"\n      data-sidebar=\"separator\"\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-content\"\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group\"\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupLabel({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-label\"\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:h-4 [&>svg]:w-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupAction({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-action\"\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupContent({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group-content\"\n      data-sidebar=\"group-content\"\n      className={cn(\"w-full text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu\"\n      data-sidebar=\"menu\"\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-item\"\n      data-sidebar=\"menu-item\"\n      className={cn(\"group/menu-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:w-8! group-data-[collapsible=icon]:h-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction SidebarMenuButton({\n  asChild = false,\n  isActive = false,\n  variant = \"default\",\n  size = \"default\",\n  tooltip,\n  className,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  isActive?: boolean\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\n  const Comp = asChild ? Slot : \"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n    <Comp\n      data-slot=\"sidebar-menu-button\"\n      data-sidebar=\"menu-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n      {...props}\n    />\n  )\n\n  if (!tooltip) {\n    return button\n  }\n\n  if (typeof tooltip === \"string\") {\n    tooltip = {\n      children: tooltip,\n    }\n  }\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent\n        side=\"right\"\n        align=\"center\"\n        hidden={state !== \"collapsed\" || isMobile}\n        {...tooltip}\n      />\n    </Tooltip>\n  )\n}\n\nfunction SidebarMenuAction({\n  className,\n  asChild = false,\n  showOnHover = false,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  showOnHover?: boolean\n}) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-action\"\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuBadge({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-menu-badge\"\n      data-sidebar=\"menu-badge\"\n      className={cn(\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSkeleton({\n  className,\n  showIcon = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  showIcon?: boolean\n}) {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      data-slot=\"sidebar-menu-skeleton\"\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[var(--skeleton-width)] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n}\n\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu-sub\"\n      data-sidebar=\"menu-sub\"\n      className={cn(\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubItem({\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-sub-item\"\n      data-sidebar=\"menu-sub-item\"\n      className={cn(\"group/menu-sub-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubButton({\n  asChild = false,\n  size = \"md\",\n  isActive = false,\n  className,\n  ...props\n}: React.ComponentProps<\"a\"> & {\n  asChild?: boolean\n  size?: \"sm\" | \"md\"\n  isActive?: boolean\n}) {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-sub-button\"\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline outline-2 outline-transparent outline-offset-2 focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","path":null,"size_bytes":21846,"size_tokens":null},"client/src/components/ui/hover-card.tsx":{"content":"import * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","path":null,"size_bytes":1237,"size_tokens":null},"client/src/components/dashboard/EfficiencyChart.tsx":{"content":"import { ResponsiveContainer, AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, Legend } from \"recharts\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { useTranslation } from \"react-i18next\";\n\nconst data = [\n  { time: \"08:00\", efficiency: 65, harmony: 80 },\n  { time: \"09:00\", efficiency: 75, harmony: 78 },\n  { time: \"10:00\", efficiency: 85, harmony: 75 },\n  { time: \"11:00\", efficiency: 90, harmony: 70 },\n  { time: \"12:00\", efficiency: 80, harmony: 85 },\n  { time: \"13:00\", efficiency: 70, harmony: 88 },\n  { time: \"14:00\", efficiency: 85, harmony: 80 },\n  { time: \"15:00\", efficiency: 92, harmony: 75 },\n  { time: \"16:00\", efficiency: 88, harmony: 72 },\n  { time: \"17:00\", efficiency: 70, harmony: 65 },\n];\n\nexport function EfficiencyChart() {\n  const { t } = useTranslation();\n  return (\n    <Card className=\"col-span-4\">\n      <CardHeader>\n        <CardTitle>{t(\"chart.title\")}</CardTitle>\n      </CardHeader>\n      <CardContent className=\"pl-2\">\n        <ResponsiveContainer width=\"100%\" height={350}>\n          <AreaChart data={data}>\n            <defs>\n              <linearGradient id=\"colorEfficiency\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n                <stop offset=\"5%\" stopColor=\"hsl(var(--primary))\" stopOpacity={0.3} />\n                <stop offset=\"95%\" stopColor=\"hsl(var(--primary))\" stopOpacity={0} />\n              </linearGradient>\n              <linearGradient id=\"colorHarmony\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n                <stop offset=\"5%\" stopColor=\"hsl(var(--secondary))\" stopOpacity={0.3} />\n                <stop offset=\"95%\" stopColor=\"hsl(var(--secondary))\" stopOpacity={0} />\n              </linearGradient>\n            </defs>\n            <XAxis dataKey=\"time\" stroke=\"#888888\" fontSize={12} tickLine={false} axisLine={false} />\n            <YAxis stroke=\"#888888\" fontSize={12} tickLine={false} axisLine={false} tickFormatter={(value) => `${value}%`} />\n            <CartesianGrid strokeDasharray=\"3 3\" vertical={false} stroke=\"hsl(var(--border))\" />\n            <Tooltip \n              contentStyle={{ backgroundColor: 'hsl(var(--card))', borderRadius: '8px', border: '1px solid hsl(var(--border))' }}\n              labelStyle={{ color: 'hsl(var(--foreground))' }}\n            />\n            <Legend />\n            <Area type=\"monotone\" dataKey=\"efficiency\" stroke=\"hsl(var(--primary))\" fillOpacity={1} fill=\"url(#colorEfficiency)\" name={t(\"chart.efficiency\")} strokeWidth={2} />\n            <Area type=\"monotone\" dataKey=\"harmony\" stroke=\"hsl(var(--secondary))\" fillOpacity={1} fill=\"url(#colorHarmony)\" name={t(\"chart.harmony\")} strokeWidth={2} />\n          </AreaChart>\n        </ResponsiveContainer>\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":2720,"size_tokens":null},"client/src/components/ui/dialog.tsx":{"content":"import * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogTrigger,\n  DialogClose,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","path":null,"size_bytes":3835,"size_tokens":null},"client/src/lib/i18n.ts":{"content":"import i18n from \"i18next\";\nimport { initReactI18next } from \"react-i18next\";\n\nconst resources = {\n  en: {\n    translation: {\n      \"app.title\": \"PraxisFlow AI\",\n      \"nav.dashboard\": \"Dashboard\",\n      \"nav.layout\": \"Practice Layout\",\n      \"nav.staff\": \"Staff & Resources\",\n      \"nav.simulation\": \"Simulation\",\n      \"nav.settings\": \"Settings\",\n      \n      \"dashboard.title\": \"Practice Overview\",\n      \"dashboard.subtitle\": \"Current simulation status and performance metrics.\",\n      \"dashboard.runSim\": \"Run New Simulation\",\n      \"dashboard.liveView\": \"Live Floor View\",\n      \"dashboard.liveViewDesc\": \"Real-time simulation preview.\",\n      \"dashboard.analyzing\": \"Analyzing practice...\",\n      \"dashboard.healthScore\": \"Health Score\",\n      \"dashboard.excellent\": \"Excellent\",\n      \"dashboard.good\": \"Good\",\n      \"dashboard.needsWork\": \"Needs Work\",\n      \"dashboard.aiPracticeHealth\": \"AI Practice Health\",\n      \"dashboard.poweredByAI\": \"Powered by advanced analytics\",\n      \"dashboard.estDailyCapacity\": \"Est. Daily Capacity\",\n      \"dashboard.layoutEfficiency\": \"Layout Efficiency\",\n      \"dashboard.staffOptimization\": \"Staff Optimization\",\n      \"dashboard.spaceUtilization\": \"Space Utilization\",\n      \"dashboard.priorityActions\": \"Priority Actions\",\n      \"dashboard.aiRecommendedImprovements\": \"AI-recommended improvements\",\n      \"dashboard.openLayoutEditor\": \"Open Layout Editor\",\n      \"dashboard.aiInsights\": \"AI Insights\",\n      \n      \"stats.efficiency\": \"Efficiency Index\",\n      \"stats.harmony\": \"Harmony Score\",\n      \"stats.waitTime\": \"Avg Wait Time\",\n      \"stats.capacity\": \"Patient Capacity\",\n      \"stats.efficiencyDesc\": \"+2.5% from last simulation\",\n      \"stats.harmonyDesc\": \"Staff stress levels low\",\n      \"stats.waitTimeDesc\": \"-3 min optimization\",\n      \"stats.capacityDesc\": \"Using 85% of resources\",\n      \n      \"chart.title\": \"Daily Performance Metrics\",\n      \"chart.efficiency\": \"Efficiency Index\",\n      \"chart.harmony\": \"Harmony Score\",\n\n      \"layout.title\": \"Practice Layout Editor\",\n      \"layout.subtitle\": \"Drag and drop to optimize patient flow.\",\n      \"layout.reset\": \"Reset\",\n      \"layout.save\": \"Save Layout\",\n      \"layout.roomTypes\": \"Room Types\",\n      \"layout.tipTitle\": \"Optimization Tip\",\n      \"layout.tipText\": \"Placing the Waiting Room closer to Exam Rooms increases Efficiency Score by reducing patient travel time.\",\n      \n      \"staff.title\": \"Staff Management\",\n      \"staff.subtitle\": \"Monitor stress levels and assign roles to optimize harmony.\",\n      \"staff.add\": \"Add Staff Member\",\n      \"staff.efficiency\": \"Efficiency\",\n      \"staff.stress\": \"Stress Level\",\n      \"staff.aiRecommendations\": \"AI Staffing Recommendations\",\n      \"staff.optimalRatios\": \"Optimal staffing ratios based on your practice layout\",\n      \"staff.staffingOptimization\": \"Staffing Optimization\",\n      \"staff.industryBenchmarks\": \"Industry Benchmark Targets\",\n      \"staff.addRoomsHint\": \"Add rooms to your layout and staff to your team to see personalized recommendations\",\n      \"staff.addStaffHint\": \"Add staff members with roles (Doctor, Nurse, Receptionist) to calculate your actual staffing ratios\",\n      \"staff.currentTeam\": \"Current Team\",\n      \"staff.manageStaff\": \"Manage your practice staff members\",\n      \"staff.current\": \"Current\",\n      \"staff.optimal\": \"Optimal\",\n      \"staff.match\": \"match\",\n      \"staff.optimizationNeeded\": \"Staffing Optimization Needed\",\n      \"staff.optimizationNeededDesc\": \"Your current staffing levels are below optimal for your practice layout. Consider the recommendations above to improve patient flow and reduce wait times.\",\n      \"staff.excellentBalance\": \"Excellent Staffing Balance\",\n      \"staff.excellentBalanceDesc\": \"Your staffing levels are well-optimized for your current practice layout. Continue monitoring as your practice grows.\",\n      \n      \"sim.title\": \"Scenario Simulation\",\n      \"sim.subtitle\": \"Run complex scenarios to test efficiency and harmony under pressure.\",\n      \"sim.engineReady\": \"Simulation Engine Ready\",\n      \"sim.params\": \"Simulation Parameters\",\n      \"sim.paramsDesc\": \"Adjust variables in real-time\",\n      \"sim.patientVolume\": \"Patient Volume\",\n      \"sim.speed\": \"Simulation Speed\",\n      \"sim.randomEvents\": \"Random Events\",\n      \"sim.randomEventsDesc\": \"Includes staff sickness, emergency walk-ins, and equipment failure.\",\n      \"sim.activeScenario\": \"Active Scenario\",\n      \"sim.scenarioName\": \"Flu Season Peak\",\n      \"sim.scenarioDesc\": \"High patient influx with respiratory symptoms. Staff stress accumulation increased by 20%.\",\n      \"sim.results\": \"Simulation Results\",\n      \"sim.resultsDesc\": \"Run a simulation to see how your practice performs with different patient volumes\",\n      \"sim.running\": \"Running simulation...\",\n      \"sim.analyzing\": \"Analyzing {{patients}} patients over {{hours}} hours\",\n      \"sim.efficiency\": \"Efficiency\",\n      \"sim.harmony\": \"Harmony\",\n      \"sim.avgWaitTime\": \"Average Wait Time\",\n      \"sim.patientCapacity\": \"Patient Capacity\",\n      \"sim.layoutScore\": \"Layout Score\",\n      \"sim.staffHarmony\": \"Staff Harmony\",\n      \"sim.aiInsights\": \"AI Insights\",\n      \"sim.readyToSimulate\": \"Ready to Simulate\",\n      \"sim.configureParams\": \"Configure parameters and click \\\"Run Simulation\\\"\",\n      \"sim.addRoomsHint\": \"Add rooms in Layout Editor for better results\",\n      \"sim.operatingHours\": \"Operating Hours\",\n      \"sim.typical\": \"Typical: 30-80 patients/day\",\n      \"sim.standard\": \"Standard: 8-10 hours/day\",\n      \"sim.runSimulation\": \"Run Simulation\",\n      \"sim.testingEfficiency\": \"Testing practice efficiency with {{patients}} patients over {{hours}} operating hours.\",\n      \"sim.currentPracticeScore\": \"Current Practice Score\",\n      \"sim.industryTarget\": \"Industry target: <15 min\",\n      \"sim.simulated\": \"Simulated: {{count}} patients\",\n      \"sim.highWaitTimes\": \"High Wait Times\",\n      \"sim.highWaitTimesDesc\": \"{{time}} min wait exceeds 30 min threshold. Consider adding exam rooms or staff.\",\n      \"sim.waitAboveTarget\": \"Wait Time Above Target\",\n      \"sim.waitAboveTargetDesc\": \"{{time}} min wait. Industry target is <15 min for excellent experience.\",\n      \"sim.layoutEfficiencyIssue\": \"Layout Efficiency Issue\",\n      \"sim.layoutEfficiencyIssueDesc\": \"Room placement needs optimization. Move exam rooms closer to waiting area.\",\n      \"sim.staffBalanceAlert\": \"Staff Balance Alert\",\n      \"sim.staffBalanceAlertDesc\": \"Staffing ratios may be suboptimal. Check support staff to provider ratio.\",\n      \"sim.nearCapacity\": \"Near Capacity\",\n      \"sim.nearCapacityDesc\": \"Operating at >90% capacity. Consider expanding or adjusting schedules.\",\n      \"sim.underutilized\": \"Underutilized Capacity\",\n      \"sim.underutilizedDesc\": \"Only {{percent}}% capacity used. Room for growth or cost optimization.\",\n      \"sim.aiRecommendation\": \"AI Recommendation\",\n\n      \"rooms.reception\": \"Reception\",\n      \"rooms.waiting\": \"Waiting Room\",\n      \"rooms.exam\": \"Exam Room\",\n      \"rooms.xray\": \"X-Ray Room\",\n      \"rooms.lab\": \"Laboratory\",\n      \"rooms.office\": \"Doctor Office\",\n      \"rooms.sterilization\": \"Sterilization\",\n      \"rooms.storage\": \"Storage\",\n      \"rooms.toilet\": \"Toilet\",\n      \"rooms.kitchen\": \"Kitchen\",\n      \"rooms.changing\": \"Changing Room\",\n      \"rooms.room\": \"Room\",\n      \"rooms.rooms\": \"Rooms\",\n\n      \"editor.properties\": \"Properties\",\n      \"editor.roomName\": \"Room Name\",\n      \"editor.width\": \"Width\",\n      \"editor.height\": \"Height\",\n      \"editor.area\": \"Area\",\n      \"editor.floor\": \"Floor\",\n      \"editor.floorEG\": \"Ground Floor\",\n      \"editor.floorOG\": \"Upper Floor\",\n      \"editor.floorUG\": \"Basement\",\n      \"editor.delete\": \"Delete Room\",\n      \"editor.rotate\": \"Rotate\",\n      \"editor.noSelection\": \"Select a room to edit\",\n      \"editor.selected\": \"Selected\",\n\n      \"ai.practiceOverview\": \"Practice Overview\",\n      \"ai.layoutAnalysis\": \"Layout Analysis\",\n      \"ai.staffingInsights\": \"Staffing Insights\",\n      \"ai.simulationAnalysis\": \"Simulation Analysis\",\n      \"ai.aiInsights\": \"AI Insights\",\n      \"ai.poweredByAI\": \"Powered by AI\",\n      \"ai.score\": \"Score\",\n      \"ai.layoutEfficiency\": \"Layout Efficiency\",\n      \"ai.staffingOptimization\": \"Staffing Optimization\",\n      \"ai.spaceUtilization\": \"Space Utilization\",\n      \"ai.dailyCapacity\": \"Daily Capacity\",\n      \"ai.priorityActions\": \"Priority Actions\",\n      \"ai.quickActions\": \"Quick Actions\",\n      \"ai.analyzingPractice\": \"Analyzing your practice...\",\n      \"ai.unableToLoad\": \"Unable to load analysis\",\n      \"ai.tryAgain\": \"Try again\",\n      \"ai.askAI\": \"Ask AI\",\n      \"ai.howCanIImprove\": \"How can I improve?\",\n      \"ai.dashboardTip\": \"Your dashboard shows key metrics. Check the scores below to identify areas for improvement.\",\n      \"ai.layoutTip\": \"I'm watching your layout changes. Position rooms strategically for optimal patient flow.\",\n      \"ai.staffTip\": \"Staff balance is key. I'll help you optimize schedules and assignments.\",\n      \"ai.simulationTip\": \"Run simulations to test different scenarios. I'll analyze the results.\",\n      \"ai.defaultTip\": \"I'm here to help optimize your practice.\",\n\n      \"common.dashboard\": \"Dashboard\",\n      \"common.layout\": \"Layout\",\n      \"common.staff\": \"Staff\",\n      \"common.simulate\": \"Simulate\",\n      \"common.min\": \"min\",\n      \"common.perDay\": \"/day\",\n      \n      \"roles.generalPractitioner\": \"General Practitioner\",\n      \"roles.specialist\": \"Specialist\",\n      \"roles.nurse\": \"Nurse\",\n      \"roles.receptionist\": \"Receptionist\",\n      \"roles.dentist\": \"Dentist\",\n      \"roles.assistant\": \"Medical Assistant\",\n      \n      \"staff.experience\": \"Experience\",\n      \"staff.noStaff\": \"No staff members yet\",\n      \n      \"traits.empathetic\": \"Empathetic\",\n      \"traits.fast\": \"Fast\",\n      \"traits.detailOriented\": \"Detail-oriented\",\n      \"traits.multitasker\": \"Multitasker\",\n      \"traits.friendly\": \"Friendly\",\n      \"traits.organized\": \"Organized\",\n      \n      \"benchmarks.supportStaffRatio\": \"Support Staff Ratio\",\n      \"benchmarks.supportStaffDesc\": \"Optimal ratio is 2.0 support staff per provider (MGMA benchmarks). Add providers and support staff to calculate your actual ratio.\",\n      \"benchmarks.nurseToDoctor\": \"Nurse to Doctor Ratio\",\n      \"benchmarks.nurseToDoctorDesc\": \"Optimal ratio is 1.5 nurses per doctor (American Nurses Association). Add doctors and nurses to calculate your actual ratio.\",\n      \"benchmarks.examRoomsPerProvider\": \"Exam Rooms per Provider\",\n      \"benchmarks.examRoomsPerProviderDesc\": \"Optimal ratio is 2-3 exam rooms per provider (ADA standards). Add exam rooms and providers to calculate your actual ratio.\",\n      \n      \"images.simulationView\": \"Simulation View\"\n    }\n  },\n  de: {\n    translation: {\n      \"app.title\": \"PraxisFlow AI\",\n      \"nav.dashboard\": \"Dashboard\",\n      \"nav.layout\": \"Praxis-Layout\",\n      \"nav.staff\": \"Personal\",\n      \"nav.simulation\": \"Simulation\",\n      \"nav.settings\": \"Einstellungen\",\n      \n      \"dashboard.title\": \"Praxis-Übersicht\",\n      \"dashboard.subtitle\": \"Aktueller Simulationsstatus und Leistungskennzahlen.\",\n      \"dashboard.runSim\": \"Neue Simulation starten\",\n      \"dashboard.liveView\": \"Live-Grundriss\",\n      \"dashboard.liveViewDesc\": \"Echtzeit-Simulationsvorschau.\",\n      \"dashboard.analyzing\": \"Praxis wird analysiert...\",\n      \"dashboard.healthScore\": \"Gesundheits-Score\",\n      \"dashboard.excellent\": \"Ausgezeichnet\",\n      \"dashboard.good\": \"Gut\",\n      \"dashboard.needsWork\": \"Optimierbar\",\n      \"dashboard.aiPracticeHealth\": \"KI-Praxis-Check\",\n      \"dashboard.poweredByAI\": \"Unterstützt durch erweiterte Analytik\",\n      \"dashboard.estDailyCapacity\": \"Gesch. Tageskapazität\",\n      \"dashboard.layoutEfficiency\": \"Layout-Effizienz\",\n      \"dashboard.staffOptimization\": \"Personal-Optimierung\",\n      \"dashboard.spaceUtilization\": \"Raumnutzung\",\n      \"dashboard.priorityActions\": \"Prioritäre Maßnahmen\",\n      \"dashboard.aiRecommendedImprovements\": \"KI-Empfehlungen\",\n      \"dashboard.openLayoutEditor\": \"Layout-Editor öffnen\",\n      \"dashboard.aiInsights\": \"KI-Erkenntnisse\",\n      \n      \"stats.efficiency\": \"Effizienz-Index\",\n      \"stats.harmony\": \"Harmonie-Score\",\n      \"stats.waitTime\": \"Ø Wartezeit\",\n      \"stats.capacity\": \"Patientenkapazität\",\n      \"stats.efficiencyDesc\": \"+2,5% seit letzter Simulation\",\n      \"stats.harmonyDesc\": \"Personalstress niedrig\",\n      \"stats.waitTimeDesc\": \"-3 Min Optimierung\",\n      \"stats.capacityDesc\": \"85% Ressourcenauslastung\",\n      \n      \"chart.title\": \"Tägliche Leistungskennzahlen\",\n      \"chart.efficiency\": \"Effizienz-Index\",\n      \"chart.harmony\": \"Harmonie-Score\",\n\n      \"layout.title\": \"Praxis-Layout Editor\",\n      \"layout.subtitle\": \"Drag & Drop zur Optimierung des Patientenflusses.\",\n      \"layout.reset\": \"Zurücksetzen\",\n      \"layout.save\": \"Layout speichern\",\n      \"layout.roomTypes\": \"Raumtypen\",\n      \"layout.tipTitle\": \"Optimierungs-Tipp\",\n      \"layout.tipText\": \"Die Platzierung des Wartezimmers in der Nähe der Behandlungsräume erhöht den Effizienzwert durch kürzere Wege.\",\n      \n      \"staff.title\": \"Personalmanagement\",\n      \"staff.subtitle\": \"Überwachung der Stresslevel und Rollenzuweisung zur Harmonieoptimierung.\",\n      \"staff.add\": \"Mitarbeiter hinzufügen\",\n      \"staff.efficiency\": \"Effizienz\",\n      \"staff.stress\": \"Stresslevel\",\n      \"staff.aiRecommendations\": \"KI-Personalempfehlungen\",\n      \"staff.optimalRatios\": \"Optimale Personalverhältnisse basierend auf Ihrem Praxis-Layout\",\n      \"staff.staffingOptimization\": \"Optimierung\",\n      \"staff.industryBenchmarks\": \"Branchenrichtwerte\",\n      \"staff.addRoomsHint\": \"Fügen Sie Räume zu Ihrem Layout und Mitarbeiter hinzu, um personalisierte Empfehlungen zu erhalten\",\n      \"staff.addStaffHint\": \"Fügen Sie Mitarbeiter mit Rollen (Arzt, Krankenschwester, Empfang) hinzu, um Ihre Personalverhältnisse zu berechnen\",\n      \"staff.currentTeam\": \"Aktuelles Team\",\n      \"staff.manageStaff\": \"Verwalten Sie Ihre Praxismitarbeiter\",\n      \"staff.current\": \"Aktuell\",\n      \"staff.optimal\": \"Optimal\",\n      \"staff.match\": \"Treffer\",\n      \"staff.optimizationNeeded\": \"Personal-Optimierung erforderlich\",\n      \"staff.optimizationNeededDesc\": \"Ihre aktuellen Personalstände liegen unter dem Optimum für Ihr Praxis-Layout. Berücksichtigen Sie die obigen Empfehlungen zur Verbesserung des Patientenflusses.\",\n      \"staff.excellentBalance\": \"Ausgezeichnete Personalbalance\",\n      \"staff.excellentBalanceDesc\": \"Ihre Personalstände sind für Ihr aktuelles Praxis-Layout gut optimiert. Beobachten Sie weiterhin das Wachstum Ihrer Praxis.\",\n      \n      \"sim.title\": \"Szenario-Simulation\",\n      \"sim.subtitle\": \"Komplexe Szenarien testen für Effizienz und Harmonie unter Druck.\",\n      \"sim.engineReady\": \"Simulations-Engine Bereit\",\n      \"sim.params\": \"Simulations-Parameter\",\n      \"sim.paramsDesc\": \"Variablen in Echtzeit anpassen\",\n      \"sim.patientVolume\": \"Patientenaufkommen\",\n      \"sim.speed\": \"Simulationsgeschwindigkeit\",\n      \"sim.randomEvents\": \"Zufallsereignisse\",\n      \"sim.randomEventsDesc\": \"Inklusive Personalausfall, Notfälle und Geräteausfall.\",\n      \"sim.activeScenario\": \"Aktives Szenario\",\n      \"sim.scenarioName\": \"Grippewelle\",\n      \"sim.scenarioDesc\": \"Hoher Patientenzustrom mit Atemwegssymptomen. Stressakkumulation beim Personal um 20% erhöht.\",\n      \"sim.results\": \"Simulationsergebnisse\",\n      \"sim.resultsDesc\": \"Führen Sie eine Simulation durch, um zu sehen, wie Ihre Praxis bei verschiedenen Patientenzahlen abschneidet\",\n      \"sim.running\": \"Simulation läuft...\",\n      \"sim.analyzing\": \"Analysiere {{patients}} Patienten über {{hours}} Stunden\",\n      \"sim.efficiency\": \"Effizienz\",\n      \"sim.harmony\": \"Harmonie\",\n      \"sim.avgWaitTime\": \"Durchschn. Wartezeit\",\n      \"sim.patientCapacity\": \"Patientenkapazität\",\n      \"sim.layoutScore\": \"Layout-Score\",\n      \"sim.staffHarmony\": \"Personal-Harmonie\",\n      \"sim.aiInsights\": \"KI-Erkenntnisse\",\n      \"sim.readyToSimulate\": \"Bereit zur Simulation\",\n      \"sim.configureParams\": \"Parameter konfigurieren und \\\"Simulation starten\\\" klicken\",\n      \"sim.addRoomsHint\": \"Fügen Sie Räume im Layout-Editor hinzu für bessere Ergebnisse\",\n      \"sim.operatingHours\": \"Betriebsstunden\",\n      \"sim.typical\": \"Typisch: 30-80 Patienten/Tag\",\n      \"sim.standard\": \"Standard: 8-10 Stunden/Tag\",\n      \"sim.runSimulation\": \"Simulation starten\",\n      \"sim.testingEfficiency\": \"Teste Praxiseffizienz mit {{patients}} Patienten über {{hours}} Betriebsstunden.\",\n      \"sim.currentPracticeScore\": \"Aktueller Praxis-Score\",\n      \"sim.industryTarget\": \"Branchenziel: <15 Min\",\n      \"sim.simulated\": \"Simuliert: {{count}} Patienten\",\n      \"sim.highWaitTimes\": \"Hohe Wartezeiten\",\n      \"sim.highWaitTimesDesc\": \"{{time}} Min Wartezeit überschreitet 30 Min Grenzwert. Erwägen Sie mehr Behandlungsräume oder Personal.\",\n      \"sim.waitAboveTarget\": \"Wartezeit über Zielwert\",\n      \"sim.waitAboveTargetDesc\": \"{{time}} Min Wartezeit. Branchenziel ist <15 Min für beste Patientenerfahrung.\",\n      \"sim.layoutEfficiencyIssue\": \"Layout-Effizienz-Problem\",\n      \"sim.layoutEfficiencyIssueDesc\": \"Raumanordnung muss optimiert werden. Behandlungsräume näher zum Wartebereich verschieben.\",\n      \"sim.staffBalanceAlert\": \"Personal-Balance-Warnung\",\n      \"sim.staffBalanceAlertDesc\": \"Personalverhältnisse können suboptimal sein. Prüfen Sie das Verhältnis von Hilfspersonal zu Ärzten.\",\n      \"sim.nearCapacity\": \"Nahe Kapazitätsgrenze\",\n      \"sim.nearCapacityDesc\": \"Betrieb bei >90% Kapazität. Erwägen Sie Erweiterung oder Zeitplananpassungen.\",\n      \"sim.underutilized\": \"Ungenutzte Kapazität\",\n      \"sim.underutilizedDesc\": \"Nur {{percent}}% Kapazität genutzt. Raum für Wachstum oder Kostenoptimierung.\",\n      \"sim.aiRecommendation\": \"KI-Empfehlung\",\n\n      \"rooms.reception\": \"Empfang\",\n      \"rooms.waiting\": \"Wartezimmer\",\n      \"rooms.exam\": \"Behandlung\",\n      \"rooms.xray\": \"Röntgen\",\n      \"rooms.lab\": \"Labor\",\n      \"rooms.office\": \"Arztzimmer\",\n      \"rooms.sterilization\": \"Sterilisation\",\n      \"rooms.storage\": \"Lagerraum\",\n      \"rooms.toilet\": \"Toilette\",\n      \"rooms.kitchen\": \"Küche\",\n      \"rooms.changing\": \"Umkleide\",\n      \"rooms.room\": \"Raum\",\n      \"rooms.rooms\": \"Räume\",\n\n      \"editor.properties\": \"Eigenschaften\",\n      \"editor.roomName\": \"Raumbezeichnung\",\n      \"editor.width\": \"Breite\",\n      \"editor.height\": \"Höhe\",\n      \"editor.area\": \"Fläche\",\n      \"editor.floor\": \"Etage\",\n      \"editor.floorEG\": \"Erdgeschoss\",\n      \"editor.floorOG\": \"Obergeschoss\",\n      \"editor.floorUG\": \"Untergeschoss\",\n      \"editor.delete\": \"Raum löschen\",\n      \"editor.rotate\": \"Drehen\",\n      \"editor.noSelection\": \"Raum auswählen zum Bearbeiten\",\n      \"editor.selected\": \"Ausgewählt\",\n\n      \"ai.practiceOverview\": \"Praxis-Übersicht\",\n      \"ai.layoutAnalysis\": \"Layout-Analyse\",\n      \"ai.staffingInsights\": \"Personal-Erkenntnisse\",\n      \"ai.simulationAnalysis\": \"Simulations-Analyse\",\n      \"ai.aiInsights\": \"KI-Erkenntnisse\",\n      \"ai.poweredByAI\": \"Unterstützt durch KI\",\n      \"ai.score\": \"Score\",\n      \"ai.layoutEfficiency\": \"Layout-Effizienz\",\n      \"ai.staffingOptimization\": \"Personal-Optimierung\",\n      \"ai.spaceUtilization\": \"Raumnutzung\",\n      \"ai.dailyCapacity\": \"Tageskapazität\",\n      \"ai.priorityActions\": \"Prioritäre Maßnahmen\",\n      \"ai.quickActions\": \"Schnellaktionen\",\n      \"ai.analyzingPractice\": \"Analysiere Ihre Praxis...\",\n      \"ai.unableToLoad\": \"Analyse konnte nicht geladen werden\",\n      \"ai.tryAgain\": \"Erneut versuchen\",\n      \"ai.askAI\": \"KI fragen\",\n      \"ai.howCanIImprove\": \"Wie kann ich verbessern?\",\n      \"ai.dashboardTip\": \"Ihr Dashboard zeigt wichtige Kennzahlen. Prüfen Sie die Scores unten, um Verbesserungspotenziale zu identifizieren.\",\n      \"ai.layoutTip\": \"Ich beobachte Ihre Layout-Änderungen. Positionieren Sie Räume strategisch für optimalen Patientenfluss.\",\n      \"ai.staffTip\": \"Personal-Balance ist entscheidend. Ich helfe Ihnen bei der Optimierung von Zeitplänen und Zuweisungen.\",\n      \"ai.simulationTip\": \"Führen Sie Simulationen durch, um verschiedene Szenarien zu testen. Ich analysiere die Ergebnisse.\",\n      \"ai.defaultTip\": \"Ich bin hier, um Ihre Praxis zu optimieren.\",\n\n      \"common.dashboard\": \"Dashboard\",\n      \"common.layout\": \"Layout\",\n      \"common.staff\": \"Personal\",\n      \"common.simulate\": \"Simulieren\",\n      \"common.min\": \"Min\",\n      \"common.perDay\": \"/Tag\",\n      \n      \"roles.generalPractitioner\": \"Allgemeinmediziner/in\",\n      \"roles.specialist\": \"Facharzt/Fachärztin\",\n      \"roles.nurse\": \"Pflegefachkraft\",\n      \"roles.receptionist\": \"Empfangskraft\",\n      \"roles.dentist\": \"Zahnarzt/Zahnärztin\",\n      \"roles.assistant\": \"Medizinische/r Fachangestellte/r\",\n      \n      \"staff.experience\": \"Erfahrung\",\n      \"staff.noStaff\": \"Noch keine Mitarbeiter\",\n      \n      \"traits.empathetic\": \"Einfühlsam\",\n      \"traits.fast\": \"Schnell\",\n      \"traits.detailOriented\": \"Detailgenau\",\n      \"traits.multitasker\": \"Multitasking-Talent\",\n      \"traits.friendly\": \"Freundlich\",\n      \"traits.organized\": \"Gut organisiert\",\n      \n      \"benchmarks.supportStaffRatio\": \"Personal-Verhältnis\",\n      \"benchmarks.supportStaffDesc\": \"Optimales Verhältnis ist 2,0 Hilfspersonal pro Arzt (MGMA-Richtwerte). Fügen Sie Ärzte und Hilfspersonal hinzu, um Ihr aktuelles Verhältnis zu berechnen.\",\n      \"benchmarks.nurseToDoctor\": \"Pflege-Arzt-Verhältnis\",\n      \"benchmarks.nurseToDoctorDesc\": \"Optimales Verhältnis ist 1,5 Krankenschwestern pro Arzt (American Nurses Association). Fügen Sie Ärzte und Krankenschwestern hinzu, um Ihr aktuelles Verhältnis zu berechnen.\",\n      \"benchmarks.examRoomsPerProvider\": \"Zimmer pro Arzt\",\n      \"benchmarks.examRoomsPerProviderDesc\": \"Optimales Verhältnis ist 2-3 Behandlungsräume pro Arzt (ADA-Standards). Fügen Sie Behandlungsräume und Ärzte hinzu, um Ihr aktuelles Verhältnis zu berechnen.\",\n      \n      \"images.simulationView\": \"Simulationsansicht\"\n    }\n  }\n};\n\ni18n\n  .use(initReactI18next)\n  .init({\n    resources,\n    lng: \"de\", // Standardsprache: Deutsch\n    fallbackLng: \"en\",\n    interpolation: {\n      escapeValue: false // react already safes from xss\n    }\n  });\n\nexport default i18n;\n","path":null,"size_bytes":22241,"size_tokens":null},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","path":null,"size_bytes":565,"size_tokens":null},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":768,"size_tokens":null},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","path":null,"size_bytes":1383,"size_tokens":null},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\nimport \"./lib/i18n\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","path":null,"size_bytes":178,"size_tokens":null},"client/src/pages/Staff.tsx":{"content":"import { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Plus, Star, Users, TrendingUp, AlertTriangle, CheckCircle, Lightbulb } from \"lucide-react\";\nimport { useTranslation } from \"react-i18next\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { api, type LayoutAnalysis } from \"@/lib/api\";\nimport { usePractice } from \"@/contexts/PracticeContext\";\nimport { motion } from \"framer-motion\";\nimport { cn } from \"@/lib/utils\";\nimport type { Staff as StaffType } from \"@shared/schema\";\n\nfunction StaffingScoreRing({ score, size = 80 }: { score: number; size?: number }) {\n  const safeScore = typeof score === 'number' && !isNaN(score) ? Math.max(0, Math.min(100, score)) : 0;\n  const strokeWidth = 6;\n  const radius = (size - strokeWidth) / 2;\n  const circumference = radius * 2 * Math.PI;\n  const offset = circumference - (safeScore / 100) * circumference;\n  \n  const getColor = (s: number) => {\n    if (s >= 80) return { stroke: \"#22c55e\", text: \"text-green-600\" };\n    if (s >= 60) return { stroke: \"#eab308\", text: \"text-yellow-600\" };\n    return { stroke: \"#ef4444\", text: \"text-red-600\" };\n  };\n  \n  const colors = getColor(safeScore);\n  \n  return (\n    <div className=\"relative flex items-center justify-center\" style={{ width: size, height: size }}>\n      <svg width={size} height={size} className=\"absolute -rotate-90\">\n        <circle\n          cx={size / 2}\n          cy={size / 2}\n          r={radius}\n          fill=\"none\"\n          stroke=\"currentColor\"\n          strokeWidth={strokeWidth}\n          className=\"text-muted/20\"\n        />\n        <motion.circle\n          cx={size / 2}\n          cy={size / 2}\n          r={radius}\n          fill=\"none\"\n          stroke={colors.stroke}\n          strokeWidth={strokeWidth}\n          strokeLinecap=\"round\"\n          initial={{ strokeDasharray: circumference, strokeDashoffset: circumference }}\n          animate={{ strokeDashoffset: offset }}\n          transition={{ duration: 1, ease: \"easeOut\" }}\n        />\n      </svg>\n      <div className={cn(\"text-xl font-bold\", colors.text)}>{safeScore}</div>\n    </div>\n  );\n}\n\nfunction RatioCard({ \n  role, \n  actual, \n  optimal, \n  score, \n  recommendation,\n  t \n}: { \n  role: string; \n  actual: number; \n  optimal: number; \n  score: number; \n  recommendation: string;\n  t: (key: string) => string;\n}) {\n  const isOptimal = score >= 80;\n  const needsAttention = score < 60;\n  \n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 10 }}\n      animate={{ opacity: 1, y: 0 }}\n      className={cn(\n        \"p-4 rounded-xl border transition-all\",\n        isOptimal ? \"bg-green-50/50 border-green-200\" :\n        needsAttention ? \"bg-red-50/50 border-red-200\" :\n        \"bg-yellow-50/50 border-yellow-200\"\n      )}\n      data-testid={`ratio-card-${role.toLowerCase().replace(/\\s+/g, '-')}`}\n    >\n      <div className=\"flex items-center justify-between gap-2 mb-3\">\n        <div className=\"flex items-center gap-2 min-w-0\">\n          {isOptimal ? (\n            <CheckCircle className=\"h-4 w-4 text-green-600 shrink-0\" />\n          ) : needsAttention ? (\n            <AlertTriangle className=\"h-4 w-4 text-red-600 shrink-0\" />\n          ) : (\n            <Lightbulb className=\"h-4 w-4 text-yellow-600 shrink-0\" />\n          )}\n          <span className=\"font-semibold text-xs capitalize truncate\">{role}</span>\n        </div>\n        <Badge \n          variant=\"secondary\" \n          className={cn(\n            \"text-[9px] px-1.5 py-0.5 shrink-0 text-center leading-tight\",\n            isOptimal ? \"bg-green-100 text-green-700\" :\n            needsAttention ? \"bg-red-100 text-red-700\" :\n            \"bg-yellow-100 text-yellow-700\"\n          )}\n        >\n          <span className=\"block font-bold\">{score}%</span>\n          <span className=\"block font-normal\">{t(\"staff.match\")}</span>\n        </Badge>\n      </div>\n      \n      <div className=\"grid grid-cols-2 gap-4 mb-3\">\n        <div className=\"text-center p-2 rounded-lg bg-white/60\">\n          <div className=\"text-lg font-bold text-foreground\">{actual}</div>\n          <div className=\"text-[10px] uppercase tracking-wider text-muted-foreground\">{t(\"staff.current\")}</div>\n        </div>\n        <div className=\"text-center p-2 rounded-lg bg-white/60\">\n          <div className=\"text-lg font-bold text-primary\">{optimal}</div>\n          <div className=\"text-[10px] uppercase tracking-wider text-muted-foreground\">{t(\"staff.optimal\")}</div>\n        </div>\n      </div>\n      \n      <p className=\"text-xs text-muted-foreground leading-relaxed\">{recommendation}</p>\n    </motion.div>\n  );\n}\n\nfunction StaffingInsightsSkeleton({ t }: { t: (key: string) => string }) {\n  return (\n    <Card className=\"bg-gradient-to-br from-blue-50 to-indigo-50 border-blue-100\">\n      <CardHeader>\n        <div className=\"flex items-center gap-2\">\n          <Skeleton className=\"h-5 w-5 rounded\" />\n          <Skeleton className=\"h-6 w-48\" />\n        </div>\n        <Skeleton className=\"h-4 w-64\" />\n      </CardHeader>\n      <CardContent>\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {[1, 2, 3].map((i) => (\n            <div key={i} className=\"p-4 rounded-xl border bg-white/50\">\n              <Skeleton className=\"h-5 w-32 mb-3\" />\n              <div className=\"grid grid-cols-2 gap-4 mb-3\">\n                <Skeleton className=\"h-16 rounded-lg\" />\n                <Skeleton className=\"h-16 rounded-lg\" />\n              </div>\n              <Skeleton className=\"h-4 w-full\" />\n            </div>\n          ))}\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction StaffingInsightsSection({ analysis, t }: { analysis: LayoutAnalysis | null; t: (key: string) => string }) {\n  const staffingAnalysis = analysis?.staffingAnalysis || { overallScore: 0, ratios: {} };\n  const staffingScore = analysis?.staffingScore ?? 50;\n  const ratioEntries = Object.entries(staffingAnalysis.ratios || {});\n  const hasRooms = (analysis?.roomAnalyses?.length ?? 0) > 0;\n  const hasRatioData = ratioEntries.length > 0;\n  \n  const BENCHMARK_RATIOS = [\n    {\n      role: t(\"benchmarks.supportStaffRatio\"),\n      actual: 0,\n      optimal: 2.0,\n      score: 0,\n      recommendation: t(\"benchmarks.supportStaffDesc\")\n    },\n    {\n      role: t(\"benchmarks.nurseToDoctor\"),\n      actual: 0,\n      optimal: 1.5,\n      score: 0,\n      recommendation: t(\"benchmarks.nurseToDoctorDesc\")\n    },\n    {\n      role: t(\"benchmarks.examRoomsPerProvider\"),\n      actual: 0,\n      optimal: 2.5,\n      score: 0,\n      recommendation: t(\"benchmarks.examRoomsPerProviderDesc\")\n    }\n  ];\n  \n  const displayRatios = hasRatioData \n    ? ratioEntries.map(([role, data]) => ({ role, ...data }))\n    : BENCHMARK_RATIOS;\n  \n  return (\n    <Card className=\"bg-gradient-to-br from-blue-50 to-indigo-50 border-blue-100 overflow-hidden\" data-testid=\"staffing-insights-card\">\n      <CardHeader className=\"border-b border-blue-100/50 bg-gradient-to-r from-blue-600 to-indigo-600 text-white\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"p-2 rounded-lg bg-white/20\">\n              <Users className=\"h-5 w-5\" />\n            </div>\n            <div>\n              <CardTitle className=\"text-lg\">{t(\"staff.aiRecommendations\")}</CardTitle>\n              <CardDescription className=\"text-blue-100\">\n                {t(\"staff.optimalRatios\")}\n              </CardDescription>\n            </div>\n          </div>\n          <div className=\"flex items-center gap-3 bg-white/10 rounded-xl p-3\">\n            <StaffingScoreRing score={staffingScore} size={60} />\n            <div className=\"text-right\">\n              <div className=\"text-xs text-blue-100\">{t(\"staff.staffingOptimization\")}</div>\n            </div>\n          </div>\n        </div>\n      </CardHeader>\n      <CardContent className=\"p-6\">\n        {!hasRatioData && (\n          <motion.div\n            initial={{ opacity: 0, y: -10 }}\n            animate={{ opacity: 1, y: 0 }}\n            className=\"mb-4 p-3 rounded-xl bg-blue-50/80 border border-blue-200 flex items-start gap-3\"\n          >\n            <Lightbulb className=\"h-5 w-5 text-blue-500 shrink-0 mt-0.5\" />\n            <div>\n              <p className=\"text-sm font-medium text-blue-800 mb-1\">{t(\"staff.industryBenchmarks\")}</p>\n              <p className=\"text-xs text-blue-700\">\n                {!hasRooms \n                  ? t(\"staff.addRoomsHint\")\n                  : t(\"staff.addStaffHint\")\n                }\n              </p>\n            </div>\n          </motion.div>\n        )}\n        \n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {displayRatios.map((data) => (\n            <RatioCard\n              key={data.role}\n              role={data.role}\n              actual={data.actual}\n              optimal={data.optimal}\n              score={data.score}\n              recommendation={data.recommendation}\n              t={t}\n            />\n          ))}\n        </div>\n        \n        {hasRatioData && staffingScore < 70 && (\n          <motion.div\n            initial={{ opacity: 0, y: 10 }}\n            animate={{ opacity: 1, y: 0 }}\n            className=\"mt-6 p-4 rounded-xl bg-amber-50 border border-amber-200 flex items-start gap-3\"\n            data-testid=\"staffing-alert\"\n          >\n            <AlertTriangle className=\"h-5 w-5 text-amber-600 shrink-0 mt-0.5\" />\n            <div>\n              <p className=\"text-sm font-medium text-amber-800 mb-1\">{t(\"staff.optimizationNeeded\")}</p>\n              <p className=\"text-xs text-amber-700\">\n                {t(\"staff.optimizationNeededDesc\")}\n              </p>\n            </div>\n          </motion.div>\n        )}\n        \n        {hasRatioData && staffingScore >= 80 && (\n          <motion.div\n            initial={{ opacity: 0, y: 10 }}\n            animate={{ opacity: 1, y: 0 }}\n            className=\"mt-6 p-4 rounded-xl bg-green-50 border border-green-200 flex items-start gap-3\"\n            data-testid=\"staffing-success\"\n          >\n            <CheckCircle className=\"h-5 w-5 text-green-600 shrink-0 mt-0.5\" />\n            <div>\n              <p className=\"text-sm font-medium text-green-800 mb-1\">{t(\"staff.excellentBalance\")}</p>\n              <p className=\"text-xs text-green-700\">\n                {t(\"staff.excellentBalanceDesc\")}\n              </p>\n            </div>\n          </motion.div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction ExperienceStars({ level }: { level: number }) {\n  return (\n    <div className=\"flex gap-0.5\">\n      {[1, 2, 3, 4, 5].map((star) => (\n        <Star\n          key={star}\n          className={cn(\n            \"h-4 w-4\",\n            star <= level ? \"fill-amber-400 text-amber-400\" : \"text-muted-foreground/30\"\n          )}\n        />\n      ))}\n    </div>\n  );\n}\n\nfunction getInitials(name: string): string {\n  return name.split(\" \").map(n => n[0]).join(\"\").toUpperCase().slice(0, 2);\n}\n\nfunction getRoleLabel(role: string, t: (key: string) => string): string {\n  const roleMap: Record<string, string> = {\n    doctor: t(\"roles.generalPractitioner\"),\n    dentist: t(\"roles.dentist\"),\n    nurse: t(\"roles.nurse\"),\n    receptionist: t(\"roles.receptionist\"),\n    assistant: t(\"roles.assistant\"),\n  };\n  return roleMap[role] || role;\n}\n\nfunction StaffCard({ member, t }: { member: StaffType; t: (key: string) => string }) {\n  return (\n    <Card \n      className=\"overflow-hidden hover:shadow-lg transition-all duration-300 border-t-4 border-t-transparent hover:border-t-primary\"\n      data-testid={`staff-card-${member.id}`}\n    >\n      <CardHeader className=\"flex flex-row items-center gap-4 pb-2\">\n        <Avatar className=\"h-12 w-12 border-2 border-background shadow-sm\">\n          <AvatarFallback className=\"bg-primary/10 text-primary font-bold\">\n            {member.avatar || getInitials(member.name)}\n          </AvatarFallback>\n        </Avatar>\n        <div className=\"flex-1\">\n          <CardTitle className=\"text-lg\">{member.name}</CardTitle>\n          <CardDescription>{getRoleLabel(member.role, t)}</CardDescription>\n        </div>\n      </CardHeader>\n      <CardContent>\n        <div className=\"flex flex-wrap gap-2 mb-4\">\n          {member.specializations.map(spec => (\n            <Badge key={spec} variant=\"secondary\" className=\"bg-blue-50 text-blue-700 hover:bg-blue-100 border-none font-normal\">\n              {spec}\n            </Badge>\n          ))}\n        </div>\n\n        <div className=\"flex items-center justify-between\">\n          <span className=\"text-sm text-muted-foreground\">{t(\"staff.experience\")}</span>\n          <ExperienceStars level={member.experienceLevel} />\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction EmptyStaffState({ t }: { t: (key: string) => string }) {\n  return (\n    <div className=\"col-span-full flex flex-col items-center justify-center py-12 text-center\">\n      <Users className=\"h-12 w-12 text-muted-foreground/30 mb-4\" />\n      <h3 className=\"text-lg font-medium text-muted-foreground mb-2\">{t(\"staff.noStaff\")}</h3>\n      <p className=\"text-sm text-muted-foreground/70 max-w-md\">\n        {t(\"staff.addStaffHint\")}\n      </p>\n    </div>\n  );\n}\n\nexport default function Staff() {\n  const { t } = useTranslation();\n  const { practiceId, practice } = usePractice();\n\n  const { data: analysis, isLoading } = useQuery({\n    queryKey: [\"ai-analysis\", practiceId],\n    queryFn: () => api.ai.analyzeLayout({ practiceId: practiceId!, operatingHours: 8 }),\n    enabled: !!practiceId,\n    staleTime: 30000,\n  });\n\n  const staffMembers = practice?.staff || [];\n\n  return (\n    <div className=\"flex-1 overflow-y-auto p-4 md:p-8\">\n      <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6 md:mb-8\">\n        <div>\n          <h2 className=\"text-2xl md:text-3xl font-bold tracking-tight text-primary\" data-testid=\"text-staff-title\">{t(\"staff.title\")}</h2>\n          <p className=\"text-sm md:text-base text-muted-foreground\">{t(\"staff.subtitle\")}</p>\n        </div>\n        <Button className=\"bg-primary hover:bg-primary/90 w-full sm:w-auto\" data-testid=\"button-add-staff\">\n          <Plus className=\"mr-2 h-4 w-4\" /> {t(\"staff.add\")}\n        </Button>\n      </div>\n\n      <div className=\"mb-8\">\n        {isLoading ? (\n          <StaffingInsightsSkeleton t={t} />\n        ) : (\n          <StaffingInsightsSection analysis={analysis ?? null} t={t} />\n        )}\n      </div>\n\n      <div className=\"mb-6\">\n        <h3 className=\"text-xl font-semibold text-foreground flex items-center gap-2\">\n          <TrendingUp className=\"h-5 w-5 text-primary\" />\n          {t(\"staff.currentTeam\")}\n        </h3>\n        <p className=\"text-sm text-muted-foreground\">{t(\"staff.manageStaff\")}</p>\n      </div>\n\n      <div className=\"grid gap-6 md:grid-cols-2 xl:grid-cols-3\">\n        {staffMembers.length > 0 ? (\n          staffMembers.map((member) => (\n            <StaffCard key={member.id} member={member} t={t} />\n          ))\n        ) : (\n          <EmptyStaffState t={t} />\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":15252,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","path":null,"size_bytes":1642,"size_tokens":null},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","path":null,"size_bytes":329,"size_tokens":null},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-9 w-full items-center justify-between whitespace-nowrap rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"px-2 py-1.5 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-2 pr-8 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute right-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","path":null,"size_bytes":5745,"size_tokens":null},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","path":null,"size_bytes":325,"size_tokens":null},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverAnchor = PopoverPrimitive.Anchor\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent, PopoverAnchor }\n","path":null,"size_bytes":1342,"size_tokens":null},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","path":null,"size_bytes":2712,"size_tokens":null},"client/src/components/ui/empty.tsx":{"content":"import { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction Empty({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"empty\"\n      className={cn(\n        \"flex min-w-0 flex-1 flex-col items-center justify-center gap-6 text-balance rounded-lg border-dashed p-6 text-center md:p-12\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction EmptyHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"empty-header\"\n      className={cn(\n        \"flex max-w-sm flex-col items-center gap-2 text-center\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nconst emptyMediaVariants = cva(\n  \"mb-2 flex shrink-0 items-center justify-center [&_svg]:pointer-events-none [&_svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        icon: \"bg-muted text-foreground flex size-10 shrink-0 items-center justify-center rounded-lg [&_svg:not([class*='size-'])]:size-6\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nfunction EmptyMedia({\n  className,\n  variant = \"default\",\n  ...props\n}: React.ComponentProps<\"div\"> & VariantProps<typeof emptyMediaVariants>) {\n  return (\n    <div\n      data-slot=\"empty-icon\"\n      data-variant={variant}\n      className={cn(emptyMediaVariants({ variant, className }))}\n      {...props}\n    />\n  )\n}\n\nfunction EmptyTitle({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"empty-title\"\n      className={cn(\"text-lg font-medium tracking-tight\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction EmptyDescription({ className, ...props }: React.ComponentProps<\"p\">) {\n  return (\n    <div\n      data-slot=\"empty-description\"\n      className={cn(\n        \"text-muted-foreground [&>a:hover]:text-primary text-sm/relaxed [&>a]:underline [&>a]:underline-offset-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction EmptyContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"empty-content\"\n      className={cn(\n        \"flex w-full min-w-0 max-w-sm flex-col items-center gap-4 text-balance text-sm\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Empty,\n  EmptyHeader,\n  EmptyTitle,\n  EmptyDescription,\n  EmptyContent,\n  EmptyMedia,\n}\n","path":null,"size_bytes":2396,"size_tokens":null},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=closed]:duration-300 data-[state=open]:duration-500 data-[state=open]:animate-in data-[state=closed]:animate-out\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4 border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n      {children}\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","path":null,"size_bytes":4280,"size_tokens":null},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport tailwindcss from \"@tailwindcss/vite\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\nimport { metaImagesPlugin } from \"./vite-plugin-meta-images\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    tailwindcss(),\n    metaImagesPlugin(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  css: {\n    postcss: {\n      plugins: [],\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    host: \"0.0.0.0\",\n    allowedHosts: true,\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","path":null,"size_bytes":1330,"size_tokens":null},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","path":null,"size_bytes":772,"size_tokens":null},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","path":null,"size_bytes":4845,"size_tokens":null},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Minus } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-9 w-9 items-center justify-center border-y border-r border-input text-sm shadow-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-1 ring-ring\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Minus />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","path":null,"size_bytes":2143,"size_tokens":null},"client/src/components/ui/sonner.tsx":{"content":"\"use client\"\n\nimport { useTheme } from \"next-themes\"\nimport { Toaster as Sonner } from \"sonner\"\n\ntype ToasterProps = React.ComponentProps<typeof Sonner>\n\nconst Toaster = ({ ...props }: ToasterProps) => {\n  const { theme = \"system\" } = useTheme()\n\n  return (\n    <Sonner\n      theme={theme as ToasterProps[\"theme\"]}\n      className=\"toaster group\"\n      toastOptions={{\n        classNames: {\n          toast:\n            \"group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg\",\n          description: \"group-[.toast]:text-muted-foreground\",\n          actionButton:\n            \"group-[.toast]:bg-primary group-[.toast]:text-primary-foreground\",\n          cancelButton:\n            \"group-[.toast]:bg-muted group-[.toast]:text-muted-foreground\",\n        },\n      }}\n      {...props}\n    />\n  )\n}\n\nexport { Toaster }\n","path":null,"size_bytes":894,"size_tokens":null},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-9 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-300 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","path":null,"size_bytes":5124,"size_tokens":null},"client/src/components/ui/chart.tsx":{"content":"import * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload\n            .filter((item) => item.type !== \"none\")\n            .map((item, index) => {\n              const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n              const itemConfig = getPayloadConfigFromPayload(config, item, key)\n              const indicatorColor = color || item.payload.fill || item.color\n\n              return (\n                <div\n                  key={item.dataKey}\n                  className={cn(\n                    \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                    indicator === \"dot\" && \"items-center\"\n                  )}\n                >\n                  {formatter && item?.value !== undefined && item.name ? (\n                    formatter(item.value, item.name, item, index, item.payload)\n                  ) : (\n                    <>\n                      {itemConfig?.icon ? (\n                        <itemConfig.icon />\n                      ) : (\n                        !hideIndicator && (\n                          <div\n                            className={cn(\n                              \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                              {\n                                \"h-2.5 w-2.5\": indicator === \"dot\",\n                                \"w-1\": indicator === \"line\",\n                                \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                  indicator === \"dashed\",\n                                \"my-0.5\": nestLabel && indicator === \"dashed\",\n                              }\n                            )}\n                            style={\n                              {\n                                \"--color-bg\": indicatorColor,\n                                \"--color-border\": indicatorColor,\n                              } as React.CSSProperties\n                            }\n                          />\n                        )\n                      )}\n                      <div\n                        className={cn(\n                          \"flex flex-1 justify-between leading-none\",\n                          nestLabel ? \"items-end\" : \"items-center\"\n                        )}\n                      >\n                        <div className=\"grid gap-1.5\">\n                          {nestLabel ? tooltipLabel : null}\n                          <span className=\"text-muted-foreground\">\n                            {itemConfig?.label || item.name}\n                          </span>\n                        </div>\n                        {item.value && (\n                          <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                            {item.value.toLocaleString()}\n                          </span>\n                        )}\n                      </div>\n                    </>\n                  )}\n                </div>\n              )\n            })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload\n          .filter((item) => item.type !== \"none\")\n          .map((item) => {\n            const key = `${nameKey || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n            return (\n              <div\n                key={item.value}\n                className={cn(\n                  \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n                )}\n              >\n                {itemConfig?.icon && !hideIcon ? (\n                  <itemConfig.icon />\n                ) : (\n                  <div\n                    className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                    style={{\n                      backgroundColor: item.color,\n                    }}\n                  />\n                )}\n                {itemConfig?.label}\n              </div>\n            )\n          })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","path":null,"size_bytes":10763,"size_tokens":null},"client/src/components/ui/label.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":724,"size_tokens":null},"client/src/components/ui/item.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Separator } from \"@/components/ui/separator\"\n\nfunction ItemGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      role=\"list\"\n      data-slot=\"item-group\"\n      className={cn(\"group/item-group flex flex-col\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction ItemSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"item-separator\"\n      orientation=\"horizontal\"\n      className={cn(\"my-0\", className)}\n      {...props}\n    />\n  )\n}\n\nconst itemVariants = cva(\n  \"group/item [a]:hover:bg-accent/50 focus-visible:border-ring focus-visible:ring-ring/50 [a]:transition-colors flex flex-wrap items-center rounded-md border border-transparent text-sm outline-none transition-colors duration-100 focus-visible:ring-[3px]\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline: \"border-border\",\n        muted: \"bg-muted/50\",\n      },\n      size: {\n        default: \"gap-4 p-4 \",\n        sm: \"gap-2.5 px-4 py-3\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction Item({\n  className,\n  variant = \"default\",\n  size = \"default\",\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> &\n  VariantProps<typeof itemVariants> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n  return (\n    <Comp\n      data-slot=\"item\"\n      data-variant={variant}\n      data-size={size}\n      className={cn(itemVariants({ variant, size, className }))}\n      {...props}\n    />\n  )\n}\n\nconst itemMediaVariants = cva(\n  \"flex shrink-0 items-center justify-center gap-2 group-has-[[data-slot=item-description]]/item:translate-y-0.5 group-has-[[data-slot=item-description]]/item:self-start [&_svg]:pointer-events-none\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        icon: \"bg-muted size-8 rounded-sm border [&_svg:not([class*='size-'])]:size-4\",\n        image:\n          \"size-10 overflow-hidden rounded-sm [&_img]:size-full [&_img]:object-cover\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nfunction ItemMedia({\n  className,\n  variant = \"default\",\n  ...props\n}: React.ComponentProps<\"div\"> & VariantProps<typeof itemMediaVariants>) {\n  return (\n    <div\n      data-slot=\"item-media\"\n      data-variant={variant}\n      className={cn(itemMediaVariants({ variant, className }))}\n      {...props}\n    />\n  )\n}\n\nfunction ItemContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"item-content\"\n      className={cn(\n        \"flex flex-1 flex-col gap-1 [&+[data-slot=item-content]]:flex-none\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction ItemTitle({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"item-title\"\n      className={cn(\n        \"flex w-fit items-center gap-2 text-sm font-medium leading-snug\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction ItemDescription({ className, ...props }: React.ComponentProps<\"p\">) {\n  return (\n    <p\n      data-slot=\"item-description\"\n      className={cn(\n        \"text-muted-foreground line-clamp-2 text-balance text-sm font-normal leading-normal\",\n        \"[&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction ItemActions({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"item-actions\"\n      className={cn(\"flex items-center gap-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction ItemHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"item-header\"\n      className={cn(\n        \"flex basis-full items-center justify-between gap-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction ItemFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"item-footer\"\n      className={cn(\n        \"flex basis-full items-center justify-between gap-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Item,\n  ItemMedia,\n  ItemContent,\n  ItemActions,\n  ItemGroup,\n  ItemSeparator,\n  ItemTitle,\n  ItemDescription,\n  ItemHeader,\n  ItemFooter,\n}\n","path":null,"size_bytes":4494,"size_tokens":null},"server/routes.ts":{"content":"import type { Express } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { storage } from \"./storage\";\nimport {\n  insertPracticeSchema,\n  insertRoomSchema,\n  insertStaffSchema,\n  insertSimulationSchema,\n  insertWorkflowSchema,\n  insertWorkflowConnectionSchema,\n  insertWorkflowStepSchema,\n} from \"@shared/schema\";\nimport { runSimulation, calculateLayoutEfficiencyBreakdown, type SimulationParameters } from \"./simulation\";\nimport { computeLayoutEfficiency, computeWorkflowMetrics } from \"./ai/layoutEfficiency\";\nimport { analyzeLayout, getQuickRecommendation, computeWorkflowAnalysis } from \"./ai/advisor\";\nimport { DEFAULT_LAYOUT_SCALE_PX_PER_METER } from \"@shared/roomTypes\";\nimport { searchKnowledge } from \"./ai/knowledgeProcessor\";\nimport { generateCoachResponse } from \"./ai/coachChat\";\nimport { queryRAG, retrieveKnowledgeChunks } from \"./ai/ragQuery\";\nimport {\n  getKnowledgePoweredRoomSizes,\n  getKnowledgePoweredStaffing,\n  getKnowledgePoweredScheduling,\n  getHealthScoreDrivers,\n} from \"./ai/artifactBenchmarks\";\nimport { getArtifacts } from \"./ai/artifactService\";\nimport { z } from \"zod\";\nimport {\n  authRouter,\n  requireAuth,\n  requirePracticeAccess,\n  requireRoomAccess,\n  requireStaffAccess,\n  requireWorkflowAccess,\n  requireConnectionAccess,\n  requireStepAccess,\n} from \"./auth\";\n\n// ... deine existierenden Imports (Express, http, storage, schema, etc.) ...\n// NEU: Imports für den Consultant Bot\nimport { OpenAI } from \"openai\";\nimport { tavily } from \"@tavily/core\";\nimport { DENTAL_BENCHMARKS } from \"./benchmark\"; // Wichtig: Singular \"./benchmark\", wie in deinem Screenshot\n\n// NEU: Clients initialisieren\n// Stelle sicher, dass diese Keys in den Replit Secrets (.env) sind!\nconst openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });\nconst tvly = tavily({ apiKey: process.env.TAVILY_API_KEY || \"tvly-DUMMY\" }); // Fallback verhindert Crash beim Start\n\nexport async function registerRoutes(\n  httpServer: Server,\n  app: Express,\n): Promise<Server> {\n  app.use(\"/api/auth\", authRouter);\n\n  app.use(\"/api\", (req, res, next) => {\n    if (req.path.startsWith(\"/auth\")) return next();\n    if (req.path === \"/debug/status\") return next();\n    return requireAuth(req, res, next);\n  });\n\n  app.get(\"/api/debug/status\", async (req, res) => {\n    const isDebugEnabled = process.env.DEBUG_STATUS === \"true\" || process.env.NODE_ENV !== \"production\";\n    if (!isDebugEnabled) {\n      return res.status(403).json({ error: \"Debug endpoint disabled in production\" });\n    }\n    try {\n      const stats = await storage.getDebugStats();\n      res.json({\n        ...stats,\n        timestamp: new Date().toISOString(),\n        environment: process.env.NODE_ENV || \"development\",\n      });\n    } catch (error) {\n      console.error(\"Debug stats error:\", error);\n      res.status(500).json({ error: \"Failed to fetch debug stats\" });\n    }\n  });\n\n  app.get(\"/api/practices/:id\", requirePracticeAccess, async (req, res) => {\n    try {\n      const practice = await storage.getPractice(req.params.id);\n      if (!practice) {\n        return res.status(404).json({ error: \"Practice not found\" });\n      }\n\n      const rooms = await storage.getRoomsByPracticeId(req.params.id);\n      const staff = await storage.getStaffByPracticeId(req.params.id);\n\n      res.json({ practice, rooms, staff });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch practice\" });\n    }\n  });\n\n  app.post(\"/api/practices\", async (req, res) => {\n    try {\n      const validated = insertPracticeSchema.parse(req.body);\n      const practice = await storage.createPractice({\n        ...validated,\n        ownerId: req.session.userId,\n      });\n      res.json(practice);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid practice data\" });\n    }\n  });\n\n  app.put(\"/api/practices/:id/budget\", requirePracticeAccess, async (req, res) => {\n    try {\n      const { budget } = req.body;\n      if (typeof budget !== \"number\") {\n        return res.status(400).json({ error: \"Budget must be a number\" });\n      }\n\n      const practice = await storage.updatePracticeBudget(\n        req.params.id,\n        budget,\n      );\n      if (!practice) {\n        return res.status(404).json({ error: \"Practice not found\" });\n      }\n\n      res.json(practice);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update budget\" });\n    }\n  });\n\n  app.get(\"/api/practices/:id/layout-efficiency\", requirePracticeAccess, async (req, res) => {\n    try {\n      const rooms = await storage.getRoomsByPracticeId(req.params.id);\n      const breakdown = await calculateLayoutEfficiencyBreakdown(rooms);\n      res.json(breakdown);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to calculate layout efficiency\" });\n    }\n  });\n\n  app.post(\"/api/layout/efficiency\", requirePracticeAccess, async (req, res) => {\n    try {\n      const { practiceId } = req.body;\n      if (!practiceId || typeof practiceId !== \"string\") {\n        return res.status(400).json({ error: \"practiceId is required\" });\n      }\n      const rooms = await storage.getRoomsByPracticeId(practiceId);\n      const result = computeLayoutEfficiency(rooms);\n      \n      const connections = await storage.getConnectionsByPracticeId(practiceId);\n      const workflowAnalysis = computeWorkflowAnalysis(rooms, connections);\n      let workflowMetrics = null;\n      let workflowTips: string[] = [];\n      \n      if (connections.length > 0) {\n        workflowMetrics = computeWorkflowMetrics(rooms, connections);\n        \n        if (workflowMetrics) {\n          for (const conn of workflowMetrics.longestConnections) {\n            if (conn.distanceMeters > 5 && workflowTips.length < 3) {\n              workflowTips.push(\n                `Diese Verbindung ist besonders lang: ${conn.fromName} → ${conn.toName} (${conn.distanceMeters}m) – Räume näher platzieren.`\n              );\n            }\n          }\n          \n          if (workflowMetrics.crossingConnections.length > 0 && workflowTips.length < 3) {\n            const crossing = workflowMetrics.crossingConnections[0];\n            workflowTips.push(\n              `Diese Verbindung kreuzt andere Flows (potenzielle Kollisionen): ${crossing.conn1} × ${crossing.conn2}`\n            );\n          }\n          \n          if (workflowMetrics.coreRoomDistanceIssue && workflowTips.length < 3) {\n            workflowTips.push(\n              `Empfang/Wartebereich/Behandlung sind zu weit auseinander (${workflowMetrics.coreRoomDistanceMeters}m gesamt, optimal <8m).`\n            );\n          }\n        }\n      }\n      \n      let finalScore = result.score;\n      if (workflowMetrics) {\n        const workflowWeight = 0.15;\n        const workflowScore = 100 - workflowMetrics.motionWasteScore;\n        finalScore = Math.round(result.score * (1 - workflowWeight) + workflowScore * workflowWeight);\n      }\n      \n      res.json({\n        ...result,\n        score: finalScore,\n        tips: [...result.tips, ...workflowTips].slice(0, 6),\n        workflowMetrics: workflowMetrics || undefined,\n        workflowAnalysis,\n      });\n    } catch (error) {\n      console.error(\"Layout efficiency error:\", error);\n      res.status(500).json({ error: \"Failed to compute layout efficiency\" });\n    }\n  });\n\n  app.get(\"/api/practices/:id/rooms\", requirePracticeAccess, async (req, res) => {\n    try {\n      const rooms = await storage.getRoomsByPracticeId(req.params.id);\n      res.json(rooms);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch rooms\" });\n    }\n  });\n\n  app.post(\"/api/practices/:id/rooms\", requirePracticeAccess, async (req, res) => {\n    try {\n      const validated = insertRoomSchema.parse({\n        ...req.body,\n        practiceId: req.params.id,\n      });\n      const room = await storage.createRoom(validated);\n      res.json(room);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid room data\" });\n    }\n  });\n\n  app.put(\"/api/rooms/:id\", requireRoomAccess, async (req, res) => {\n    try {\n      const room = await storage.updateRoom(req.params.id, req.body);\n      if (!room) {\n        return res.status(404).json({ error: \"Room not found\" });\n      }\n      res.json(room);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update room\" });\n    }\n  });\n\n  app.delete(\"/api/rooms/:id\", requireRoomAccess, async (req, res) => {\n    try {\n      await storage.deleteRoom(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete room\" });\n    }\n  });\n\n  app.get(\"/api/practices/:id/staff\", requirePracticeAccess, async (req, res) => {\n    try {\n      const staff = await storage.getStaffByPracticeId(req.params.id);\n      res.json(staff);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch staff\" });\n    }\n  });\n\n  app.post(\"/api/practices/:id/staff\", requirePracticeAccess, async (req, res) => {\n    try {\n      const validated = insertStaffSchema.parse({\n        ...req.body,\n        practiceId: req.params.id,\n      });\n      const staffMember = await storage.createStaff(validated);\n      res.json(staffMember);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid staff data\" });\n    }\n  });\n\n  app.put(\"/api/staff/:id\", requireStaffAccess, async (req, res) => {\n    try {\n      const staffMember = await storage.updateStaff(req.params.id, req.body);\n      if (!staffMember) {\n        return res.status(404).json({ error: \"Staff member not found\" });\n      }\n      res.json(staffMember);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update staff\" });\n    }\n  });\n\n  app.delete(\"/api/staff/:id\", requireStaffAccess, async (req, res) => {\n    try {\n      await storage.deleteStaff(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete staff\" });\n    }\n  });\n\n  app.post(\"/api/simulations\", requirePracticeAccess, async (req, res) => {\n    try {\n      const validated = insertSimulationSchema.parse(req.body);\n      const simulation = await storage.createSimulation(validated);\n      res.json(simulation);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid simulation data\" });\n    }\n  });\n\n  app.get(\"/api/practices/:id/simulations\", requirePracticeAccess, async (req, res) => {\n    try {\n      const simulations = await storage.getSimulationsByPracticeId(\n        req.params.id,\n      );\n      res.json(simulations);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch simulations\" });\n    }\n  });\n\n  const runSimulationSchema = z.object({\n    practiceId: z.string(),\n    patientVolume: z.number().min(1).max(1000),\n    operatingHours: z.number().min(1).max(24),\n  });\n\n  app.post(\"/api/simulations/run\", requirePracticeAccess, async (req, res) => {\n    try {\n      const { practiceId, patientVolume, operatingHours } =\n        runSimulationSchema.parse(req.body);\n\n      const practice = await storage.getPractice(practiceId);\n      if (!practice) {\n        return res.status(404).json({ error: \"Practice not found\" });\n      }\n\n      const rooms = await storage.getRoomsByPracticeId(practiceId);\n      const staff = await storage.getStaffByPracticeId(practiceId);\n\n      const parameters: SimulationParameters = {\n        patientVolume,\n        operatingHours,\n        layoutScalePxPerMeter: practice.layoutScalePxPerMeter ?? DEFAULT_LAYOUT_SCALE_PX_PER_METER,\n      };\n      const result = await runSimulation(rooms, staff, parameters);\n\n      const simulation = await storage.createSimulation({\n        practiceId,\n        efficiencyScore: result.efficiencyScore,\n        harmonyScore: result.harmonyScore,\n        waitTime: result.waitTime,\n        patientCapacity: result.patientCapacity,\n        parameters: result.parameters,\n      });\n\n      res.json(simulation);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid simulation parameters\" });\n      }\n      res.status(500).json({ error: \"Failed to run simulation\" });\n    }\n  });\n\n  const analyzeLayoutSchema = z.object({\n    practiceId: z.string(),\n    operatingHours: z.number().min(1).max(24).optional().default(8),\n  });\n\n  app.post(\"/api/ai/analyze-layout\", requirePracticeAccess, async (req, res) => {\n    try {\n      const { practiceId, operatingHours } = analyzeLayoutSchema.parse(\n        req.body,\n      );\n\n      const practice = await storage.getPractice(practiceId);\n      if (!practice) {\n        return res.status(404).json({ error: \"Practice not found\" });\n      }\n\n      const rooms = await storage.getRoomsByPracticeId(practiceId);\n      const staff = await storage.getStaffByPracticeId(practiceId);\n      const connections = await storage.getConnectionsByPracticeId(practiceId);\n\n      const analysis = await analyzeLayout(rooms, staff, operatingHours, practice.layoutScalePxPerMeter ?? DEFAULT_LAYOUT_SCALE_PX_PER_METER, connections);\n      res.json(analysis);\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid request parameters\" });\n      }\n      console.error(\"AI analysis error:\", error);\n      res.status(500).json({ error: \"Failed to analyze layout\" });\n    }\n  });\n\n  const recommendSchema = z.object({\n    practiceId: z.string(),\n    question: z.string().optional(),\n  });\n\n  app.post(\"/api/ai/recommend\", requirePracticeAccess, async (req, res) => {\n    try {\n      const { practiceId, question } = recommendSchema.parse(req.body);\n\n      const practice = await storage.getPractice(practiceId);\n      if (!practice) {\n        return res.status(404).json({ error: \"Practice not found\" });\n      }\n\n      const rooms = await storage.getRoomsByPracticeId(practiceId);\n      const staff = await storage.getStaffByPracticeId(practiceId);\n\n      const recommendation = await getQuickRecommendation(\n        rooms,\n        staff,\n        question,\n        practice.layoutScalePxPerMeter ?? DEFAULT_LAYOUT_SCALE_PX_PER_METER,\n      );\n      res.json({ recommendation });\n    } catch (error) {\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid request parameters\" });\n      }\n      console.error(\"AI recommendation error:\", error);\n      res.status(500).json({ error: \"Failed to get recommendation\" });\n    }\n  });\n\n  app.get(\"/api/knowledge\", async (req, res) => {\n    try {\n      const sources = await storage.getAllKnowledgeSources();\n      res.json(sources);\n    } catch (error) {\n      console.error(\"Failed to fetch knowledge sources:\", error);\n      res.status(500).json({ error: \"Failed to fetch knowledge sources\" });\n    }\n  });\n\n  app.get(\"/api/knowledge/:id\", async (req, res) => {\n    try {\n      const source = await storage.getKnowledgeSource(req.params.id);\n      if (!source) {\n        return res.status(404).json({ error: \"Knowledge source not found\" });\n      }\n      const chunks = await storage.getChunksBySourceId(req.params.id);\n      res.json({ source, chunks });\n    } catch (error) {\n      console.error(\"Failed to fetch knowledge source:\", error);\n      res.status(500).json({ error: \"Failed to fetch knowledge source\" });\n    }\n  });\n\n  const searchKnowledgeSchema = z.object({\n    query: z.string().min(1),\n    limit: z.number().min(1).max(20).optional().default(5),\n  });\n\n  app.post(\"/api/knowledge/search\", async (req, res) => {\n    try {\n      const { query, limit } = searchKnowledgeSchema.parse(req.body);\n      const results = await searchKnowledge(query, limit);\n      res.json(results);\n    } catch (error) {\n      console.error(\"Failed to search knowledge:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid search parameters\" });\n      }\n      res.status(500).json({ error: \"Failed to search knowledge\" });\n    }\n  });\n\n  const coachChatSchema = z.object({\n    question: z.string().min(1),\n  });\n\n  app.post(\"/api/ai/coach-chat\", async (req, res) => {\n    try {\n      const { question } = coachChatSchema.parse(req.body);\n      const response = await queryRAG(question, 5);\n      res.json({\n        answer: response.answer,\n        sources: response.kbChunks.map((c) => ({\n          title: c.docName.replace(/\\.docx$/i, \"\").replace(/[_-]/g, \" \"),\n          category: c.headingPath || \"Allgemein\",\n        })),\n        webResults: response.webResults,\n        kbCoverage: response.kbCoverage,\n      });\n    } catch (error) {\n      console.error(\"Coach chat error:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid request\" });\n      }\n      res.status(500).json({ error: \"Failed to generate response\" });\n    }\n  });\n\n  const ragQuerySchema = z.object({\n    question: z.string().min(1),\n    topK: z.number().min(1).max(20).optional().default(5),\n  });\n\n  app.post(\"/api/v1/rag/query\", async (req, res) => {\n    try {\n      const { question, topK } = ragQuerySchema.parse(req.body);\n      const response = await queryRAG(question, topK);\n      res.json({\n        answer: response.answer,\n        kbCitations: response.kbChunks.map((c) => ({\n          chunkId: c.id,\n          docName: c.docName.replace(/\\.docx$/i, \"\"),\n          headingPath: c.headingPath || \"Allgemein\",\n          score: c.score,\n        })),\n        webCitations: response.webResults?.map((w) => ({\n          title: w.title,\n          publisher: w.publisher || \"web\",\n          date: w.date || new Date().toISOString().split(\"T\")[0],\n          url: w.url,\n        })),\n        kbCoverage: response.kbCoverage,\n      });\n    } catch (error) {\n      console.error(\"RAG query error:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid query parameters\" });\n      }\n      res.status(500).json({ error: \"Failed to process query\" });\n    }\n  });\n\n  app.get(\"/api/benchmarks\", async (req, res) => {\n    try {\n      const [roomSizes, staffing, scheduling, healthScore] = await Promise.all([\n        getKnowledgePoweredRoomSizes(),\n        getKnowledgePoweredStaffing(),\n        getKnowledgePoweredScheduling(),\n        getHealthScoreDrivers(),\n      ]);\n\n      res.json({\n        roomSizes,\n        staffing,\n        scheduling,\n        healthScoreWeights: healthScore.weights,\n        healthScoreFromKnowledge: healthScore.fromKnowledge,\n      });\n    } catch (error) {\n      console.error(\"Failed to fetch benchmarks:\", error);\n      res.status(500).json({ error: \"Failed to fetch benchmarks\" });\n    }\n  });\n\n  app.get(\"/api/playbooks\", async (req, res) => {\n    try {\n      const playbooks = await getArtifacts({ artifactType: \"playbook\" });\n      res.json(playbooks);\n    } catch (error) {\n      console.error(\"Error fetching playbooks:\", error);\n      res.status(500).json({ error: \"Failed to fetch playbooks\" });\n    }\n  });\n\n  app.get(\"/api/playbooks/:id\", async (req, res) => {\n    try {\n      const playbooks = await getArtifacts({ artifactType: \"playbook\" });\n      const playbook = playbooks.find(p => p.id === req.params.id);\n      if (!playbook) {\n        return res.status(404).json({ error: \"Playbook not found\" });\n      }\n      res.json(playbook);\n    } catch (error) {\n      console.error(\"Error fetching playbook:\", error);\n      res.status(500).json({ error: \"Failed to fetch playbook\" });\n    }\n  });\n\n  // ---------------------------------------------------------\n  // NEU: Der \"Smart Consultant\" mit Benchmarks & Web-Suche\n  // ---------------------------------------------------------\n  app.post(\"/api/ai/chat\", async (req, res) => {\n    try {\n      const { message } = req.body;\n\n      // 1. System Prompt mit den harten Fakten (Benchmarks) anreichern\n      const benchmarkContext = JSON.stringify(DENTAL_BENCHMARKS, null, 2);\n\n      const systemPrompt = `\n      Du bist ein hochspezialisierter KI-Unternehmensberater für Zahnarztpraxen.\n\n      DEINE GRUNDLAGE (GROUND TRUTH):\n      Nutze für Berechnungen und Standards ZWINGEND diese Benchmarks. Rate nicht, wenn Daten hier stehen:\n      ${benchmarkContext}\n\n      INSTRUKTIONEN ZUR SUCHE:\n      - Nutze das 'web_search' Tool für aktuelle Trends (2024/2025), Gesetzesänderungen oder Marktanalysen.\n      - Nutze die Benchmarks für operative Fragen (Raumgrößen, Umsatz, Personal).\n      - Antworte professionell, präzise und immer auf Deutsch.\n      `;\n\n      // 2. Definition der Tools (Websuche)\n      const tools = [\n        {\n          type: \"function\",\n          function: {\n            name: \"web_search\",\n            description:\n              \"Sucht im Internet nach aktuellen Informationen, Nachrichten oder Fakten.\",\n            parameters: {\n              type: \"object\",\n              properties: {\n                query: { type: \"string\", description: \"Der Suchbegriff\" },\n              },\n              required: [\"query\"],\n            },\n          },\n        },\n      ];\n\n      // 3. Initialer Aufruf an GPT-4o\n      const messages = [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: message },\n      ];\n\n      const completion = await openai.chat.completions.create({\n        model: \"gpt-4o\",\n        messages: messages as any,\n        tools: tools as any,\n        tool_choice: \"auto\",\n      });\n\n      const responseMessage = completion.choices[0].message;\n\n      // 4. Prüfen: Will die KI ein Tool nutzen?\n      if (responseMessage.tool_calls) {\n        // KI will suchen -> Wir führen die Suche aus\n        const toolCall = responseMessage.tool_calls[0];\n\n        if (toolCall.function.name === \"web_search\") {\n          const args = JSON.parse(toolCall.function.arguments);\n          console.log(`🔎 KI sucht nach: ${args.query}`);\n\n          // Tavily Suche ausführen\n          let searchResult;\n          try {\n            searchResult = await tvly.search(args.query, {\n              searchDepth: \"basic\",\n            });\n          } catch (e) {\n            searchResult = { error: \"Suche fehlgeschlagen\" };\n          }\n\n          // Verlauf aktualisieren\n          messages.push(responseMessage as any); // Die Absicht der KI\n          messages.push({\n            role: \"tool\",\n            tool_call_id: toolCall.id,\n            content: JSON.stringify(searchResult), // Das Ergebnis der Suche\n          } as any);\n\n          // 5. Zweiter Aufruf: KI verarbeitet das Suchergebnis\n          const secondResponse = await openai.chat.completions.create({\n            model: \"gpt-4o\",\n            messages: messages as any,\n          });\n\n          return res.json({\n            response: secondResponse.choices[0].message.content,\n          });\n        }\n      }\n\n      // Fallback: Keine Suche nötig\n      res.json({ response: responseMessage.content });\n    } catch (error) {\n      console.error(\"Smart Consultant Error:\", error);\n      res.status(500).json({ error: \"Fehler im KI-Berater Modul\" });\n    }\n  });\n  // ---------------------------------------------------------\n\n  // Workflow endpoints\n  app.get(\"/api/practices/:id/workflows\", requirePracticeAccess, async (req, res) => {\n    try {\n      const workflows = await storage.getWorkflowsByPracticeId(req.params.id);\n      res.json(workflows);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch workflows\" });\n    }\n  });\n\n  app.post(\"/api/practices/:id/workflows\", requirePracticeAccess, async (req, res) => {\n    try {\n      const validated = insertWorkflowSchema.parse({\n        ...req.body,\n        practiceId: req.params.id,\n      });\n      const workflow = await storage.createWorkflow(validated);\n      res.json(workflow);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid workflow data\" });\n    }\n  });\n\n  app.put(\"/api/practices/:id/workflows\", requirePracticeAccess, async (req, res) => {\n    try {\n      const validated = insertWorkflowSchema.parse({\n        ...req.body,\n        practiceId: req.params.id,\n      });\n      const workflow = await storage.upsertWorkflow(validated);\n      res.json(workflow);\n    } catch (error) {\n      console.error(\"Failed to upsert workflow:\", error);\n      res.status(400).json({ error: \"Invalid workflow data\" });\n    }\n  });\n\n  app.delete(\"/api/workflows/:id\", requireWorkflowAccess, async (req, res) => {\n    try {\n      await storage.deleteWorkflow(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete workflow\" });\n    }\n  });\n\n  // Workflow Steps endpoints (workflow-specific ordered steps)\n  app.get(\"/api/workflows/:id/steps\", requireWorkflowAccess, async (req, res) => {\n    try {\n      const steps = await storage.getWorkflowSteps(req.params.id);\n      res.json(steps);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch workflow steps\" });\n    }\n  });\n\n  app.post(\"/api/workflows/:id/steps\", requireWorkflowAccess, async (req, res) => {\n    try {\n      const maxIndex = await storage.getMaxStepIndex(req.params.id);\n      const validated = insertWorkflowStepSchema.parse({\n        ...req.body,\n        workflowId: req.params.id,\n        stepIndex: maxIndex + 1,\n      });\n      const step = await storage.createWorkflowStep(validated);\n      res.json(step);\n    } catch (error) {\n      console.error(\"Failed to create workflow step:\", error);\n      res.status(400).json({ error: \"Invalid step data\" });\n    }\n  });\n\n  app.delete(\"/api/workflow-steps/:id\", requireStepAccess, async (req, res) => {\n    try {\n      await storage.deleteWorkflowStep(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete workflow step\" });\n    }\n  });\n\n  // Workflow connection endpoints (practice-based)\n\n  app.put(\"/api/workflow-connections/:id\", requireConnectionAccess, async (req, res) => {\n    try {\n      const connection = await storage.updateConnection(req.params.id, req.body);\n      if (!connection) {\n        return res.status(404).json({ error: \"Connection not found\" });\n      }\n      res.json(connection);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to update connection\" });\n    }\n  });\n\n  app.delete(\"/api/workflow-connections/:id\", requireConnectionAccess, async (req, res) => {\n    try {\n      await storage.deleteConnection(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete connection\" });\n    }\n  });\n\n  // Practice-level workflow connections (alle Connections einer Praxis)\n  app.get(\"/api/practices/:id/workflow-connections\", requirePracticeAccess, async (req, res) => {\n    try {\n      const connections = await storage.getConnectionsByPracticeId(req.params.id);\n      res.json(connections);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch workflow connections\" });\n    }\n  });\n\n  app.post(\"/api/practices/:id/workflow-connections\", requirePracticeAccess, async (req, res) => {\n    try {\n      const validated = insertWorkflowConnectionSchema.parse({\n        ...req.body,\n        practiceId: req.params.id,\n      });\n      const connection = await storage.createConnection(validated);\n      res.json(connection);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid connection data\" });\n    }\n  });\n\n  const analyzeWorkflowsSchema = z.object({\n    practiceId: z.string(),\n    includeRAG: z.boolean().optional().default(false),\n  });\n\n  app.post(\"/api/ai/analyze-workflows\", requirePracticeAccess, async (req, res) => {\n    try {\n      const { practiceId, includeRAG } = analyzeWorkflowsSchema.parse(req.body);\n      \n      const practice = await storage.getPractice(practiceId);\n      if (!practice) {\n        return res.status(404).json({ error: \"Practice not found\" });\n      }\n      \n      const rooms = await storage.getRoomsByPracticeId(practiceId);\n      const workflows = await storage.getWorkflowsByPracticeId(practiceId);\n      \n      const workflowStepsMap = new Map<string, any[]>();\n      for (const workflow of workflows) {\n        const steps = await storage.getWorkflowSteps(workflow.id);\n        workflowStepsMap.set(workflow.id, steps);\n      }\n      \n      const { analyzeWorkflows } = await import(\"./ai/workflowEfficiency\");\n      const analysis = await analyzeWorkflows(\n        practiceId,\n        rooms,\n        workflows,\n        workflowStepsMap,\n        practice.layoutScalePxPerMeter ?? DEFAULT_LAYOUT_SCALE_PX_PER_METER\n      );\n      \n      if (includeRAG && analysis.recommendations.length > 0) {\n        try {\n          const metricsContext = analysis.workflows.map(w => \n            `Workflow \"${w.workflowName}\": ${w.totalDistanceM}m Gesamtweg, Score ${w.score}/100, ${w.floorChangeCount} Etagenwechsel`\n          ).join(\". \");\n          \n          const ragQuestion = `Gib 3 konkrete Optimierungen für Praxisabläufe ohne Umbau. Kontext: ${metricsContext}. Fokus auf Prozessoptimierung, digitale Lösungen und Materialorganisation.`;\n          \n          const ragResult = await queryRAG(ragQuestion, 3);\n          \n          (analysis as any).knowledgeInsight = {\n            answer: ragResult.answer,\n            sources: ragResult.kbChunks.map(c => ({\n              docName: c.docName.replace(/\\.docx$/i, \"\"),\n              headingPath: c.headingPath || \"Allgemein\",\n            })),\n          };\n        } catch (ragError) {\n          console.error(\"RAG enhancement failed:\", ragError);\n        }\n      }\n      \n      res.json(analysis);\n    } catch (error) {\n      console.error(\"Workflow analysis error:\", error);\n      if (error instanceof z.ZodError) {\n        return res.status(400).json({ error: \"Invalid request parameters\" });\n      }\n      res.status(500).json({ error: \"Failed to analyze workflows\" });\n    }\n  });\n\n  return httpServer;\n}\n","path":null,"size_bytes":29701,"size_tokens":null},"client/src/components/ui/menubar.tsx":{"content":"import * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-9 items-center space-x-1 rounded-md border bg-background p-1 shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-4 w-4 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","path":null,"size_bytes":8608,"size_tokens":null},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border px-4 py-3 text-sm [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground [&>svg~*]:pl-7\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","path":null,"size_bytes":1598,"size_tokens":null},"client/src/components/layout/LanguageToggle.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { useTranslation } from \"react-i18next\";\n\nexport function LanguageToggle() {\n  const { i18n } = useTranslation();\n\n  const toggleLanguage = () => {\n    const newLang = i18n.language === \"en\" ? \"de\" : \"en\";\n    i18n.changeLanguage(newLang);\n  };\n\n  return (\n    <Button \n      variant=\"ghost\" \n      size=\"sm\" \n      onClick={toggleLanguage}\n      className=\"w-full justify-start font-normal\"\n    >\n      <span className=\"mr-2 text-lg\">\n        {i18n.language === \"en\" ? \"🇩🇪\" : \"🇺🇸\"}\n      </span>\n      {i18n.language === \"en\" ? \"Switch to German\" : \"Switch to English\"}\n    </Button>\n  );\n}\n","path":null,"size_bytes":660,"size_tokens":null},"client/src/components/dashboard/StatsCards.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { TrendingUp, Users, Clock, Heart } from \"lucide-react\";\nimport { useTranslation } from \"react-i18next\";\n\nexport function StatsCards() {\n  const { t } = useTranslation();\n  return (\n    <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n      <Card>\n        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n          <CardTitle className=\"text-sm font-medium\">{t(\"stats.efficiency\")}</CardTitle>\n          <TrendingUp className=\"h-4 w-4 text-primary\" />\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-2xl font-bold\">92%</div>\n          <p className=\"text-xs text-muted-foreground\">{t(\"stats.efficiencyDesc\")}</p>\n        </CardContent>\n      </Card>\n      <Card>\n        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n          <CardTitle className=\"text-sm font-medium\">{t(\"stats.harmony\")}</CardTitle>\n          <Heart className=\"h-4 w-4 text-secondary\" />\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-2xl font-bold\">88/100</div>\n          <p className=\"text-xs text-muted-foreground\">{t(\"stats.harmonyDesc\")}</p>\n        </CardContent>\n      </Card>\n      <Card>\n        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n          <CardTitle className=\"text-sm font-medium\">{t(\"stats.waitTime\")}</CardTitle>\n          <Clock className=\"h-4 w-4 text-warning\" />\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-2xl font-bold\">12 min</div>\n          <p className=\"text-xs text-muted-foreground\">{t(\"stats.waitTimeDesc\")}</p>\n        </CardContent>\n      </Card>\n      <Card>\n        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n          <CardTitle className=\"text-sm font-medium\">{t(\"stats.capacity\")}</CardTitle>\n          <Users className=\"h-4 w-4 text-muted-foreground\" />\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-2xl font-bold\">45/day</div>\n          <p className=\"text-xs text-muted-foreground\">{t(\"stats.capacityDesc\")}</p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":2242,"size_tokens":null},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":711,"size_tokens":null},"client/src/index.css":{"content":"@import \"tailwindcss\";\n@import \"tw-animate-css\";\n\n@custom-variant dark (&:is(.dark *));\n\n@theme inline {\n  --radius-sm: calc(var(--radius) - 4px);\n  --radius-md: calc(var(--radius) - 2px);\n  --radius-lg: var(--radius);\n  --radius-xl: calc(var(--radius) + 4px);\n  \n  /* Medical Theme Colors */\n  --color-background: hsl(var(--background));\n  --color-foreground: hsl(var(--foreground));\n  \n  --color-primary: hsl(var(--primary));\n  --color-primary-foreground: hsl(var(--primary-foreground));\n  \n  --color-secondary: hsl(var(--secondary));\n  --color-secondary-foreground: hsl(var(--secondary-foreground));\n  \n  --color-muted: hsl(var(--muted));\n  --color-muted-foreground: hsl(var(--muted-foreground));\n  \n  --color-accent: hsl(var(--accent));\n  --color-accent-foreground: hsl(var(--accent-foreground));\n  \n  --color-destructive: hsl(var(--destructive));\n  --color-destructive-foreground: hsl(var(--destructive-foreground));\n  \n  --color-success: hsl(var(--success));\n  --color-warning: hsl(var(--warning));\n\n  --color-border: hsl(var(--border));\n  --color-input: hsl(var(--input));\n  --color-ring: hsl(var(--ring));\n  \n  --color-card: hsl(var(--card));\n  --color-card-foreground: hsl(var(--card-foreground));\n  \n  --color-popover: hsl(var(--popover));\n  --color-popover-foreground: hsl(var(--popover-foreground));\n  \n  --color-sidebar: hsl(var(--sidebar));\n  --color-sidebar-foreground: hsl(var(--sidebar-foreground));\n  --color-sidebar-primary: hsl(var(--sidebar-primary));\n  --color-sidebar-primary-foreground: hsl(var(--sidebar-primary-foreground));\n  --color-sidebar-accent: hsl(var(--sidebar-accent));\n  --color-sidebar-accent-foreground: hsl(var(--sidebar-accent-foreground));\n  --color-sidebar-border: hsl(var(--sidebar-border));\n  --color-sidebar-ring: hsl(var(--sidebar-ring));\n\n  --font-sans: 'Inter', 'Roboto', sans-serif;\n  --radius: 0.5rem;\n}\n\n/* LIGHT MODE - Professional Medical Theme */\n:root {\n  /* Colors provided:\n     Primary #2E7D32 -> 123 46% 34%\n     Secondary #1976D2 -> 210 79% 46%\n     Background #F5F7FA -> 210 20% 97%\n     Text #263238 -> 200 19% 18%\n     Success #4CAF50 -> 122 39% 49%\n     Warning #FF9800 -> 36 100% 50%\n  */\n\n  --background: 210 20% 97%; /* #F5F7FA */\n  --foreground: 200 19% 18%; /* #263238 */\n\n  --card: 0 0% 100%;\n  --card-foreground: 200 19% 18%;\n\n  --popover: 0 0% 100%;\n  --popover-foreground: 200 19% 18%;\n\n  --primary: 123 46% 34%; /* #2E7D32 */\n  --primary-foreground: 0 0% 100%;\n\n  --secondary: 210 79% 46%; /* #1976D2 */\n  --secondary-foreground: 0 0% 100%;\n\n  --muted: 210 20% 90%;\n  --muted-foreground: 200 10% 40%;\n\n  --accent: 210 30% 94%;\n  --accent-foreground: 200 19% 18%;\n\n  --destructive: 0 84% 60%;\n  --destructive-foreground: 0 0% 98%;\n\n  --success: 122 39% 49%;\n  --warning: 36 100% 50%;\n\n  --border: 214 32% 91%;\n  --input: 214 32% 91%;\n  --ring: 123 46% 34%;\n\n  --radius: 0.5rem;\n\n  /* Sidebar defaults (light mode) */\n  --sidebar: 0 0% 100%;\n  --sidebar-foreground: 200 19% 18%;\n  --sidebar-primary: 123 46% 34%;\n  --sidebar-primary-foreground: 0 0% 100%;\n  --sidebar-accent: 210 30% 94%;\n  --sidebar-accent-foreground: 200 19% 18%;\n  --sidebar-border: 220 13% 91%;\n  --sidebar-ring: 123 46% 34%;\n  \n  /* Charts */\n  --chart-1: 123 46% 34%; /* Primary Green */\n  --chart-2: 210 79% 46%; /* Secondary Blue */\n  --chart-3: 122 39% 49%; /* Success Green */\n  --chart-4: 36 100% 50%; /* Warning Orange */\n  --chart-5: 200 19% 18%; /* Dark Text */\n}\n\n.dark {\n  --background: 200 20% 10%;\n  --foreground: 210 20% 98%;\n\n  --card: 200 20% 12%;\n  --card-foreground: 210 20% 98%;\n\n  --popover: 200 20% 12%;\n  --popover-foreground: 210 20% 98%;\n\n  --primary: 123 46% 40%;\n  --primary-foreground: 0 0% 100%;\n\n  --secondary: 210 79% 50%;\n  --secondary-foreground: 0 0% 100%;\n\n  --muted: 200 20% 20%;\n  --muted-foreground: 210 20% 70%;\n\n  --accent: 200 20% 20%;\n  --accent-foreground: 210 20% 98%;\n\n  --destructive: 0 62% 30%;\n  --destructive-foreground: 210 20% 98%;\n  \n  --success: 122 39% 49%;\n  --warning: 36 100% 50%;\n\n  --border: 200 20% 20%;\n  --input: 200 20% 20%;\n  --ring: 123 46% 40%;\n  \n  --sidebar: 200 20% 10%;\n  --sidebar-foreground: 210 20% 98%;\n  --sidebar-primary: 123 46% 40%;\n  --sidebar-primary-foreground: 0 0% 100%;\n  --sidebar-accent: 200 20% 20%;\n  --sidebar-accent-foreground: 210 20% 98%;\n  --sidebar-border: 200 20% 20%;\n  --sidebar-ring: 123 46% 40%;\n  \n  --chart-1: 123 46% 45%;\n  --chart-2: 210 79% 55%;\n  --chart-3: 122 39% 55%;\n  --chart-4: 36 100% 55%;\n  --chart-5: 210 20% 85%;\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n}\n","path":null,"size_bytes":4603,"size_tokens":null},"client/src/components/ui/button-group.tsx":{"content":"import { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Separator } from \"@/components/ui/separator\"\n\nconst buttonGroupVariants = cva(\n  \"flex w-fit items-stretch has-[>[data-slot=button-group]]:gap-2 [&>*]:focus-visible:relative [&>*]:focus-visible:z-10 has-[select[aria-hidden=true]:last-child]:[&>[data-slot=select-trigger]:last-of-type]:rounded-r-md [&>[data-slot=select-trigger]:not([class*='w-'])]:w-fit [&>input]:flex-1\",\n  {\n    variants: {\n      orientation: {\n        horizontal:\n          \"[&>*:not(:first-child)]:rounded-l-none [&>*:not(:first-child)]:border-l-0 [&>*:not(:last-child)]:rounded-r-none\",\n        vertical:\n          \"flex-col [&>*:not(:first-child)]:rounded-t-none [&>*:not(:first-child)]:border-t-0 [&>*:not(:last-child)]:rounded-b-none\",\n      },\n    },\n    defaultVariants: {\n      orientation: \"horizontal\",\n    },\n  }\n)\n\nfunction ButtonGroup({\n  className,\n  orientation,\n  ...props\n}: React.ComponentProps<\"div\"> & VariantProps<typeof buttonGroupVariants>) {\n  return (\n    <div\n      role=\"group\"\n      data-slot=\"button-group\"\n      data-orientation={orientation}\n      className={cn(buttonGroupVariants({ orientation }), className)}\n      {...props}\n    />\n  )\n}\n\nfunction ButtonGroupText({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  asChild?: boolean\n}) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      className={cn(\n        \"bg-muted shadow-xs flex items-center gap-2 rounded-md border px-4 text-sm font-medium [&_svg:not([class*='size-'])]:size-4 [&_svg]:pointer-events-none\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction ButtonGroupSeparator({\n  className,\n  orientation = \"vertical\",\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"button-group-separator\"\n      orientation={orientation}\n      className={cn(\n        \"bg-input relative !m-0 self-stretch data-[orientation=vertical]:h-auto\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  ButtonGroup,\n  ButtonGroupSeparator,\n  ButtonGroupText,\n  buttonGroupVariants,\n}\n","path":null,"size_bytes":2209,"size_tokens":null},"client/src/App.tsx":{"content":"import { Switch, Route, useLocation } from \"wouter\";\nimport { QueryClient, QueryClientProvider } from \"@tanstack/react-query\";\nimport { PracticeProvider } from \"@/contexts/PracticeContext\";\nimport { AppLayout } from \"@/components/layout/AppLayout\";\nimport Dashboard from \"@/pages/Dashboard\";\nimport LayoutEditor from \"@/pages/LayoutEditor\";\nimport Staff from \"@/pages/Staff\";\nimport Simulation from \"@/pages/Simulation\";\nimport Knowledge from \"@/pages/Knowledge\";\nimport Playbooks from \"@/pages/Playbooks\";\nimport Debug from \"@/pages/Debug\";\nimport Auth from \"@/pages/Auth\";\nimport NotFound from \"@/pages/not-found\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\n\nconst queryClient = new QueryClient();\n\nfunction ProtectedRouter() {\n  return (\n    <AppLayout>\n      <Switch>\n        <Route path=\"/\" component={Dashboard} />\n        <Route path=\"/editor\" component={LayoutEditor} />\n        <Route path=\"/staff\" component={Staff} />\n        <Route path=\"/simulation\" component={Simulation} />\n        <Route path=\"/knowledge\" component={Knowledge} />\n        <Route path=\"/playbooks\" component={Playbooks} />\n        <Route path=\"/debug\" component={Debug} />\n        <Route component={NotFound} />\n      </Switch>\n    </AppLayout>\n  );\n}\n\nfunction AppRouter() {\n  const [location] = useLocation();\n  \n  if (location === \"/auth\") {\n    return <Auth />;\n  }\n  \n  return (\n    <PracticeProvider>\n      <ProtectedRouter />\n    </PracticeProvider>\n  );\n}\n\nfunction App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <TooltipProvider>\n        <AppRouter />\n        <Toaster />\n      </TooltipProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","path":null,"size_bytes":1735,"size_tokens":null},"client/src/pages/Dashboard.tsx":{"content":"import { StatsCards } from \"@/components/dashboard/StatsCards\";\nimport { EfficiencyChart } from \"@/components/dashboard/EfficiencyChart\";\nimport medicalHero from \"@assets/generated_images/isometric_medical_practice_floor_plan_vector_art.png\";\nimport { Button } from \"@/components/ui/button\";\nimport { Play, Brain, LayoutGrid, Users, Target, AlertCircle, AlertTriangle, Lightbulb, TrendingUp, Zap, ArrowRight, Loader2 } from \"lucide-react\";\nimport { useTranslation } from \"react-i18next\";\nimport { Link } from \"wouter\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { api } from \"@/lib/api\";\nimport { usePractice } from \"@/contexts/PracticeContext\";\nimport { motion } from \"framer-motion\";\nimport { cn } from \"@/lib/utils\";\n\nfunction AIHealthScore({ score, isLoading, t }: { score: number; isLoading: boolean; t: (key: string) => string }) {\n  const safeScore = typeof score === 'number' && !isNaN(score) ? Math.max(0, Math.min(100, score)) : 0;\n  const strokeWidth = 10;\n  const size = 140;\n  const radius = (size - strokeWidth) / 2;\n  const circumference = radius * 2 * Math.PI;\n  const offset = circumference - (safeScore / 100) * circumference;\n  \n  const getColor = (s: number) => {\n    if (s >= 80) return { stroke: \"#22c55e\", text: \"text-green-600\", bg: \"from-green-500/20 to-green-500/5\", badge: \"bg-green-100\", label: t(\"dashboard.excellent\") };\n    if (s >= 60) return { stroke: \"#eab308\", text: \"text-yellow-600\", bg: \"from-yellow-500/20 to-yellow-500/5\", badge: \"bg-yellow-100\", label: t(\"dashboard.good\") };\n    return { stroke: \"#ef4444\", text: \"text-red-600\", bg: \"from-red-500/20 to-red-500/5\", badge: \"bg-red-100\", label: t(\"dashboard.needsWork\") };\n  };\n  \n  const colors = getColor(safeScore);\n\n  if (isLoading) {\n    return (\n      <div className=\"flex flex-col items-center justify-center py-8\">\n        <Loader2 className=\"h-12 w-12 animate-spin text-purple-500\" />\n        <p className=\"mt-3 text-sm text-muted-foreground\">{t(\"dashboard.analyzing\")}</p>\n      </div>\n    );\n  }\n  \n  return (\n    <div className=\"flex flex-col items-center\">\n      <div className={cn(\"relative flex items-center justify-center rounded-full bg-gradient-to-b\", colors.bg)} style={{ width: size, height: size }}>\n        <svg width={size} height={size} className=\"absolute -rotate-90\">\n          <circle\n            cx={size / 2}\n            cy={size / 2}\n            r={radius}\n            fill=\"none\"\n            stroke=\"currentColor\"\n            strokeWidth={strokeWidth}\n            className=\"text-muted/20\"\n          />\n          <motion.circle\n            cx={size / 2}\n            cy={size / 2}\n            r={radius}\n            fill=\"none\"\n            stroke={colors.stroke}\n            strokeWidth={strokeWidth}\n            strokeLinecap=\"round\"\n            initial={{ strokeDasharray: circumference, strokeDashoffset: circumference }}\n            animate={{ strokeDashoffset: offset }}\n            transition={{ duration: 1.2, ease: \"easeOut\" }}\n          />\n        </svg>\n        <div className=\"text-center z-10\">\n          <motion.div \n            className={cn(\"text-4xl font-bold\", colors.text)}\n            initial={{ opacity: 0, scale: 0.5 }}\n            animate={{ opacity: 1, scale: 1 }}\n            transition={{ delay: 0.3 }}\n          >\n            {safeScore}\n          </motion.div>\n          <div className=\"text-[9px] uppercase tracking-wider text-muted-foreground font-medium leading-tight text-center max-w-[80px]\">{t(\"dashboard.healthScore\")}</div>\n        </div>\n      </div>\n      <motion.div \n        className={cn(\"mt-3 px-3 py-1 rounded-full text-xs font-semibold\", colors.text, colors.badge)}\n        initial={{ opacity: 0, y: 10 }}\n        animate={{ opacity: 1, y: 0 }}\n        transition={{ delay: 0.5 }}\n      >\n        {colors.label}\n      </motion.div>\n    </div>\n  );\n}\n\nfunction MetricCard({ label, value, icon: Icon, color, trend }: { label: string; value: number; icon: React.ElementType; color: string; trend?: string }) {\n  const safeValue = typeof value === 'number' && !isNaN(value) ? Math.max(0, Math.min(100, value)) : 0;\n  \n  return (\n    <motion.div \n      className=\"p-4 rounded-xl bg-card border shadow-sm hover:shadow-md transition-shadow\"\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n    >\n      <div className=\"flex items-center gap-3 mb-3\">\n        <div className={cn(\"p-2 rounded-lg\", color)}>\n          <Icon className=\"h-4 w-4 text-white\" />\n        </div>\n        <span className=\"text-sm font-medium text-muted-foreground\">{label}</span>\n      </div>\n      <div className=\"flex items-end justify-between\">\n        <div className=\"text-2xl font-bold\">{safeValue}%</div>\n        {trend && (\n          <div className=\"flex items-center gap-1 text-xs text-green-600\">\n            <TrendingUp className=\"h-3 w-3\" />\n            {trend}\n          </div>\n        )}\n      </div>\n      <div className=\"mt-2 h-2 bg-muted/50 rounded-full overflow-hidden\">\n        <motion.div \n          className={cn(\"h-full rounded-full\", color)}\n          initial={{ width: 0 }}\n          animate={{ width: `${safeValue}%` }}\n          transition={{ duration: 0.8, ease: \"easeOut\", delay: 0.2 }}\n        />\n      </div>\n    </motion.div>\n  );\n}\n\nfunction MetricCardSkeleton() {\n  return (\n    <div className=\"p-4 rounded-xl bg-card border shadow-sm animate-pulse\">\n      <div className=\"flex items-center gap-3 mb-3\">\n        <div className=\"p-2 rounded-lg bg-muted h-8 w-8\" />\n        <div className=\"h-4 w-24 bg-muted rounded\" />\n      </div>\n      <div className=\"h-8 w-16 bg-muted rounded mb-2\" />\n      <div className=\"h-2 bg-muted rounded-full\" />\n    </div>\n  );\n}\n\nfunction PriorityAlert({ text, priority, index }: { text: string; priority: \"high\" | \"medium\" | \"low\"; index: number }) {\n  const configs = {\n    high: { \n      bg: \"bg-red-50 border-red-200 hover:bg-red-100\", \n      text: \"text-red-700\",\n      icon: AlertCircle,\n      badge: \"bg-red-100 text-red-700\"\n    },\n    medium: { \n      bg: \"bg-yellow-50 border-yellow-200 hover:bg-yellow-100\", \n      text: \"text-yellow-700\",\n      icon: AlertTriangle,\n      badge: \"bg-yellow-100 text-yellow-700\"\n    },\n    low: { \n      bg: \"bg-green-50 border-green-200 hover:bg-green-100\", \n      text: \"text-green-700\",\n      icon: Lightbulb,\n      badge: \"bg-green-100 text-green-700\"\n    }\n  };\n  \n  const config = configs[priority];\n  const Icon = config.icon;\n  \n  return (\n    <motion.div \n      className={cn(\"flex items-start gap-3 p-4 rounded-xl border transition-colors cursor-pointer\", config.bg)}\n      initial={{ opacity: 0, x: -20 }}\n      animate={{ opacity: 1, x: 0 }}\n      transition={{ delay: index * 0.1 }}\n      data-testid={`alert-priority-${index}`}\n    >\n      <div className={cn(\"p-1.5 rounded-lg shrink-0\", config.badge)}>\n        <Icon className=\"h-4 w-4\" />\n      </div>\n      <div className=\"flex-1\">\n        <p className={cn(\"text-sm leading-relaxed\", config.text)}>{text}</p>\n      </div>\n      <ArrowRight className={cn(\"h-4 w-4 shrink-0 mt-1\", config.text)} />\n    </motion.div>\n  );\n}\n\nexport default function Dashboard() {\n  const { t } = useTranslation();\n  const { practiceId } = usePractice();\n\n  const { data: analysis, isLoading } = useQuery({\n    queryKey: [\"ai-analysis\", practiceId],\n    queryFn: () => api.ai.analyzeLayout({ practiceId: practiceId!, operatingHours: 8 }),\n    enabled: !!practiceId,\n    staleTime: 30000,\n    refetchOnWindowFocus: false,\n  });\n\n  const getPriorityRecommendations = () => {\n    if (!analysis?.recommendations) return [];\n    return analysis.recommendations.slice(0, 3).map((rec, i) => {\n      const cleanText = rec.split('[')[0].trim();\n      const truncated = cleanText.length > 150 ? cleanText.slice(0, 150) + '...' : cleanText;\n      return {\n        text: truncated,\n        priority: i === 0 ? \"high\" as const : i === 1 ? \"medium\" as const : \"low\" as const\n      };\n    });\n  };\n\n  return (\n    <div className=\"flex-1 overflow-y-auto p-4 md:p-8\">\n      <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6 md:mb-8\">\n        <div>\n          <h2 className=\"text-2xl md:text-3xl font-bold tracking-tight text-primary\" data-testid=\"text-dashboard-title\">{t(\"dashboard.title\")}</h2>\n          <p className=\"text-sm md:text-base text-muted-foreground\">{t(\"dashboard.subtitle\")}</p>\n        </div>\n        <div className=\"flex items-center space-x-2\">\n          <Link href=\"/simulation\">\n            <Button className=\"bg-primary hover:bg-primary/90 text-white shadow-lg shadow-primary/20 transition-all hover:scale-105 active:scale-95 w-full sm:w-auto\" data-testid=\"button-run-simulation\">\n              <Play className=\"mr-2 h-4 w-4\" /> {t(\"dashboard.runSim\")}\n            </Button>\n          </Link>\n        </div>\n      </div>\n\n      <div className=\"space-y-6\">\n        <div className=\"grid gap-6 lg:grid-cols-3\">\n          <motion.div \n            className=\"lg:col-span-1 rounded-2xl border bg-gradient-to-br from-purple-50 via-white to-blue-50 p-6 shadow-lg\"\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n          >\n            <div className=\"flex items-center gap-2 mb-4\">\n              <div className=\"p-2 rounded-xl bg-gradient-to-br from-purple-500 to-blue-500\">\n                <Brain className=\"h-5 w-5 text-white\" />\n              </div>\n              <div>\n                <h3 className=\"font-semibold text-foreground\">{t(\"dashboard.aiPracticeHealth\")}</h3>\n                <p className=\"text-xs text-muted-foreground\">{t(\"dashboard.poweredByAI\")}</p>\n              </div>\n            </div>\n            \n            <AIHealthScore score={analysis?.overallScore ?? 0} isLoading={isLoading} t={t} />\n            \n            {analysis && (\n              <motion.div \n                className=\"mt-6 p-4 rounded-xl bg-white/60 border\"\n                initial={{ opacity: 0 }}\n                animate={{ opacity: 1 }}\n                transition={{ delay: 0.6 }}\n              >\n                <div className=\"flex items-center justify-between mb-2\">\n                  <span className=\"text-xs font-semibold text-muted-foreground\">{t(\"dashboard.estDailyCapacity\")}</span>\n                  <span className=\"text-xl font-bold text-foreground\" data-testid=\"text-daily-capacity\">{analysis.capacityAnalysis.estimatedCapacity}</span>\n                </div>\n                <p className=\"text-[11px] text-muted-foreground leading-relaxed\">{analysis.capacityAnalysis.benchmarkComparison}</p>\n              </motion.div>\n            )}\n          </motion.div>\n\n          <div className=\"lg:col-span-2 grid gap-4 sm:grid-cols-3\">\n            {isLoading ? (\n              <>\n                <MetricCardSkeleton />\n                <MetricCardSkeleton />\n                <MetricCardSkeleton />\n              </>\n            ) : (\n              <>\n                <MetricCard \n                  label={t(\"dashboard.layoutEfficiency\")} \n                  value={analysis?.efficiencyScore ?? 0} \n                  icon={LayoutGrid} \n                  color=\"bg-purple-500\"\n                />\n                <MetricCard \n                  label={t(\"dashboard.staffOptimization\")} \n                  value={analysis?.staffingScore ?? 0} \n                  icon={Users} \n                  color=\"bg-blue-500\"\n                />\n                <MetricCard \n                  label={t(\"dashboard.spaceUtilization\")} \n                  value={analysis?.spaceUtilizationScore ?? 0} \n                  icon={Target} \n                  color=\"bg-emerald-500\"\n                />\n              </>\n            )}\n          </div>\n        </div>\n\n        {analysis && getPriorityRecommendations().length > 0 && (\n          <motion.div \n            className=\"rounded-2xl border bg-card p-6 shadow-sm\"\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ delay: 0.3 }}\n          >\n            <div className=\"flex items-center justify-between mb-4\">\n              <div className=\"flex items-center gap-2\">\n                <div className=\"p-2 rounded-lg bg-amber-100\">\n                  <Zap className=\"h-4 w-4 text-amber-600\" />\n                </div>\n                <div>\n                  <h3 className=\"font-semibold text-foreground\">{t(\"dashboard.priorityActions\")}</h3>\n                  <p className=\"text-xs text-muted-foreground\">{t(\"dashboard.aiRecommendedImprovements\")}</p>\n                </div>\n              </div>\n              <Link href=\"/editor\">\n                <Button variant=\"outline\" size=\"sm\" className=\"text-xs\" data-testid=\"button-view-layout\">\n                  {t(\"dashboard.openLayoutEditor\")}\n                  <ArrowRight className=\"ml-2 h-3 w-3\" />\n                </Button>\n              </Link>\n            </div>\n            <div className=\"space-y-3\">\n              {getPriorityRecommendations().map((rec, i) => (\n                <PriorityAlert key={i} text={rec.text} priority={rec.priority} index={i} />\n              ))}\n            </div>\n          </motion.div>\n        )}\n\n        <StatsCards />\n        \n        <div className=\"grid gap-6 grid-cols-1 lg:grid-cols-7\">\n          <EfficiencyChart />\n          \n          <div className=\"lg:col-span-3 rounded-xl border bg-card text-card-foreground shadow-sm overflow-hidden flex flex-col\">\n            <div className=\"p-6 flex flex-col space-y-1.5\">\n              <h3 className=\"font-semibold leading-none tracking-tight\">{t(\"dashboard.liveView\")}</h3>\n              <p className=\"text-sm text-muted-foreground\">{t(\"dashboard.liveViewDesc\")}</p>\n            </div>\n            <div className=\"flex-1 relative bg-muted/20 min-h-[200px]\">\n              <img \n                src={medicalHero} \n                alt={t(\"images.simulationView\")} \n                className=\"absolute inset-0 h-full w-full object-cover opacity-90 hover:opacity-100 transition-opacity duration-500\"\n              />\n              <div className=\"absolute inset-0 bg-linear-to-t from-background/50 to-transparent pointer-events-none\" />\n            </div>\n          </div>\n        </div>\n\n        {analysis?.aiInsights && (\n          <motion.div \n            className=\"rounded-2xl border bg-gradient-to-r from-purple-50 to-blue-50 p-6 shadow-sm\"\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ delay: 0.5 }}\n          >\n            <div className=\"flex items-start gap-4\">\n              <div className=\"p-2 rounded-xl bg-gradient-to-br from-purple-500 to-blue-500 shrink-0\">\n                <Brain className=\"h-5 w-5 text-white\" />\n              </div>\n              <div>\n                <h3 className=\"font-semibold text-foreground mb-2\">{t(\"dashboard.aiInsights\")}</h3>\n                <p className=\"text-sm text-slate-600 leading-relaxed\" data-testid=\"text-dashboard-ai-insights\">\n                  {analysis.aiInsights}\n                </p>\n              </div>\n            </div>\n          </motion.div>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":15021,"size_tokens":null},"server/db.ts":{"content":"import { drizzle } from \"drizzle-orm/node-postgres\";\nimport pkg from \"pg\";\nconst { Pool } = pkg;\nimport * as schema from \"@shared/schema\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\nexport const pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n});\n\nexport const db = drizzle(pool, { schema });\n","path":null,"size_bytes":400,"size_tokens":null},"client/src/components/ui/command.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","path":null,"size_bytes":4887,"size_tokens":null},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  // @replit\n  // Whitespace-nowrap: Badges should never wrap.\n  \"whitespace-nowrap inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\" +\n  \" hover-elevate \",\n  {\n    variants: {\n      variant: {\n        default:\n          // @replit shadow-xs instead of shadow, no hover because we use hover-elevate\n          \"border-transparent bg-primary text-primary-foreground shadow-xs\",\n        secondary:\n          // @replit no hover because we use hover-elevate\n          \"border-transparent bg-secondary text-secondary-foreground\",\n        destructive:\n          // @replit shadow-xs instead of shadow, no hover because we use hover-elevate\n          \"border-transparent bg-destructive text-destructive-foreground shadow-xs\",\n          // @replit shadow-xs\" - use badge outline variable\n        outline: \"text-foreground border [border-color:var(--badge-outline)]\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  )\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1522,"size_tokens":null},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1419,"size_tokens":null},"client/src/components/ui/dropdown-menu.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md\",\n        \"data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":7606,"size_tokens":null},"vite-plugin-meta-images.ts":{"content":"import type { Plugin } from 'vite';\nimport fs from 'fs';\nimport path from 'path';\n\n/**\n * Vite plugin that updates og:image and twitter:image meta tags\n * to point to the app's opengraph image with the correct Replit domain.\n */\nexport function metaImagesPlugin(): Plugin {\n  return {\n    name: 'vite-plugin-meta-images',\n    transformIndexHtml(html) {\n      const baseUrl = getDeploymentUrl();\n      if (!baseUrl) {\n        log('[meta-images] no Replit deployment domain found, skipping meta tag updates');\n        return html;\n      }\n\n      // Check if opengraph image exists in public directory\n      const publicDir = path.resolve(process.cwd(), 'client', 'public');\n      const opengraphPngPath = path.join(publicDir, 'opengraph.png');\n      const opengraphJpgPath = path.join(publicDir, 'opengraph.jpg');\n      const opengraphJpegPath = path.join(publicDir, 'opengraph.jpeg');\n\n      let imageExt: string | null = null;\n      if (fs.existsSync(opengraphPngPath)) {\n        imageExt = 'png';\n      } else if (fs.existsSync(opengraphJpgPath)) {\n        imageExt = 'jpg';\n      } else if (fs.existsSync(opengraphJpegPath)) {\n        imageExt = 'jpeg';\n      }\n\n      if (!imageExt) {\n        log('[meta-images] OpenGraph image not found, skipping meta tag updates');\n        return html;\n      }\n\n      const imageUrl = `${baseUrl}/opengraph.${imageExt}`;\n\n      log('[meta-images] updating meta image tags to:', imageUrl);\n\n      html = html.replace(\n        /<meta\\s+property=\"og:image\"\\s+content=\"[^\"]*\"\\s*\\/>/g,\n        `<meta property=\"og:image\" content=\"${imageUrl}\" />`\n      );\n\n      html = html.replace(\n        /<meta\\s+name=\"twitter:image\"\\s+content=\"[^\"]*\"\\s*\\/>/g,\n        `<meta name=\"twitter:image\" content=\"${imageUrl}\" />`\n      );\n\n      return html;\n    },\n  };\n}\n\nfunction getDeploymentUrl(): string | null {\n  if (process.env.REPLIT_INTERNAL_APP_DOMAIN) {\n    const url = `https://${process.env.REPLIT_INTERNAL_APP_DOMAIN}`;\n    log('[meta-images] using internal app domain:', url);\n    return url;\n  }\n\n  if (process.env.REPLIT_DEV_DOMAIN) {\n    const url = `https://${process.env.REPLIT_DEV_DOMAIN}`;\n    log('[meta-images] using dev domain:', url);\n    return url;\n  }\n\n  return null;\n}\n\nfunction log(...args: any[]): void {\n  if (process.env.NODE_ENV === 'production') {\n    console.log(...args);\n  }\n}\n","path":null,"size_bytes":2333,"size_tokens":null},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","path":null,"size_bytes":6210,"size_tokens":null},"client/src/components/ui/input-group.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Textarea } from \"@/components/ui/textarea\"\n\nfunction InputGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"input-group\"\n      role=\"group\"\n      className={cn(\n        \"group/input-group border-input dark:bg-input/30 shadow-xs relative flex w-full items-center rounded-md border outline-none transition-[color,box-shadow]\",\n        \"h-9 has-[>textarea]:h-auto\",\n\n        // Variants based on alignment.\n        \"has-[>[data-align=inline-start]]:[&>input]:pl-2\",\n        \"has-[>[data-align=inline-end]]:[&>input]:pr-2\",\n        \"has-[>[data-align=block-start]]:h-auto has-[>[data-align=block-start]]:flex-col has-[>[data-align=block-start]]:[&>input]:pb-3\",\n        \"has-[>[data-align=block-end]]:h-auto has-[>[data-align=block-end]]:flex-col has-[>[data-align=block-end]]:[&>input]:pt-3\",\n\n        // Focus state.\n        \"has-[[data-slot=input-group-control]:focus-visible]:ring-ring has-[[data-slot=input-group-control]:focus-visible]:ring-1\",\n\n        // Error state.\n        \"has-[[data-slot][aria-invalid=true]]:ring-destructive/20 has-[[data-slot][aria-invalid=true]]:border-destructive dark:has-[[data-slot][aria-invalid=true]]:ring-destructive/40\",\n\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nconst inputGroupAddonVariants = cva(\n  \"text-muted-foreground flex h-auto cursor-text select-none items-center justify-center gap-2 py-1.5 text-sm font-medium group-data-[disabled=true]/input-group:opacity-50 [&>kbd]:rounded-[calc(var(--radius)-5px)] [&>svg:not([class*='size-'])]:size-4\",\n  {\n    variants: {\n      align: {\n        \"inline-start\":\n          \"order-first pl-3 has-[>button]:ml-[-0.45rem] has-[>kbd]:ml-[-0.35rem]\",\n        \"inline-end\":\n          \"order-last pr-3 has-[>button]:mr-[-0.4rem] has-[>kbd]:mr-[-0.35rem]\",\n        \"block-start\":\n          \"[.border-b]:pb-3 order-first w-full justify-start px-3 pt-3 group-has-[>input]/input-group:pt-2.5\",\n        \"block-end\":\n          \"[.border-t]:pt-3 order-last w-full justify-start px-3 pb-3 group-has-[>input]/input-group:pb-2.5\",\n      },\n    },\n    defaultVariants: {\n      align: \"inline-start\",\n    },\n  }\n)\n\nfunction InputGroupAddon({\n  className,\n  align = \"inline-start\",\n  ...props\n}: React.ComponentProps<\"div\"> & VariantProps<typeof inputGroupAddonVariants>) {\n  return (\n    <div\n      role=\"group\"\n      data-slot=\"input-group-addon\"\n      data-align={align}\n      className={cn(inputGroupAddonVariants({ align }), className)}\n      onClick={(e) => {\n        if ((e.target as HTMLElement).closest(\"button\")) {\n          return\n        }\n        e.currentTarget.parentElement?.querySelector(\"input\")?.focus()\n      }}\n      {...props}\n    />\n  )\n}\n\nconst inputGroupButtonVariants = cva(\n  \"flex items-center gap-2 text-sm shadow-none\",\n  {\n    variants: {\n      size: {\n        xs: \"h-6 gap-1 rounded-[calc(var(--radius)-5px)] px-2 has-[>svg]:px-2 [&>svg:not([class*='size-'])]:size-3.5\",\n        sm: \"h-8 gap-1.5 rounded-md px-2.5 has-[>svg]:px-2.5\",\n        \"icon-xs\":\n          \"size-6 rounded-[calc(var(--radius)-5px)] p-0 has-[>svg]:p-0\",\n        \"icon-sm\": \"size-8 p-0 has-[>svg]:p-0\",\n      },\n    },\n    defaultVariants: {\n      size: \"xs\",\n    },\n  }\n)\n\nfunction InputGroupButton({\n  className,\n  type = \"button\",\n  variant = \"ghost\",\n  size = \"xs\",\n  ...props\n}: Omit<React.ComponentProps<typeof Button>, \"size\"> &\n  VariantProps<typeof inputGroupButtonVariants>) {\n  return (\n    <Button\n      type={type}\n      data-size={size}\n      variant={variant}\n      className={cn(inputGroupButtonVariants({ size }), className)}\n      {...props}\n    />\n  )\n}\n\nfunction InputGroupText({ className, ...props }: React.ComponentProps<\"span\">) {\n  return (\n    <span\n      className={cn(\n        \"text-muted-foreground flex items-center gap-2 text-sm [&_svg:not([class*='size-'])]:size-4 [&_svg]:pointer-events-none\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction InputGroupInput({\n  className,\n  ...props\n}: React.ComponentProps<\"input\">) {\n  return (\n    <Input\n      data-slot=\"input-group-control\"\n      className={cn(\n        \"flex-1 rounded-none border-0 bg-transparent shadow-none focus-visible:ring-0 dark:bg-transparent\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction InputGroupTextarea({\n  className,\n  ...props\n}: React.ComponentProps<\"textarea\">) {\n  return (\n    <Textarea\n      data-slot=\"input-group-control\"\n      className={cn(\n        \"flex-1 resize-none rounded-none border-0 bg-transparent py-3 shadow-none focus-visible:ring-0 dark:bg-transparent\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  InputGroup,\n  InputGroupAddon,\n  InputGroupButton,\n  InputGroupText,\n  InputGroupInput,\n  InputGroupTextarea,\n}\n","path":null,"size_bytes":4971,"size_tokens":null},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","path":null,"size_bytes":140,"size_tokens":null},"server/static.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(__dirname, \"public\");\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","path":null,"size_bytes":547,"size_tokens":null},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"rounded-xl border bg-card text-card-foreground shadow\",\n      className\n    )}\n    {...props}\n  />\n))\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n))\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"font-semibold leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\n\nexport { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }\n","path":null,"size_bytes":1828,"size_tokens":null},"script/build.ts":{"content":"import { build as esbuild } from \"esbuild\";\nimport { build as viteBuild } from \"vite\";\nimport { rm, readFile } from \"fs/promises\";\n\n// server deps to bundle to reduce openat(2) syscalls\n// which helps cold start times\nconst allowlist = [\n  \"@google/generative-ai\",\n  \"axios\",\n  \"connect-pg-simple\",\n  \"cors\",\n  \"date-fns\",\n  \"drizzle-orm\",\n  \"drizzle-zod\",\n  \"express\",\n  \"express-rate-limit\",\n  \"express-session\",\n  \"jsonwebtoken\",\n  \"memorystore\",\n  \"multer\",\n  \"nanoid\",\n  \"nodemailer\",\n  \"openai\",\n  \"passport\",\n  \"passport-local\",\n  \"pg\",\n  \"stripe\",\n  \"uuid\",\n  \"ws\",\n  \"xlsx\",\n  \"zod\",\n  \"zod-validation-error\",\n];\n\nasync function buildAll() {\n  await rm(\"dist\", { recursive: true, force: true });\n\n  console.log(\"building client...\");\n  await viteBuild();\n\n  console.log(\"building server...\");\n  const pkg = JSON.parse(await readFile(\"package.json\", \"utf-8\"));\n  const allDeps = [\n    ...Object.keys(pkg.dependencies || {}),\n    ...Object.keys(pkg.devDependencies || {}),\n  ];\n  const externals = allDeps.filter((dep) => !allowlist.includes(dep));\n\n  await esbuild({\n    entryPoints: [\"server/index.ts\"],\n    platform: \"node\",\n    bundle: true,\n    format: \"cjs\",\n    outfile: \"dist/index.cjs\",\n    define: {\n      \"process.env.NODE_ENV\": '\"production\"',\n    },\n    minify: true,\n    external: externals,\n    logLevel: \"info\",\n  });\n}\n\nbuildAll().catch((err) => {\n  console.error(err);\n  process.exit(1);\n});\n","path":null,"size_bytes":1417,"size_tokens":null},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-1.5 w-full grow overflow-hidden rounded-full bg-primary/20\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-4 w-4 rounded-full border border-primary/50 bg-background shadow transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","path":null,"size_bytes":1037,"size_tokens":null},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"grid place-content-center peer h-4 w-4 shrink-0 rounded-sm border border-primary shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"grid place-content-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","path":null,"size_bytes":1031,"size_tokens":null},"replit.md":{"content":"# PraxisFlow AI - Medical Practice Simulation\n\n## Overview\n\nPraxisFlow AI is an AI-powered medical practice simulation application that helps optimize clinic workflows, efficiency, and staff harmony. The application allows users to design practice layouts, manage staff resources, run simulations with varying patient volumes, and receive AI-driven recommendations for improving practice operations.\n\nThe system uses **German medical industry regulations and benchmarks** to evaluate room sizes, staffing ratios, patient flow, and layout efficiency, providing actionable insights for practice optimization compliant with German healthcare standards.\n\n## User Preferences\n\nPreferred communication style: Simple, everyday language.\n\n## System Architecture\n\n### Frontend Architecture\n\n**Framework**: React 18 with TypeScript, using Vite as the build tool\n\n**Routing**: Wouter for lightweight client-side routing\n\n**State Management**: \n- React Context API for global practice state (PracticeContext)\n- TanStack Query (React Query) for server state management and caching\n\n**UI Framework**: \n- Shadcn UI component library (Radix UI primitives)\n- Tailwind CSS for styling with custom medical theme\n- Framer Motion for animations\n- Recharts for data visualization\n\n**Key Design Patterns**:\n- Component composition with shadcn/ui components\n- Custom hooks for reusable logic (use-mobile, use-toast)\n- Query-based data fetching with automatic caching and invalidation\n- Context providers for shared state\n\n**Pages**:\n- Dashboard: Overview with metrics and performance charts\n- Layout Editor: Drag-and-drop room placement with AI advisor\n- Staff Management: View and manage staff members\n- Simulation: Run scenarios with configurable parameters\n- AI Praxis-Coach: Interactive AI coaching chat for practice optimization advice\n- Debug (/debug): Hidden system diagnostics page (not in sidebar) - shows DB counts, timestamps, RAG config, workflow duplicates\n\n### Backend Architecture\n\n**Runtime**: Node.js with TypeScript (ES modules)\n\n**Framework**: Express.js with custom middleware\n\n**API Design**: RESTful endpoints organized by resource:\n- `/api/practices` - Practice CRUD operations\n- `/api/practices/:id/layout-efficiency` - Layout efficiency breakdown with detailed scoring\n- `/api/rooms` - Room management within practices (supports multi-floor layouts)\n- `/api/staff` - Staff member management\n- `/api/simulations` - Run and retrieve simulations\n- `/api/ai/*` - AI analysis and recommendations\n- `/api/knowledge` - Coach knowledge base (list, get, search - read-only for users)\n- `/api/ai/coach-chat` - Interactive AI coaching chat with RAG-based knowledge retrieval\n- `/api/debug/status` - System diagnostics (counts, timestamps, RAG config) - only enabled when DEBUG_STATUS=true or NODE_ENV !== \"production\"\n\n**Key Design Patterns**:\n- Storage abstraction layer (IStorage interface) for database operations\n- Separation of concerns: routes, storage, simulation logic, AI services\n- Request/response logging middleware\n- JSON body parsing with raw body preservation for webhooks\n\n**Simulation Engine**: \n- Pure TypeScript implementation calculating efficiency, harmony, wait times, and patient capacity\n- Based on industry benchmarks (room sizes, staffing ratios, patient flow metrics)\n- Considers room placement, distances, and staffing levels\n\n**AI Integration**:\n- OpenAI API for advanced layout analysis and recommendations\n- Tavily API for real-time web search (current regulations, guidelines, industry news)\n- Benchmark-based scoring system using medical industry standards\n- Quick recommendations and detailed layout analysis endpoints\n- AI Coach with RAG-based knowledge retrieval + live web search\n\n### Data Storage\n\n**ORM**: Drizzle ORM with PostgreSQL dialect\n\n**Database Schema**:\n- `users` - User accounts (currently minimal auth)\n- `practices` - Medical practice configurations with budgets\n- `rooms` - Practice layout rooms (type, name, position, dimensions)\n- `staff` - Staff members with roles, efficiency, stress levels, and traits\n- `simulations` - Historical simulation results with parameters\n- `knowledge_sources` - Uploaded coaching documents metadata (title, category, tags)\n- `knowledge_chunks` - Chunked document content with vector embeddings for semantic search\n\n**Vector Search (pgvector)**:\n- Uses pgvector extension for semantic similarity search\n- Embeddings generated via OpenAI text-embedding-3-small model\n- Coaching knowledge is retrieved and injected into AI prompts as primary knowledge source\n\n**Migration Strategy**: Drizzle Kit for schema migrations via `db:push` command\n\n**Connection Management**: PostgreSQL connection pool via `pg` library\n\n### External Dependencies\n\n**AI Services**:\n- OpenAI API (configurable base URL and API key)\n- Used for intelligent layout analysis and contextual recommendations\n\n**Database**:\n- PostgreSQL (required, configured via `DATABASE_URL` environment variable)\n- Drizzle ORM for type-safe database queries\n\n**Development Tools**:\n- Vite plugins for Replit integration (cartographer, dev banner, runtime error overlay)\n- Custom meta-images plugin for OpenGraph image injection\n- TypeScript compilation without emission (type checking only)\n\n**Build Process**:\n- Client: Vite builds React app to `dist/public`\n- Server: esbuild bundles server code to single CJS file with selective dependency bundling\n- Allowlist of dependencies bundled to reduce cold start syscalls\n\n**Session Management**: \n- Infrastructure present (connect-pg-simple, express-session) but not fully implemented in provided code\n\n**German Medical Standards Integration**:\n- Arbeitsstättenverordnung (ArbStättV) - German Workplace Ordinance for room sizes\n- ASR A1.2 - Technical Rules for Room Dimensions and Movement Areas\n- Praxisbegehung - Medical practice inspection requirements\n- Hygieneverordnung & RKI Guidelines - Hygiene and laboratory standards\n- KV (Kassenärztliche Vereinigung) - Statutory health insurance physicians' association benchmarks\n- KZBV (Kassenzahnärztliche Bundesvereinigung) - Dental practice benchmarks\n- DIN 18040 - Barrier-free building standards (Barrierefreies Bauen)\n- QM-RL (Qualitätsmanagement-Richtlinie) - Quality management guidelines from G-BA\n- EBM (Einheitlicher Bewertungsmaßstab) - Unified assessment standard for appointment timing\n\n**Room Size Standards (in square meters)**:\n- Empfangsbereich (Reception): 8-14 m² (optimal: 10 m²)\n- Wartebereich (Waiting): 15-35 m² (optimal: 22 m²)\n- Behandlungsraum (Exam Room): 9-12 m² (optimal: 10 m²)\n- Labor (Lab): 8-15 m² (optimal: 10 m²)\n- Büro (Office): 10-18 m² (optimal: 14 m²)\n\n**Staffing Benchmarks**:\n- 2.5-4.0 support staff per physician (KV recommendation)\n- 3-4 exam rooms per provider (optimal patient flow)\n- 1.0-2.0 MFA (Medizinische Fachangestellte) per doctor\n\n**Internationalization**:\n- Full German and English language support via i18next\n- AI responses in German when using German interface\n\n## RAG System Operations\n\n**Artifact Building**:\n- Script: `npx tsx scripts/build-artifacts.ts`\n- Extracts structured JSON artifacts from knowledge chunks using GPT-4o\n- Zod validation ensures type safety\n- Idempotent: skips unchanged artifacts via source hash\n- Generates: 5 dashboard, 3 staffing, 3 layout artifacts\n\n**Knowledge Ingestion**:\n- Script: `npx tsx scripts/ingest-knowledge.ts`\n- Source: `.docx` files in `/knowledge-docs/` directory\n- Chunking: Heading-based with 600-900 token chunks, 100 token overlap\n- Hash-based upsert: Skips unchanged files/chunks for efficient re-runs\n- Embeddings: OpenAI text-embedding-3-small (1536 dimensions)\n\n**RAG Query Pipeline** (`server/ai/ragQuery.ts`):\n1. Generate embedding for user question\n2. pgvector similarity search against knowledge_chunks\n3. Assess KB coverage (sufficient/partial/insufficient based on similarity scores)\n4. If KB insufficient OR time-sensitive topic → Tavily web search\n5. Filter web results to authoritative German medical domains\n6. Generate answer with mandatory KB/Web source citations\n\n**API Endpoints**:\n- `POST /api/ai/coach-chat` - Main coach chat (uses RAG)\n- `POST /api/v1/rag/query` - Direct RAG query with KB-first, Web-second logic\n  - Request: `{ question: string, topK?: number (1-20, default 5) }`\n  - Response: `{ answer, kbCitations[], webCitations[], kbCoverage }`\n  - kbCitations: `{ chunkId, docName, headingPath, score }`\n  - webCitations: `{ title, publisher, date, url }`\n  - kbCoverage: \"sufficient\" | \"partial\" | \"insufficient\"\n\n**Environment Secrets Required**:\n- `OPENAI_API_KEY` - For embeddings and chat completions\n- `TAVILY_API_KEY` - For web search augmentation (optional)","path":null,"size_bytes":8645,"size_tokens":null},"client/src/components/AIAdvisor.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { api, type LayoutAnalysis } from \"@/lib/api\";\nimport { usePractice } from \"@/contexts/PracticeContext\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Input } from \"@/components/ui/input\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { \n  Sparkles, \n  TrendingUp, \n  Users, \n  LayoutGrid, \n  Target,\n  ChevronDown,\n  ChevronUp,\n  MessageSquare,\n  Send,\n  Loader2,\n  AlertCircle,\n  CheckCircle,\n  AlertTriangle,\n  RefreshCw,\n  Workflow,\n  ArrowRight\n} from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface AIAdvisorProps {\n  collapsed?: boolean;\n  onToggle?: () => void;\n}\n\nfunction ScoreGauge({ score, label, icon: Icon }: { score: number | null | undefined; label: string; icon: React.ElementType }) {\n  const safeScore = typeof score === 'number' && !isNaN(score) ? Math.max(0, Math.min(100, score)) : 0;\n  \n  const getScoreColor = (s: number) => {\n    if (s >= 80) return \"text-green-600\";\n    if (s >= 60) return \"text-yellow-600\";\n    return \"text-red-600\";\n  };\n\n  const getProgressColor = (s: number) => {\n    if (s >= 80) return \"bg-green-500\";\n    if (s >= 60) return \"bg-yellow-500\";\n    return \"bg-red-500\";\n  };\n\n  return (\n    <div className=\"space-y-2\">\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-2\">\n          <Icon className=\"h-4 w-4 text-muted-foreground\" />\n          <span className=\"text-sm font-medium\">{label}</span>\n        </div>\n        <span className={cn(\"text-sm font-bold\", getScoreColor(safeScore))}>{safeScore}%</span>\n      </div>\n      <div className=\"h-2 bg-muted rounded-full overflow-hidden\">\n        <div \n          className={cn(\"h-full transition-all duration-500\", getProgressColor(safeScore))}\n          style={{ width: `${safeScore}%` }}\n        />\n      </div>\n    </div>\n  );\n}\n\nfunction RecommendationItem({ text, index }: { text: string; index: number }) {\n  const isCritical = text.startsWith(\"CRITICAL:\");\n  const isGood = text.includes(\"Good\") || text.includes(\"Excellent\") || text.includes(\"optimal\");\n  \n  const Icon = isCritical ? AlertCircle : isGood ? CheckCircle : AlertTriangle;\n  const iconColor = isCritical ? \"text-red-500\" : isGood ? \"text-green-500\" : \"text-yellow-500\";\n\n  return (\n    <motion.div\n      initial={{ opacity: 0, x: -10 }}\n      animate={{ opacity: 1, x: 0 }}\n      transition={{ delay: index * 0.1 }}\n      className=\"flex gap-3 p-3 rounded-lg bg-muted/50 hover:bg-muted transition-colors\"\n    >\n      <Icon className={cn(\"h-5 w-5 shrink-0 mt-0.5\", iconColor)} />\n      <p className=\"text-sm text-muted-foreground leading-relaxed\">{text}</p>\n    </motion.div>\n  );\n}\n\nexport function AIAdvisor({ collapsed = false, onToggle }: AIAdvisorProps) {\n  const { practiceId } = usePractice();\n  const [question, setQuestion] = useState(\"\");\n  const [showDetails, setShowDetails] = useState(false);\n\n  const { data: analysis, isLoading, refetch, isFetching } = useQuery({\n    queryKey: [\"ai-analysis\", practiceId],\n    queryFn: () => api.ai.analyzeLayout({ practiceId: practiceId!, operatingHours: 8 }),\n    enabled: !!practiceId && !collapsed,\n    staleTime: 30000,\n    refetchOnWindowFocus: false,\n  });\n\n  const askMutation = useMutation({\n    mutationFn: (q: string) => api.ai.getRecommendation({ practiceId: practiceId!, question: q }),\n  });\n\n  const handleAsk = () => {\n    if (question.trim()) {\n      askMutation.mutate(question);\n      setQuestion(\"\");\n    }\n  };\n\n  if (collapsed) {\n    return (\n      <Button\n        variant=\"outline\"\n        size=\"sm\"\n        onClick={onToggle}\n        className=\"gap-2 bg-gradient-to-r from-purple-500/10 to-blue-500/10 border-purple-200 hover:border-purple-300\"\n        data-testid=\"button-open-advisor\"\n      >\n        <Sparkles className=\"h-4 w-4 text-purple-500\" />\n        AI Advisor\n      </Button>\n    );\n  }\n\n  return (\n    <Card className=\"w-80 shadow-xl border-purple-200/50 bg-gradient-to-b from-white to-purple-50/30\">\n      <CardHeader className=\"pb-3\">\n        <div className=\"flex items-center justify-between\">\n          <CardTitle className=\"flex items-center gap-2 text-lg\">\n            <div className=\"p-1.5 rounded-lg bg-gradient-to-br from-purple-500 to-blue-500\">\n              <Sparkles className=\"h-4 w-4 text-white\" />\n            </div>\n            AI Practice Advisor\n          </CardTitle>\n          <div className=\"flex gap-1\">\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              className=\"h-8 w-8\"\n              onClick={() => refetch()}\n              disabled={isFetching}\n              data-testid=\"button-refresh-analysis\"\n            >\n              <RefreshCw className={cn(\"h-4 w-4\", isFetching && \"animate-spin\")} />\n            </Button>\n            {onToggle && (\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                className=\"h-8 w-8\"\n                onClick={onToggle}\n                data-testid=\"button-close-advisor\"\n              >\n                <ChevronDown className=\"h-4 w-4\" />\n              </Button>\n            )}\n          </div>\n        </div>\n        <p className=\"text-xs text-muted-foreground\">\n          Powered by real industry benchmarks from MGMA, ADA & AAOMS\n        </p>\n      </CardHeader>\n\n      <CardContent className=\"space-y-4\">\n        {isLoading ? (\n          <div className=\"flex items-center justify-center py-8\">\n            <Loader2 className=\"h-8 w-8 animate-spin text-purple-500\" />\n          </div>\n        ) : analysis ? (\n          <>\n            <div className=\"text-center p-4 rounded-xl bg-gradient-to-br from-purple-100 to-blue-100\">\n              <div className=\"text-4xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent\" data-testid=\"text-overall-score\">\n                {typeof analysis.overallScore === 'number' && !isNaN(analysis.overallScore) ? analysis.overallScore : 0}%\n              </div>\n              <p className=\"text-sm text-muted-foreground mt-1\">Overall Practice Score</p>\n            </div>\n\n            <div className=\"space-y-3\">\n              <ScoreGauge score={analysis.efficiencyScore} label=\"Layout Efficiency\" icon={LayoutGrid} />\n              <ScoreGauge score={analysis.staffingScore} label=\"Staffing Optimization\" icon={Users} />\n              <ScoreGauge score={analysis.spaceUtilizationScore} label=\"Space Utilization\" icon={Target} />\n              <ScoreGauge score={analysis.workflowAnalysis?.workflowScore ?? 70} label=\"Workflow Efficiency\" icon={Workflow} />\n            </div>\n\n            {analysis.workflowAnalysis && analysis.workflowAnalysis.topConnections.length > 0 && (\n              <>\n                <Separator />\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center gap-2 text-sm font-medium\">\n                    <Workflow className=\"h-4 w-4 text-blue-500\" />\n                    <span>Top Workflow Connections</span>\n                  </div>\n                  <div className=\"space-y-1.5\">\n                    {analysis.workflowAnalysis.topConnections.map((conn, i) => (\n                      <div key={i} className=\"flex items-center justify-between text-xs p-2 rounded bg-muted/50\" data-testid={`workflow-connection-${i}`}>\n                        <div className=\"flex items-center gap-1.5\">\n                          <span className=\"font-medium\">{conn.fromName}</span>\n                          <ArrowRight className=\"h-3 w-3 text-muted-foreground\" />\n                          <span className=\"font-medium\">{conn.toName}</span>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          <span className={cn(\n                            \"px-1.5 py-0.5 rounded text-[10px] font-medium\",\n                            conn.distanceClass === \"short\" && \"bg-green-100 text-green-700\",\n                            conn.distanceClass === \"medium\" && \"bg-yellow-100 text-yellow-700\",\n                            conn.distanceClass === \"long\" && \"bg-red-100 text-red-700\"\n                          )}>\n                            {conn.distanceClass === \"short\" ? \"Kurz\" : conn.distanceClass === \"medium\" ? \"Mittel\" : \"Lang\"} • {conn.distance}m\n                          </span>\n                          {conn.weight > 1 && (\n                            <span className=\"px-1 py-0.5 rounded text-[10px] bg-blue-100 text-blue-700\">\n                              ×{conn.weight}\n                            </span>\n                          )}\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                  <div className=\"text-[10px] text-muted-foreground\">\n                    Gesamtkosten: {analysis.workflowAnalysis.workflowCostTotal}\n                  </div>\n                </div>\n              </>\n            )}\n\n            <Separator />\n\n            <div className=\"p-3 rounded-lg bg-purple-50 border border-purple-100\">\n              <div className=\"flex items-start gap-2\">\n                <Sparkles className=\"h-4 w-4 text-purple-500 mt-0.5 shrink-0\" />\n                <p className=\"text-sm text-purple-900 leading-relaxed\" data-testid=\"text-ai-insights\">\n                  {analysis.aiInsights}\n                </p>\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <div className=\"flex items-center justify-between text-sm font-medium text-muted-foreground\">\n                <span>Capacity Analysis</span>\n                <span className=\"text-foreground\">{analysis.capacityAnalysis.estimatedCapacity} patients/day</span>\n              </div>\n              <p className=\"text-xs text-muted-foreground\">{analysis.capacityAnalysis.benchmarkComparison}</p>\n            </div>\n\n            <Button\n              variant=\"ghost\"\n              className=\"w-full justify-between text-sm\"\n              onClick={() => setShowDetails(!showDetails)}\n              data-testid=\"button-toggle-details\"\n            >\n              <span>{analysis.recommendations.length} Recommendations</span>\n              {showDetails ? <ChevronUp className=\"h-4 w-4\" /> : <ChevronDown className=\"h-4 w-4\" />}\n            </Button>\n\n            <AnimatePresence>\n              {showDetails && (\n                <motion.div\n                  initial={{ height: 0, opacity: 0 }}\n                  animate={{ height: \"auto\", opacity: 1 }}\n                  exit={{ height: 0, opacity: 0 }}\n                  className=\"overflow-hidden\"\n                >\n                  <div className=\"space-y-2 max-h-60 overflow-y-auto\">\n                    {analysis.recommendations.map((rec, i) => (\n                      <RecommendationItem key={i} text={rec} index={i} />\n                    ))}\n                  </div>\n                </motion.div>\n              )}\n            </AnimatePresence>\n\n            <Separator />\n\n            <div className=\"space-y-2\">\n              <div className=\"flex items-center gap-2 text-sm font-medium\">\n                <MessageSquare className=\"h-4 w-4 text-purple-500\" />\n                <span>Ask the Advisor</span>\n              </div>\n              <div className=\"flex gap-2\">\n                <Input\n                  placeholder=\"e.g., How can I reduce wait times?\"\n                  value={question}\n                  onChange={(e) => setQuestion(e.target.value)}\n                  onKeyDown={(e) => e.key === \"Enter\" && handleAsk()}\n                  className=\"text-sm\"\n                  data-testid=\"input-ask-advisor\"\n                />\n                <Button\n                  size=\"icon\"\n                  onClick={handleAsk}\n                  disabled={!question.trim() || askMutation.isPending}\n                  className=\"bg-purple-500 hover:bg-purple-600\"\n                  data-testid=\"button-ask-advisor\"\n                >\n                  {askMutation.isPending ? (\n                    <Loader2 className=\"h-4 w-4 animate-spin\" />\n                  ) : (\n                    <Send className=\"h-4 w-4\" />\n                  )}\n                </Button>\n              </div>\n\n              <AnimatePresence>\n                {askMutation.data && (\n                  <motion.div\n                    initial={{ opacity: 0, y: -10 }}\n                    animate={{ opacity: 1, y: 0 }}\n                    exit={{ opacity: 0, y: -10 }}\n                    className=\"p-3 rounded-lg bg-blue-50 border border-blue-100\"\n                  >\n                    <p className=\"text-sm text-blue-900\" data-testid=\"text-advisor-response\">\n                      {askMutation.data.recommendation}\n                    </p>\n                  </motion.div>\n                )}\n              </AnimatePresence>\n            </div>\n          </>\n        ) : (\n          <div className=\"text-center py-8 text-muted-foreground\">\n            <p className=\"text-sm\">Unable to load analysis.</p>\n            <Button variant=\"link\" size=\"sm\" onClick={() => refetch()}>\n              Try again\n            </Button>\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","path":null,"size_bytes":13373,"size_tokens":null},"server/ai/advisor.ts":{"content":"import OpenAI from \"openai\";\nimport { zodResponseFormat } from \"openai/helpers/zod\";\nimport { z } from \"zod\";\nimport type { Room, Staff, WorkflowConnection } from \"@shared/schema\";\nimport {\n  ROOM_SIZE_STANDARDS,\n  STAFFING_RATIOS,\n  PATIENT_FLOW_METRICS,\n  LAYOUT_EFFICIENCY_PRINCIPLES,\n  INDUSTRY_BENCHMARKS,\n  evaluateRoomSize,\n  evaluateStaffingRatios,\n  calculatePatientCapacityBenchmark,\n  getLayoutRecommendations,\n  pixelsToSqM\n} from \"./benchmarks\";\nimport { pxToMeters, normalizeRoomType, DEFAULT_LAYOUT_SCALE_PX_PER_METER } from \"@shared/roomTypes\";\nimport { searchKnowledge, formatKnowledgeContext } from \"./knowledgeProcessor\";\nimport {\n  evaluateRoomSizeWithKnowledge,\n  getKnowledgePoweredRecommendations\n} from \"./artifactBenchmarks\";\nimport { formatCitations } from \"./artifactService\";\nimport { pxToM } from \"@shared/units\";\n\nconst DISTANCE_CLASS_THRESHOLDS = {\n  short: { min: 0, max: 3 },\n  medium: { min: 3, max: 8 },\n  long: { min: 8, max: Infinity }\n};\n\nconst DISTANCE_CLASS_WEIGHTS = {\n  short: 1.0,\n  medium: 1.5,\n  long: 2.0\n};\n\nfunction getDistanceClass(distanceMeters: number): \"short\" | \"medium\" | \"long\" {\n  if (distanceMeters <= DISTANCE_CLASS_THRESHOLDS.short.max) return \"short\";\n  if (distanceMeters <= DISTANCE_CLASS_THRESHOLDS.medium.max) return \"medium\";\n  return \"long\";\n}\n\nexport function computeWorkflowAnalysis(\n  rooms: Room[],\n  connections: WorkflowConnection[]\n): WorkflowAnalysis {\n  const roomMap = new Map(rooms.map(r => [r.id, r]));\n  \n  if (connections.length === 0) {\n    return {\n      workflowCostTotal: 0,\n      workflowScore: 70,\n      topConnections: [],\n      recommendations: [\n        \"Verbinden Sie Räume im Layout-Editor, um Arbeitsabläufe sichtbar zu machen.\",\n        \"Kanban-Prinzip anwenden: Check-In → Warten → Behandlung → Check-Out als Workflow definieren.\",\n        \"Beginnen Sie mit dem häufigsten Patientenpfad (Empfang → Wartebereich → Behandlungsraum).\",\n        \"Materialien an frequentierten Stationen vorhalten, um Laufwege zu minimieren.\",\n        \"Standardisierte Checklisten für wiederkehrende Abläufe einführen.\"\n      ]\n    };\n  }\n\n  const connectionDetails: Array<{\n    fromName: string;\n    toName: string;\n    distance: number;\n    distanceClass: \"short\" | \"medium\" | \"long\";\n    weight: number;\n    cost: number;\n    fromRoomId: string;\n    toRoomId: string;\n  }> = [];\n\n  let totalCost = 0;\n  const visitedPairs = new Map<string, number>();\n\n  for (const conn of connections) {\n    const fromRoom = roomMap.get(conn.fromRoomId);\n    const toRoom = roomMap.get(conn.toRoomId);\n    \n    if (!fromRoom || !toRoom) continue;\n\n    const fromCenter = { x: fromRoom.x + fromRoom.width / 2, y: fromRoom.y + fromRoom.height / 2 };\n    const toCenter = { x: toRoom.x + toRoom.width / 2, y: toRoom.y + toRoom.height / 2 };\n    \n    const distancePx = Math.sqrt(\n      Math.pow(toCenter.x - fromCenter.x, 2) + Math.pow(toCenter.y - fromCenter.y, 2)\n    );\n    const distanceMeters = pxToM(distancePx);\n    \n    const distanceClass = conn.distanceClass === \"auto\" || !conn.distanceClass\n      ? getDistanceClass(distanceMeters)\n      : conn.distanceClass as \"short\" | \"medium\" | \"long\";\n    \n    const userWeight = conn.weight || 1;\n    const classWeight = DISTANCE_CLASS_WEIGHTS[distanceClass];\n    const cost = distanceMeters * userWeight * classWeight;\n    \n    totalCost += cost;\n\n    connectionDetails.push({\n      fromName: fromRoom.name || fromRoom.type,\n      toName: toRoom.name || toRoom.type,\n      distance: Math.round(distanceMeters * 10) / 10,\n      distanceClass,\n      weight: userWeight,\n      cost: Math.round(cost * 10) / 10,\n      fromRoomId: conn.fromRoomId,\n      toRoomId: conn.toRoomId\n    });\n\n    const pairKey = [conn.fromRoomId, conn.toRoomId].sort().join(\"-\");\n    visitedPairs.set(pairKey, (visitedPairs.get(pairKey) || 0) + 1);\n  }\n\n  const backtrackingPairs = Array.from(visitedPairs.entries()).filter(([_, count]) => count > 1);\n  const hasBacktracking = backtrackingPairs.length > 0;\n  const longConnections = connectionDetails.filter(c => c.distanceClass === \"long\");\n  const mediumConnections = connectionDetails.filter(c => c.distanceClass === \"medium\");\n  const hasLongConnections = longConnections.length > 0;\n\n  const avgCostPerConnection = connections.length > 0 ? totalCost / connections.length : 0;\n  const penaltyPerPoint = 2;\n  const normalizedPenalty = Math.min(30, avgCostPerConnection * penaltyPerPoint / 3);\n  let workflowScore = Math.round(100 - normalizedPenalty);\n  \n  if (hasBacktracking) workflowScore -= 3;\n  if (hasLongConnections) workflowScore -= longConnections.length * 2;\n  if (mediumConnections.length > 2) workflowScore -= 2;\n  \n  workflowScore = Math.max(0, Math.min(100, workflowScore));\n\n  const recommendations: string[] = [];\n\n  if (hasLongConnections) {\n    const longNames = longConnections.map(c => `${c.fromName}→${c.toName}`).join(\", \");\n    recommendations.push(\n      `Lange Wege (${longNames}): Material-Staging an diesen Stationen einrichten oder Aufgaben bündeln.`\n    );\n  }\n\n  if (hasBacktracking) {\n    recommendations.push(\n      \"Rückläufige Bewegungen: Checklisten und standardisierte Abläufe helfen, Hin- und Herlaufen zu reduzieren.\"\n    );\n  }\n\n  const patientKind = connections.filter(c => c.kind === \"patient\");\n  const staffKind = connections.filter(c => c.kind === \"staff\");\n  \n  if (patientKind.length === 0 && staffKind.length > 0) {\n    recommendations.push(\n      \"Patientenpfad definieren: Check-In → Warten → Behandlung als separate Verbindungen anlegen.\"\n    );\n  }\n\n  if (avgCostPerConnection > 12) {\n    recommendations.push(\n      \"Hohe Wegkosten: Prüfen Sie Material-Bereitstellung und Aufgaben-Bündelung an frequentierten Stationen.\"\n    );\n  }\n\n  if (recommendations.length === 0) {\n    recommendations.push(\n      \"Gute Arbeitsabläufe! Materialien direkt am Einsatzort lagern optimiert den Workflow weiter.\"\n    );\n  }\n\n  if (recommendations.length < 3) {\n    recommendations.push(\n      \"Lean-Tipp: Kanban-Tafeln (Check-In → Warten → Behandlung → Check-Out) machen den Workflow sichtbar.\"\n    );\n  }\n\n  if (recommendations.length < 4 && mediumConnections.length > 0) {\n    recommendations.push(\n      \"Mittlere Distanzen: Überlegen Sie, ob häufig benötigte Materialien an Zwischenstationen bereitgestellt werden können.\"\n    );\n  }\n\n  const topConnections = connectionDetails\n    .sort((a, b) => b.cost - a.cost)\n    .slice(0, 3)\n    .map(({ fromName, toName, distance, distanceClass, weight, cost }) => ({\n      fromName,\n      toName,\n      distance,\n      distanceClass,\n      weight,\n      cost\n    }));\n\n  return {\n    workflowCostTotal: Math.round(totalCost * 10) / 10,\n    workflowScore,\n    topConnections,\n    recommendations: recommendations.slice(0, 5)\n  };\n}\n\nconst openai = new OpenAI({\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY\n});\n\nconst AIInsightsSchema = z.object({\n  analysis: z.string().describe(\"Kurze 1-2 Sätze Analyse der aktuellen Praxis-Situation\"),\n  keyImprovement: z.string().describe(\"Die wichtigste Verbesserung basierend auf Coach-Erfahrung\"),\n  marketComparison: z.string().describe(\"Wie die Praxis im Vergleich zu erfolgreichen Praxen abschneidet\"),\n  practicalTip: z.string().describe(\"Ein konkreter, umsetzbarer Tipp aus der Praxis\")\n});\n\nconst QuickRecommendationSchema = z.object({\n  recommendation: z.string().describe(\"Die konkrete Empfehlung ohne Quellenangaben\"),\n  reasoning: z.string().describe(\"Kurze Begründung für die Empfehlung\")\n});\n\nexport interface WorkflowAnalysis {\n  workflowCostTotal: number;\n  workflowScore: number;\n  topConnections: Array<{\n    fromName: string;\n    toName: string;\n    distance: number;\n    distanceClass: \"short\" | \"medium\" | \"long\";\n    weight: number;\n    cost: number;\n  }>;\n  recommendations: string[];\n}\n\nexport interface LayoutAnalysis {\n  overallScore: number;\n  efficiencyScore: number;\n  staffingScore: number;\n  spaceUtilizationScore: number;\n  roomAnalyses: RoomAnalysis[];\n  staffingAnalysis: StaffingAnalysis;\n  capacityAnalysis: CapacityAnalysis;\n  recommendations: string[];\n  aiInsights: string;\n  workflowAnalysis?: WorkflowAnalysis;\n}\n\nexport interface RoomAnalysis {\n  roomId: string;\n  roomName: string;\n  roomType: string;\n  sizeScore: number;\n  sizeAssessment: \"undersized\" | \"optimal\" | \"oversized\";\n  actualSqM: number;\n  recommendation: string;\n  source?: string;\n  fromKnowledge?: boolean;\n}\n\nexport interface StaffingAnalysis {\n  overallScore: number;\n  ratios: Record<string, {\n    actual: number;\n    optimal: number;\n    score: number;\n    recommendation: string;\n  }>;\n}\n\nexport interface CapacityAnalysis {\n  estimatedCapacity: number;\n  capacityScore: number;\n  benchmarkComparison: string;\n}\n\nfunction calculateDistance(x1: number, y1: number, x2: number, y2: number): number {\n  return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));\n}\n\nfunction getRoomCenter(room: Room): { x: number; y: number } {\n  return {\n    x: room.x + room.width / 2,\n    y: room.y + room.height / 2\n  };\n}\n\nfunction calculateLayoutEfficiencyScore(rooms: Room[], scalePxPerMeter: number = DEFAULT_LAYOUT_SCALE_PX_PER_METER): number {\n  if (rooms.length === 0) return 0;\n\n  const roomsByType = new Map<string, Room[]>();\n  rooms.forEach(room => {\n    const normalizedType = normalizeRoomType(room.type);\n    if (!roomsByType.has(normalizedType)) {\n      roomsByType.set(normalizedType, []);\n    }\n    roomsByType.get(normalizedType)!.push(room);\n  });\n\n  let score = 50;\n\n  const reception = roomsByType.get(\"reception\")?.[0];\n  const waiting = roomsByType.get(\"waiting\")?.[0];\n  const examRooms = roomsByType.get(\"exam\") || [];\n  const lab = roomsByType.get(\"lab\")?.[0];\n\n  if (reception && waiting) {\n    const recCenter = getRoomCenter(reception);\n    const waitCenter = getRoomCenter(waiting);\n    const distancePx = calculateDistance(recCenter.x, recCenter.y, waitCenter.x, waitCenter.y);\n    const distanceM = pxToMeters(distancePx, scalePxPerMeter);\n    \n    const benchmark = LAYOUT_EFFICIENCY_PRINCIPLES.distanceGuidelines.receptionToWaiting;\n    if (distanceM <= benchmark.optimal) {\n      score += 15;\n    } else if (distanceM <= benchmark.maxMeters) {\n      score += 10;\n    } else {\n      score -= 5;\n    }\n  }\n\n  if (waiting && examRooms.length > 0) {\n    const waitCenter = getRoomCenter(waiting);\n    const avgDistance = examRooms.reduce((sum, exam) => {\n      const examCenter = getRoomCenter(exam);\n      return sum + calculateDistance(waitCenter.x, waitCenter.y, examCenter.x, examCenter.y);\n    }, 0) / examRooms.length;\n    \n    const distanceM = pxToMeters(avgDistance, scalePxPerMeter);\n    const benchmark = LAYOUT_EFFICIENCY_PRINCIPLES.distanceGuidelines.waitingToExam;\n    \n    if (distanceM <= benchmark.optimal) {\n      score += 15;\n    } else if (distanceM <= benchmark.maxMeters) {\n      score += 8;\n    } else {\n      score -= 5;\n    }\n  }\n\n  if (lab && examRooms.length > 0) {\n    const labCenter = getRoomCenter(lab);\n    const avgDistance = examRooms.reduce((sum, exam) => {\n      const examCenter = getRoomCenter(exam);\n      return sum + calculateDistance(labCenter.x, labCenter.y, examCenter.x, examCenter.y);\n    }, 0) / examRooms.length;\n    \n    const distanceM = pxToMeters(avgDistance, scalePxPerMeter);\n    const benchmark = LAYOUT_EFFICIENCY_PRINCIPLES.distanceGuidelines.examToLab;\n    \n    if (distanceM <= benchmark.optimal) {\n      score += 12;\n    } else if (distanceM <= benchmark.maxMeters) {\n      score += 6;\n    } else {\n      score -= 3;\n    }\n  }\n\n  if (!reception) score -= 15;\n  if (!waiting) score -= 10;\n  if (examRooms.length === 0) score -= 20;\n\n  return Math.max(0, Math.min(100, score));\n}\n\nasync function analyzeRoomsWithKnowledge(rooms: Room[], scalePxPerMeter: number = DEFAULT_LAYOUT_SCALE_PX_PER_METER): Promise<RoomAnalysis[]> {\n  const analyses = await Promise.all(\n    rooms.map(async (room) => {\n      const evaluation = await evaluateRoomSizeWithKnowledge(room.type, room.width, room.height, scalePxPerMeter);\n      return {\n        roomId: room.id,\n        roomName: room.name || room.type,\n        roomType: room.type,\n        sizeScore: evaluation.score,\n        sizeAssessment: evaluation.assessment,\n        actualSqM: evaluation.actualSqM,\n        recommendation: evaluation.recommendation,\n        source: evaluation.citations.length > 0 ? formatCitations(evaluation.citations).join(\", \") : undefined,\n        fromKnowledge: evaluation.fromKnowledge\n      };\n    })\n  );\n  return analyses;\n}\n\nfunction analyzeStaffing(staff: Staff[], rooms: Room[]): StaffingAnalysis {\n  const doctors = staff.filter(s => s.role === \"doctor\" || s.role === \"dentist\").length;\n  const nurses = staff.filter(s => s.role === \"nurse\").length;\n  const receptionists = staff.filter(s => s.role === \"receptionist\").length;\n  const examRooms = rooms.filter(r => r.type === \"exam\").length;\n\n  return evaluateStaffingRatios(doctors, nurses, receptionists, staff.length, examRooms);\n}\n\nfunction analyzeCapacity(rooms: Room[], staff: Staff[], operatingHours: number = 8): CapacityAnalysis {\n  const examRooms = rooms.filter(r => r.type === \"exam\").length;\n  const providers = staff.filter(s => s.role === \"doctor\" || s.role === \"dentist\").length;\n  \n  return calculatePatientCapacityBenchmark(examRooms, operatingHours, providers);\n}\n\nasync function generateAIInsights(\n  rooms: Room[],\n  staff: Staff[],\n  efficiencyScore: number,\n  staffingScore: number,\n  recommendations: string[]\n): Promise<string> {\n  const roomsByType = new Map<string, number>();\n  rooms.forEach(room => {\n    roomsByType.set(room.type, (roomsByType.get(room.type) || 0) + 1);\n  });\n\n  const staffByRole = new Map<string, number>();\n  staff.forEach(s => {\n    staffByRole.set(s.role, (staffByRole.get(s.role) || 0) + 1);\n  });\n\n  const roomsSummary = Array.from(roomsByType.entries())\n    .map(([type, count]) => `${count} ${type}(s)`)\n    .join(\", \");\n  \n  const staffSummary = Array.from(staffByRole.entries())\n    .map(([role, count]) => `${count} ${role}(s)`)\n    .join(\", \");\n\n  const searchQuery = `Zahnarztpraxis Optimierung ${roomsSummary} ${staffSummary} Effizienz Layout`;\n  let coachKnowledge = \"\";\n  try {\n    const knowledgeResults = await searchKnowledge(searchQuery, 3);\n    coachKnowledge = formatKnowledgeContext(knowledgeResults);\n  } catch (error) {\n    console.log(\"No coaching knowledge available yet, using base standards\");\n  }\n\n  const systemPrompt = `Du bist ein erfahrener Zahnarztpraxis-Coach und Berater. Gib strukturierte Empfehlungen basierend auf den Praxisdaten. KEINE Quellenangaben, Dokumenttitel oder Kapitelnummern. Nur reiner Empfehlungstext, professionell und freundlich auf Deutsch.`;\n\n  const userPrompt = `${coachKnowledge}\n\nPRAXIS-DATEN:\n- Räume: ${roomsSummary || \"Noch keine Räume\"}\n- Personal: ${staffSummary || \"Noch kein Personal\"}\n- Layout-Effizienz Score: ${efficiencyScore}/100\n- Personal-Score: ${staffingScore}/100\n\nDEUTSCHE STANDARDS (Ergänzend):\n- Raumgrößen: Arbeitsstättenverordnung (ArbStättV) & Praxisbegehung\n- Personal: KV-Benchmarks (2.5-4.0 Mitarbeiter pro Arzt)\n- Patientenfluss: QM-Richtlinie G-BA\n\nAKTUELLE EMPFEHLUNGEN:\n${recommendations.map((r, i) => `${i + 1}. ${r}`).join('\\n')}\n\nAnalysiere die Praxis und gib strukturierte Empfehlungen.`;\n\n  try {\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt }\n      ],\n      max_tokens: 500,\n      response_format: zodResponseFormat(AIInsightsSchema, \"ai_insights\")\n    });\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) {\n      return \"KI-Analyse ist derzeit nicht verfügbar.\";\n    }\n\n    const parsed = AIInsightsSchema.safeParse(JSON.parse(content));\n    if (!parsed.success) {\n      console.error(\"AI Insights parse error:\", parsed.error);\n      return content;\n    }\n\n    const insight = parsed.data;\n    return `${insight.analysis}\\n\\n**Wichtigste Verbesserung:** ${insight.keyImprovement}\\n**Marktvergleich:** ${insight.marketComparison}\\n**Praxis-Tipp:** ${insight.practicalTip}`;\n  } catch (error) {\n    console.error(\"OpenAI API error:\", error);\n    return \"KI-Analyse ist vorübergehend nicht verfügbar. Bitte beachten Sie die benchmark-basierten Empfehlungen oben.\";\n  }\n}\n\nexport async function analyzeLayout(\n  rooms: Room[],\n  staff: Staff[],\n  operatingHours: number = 8,\n  scalePxPerMeter: number = DEFAULT_LAYOUT_SCALE_PX_PER_METER,\n  connections: WorkflowConnection[] = []\n): Promise<LayoutAnalysis> {\n  const efficiencyScore = calculateLayoutEfficiencyScore(rooms, scalePxPerMeter);\n  \n  const workflowAnalysis = computeWorkflowAnalysis(rooms, connections);\n  \n  const roomAnalyses = await analyzeRoomsWithKnowledge(rooms, scalePxPerMeter);\n  const avgRoomScore = roomAnalyses.length > 0\n    ? roomAnalyses.reduce((sum, r) => sum + r.sizeScore, 0) / roomAnalyses.length\n    : 50;\n\n  const staffingAnalysis = analyzeStaffing(staff, rooms);\n  \n  const capacityAnalysis = analyzeCapacity(rooms, staff, operatingHours);\n\n  const hasReception = rooms.some(r => normalizeRoomType(r.type) === \"reception\");\n  const hasWaiting = rooms.some(r => normalizeRoomType(r.type) === \"waiting\");\n  const examRoomCount = rooms.filter(r => normalizeRoomType(r.type) === \"exam\").length;\n  const hasLab = rooms.some(r => normalizeRoomType(r.type) === \"lab\");\n  const hasOffice = rooms.some(r => normalizeRoomType(r.type) === \"office\");\n\n  const knowledgeRecommendations = await getKnowledgePoweredRecommendations(\n    hasReception,\n    hasWaiting,\n    examRoomCount,\n    hasLab,\n    hasOffice\n  );\n\n  const recommendations: string[] = knowledgeRecommendations.map(rec => {\n    const citation = rec.citations.length > 0 ? ` [${formatCitations(rec.citations).join(\", \")}]` : \"\";\n    return rec.text + citation;\n  });\n\n  roomAnalyses.forEach(analysis => {\n    if (analysis.sizeAssessment !== \"optimal\") {\n      const source = analysis.source ? ` [${analysis.source}]` : \"\";\n      recommendations.push(`${analysis.roomName}: ${analysis.recommendation}${source}`);\n    }\n  });\n\n  Object.entries(staffingAnalysis.ratios).forEach(([key, ratio]) => {\n    if (ratio.score < 80) {\n      recommendations.push(ratio.recommendation);\n    }\n  });\n\n  const safeEfficiency = isNaN(efficiencyScore) ? 0 : efficiencyScore;\n  const safeRoomScore = isNaN(avgRoomScore) ? 50 : avgRoomScore;\n  const safeStaffingScore = isNaN(staffingAnalysis.overallScore) ? 50 : staffingAnalysis.overallScore;\n  const safeCapacityScore = isNaN(capacityAnalysis.capacityScore) || capacityAnalysis.capacityScore === null \n    ? 0 : capacityAnalysis.capacityScore;\n  \n  const overallScore = Math.round(\n    (safeEfficiency * 0.35) +\n    (safeRoomScore * 0.25) +\n    (safeStaffingScore * 0.25) +\n    (safeCapacityScore * 0.15)\n  );\n\n  const aiInsights = await generateAIInsights(\n    rooms,\n    staff,\n    efficiencyScore,\n    staffingAnalysis.overallScore,\n    recommendations.slice(0, 5)\n  );\n\n  return {\n    overallScore,\n    efficiencyScore: Math.round(efficiencyScore),\n    staffingScore: staffingAnalysis.overallScore,\n    spaceUtilizationScore: Math.round(avgRoomScore),\n    roomAnalyses,\n    staffingAnalysis,\n    capacityAnalysis,\n    recommendations: recommendations.slice(0, 10),\n    aiInsights,\n    workflowAnalysis\n  };\n}\n\nexport async function getQuickRecommendation(\n  rooms: Room[],\n  staff: Staff[],\n  question?: string,\n  scalePxPerMeter: number = DEFAULT_LAYOUT_SCALE_PX_PER_METER\n): Promise<string> {\n  const roomsByType = new Map<string, number>();\n  rooms.forEach(room => {\n    const normalizedType = normalizeRoomType(room.type);\n    roomsByType.set(normalizedType, (roomsByType.get(normalizedType) || 0) + 1);\n  });\n\n  const staffByRole = new Map<string, number>();\n  staff.forEach(s => {\n    staffByRole.set(s.role, (staffByRole.get(s.role) || 0) + 1);\n  });\n\n  const roomsSummary = Array.from(roomsByType.entries())\n    .map(([type, count]) => `${count} ${type}(s)`)\n    .join(\", \");\n  \n  const staffSummary = Array.from(staffByRole.entries())\n    .map(([role, count]) => `${count} ${role}(s)`)\n    .join(\", \");\n\n  const totalArea = rooms.reduce((sum, room) => sum + pixelsToSqM(room.width, room.height, scalePxPerMeter), 0);\n\n  const searchQuery = question || `Zahnarztpraxis Optimierung ${roomsSummary} ${staffSummary}`;\n  let coachKnowledge = \"\";\n  try {\n    const knowledgeResults = await searchKnowledge(searchQuery, 5);\n    coachKnowledge = formatKnowledgeContext(knowledgeResults);\n  } catch (error) {\n    console.log(\"No coaching knowledge available yet, using base standards\");\n  }\n\n  const prompt = `Du bist ein erfahrener Zahnarztpraxis-Coach.\n\n${coachKnowledge}\n\nPRAXIS-SETUP:\n- Räume: ${roomsSummary || \"Keine\"} (Gesamtfläche: ~${totalArea} m²)\n- Personal: ${staffSummary || \"Keines\"}\n\nDEUTSCHE STANDARDS (Ergänzend):\n- Behandlungsräume: 9-12 m² pro Raum, 3-4 pro Arzt\n- Mitarbeiter: 2.5-4.0 pro Arzt\n- Wartezeit-Ziel: <15 Min. (ausgezeichnet)\n\n${question ? `NUTZERFRAGE: ${question}` : \"Gib eine wichtige Empfehlung zur Verbesserung dieser Praxis.\"}\n\nGib eine konkrete, umsetzbare Empfehlung. KEINE Quellenangaben, Dokumenttitel oder Kapitelnummern. Unter 100 Wörter, auf Deutsch.`;\n\n  try {\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [{ role: \"user\", content: prompt }],\n      max_tokens: 300,\n      response_format: zodResponseFormat(QuickRecommendationSchema, \"quick_recommendation\")\n    });\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) {\n      return \"Empfehlung konnte nicht generiert werden.\";\n    }\n\n    const parsed = QuickRecommendationSchema.safeParse(JSON.parse(content));\n    if (!parsed.success) {\n      console.error(\"Quick recommendation parse error:\", parsed.error);\n      return content;\n    }\n\n    return parsed.data.recommendation;\n  } catch (error) {\n    console.error(\"OpenAI API error:\", error);\n    return \"KI-Empfehlungen sind vorübergehend nicht verfügbar. Bitte prüfen Sie Ihr Layout gegen die deutschen Standards.\";\n  }\n}\n","path":null,"size_bytes":22148,"size_tokens":null},"server/ai/benchmarks.ts":{"content":"export interface RoomSizeStandard {\n  minSqM: number;\n  maxSqM: number;\n  optimalSqM: number;\n  source: string;\n}\n\nexport interface StaffingRatio {\n  min: number;\n  max: number;\n  optimal: number;\n  source: string;\n}\n\nexport interface PatientFlowMetric {\n  excellent: number;\n  acceptable: number;\n  poor: number;\n  unit: string;\n  source: string;\n}\n\nexport const ROOM_SIZE_STANDARDS: Record<string, RoomSizeStandard> = {\n  reception: {\n    minSqM: 8,\n    maxSqM: 14,\n    optimalSqM: 10,\n    source: \"Arbeitsstättenverordnung (ArbStättV) - ASR A1.2\"\n  },\n  waiting: {\n    minSqM: 15,\n    maxSqM: 35,\n    optimalSqM: 22,\n    source: \"Praxisbegehung - 1.2-1.5 m² pro Sitzplatz, 12-15 Patienten\"\n  },\n  exam: {\n    minSqM: 9,\n    maxSqM: 12,\n    optimalSqM: 10,\n    source: \"Praxisbegehung & Hygieneverordnung - Behandlungsraum Standards\"\n  },\n  lab: {\n    minSqM: 8,\n    maxSqM: 15,\n    optimalSqM: 10,\n    source: \"RKI Laborrichtlinien & Hygieneverordnung\"\n  },\n  office: {\n    minSqM: 10,\n    maxSqM: 18,\n    optimalSqM: 14,\n    source: \"Arbeitsstättenverordnung (ArbStättV) - ASR A1.2\"\n  },\n  sterilization: {\n    minSqM: 8,\n    maxSqM: 14,\n    optimalSqM: 10.5,\n    source: \"RKI Aufbereitung Medizinprodukte & Hygieneverordnung\"\n  },\n  storage: {\n    minSqM: 4,\n    maxSqM: 10,\n    optimalSqM: 6,\n    source: \"Arbeitsstättenverordnung (ArbStättV) - Lagerräume\"\n  },\n  toilet: {\n    minSqM: 3,\n    maxSqM: 6,\n    optimalSqM: 4.4,\n    source: \"DIN 18040 Barrierefreies Bauen - Sanitärräume\"\n  },\n  kitchen: {\n    minSqM: 6,\n    maxSqM: 12,\n    optimalSqM: 7.5,\n    source: \"Arbeitsstättenverordnung (ArbStättV) - ASR A4.2 Pausenräume\"\n  },\n  changing: {\n    minSqM: 5,\n    maxSqM: 10,\n    optimalSqM: 6.6,\n    source: \"Arbeitsstättenverordnung (ArbStättV) - ASR A4.1 Umkleideräume\"\n  }\n};\n\nexport const STAFFING_RATIOS = {\n  supportStaffPerDentist: {\n    min: 1.5,\n    max: 2.5,\n    optimal: 2.0,\n    source: \"KZBV Praxis-Benchmarks\"\n  },\n  supportStaffPerPhysician: {\n    min: 2.5,\n    max: 4.0,\n    optimal: 3.0,\n    source: \"KV Praxisorganisation Empfehlungen\"\n  },\n  nursePerDoctor: {\n    min: 1.0,\n    max: 2.0,\n    optimal: 1.5,\n    source: \"Berufsverband der Medizinischen Fachangestellten\"\n  },\n  receptionistPerProvider: {\n    min: 0.33,\n    max: 0.5,\n    optimal: 0.4,\n    source: \"KV Empfehlung Praxisorganisation\"\n  },\n  examRoomsPerProvider: {\n    min: 2.0,\n    max: 4.0,\n    optimal: 3.0,\n    source: \"KV Praxisplanung - 3-4 Behandlungsräume pro Arzt optimal\"\n  }\n};\n\nexport const PATIENT_FLOW_METRICS = {\n  waitTime: {\n    excellent: 10,\n    acceptable: 20,\n    poor: 30,\n    unit: \"Minuten\",\n    source: \"Qualitätsmanagement-Richtlinie (QM-RL) - Gemeinsamer Bundesausschuss\"\n  },\n  patientsPerExamRoomPerDay: {\n    excellent: 12,\n    acceptable: 10,\n    poor: 6,\n    unit: \"Patienten/Raum/Tag\",\n    source: \"KV Benchmarks Praxisauslastung\"\n  },\n  patientThroughputPerHour: {\n    excellent: 4,\n    acceptable: 3,\n    poor: 2,\n    unit: \"Patienten/Stunde\",\n    source: \"Praxismanagement Leitfaden\"\n  },\n  appointmentDuration: {\n    excellent: 15,\n    acceptable: 20,\n    poor: 30,\n    unit: \"Minuten\",\n    source: \"EBM Einheitlicher Bewertungsmaßstab Zeitvorgaben\"\n  }\n};\n\nexport const LAYOUT_EFFICIENCY_PRINCIPLES = {\n  optimalFlow: [\n    \"Empfangsbereich sollte beim Betreten sofort sichtbar sein\",\n    \"Wartebereich sollte neben dem Empfang liegen (max. 15m Entfernung)\",\n    \"Behandlungsräume sollten gruppiert und gleich weit vom Wartebereich entfernt sein\",\n    \"Labor sollte zentral zwischen den Behandlungsräumen liegen für Effizienz\",\n    \"Büro/Verwaltung sollte Sichtverbindung zum Empfang haben, aber nicht im Patientenfluss\"\n  ],\n  distanceGuidelines: {\n    receptionToWaiting: { maxMeters: 10, optimal: 5, source: \"DIN 18040 Barrierefreies Bauen\" },\n    waitingToExam: { maxMeters: 25, optimal: 12, source: \"Praxisbegehung Laufwege\" },\n    examToLab: { maxMeters: 15, optimal: 8, source: \"RKI Probenhandhabung Richtlinien\" },\n    examToExam: { maxMeters: 10, optimal: 5, source: \"Praxiseffizienz Standards\" }\n  },\n  circulationPatterns: {\n    patientPath: \"Linear: Eingang → Empfang → Warten → Behandlung → Abrechnung\",\n    staffPath: \"Zirkulär: Sollte Patientenwege nicht häufig kreuzen\",\n    emergencyEgress: \"Mindestens 1,2m breite Flure (DIN 18040 Barrierefreiheit)\"\n  }\n};\n\nexport const INDUSTRY_BENCHMARKS = {\n  dentalPractice: {\n    avgSquareMetersPerOperatory: 37,\n    avgPatientsPerDayPerDentist: 12,\n    avgRevenuePerPatient: 300,\n    avgStaffCostPercentage: 25,\n    patientRetentionRate: 85,\n    source: \"KZBV Jahrbuch 2024\"\n  },\n  medicalPractice: {\n    avgSquareMetersPerExamRoom: 28,\n    avgPatientsPerDayPerPhysician: 25,\n    avgRevenuePerPatient: 45,\n    avgStaffCostPercentage: 28,\n    patientRetentionRate: 80,\n    source: \"Zi-Praxis-Panel 2024 (Zentralinstitut für die kassenärztliche Versorgung)\"\n  }\n};\n\nimport { pxAreaToSqM, pxToMeters, metersToPx, normalizeRoomType, DEFAULT_LAYOUT_SCALE_PX_PER_METER } from \"@shared/roomTypes\";\n\nexport function pixelsToSqM(widthPx: number, heightPx: number, scalePxPerMeter: number = DEFAULT_LAYOUT_SCALE_PX_PER_METER): number {\n  return pxAreaToSqM(widthPx, heightPx, scalePxPerMeter);\n}\n\nexport function sqMToPixels(sqM: number, scalePxPerMeter: number = DEFAULT_LAYOUT_SCALE_PX_PER_METER): number {\n  const sideM = Math.sqrt(sqM);\n  const sidePx = metersToPx(sideM, scalePxPerMeter);\n  return Math.round(sidePx * sidePx);\n}\n\nexport function evaluateRoomSize(\n  type: string, \n  widthPx: number, \n  heightPx: number,\n  scalePxPerMeter: number = DEFAULT_LAYOUT_SCALE_PX_PER_METER\n): {\n  score: number;\n  assessment: \"undersized\" | \"optimal\" | \"oversized\";\n  actualSqM: number;\n  recommendation: string;\n} {\n  const normalizedType = normalizeRoomType(type);\n  const standard = ROOM_SIZE_STANDARDS[normalizedType];\n  if (!standard) {\n    return {\n      score: 50,\n      assessment: \"optimal\",\n      actualSqM: 0,\n      recommendation: \"Unbekannter Raumtyp\"\n    };\n  }\n\n  const actualSqM = pxAreaToSqM(widthPx, heightPx, scalePxPerMeter);\n\n  let score: number;\n  let assessment: \"undersized\" | \"optimal\" | \"oversized\";\n  let recommendation: string;\n\n  if (actualSqM < standard.minSqM) {\n    const deficit = ((standard.minSqM - actualSqM) / standard.minSqM) * 100;\n    score = Math.max(0, 50 - deficit);\n    assessment = \"undersized\";\n    recommendation = `Raum ist ${Math.round(deficit)}% unter dem Minimum. Empfehlung: mindestens ${standard.minSqM} m² gemäß ${standard.source}.`;\n  } else if (actualSqM > standard.maxSqM) {\n    const excess = ((actualSqM - standard.maxSqM) / standard.maxSqM) * 100;\n    score = Math.max(60, 90 - (excess * 0.5));\n    assessment = \"oversized\";\n    recommendation = `Raum ist ${Math.round(excess)}% über dem Maximum. Raumnutzung optimieren.`;\n  } else {\n    const distanceFromOptimal = Math.abs(actualSqM - standard.optimalSqM);\n    const range = standard.maxSqM - standard.minSqM;\n    score = 100 - ((distanceFromOptimal / range) * 20);\n    assessment = \"optimal\";\n    recommendation = `Raumgröße entspricht den deutschen Standards. Optimale Größe: ${standard.optimalSqM} m².`;\n  }\n\n  return { score: Math.round(score), assessment, actualSqM, recommendation };\n}\n\nexport function evaluateRoomSizeM(\n  type: string, \n  widthM: number, \n  heightM: number\n): {\n  score: number;\n  assessment: \"undersized\" | \"optimal\" | \"oversized\";\n  actualSqM: number;\n  recommendation: string;\n} {\n  const normalizedType = normalizeRoomType(type);\n  const standard = ROOM_SIZE_STANDARDS[normalizedType];\n  if (!standard) {\n    return {\n      score: 50,\n      assessment: \"optimal\",\n      actualSqM: 0,\n      recommendation: \"Unbekannter Raumtyp\"\n    };\n  }\n\n  const actualSqM = widthM * heightM;\n\n  let score: number;\n  let assessment: \"undersized\" | \"optimal\" | \"oversized\";\n  let recommendation: string;\n\n  if (actualSqM < standard.minSqM) {\n    const deficit = ((standard.minSqM - actualSqM) / standard.minSqM) * 100;\n    score = Math.max(0, 50 - deficit);\n    assessment = \"undersized\";\n    recommendation = `Raum ist ${Math.round(deficit)}% unter dem Minimum. Empfehlung: mindestens ${standard.minSqM} m² gemäß ${standard.source}.`;\n  } else if (actualSqM > standard.maxSqM) {\n    const excess = ((actualSqM - standard.maxSqM) / standard.maxSqM) * 100;\n    score = Math.max(60, 90 - (excess * 0.5));\n    assessment = \"oversized\";\n    recommendation = `Raum ist ${Math.round(excess)}% über dem Maximum. Raumnutzung optimieren.`;\n  } else {\n    const distanceFromOptimal = Math.abs(actualSqM - standard.optimalSqM);\n    const range = standard.maxSqM - standard.minSqM;\n    score = 100 - ((distanceFromOptimal / range) * 20);\n    assessment = \"optimal\";\n    recommendation = `Raumgröße entspricht den deutschen Standards. Optimale Größe: ${standard.optimalSqM} m².`;\n  }\n\n  return { score: Math.round(score), assessment, actualSqM, recommendation };\n}\n\nexport function evaluateStaffingRatios(\n  doctors: number,\n  nurses: number,\n  receptionists: number,\n  totalStaff: number,\n  examRooms: number,\n  practiceType: \"dental\" | \"medical\" = \"dental\"\n): {\n  overallScore: number;\n  ratios: Record<string, { actual: number; optimal: number; score: number; recommendation: string }>;\n} {\n  const ratios: Record<string, { actual: number; optimal: number; score: number; recommendation: string }> = {};\n\n  if (doctors > 0) {\n    const supportStaff = totalStaff - doctors;\n    const supportRatio = supportStaff / doctors;\n    const benchmark = practiceType === \"dental\" \n      ? STAFFING_RATIOS.supportStaffPerDentist \n      : STAFFING_RATIOS.supportStaffPerPhysician;\n    \n    let score: number;\n    let recommendation: string;\n    \n    if (supportRatio < benchmark.min) {\n      score = Math.max(30, 70 - ((benchmark.min - supportRatio) / benchmark.min * 40));\n      recommendation = `Unterbesetzt: ${supportRatio.toFixed(1)} Mitarbeiter pro Arzt. Empfehlung: ${benchmark.optimal} pro Arzt.`;\n    } else if (supportRatio > benchmark.max) {\n      score = Math.max(60, 90 - ((supportRatio - benchmark.max) / benchmark.max * 30));\n      recommendation = `Überbesetzt: ${supportRatio.toFixed(1)} Mitarbeiter pro Arzt. Optimierung auf ${benchmark.optimal} empfohlen.`;\n    } else {\n      score = 85 + ((1 - Math.abs(supportRatio - benchmark.optimal) / (benchmark.max - benchmark.min)) * 15);\n      recommendation = `Gutes Personalverhältnis von ${supportRatio.toFixed(1)} Mitarbeitern pro Arzt.`;\n    }\n    \n    ratios.supportStaffRatio = { actual: supportRatio, optimal: benchmark.optimal, score: Math.round(score), recommendation };\n  }\n\n  if (doctors > 0 && nurses > 0) {\n    const nurseRatio = nurses / doctors;\n    const benchmark = STAFFING_RATIOS.nursePerDoctor;\n    \n    let score: number;\n    let recommendation: string;\n    \n    if (nurseRatio < benchmark.min) {\n      score = Math.max(40, 75 - ((benchmark.min - nurseRatio) / benchmark.min * 35));\n      recommendation = `Niedriges MFA-Verhältnis: ${nurseRatio.toFixed(1)}. Empfehlung: ${benchmark.optimal} MFA pro Arzt.`;\n    } else if (nurseRatio > benchmark.max) {\n      score = Math.max(70, 95 - ((nurseRatio - benchmark.max) / benchmark.max * 25));\n      recommendation = `Hohes MFA-Verhältnis: ${nurseRatio.toFixed(1)}. Möglicherweise über dem Optimum von ${benchmark.optimal}.`;\n    } else {\n      score = 90 + ((1 - Math.abs(nurseRatio - benchmark.optimal) / (benchmark.max - benchmark.min)) * 10);\n      recommendation = `Ausgezeichnetes MFA-zu-Arzt-Verhältnis von ${nurseRatio.toFixed(1)}.`;\n    }\n    \n    ratios.nurseRatio = { actual: nurseRatio, optimal: benchmark.optimal, score: Math.round(score), recommendation };\n  }\n\n  if (doctors > 0 && examRooms > 0) {\n    const roomRatio = examRooms / doctors;\n    const benchmark = STAFFING_RATIOS.examRoomsPerProvider;\n    \n    let score: number;\n    let recommendation: string;\n    \n    if (roomRatio < benchmark.min) {\n      score = Math.max(35, 70 - ((benchmark.min - roomRatio) / benchmark.min * 35));\n      recommendation = `Zu wenig Behandlungsräume (${roomRatio.toFixed(1)} pro Arzt). Empfehlung: ${benchmark.optimal} für optimalen Patientenfluss.`;\n    } else if (roomRatio > benchmark.max) {\n      score = Math.max(65, 90 - ((roomRatio - benchmark.max) / benchmark.max * 25));\n      recommendation = `Überschuss an Behandlungsräumen (${roomRatio.toFixed(1)} pro Arzt). ${benchmark.optimal} wäre effizienter.`;\n    } else {\n      score = 88 + ((1 - Math.abs(roomRatio - benchmark.optimal) / (benchmark.max - benchmark.min)) * 12);\n      recommendation = `Gutes Verhältnis von ${roomRatio.toFixed(1)} Behandlungsräumen pro Arzt.`;\n    }\n    \n    ratios.examRoomRatio = { actual: roomRatio, optimal: benchmark.optimal, score: Math.round(score), recommendation };\n  }\n\n  const scores = Object.values(ratios).map(r => r.score);\n  const overallScore = scores.length > 0 \n    ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) \n    : 50;\n\n  return { overallScore, ratios };\n}\n\nexport function calculatePatientCapacityBenchmark(\n  examRooms: number,\n  operatingHours: number,\n  providers: number\n): {\n  estimatedCapacity: number;\n  capacityScore: number;\n  benchmarkComparison: string;\n} {\n  if (examRooms === 0) {\n    return {\n      estimatedCapacity: 0,\n      capacityScore: 0,\n      benchmarkComparison: \"Keine Behandlungsräume - Behandlungsräume hinzufügen um Kapazität zu berechnen\"\n    };\n  }\n\n  const patientsPerRoomPerDay = PATIENT_FLOW_METRICS.patientsPerExamRoomPerDay.acceptable;\n  const throughputPerHour = PATIENT_FLOW_METRICS.patientThroughputPerHour.acceptable;\n  \n  const roomBasedCapacity = examRooms * patientsPerRoomPerDay;\n  const providerBasedCapacity = providers > 0 \n    ? providers * throughputPerHour * operatingHours \n    : roomBasedCapacity;\n  \n  const estimatedCapacity = Math.min(roomBasedCapacity, providerBasedCapacity);\n  \n  const excellentCapacity = examRooms * PATIENT_FLOW_METRICS.patientsPerExamRoomPerDay.excellent;\n  const capacityScore = excellentCapacity > 0 \n    ? Math.min(100, Math.round((estimatedCapacity / excellentCapacity) * 100))\n    : 0;\n  \n  let benchmarkComparison: string;\n  if (estimatedCapacity >= excellentCapacity * 0.9) {\n    benchmarkComparison = \"Ausgezeichnete Kapazitätsauslastung - Top 10% der Praxen\";\n  } else if (estimatedCapacity >= excellentCapacity * 0.7) {\n    benchmarkComparison = \"Gute Kapazität - über dem Branchendurchschnitt\";\n  } else {\n    benchmarkComparison = \"Unterdurchschnittliche Kapazität - Verbesserungspotenzial vorhanden\";\n  }\n\n  return { estimatedCapacity, capacityScore, benchmarkComparison };\n}\n\nexport function getLayoutRecommendations(\n  hasReception: boolean,\n  hasWaiting: boolean,\n  examRoomCount: number,\n  hasLab: boolean,\n  hasOffice: boolean\n): string[] {\n  const recommendations: string[] = [];\n\n  if (!hasReception) {\n    recommendations.push(\"KRITISCH: Empfangsbereich hinzufügen. Unerlässlich für Patientenanmeldung und ersten Eindruck.\");\n  }\n  \n  if (!hasWaiting) {\n    recommendations.push(\"KRITISCH: Wartebereich hinzufügen. Patienten benötigen einen komfortablen Raum während der Wartezeit.\");\n  }\n  \n  if (examRoomCount === 0) {\n    recommendations.push(\"KRITISCH: Behandlungsräume hinzufügen. Diese sind der Kern Ihrer Praxistätigkeit.\");\n  } else if (examRoomCount === 1) {\n    recommendations.push(\"Erwägen Sie weitere Behandlungsräume. Standard ist 3-4 pro Arzt für optimale Effizienz (KV-Empfehlung).\");\n  }\n  \n  if (!hasLab && examRoomCount > 0) {\n    recommendations.push(\"Erwägen Sie einen Laborbereich. Ein Labor neben den Behandlungsräumen reduziert Wartezeiten um 15-20%.\");\n  }\n  \n  if (!hasOffice) {\n    recommendations.push(\"Erwägen Sie ein Büro für Beratungsgespräche und Verwaltungsarbeit.\");\n  }\n\n  if (recommendations.length === 0) {\n    recommendations.push(\"Ihr Layout enthält alle wesentlichen Raumtypen. Fokussieren Sie auf Optimierung der Raumplatzierung und -größen.\");\n  }\n\n  return recommendations;\n}\n","path":null,"size_bytes":15953,"size_tokens":null},"client/src/components/layout/GlobalAIPanel.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { api, type LayoutAnalysis } from \"@/lib/api\";\nimport { usePractice } from \"@/contexts/PracticeContext\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { \n  Sparkles, \n  TrendingUp, \n  Users, \n  LayoutGrid, \n  Target,\n  ChevronDown,\n  ChevronUp,\n  MessageSquare,\n  Send,\n  Loader2,\n  AlertCircle,\n  CheckCircle,\n  AlertTriangle,\n  RefreshCw,\n  Brain,\n  Lightbulb,\n  Activity,\n  Zap,\n  ArrowRight,\n  PenTool,\n  PlayCircle,\n  LayoutDashboard\n} from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { useTranslation } from \"react-i18next\";\nimport { Link } from \"wouter\";\n\nfunction ScoreRing({ score, size = 120, t }: { score: number; size?: number; t: (key: string) => string }) {\n  const safeScore = typeof score === 'number' && !isNaN(score) ? Math.max(0, Math.min(100, score)) : 0;\n  const strokeWidth = 8;\n  const radius = (size - strokeWidth) / 2;\n  const circumference = radius * 2 * Math.PI;\n  const offset = circumference - (safeScore / 100) * circumference;\n  \n  const getColor = (s: number) => {\n    if (s >= 80) return { stroke: \"#22c55e\", bg: \"from-green-500/20 to-green-500/5\" };\n    if (s >= 60) return { stroke: \"#eab308\", bg: \"from-yellow-500/20 to-yellow-500/5\" };\n    return { stroke: \"#ef4444\", bg: \"from-red-500/20 to-red-500/5\" };\n  };\n  \n  const colors = getColor(safeScore);\n  \n  return (\n    <div className={cn(\"relative flex items-center justify-center rounded-full bg-gradient-to-b\", colors.bg)} style={{ width: size, height: size }}>\n      <svg width={size} height={size} className=\"absolute -rotate-90\">\n        <circle\n          cx={size / 2}\n          cy={size / 2}\n          r={radius}\n          fill=\"none\"\n          stroke=\"currentColor\"\n          strokeWidth={strokeWidth}\n          className=\"text-muted/20\"\n        />\n        <motion.circle\n          cx={size / 2}\n          cy={size / 2}\n          r={radius}\n          fill=\"none\"\n          stroke={colors.stroke}\n          strokeWidth={strokeWidth}\n          strokeLinecap=\"round\"\n          initial={{ strokeDasharray: circumference, strokeDashoffset: circumference }}\n          animate={{ strokeDashoffset: offset }}\n          transition={{ duration: 1, ease: \"easeOut\" }}\n        />\n      </svg>\n      <div className=\"text-center z-10\">\n        <div className=\"text-3xl font-bold\" style={{ color: colors.stroke }}>{safeScore}</div>\n        <div className=\"text-[10px] uppercase tracking-wider text-muted-foreground font-medium\">{t(\"ai.score\")}</div>\n      </div>\n    </div>\n  );\n}\n\nfunction MetricBar({ label, value, icon: Icon, color }: { label: string; value: number; icon: React.ElementType; color: string }) {\n  const safeValue = typeof value === 'number' && !isNaN(value) ? Math.max(0, Math.min(100, value)) : 0;\n  \n  return (\n    <div className=\"group\">\n      <div className=\"flex items-center justify-between mb-1.5\">\n        <div className=\"flex items-center gap-2\">\n          <div className={cn(\"p-1 rounded\", color)}>\n            <Icon className=\"h-3 w-3 text-white\" />\n          </div>\n          <span className=\"text-xs font-medium text-muted-foreground group-hover:text-foreground transition-colors\">{label}</span>\n        </div>\n        <span className=\"text-xs font-bold\">{safeValue}%</span>\n      </div>\n      <div className=\"h-1.5 bg-muted/50 rounded-full overflow-hidden\">\n        <motion.div \n          className={cn(\"h-full rounded-full\", color)}\n          initial={{ width: 0 }}\n          animate={{ width: `${safeValue}%` }}\n          transition={{ duration: 0.8, ease: \"easeOut\" }}\n        />\n      </div>\n    </div>\n  );\n}\n\nfunction QuickAction({ icon: Icon, label, href, active }: { icon: React.ElementType; label: string; href: string; active?: boolean }) {\n  return (\n    <Link href={href}>\n      <div className={cn(\n        \"flex items-center gap-2 p-2 rounded-lg cursor-pointer transition-all text-xs font-medium\",\n        active \n          ? \"bg-primary/10 text-primary border border-primary/20\" \n          : \"hover:bg-muted text-muted-foreground hover:text-foreground\"\n      )}>\n        <Icon className=\"h-3.5 w-3.5\" />\n        <span>{label}</span>\n      </div>\n    </Link>\n  );\n}\n\nfunction RecommendationPill({ text, priority }: { text: string; priority: \"high\" | \"medium\" | \"low\" }) {\n  const colors = {\n    high: \"bg-red-50 border-red-200 text-red-700\",\n    medium: \"bg-yellow-50 border-yellow-200 text-yellow-700\",\n    low: \"bg-green-50 border-green-200 text-green-700\"\n  };\n  \n  const icons = {\n    high: AlertCircle,\n    medium: AlertTriangle,\n    low: Lightbulb\n  };\n  \n  const Icon = icons[priority];\n  \n  return (\n    <div className={cn(\"flex items-start gap-2 p-2.5 rounded-lg border text-xs\", colors[priority])}>\n      <Icon className=\"h-3.5 w-3.5 shrink-0 mt-0.5\" />\n      <span className=\"leading-relaxed\">{text}</span>\n    </div>\n  );\n}\n\nexport function GlobalAIPanel() {\n  const { t } = useTranslation();\n  const [location] = useLocation();\n  const { practiceId } = usePractice();\n  const [question, setQuestion] = useState(\"\");\n  const [isExpanded, setIsExpanded] = useState(false);\n\n  const { data: analysis, isLoading, refetch, isFetching } = useQuery({\n    queryKey: [\"ai-analysis\", practiceId],\n    queryFn: () => api.ai.analyzeLayout({ practiceId: practiceId!, operatingHours: 8 }),\n    enabled: !!practiceId,\n    staleTime: 30000,\n    refetchOnWindowFocus: false,\n  });\n\n  const askMutation = useMutation({\n    mutationFn: (q: string) => api.ai.getRecommendation({ practiceId: practiceId!, question: q }),\n  });\n\n  const handleAsk = () => {\n    if (question.trim()) {\n      askMutation.mutate(question);\n      setQuestion(\"\");\n    }\n  };\n\n  const getContextualTitle = () => {\n    switch (location) {\n      case \"/\": return t(\"ai.practiceOverview\");\n      case \"/editor\": return t(\"ai.layoutAnalysis\");\n      case \"/staff\": return t(\"ai.staffingInsights\");\n      case \"/simulation\": return t(\"ai.simulationAnalysis\");\n      default: return t(\"ai.aiInsights\");\n    }\n  };\n\n  const getContextualTip = () => {\n    switch (location) {\n      case \"/\": \n        return t(\"ai.dashboardTip\");\n      case \"/editor\": \n        return t(\"ai.layoutTip\");\n      case \"/staff\": \n        return t(\"ai.staffTip\");\n      case \"/simulation\": \n        return t(\"ai.simulationTip\");\n      default: \n        return t(\"ai.defaultTip\");\n    }\n  };\n\n  const getPriorityRecommendations = () => {\n    if (!analysis?.recommendations) return [];\n    return analysis.recommendations.slice(0, 3).map((rec, i) => ({\n      text: rec,\n      priority: i === 0 ? \"high\" as const : i === 1 ? \"medium\" as const : \"low\" as const\n    }));\n  };\n\n  if (!isExpanded) {\n    return (\n      <div className=\"w-12 border-l bg-gradient-to-b from-purple-50/50 to-blue-50/50 flex flex-col items-center py-4 gap-4\">\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          onClick={() => setIsExpanded(true)}\n          className=\"h-10 w-10 rounded-xl bg-gradient-to-br from-purple-500 to-blue-500 text-white hover:opacity-90\"\n          data-testid=\"button-expand-ai\"\n        >\n          <Brain className=\"h-5 w-5\" />\n        </Button>\n        {analysis && (\n          <div className=\"flex flex-col items-center gap-1\">\n            <div className={cn(\n              \"text-lg font-bold\",\n              (analysis.overallScore ?? 0) >= 80 ? \"text-green-600\" : \n              (analysis.overallScore ?? 0) >= 60 ? \"text-yellow-600\" : \"text-red-600\"\n            )}>\n              {analysis.overallScore ?? 0}\n            </div>\n            <Activity className=\"h-3 w-3 text-muted-foreground\" />\n          </div>\n        )}\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"w-80 border-l bg-gradient-to-b from-slate-50 to-white flex flex-col shadow-xl\">\n      <div className=\"p-4 border-b bg-gradient-to-r from-purple-600 to-blue-600\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <div className=\"p-1.5 rounded-lg bg-white/20 backdrop-blur\">\n              <Brain className=\"h-4 w-4 text-white\" />\n            </div>\n            <div>\n              <h3 className=\"font-semibold text-white text-sm\">{getContextualTitle()}</h3>\n              <p className=\"text-[10px] text-white/70\">{t(\"ai.poweredByAI\")}</p>\n            </div>\n          </div>\n          <div className=\"flex gap-1\">\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              className=\"h-7 w-7 text-white/80 hover:text-white hover:bg-white/10\"\n              onClick={() => refetch()}\n              disabled={isFetching}\n              data-testid=\"button-refresh-ai\"\n            >\n              <RefreshCw className={cn(\"h-3.5 w-3.5\", isFetching && \"animate-spin\")} />\n            </Button>\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              className=\"h-7 w-7 text-white/80 hover:text-white hover:bg-white/10\"\n              onClick={() => setIsExpanded(false)}\n              data-testid=\"button-collapse-ai\"\n            >\n              <ChevronDown className=\"h-3.5 w-3.5\" />\n            </Button>\n          </div>\n        </div>\n      </div>\n\n      <ScrollArea className=\"flex-1\">\n        <div className=\"p-4 space-y-4\">\n          <div className=\"flex items-start gap-2 p-3 rounded-xl bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-100\">\n            <Sparkles className=\"h-4 w-4 text-purple-500 shrink-0 mt-0.5\" />\n            <p className=\"text-xs text-slate-600 leading-relaxed\">{getContextualTip()}</p>\n          </div>\n\n          {isLoading ? (\n            <div className=\"flex flex-col items-center justify-center py-12 gap-3\">\n              <div className=\"relative\">\n                <div className=\"absolute inset-0 rounded-full bg-purple-500/20 animate-ping\" />\n                <Loader2 className=\"h-8 w-8 animate-spin text-purple-500 relative\" />\n              </div>\n              <p className=\"text-xs text-muted-foreground\">{t(\"ai.analyzingPractice\")}</p>\n            </div>\n          ) : analysis ? (\n            <>\n              <div className=\"flex justify-center py-2\">\n                <ScoreRing score={analysis.overallScore ?? 0} t={t} />\n              </div>\n\n              <div className=\"space-y-3\">\n                <MetricBar \n                  label={t(\"ai.layoutEfficiency\")} \n                  value={analysis.efficiencyScore ?? 0} \n                  icon={LayoutGrid} \n                  color=\"bg-purple-500\" \n                />\n                <MetricBar \n                  label={t(\"ai.staffingOptimization\")} \n                  value={analysis.staffingScore ?? 0} \n                  icon={Users} \n                  color=\"bg-blue-500\" \n                />\n                <MetricBar \n                  label={t(\"ai.spaceUtilization\")} \n                  value={analysis.spaceUtilizationScore ?? 0} \n                  icon={Target} \n                  color=\"bg-emerald-500\" \n                />\n              </div>\n\n              <div className=\"p-3 rounded-xl bg-slate-50 border\">\n                <div className=\"flex items-center justify-between mb-2\">\n                  <span className=\"text-xs font-semibold text-muted-foreground\">{t(\"ai.dailyCapacity\")}</span>\n                  <span className=\"text-lg font-bold text-foreground\">{analysis.capacityAnalysis.estimatedCapacity}</span>\n                </div>\n                <p className=\"text-[10px] text-muted-foreground\">{analysis.capacityAnalysis.benchmarkComparison}</p>\n              </div>\n\n              <Separator />\n\n              <div>\n                <div className=\"flex items-center gap-2 mb-3\">\n                  <Zap className=\"h-4 w-4 text-amber-500\" />\n                  <span className=\"text-xs font-semibold\">{t(\"ai.priorityActions\")}</span>\n                </div>\n                <div className=\"space-y-2\">\n                  {getPriorityRecommendations().map((rec, i) => (\n                    <RecommendationPill key={i} text={rec.text} priority={rec.priority} />\n                  ))}\n                </div>\n              </div>\n\n              <Separator />\n\n              <div>\n                <div className=\"flex items-center gap-2 mb-3\">\n                  <ArrowRight className=\"h-4 w-4 text-muted-foreground\" />\n                  <span className=\"text-xs font-semibold\">{t(\"ai.quickActions\")}</span>\n                </div>\n                <div className=\"grid grid-cols-2 gap-2\">\n                  <QuickAction icon={LayoutDashboard} label={t(\"common.dashboard\")} href=\"/\" active={location === \"/\"} />\n                  <QuickAction icon={PenTool} label={t(\"common.layout\")} href=\"/editor\" active={location === \"/editor\"} />\n                  <QuickAction icon={Users} label={t(\"common.staff\")} href=\"/staff\" active={location === \"/staff\"} />\n                  <QuickAction icon={PlayCircle} label={t(\"common.simulate\")} href=\"/simulation\" active={location === \"/simulation\"} />\n                </div>\n              </div>\n\n              <Separator />\n\n              <div className=\"p-3 rounded-xl bg-purple-50 border border-purple-100\">\n                <p className=\"text-xs text-purple-800 leading-relaxed\" data-testid=\"text-ai-insights\">\n                  {analysis.aiInsights}\n                </p>\n              </div>\n            </>\n          ) : (\n            <div className=\"text-center py-8\">\n              <AlertCircle className=\"h-8 w-8 text-muted-foreground mx-auto mb-2\" />\n              <p className=\"text-sm text-muted-foreground\">{t(\"ai.unableToLoad\")}</p>\n              <Button variant=\"link\" size=\"sm\" onClick={() => refetch()}>\n                {t(\"ai.tryAgain\")}\n              </Button>\n            </div>\n          )}\n        </div>\n      </ScrollArea>\n\n      <div className=\"p-4 border-t bg-white\">\n        <div className=\"flex items-center gap-2 mb-2\">\n          <MessageSquare className=\"h-4 w-4 text-purple-500\" />\n          <span className=\"text-xs font-semibold\">{t(\"ai.askAI\")}</span>\n        </div>\n        <div className=\"flex gap-2\">\n          <Input\n            placeholder={t(\"ai.howCanIImprove\")}\n            value={question}\n            onChange={(e) => setQuestion(e.target.value)}\n            onKeyDown={(e) => e.key === \"Enter\" && handleAsk()}\n            className=\"text-xs h-9\"\n            data-testid=\"input-global-ask\"\n          />\n          <Button\n            size=\"icon\"\n            className=\"h-9 w-9 bg-gradient-to-r from-purple-500 to-blue-500 hover:opacity-90\"\n            onClick={handleAsk}\n            disabled={!question.trim() || askMutation.isPending}\n            data-testid=\"button-global-ask\"\n          >\n            {askMutation.isPending ? (\n              <Loader2 className=\"h-4 w-4 animate-spin\" />\n            ) : (\n              <Send className=\"h-4 w-4\" />\n            )}\n          </Button>\n        </div>\n        <AnimatePresence>\n          {askMutation.data && (\n            <motion.div\n              initial={{ opacity: 0, y: 10 }}\n              animate={{ opacity: 1, y: 0 }}\n              exit={{ opacity: 0, y: 10 }}\n              className=\"mt-3 p-3 rounded-lg bg-blue-50 border border-blue-100\"\n            >\n              <p className=\"text-xs text-blue-800 leading-relaxed\" data-testid=\"text-global-response\">\n                {askMutation.data.recommendation}\n              </p>\n            </motion.div>\n          )}\n        </AnimatePresence>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":15669,"size_tokens":null},"client/src/components/layout/AppLayout.tsx":{"content":"import { ReactNode } from \"react\";\nimport { Sidebar } from \"./Sidebar\";\nimport { MobileNav } from \"./MobileNav\";\nimport { GlobalAIPanel } from \"./GlobalAIPanel\";\n\ninterface AppLayoutProps {\n  children: ReactNode;\n}\n\nexport function AppLayout({ children }: AppLayoutProps) {\n  return (\n    <div className=\"flex h-screen bg-background flex-col md:flex-row\">\n      <MobileNav />\n      <div className=\"hidden md:block\">\n        <Sidebar />\n      </div>\n      <main className=\"flex-1 overflow-y-auto\">\n        {children}\n      </main>\n      <div className=\"hidden lg:block\">\n        <GlobalAIPanel />\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":627,"size_tokens":null},"client/src/components/layout/MobileNav.tsx":{"content":"import { useState } from \"react\";\nimport { Link, useLocation } from \"wouter\";\nimport { cn } from \"@/lib/utils\";\nimport { LayoutDashboard, PenTool, Users, PlayCircle, Brain, Menu, X, Activity, Settings, BookOpen } from \"lucide-react\";\nimport { useTranslation } from \"react-i18next\";\nimport { LanguageToggle } from \"./LanguageToggle\";\nimport { Button } from \"@/components/ui/button\";\nimport { Sheet, SheetContent, SheetTrigger } from \"@/components/ui/sheet\";\n\nexport function MobileNav() {\n  const [open, setOpen] = useState(false);\n  const [location] = useLocation();\n  const { t } = useTranslation();\n\n  const navItems = [\n    { icon: LayoutDashboard, label: t(\"nav.dashboard\"), href: \"/\" },\n    { icon: PenTool, label: t(\"nav.layout\"), href: \"/editor\" },\n    { icon: Users, label: t(\"nav.staff\"), href: \"/staff\" },\n    { icon: PlayCircle, label: t(\"nav.simulation\"), href: \"/simulation\" },\n    { icon: Brain, label: t(\"nav.knowledge\", \"Coach-Wissen\"), href: \"/knowledge\" },\n    { icon: BookOpen, label: t(\"nav.playbooks\", \"Playbooks\"), href: \"/playbooks\" },\n  ];\n\n  return (\n    <div className=\"md:hidden flex h-14 items-center justify-between border-b bg-background px-4\">\n      <div className=\"flex items-center gap-2\">\n        <Activity className=\"h-5 w-5 text-primary\" />\n        <span className=\"font-bold text-sm\">{t(\"app.title\")}</span>\n      </div>\n      \n      <Sheet open={open} onOpenChange={setOpen}>\n        <SheetTrigger asChild>\n          <Button variant=\"ghost\" size=\"icon\" data-testid=\"button-mobile-menu\">\n            <Menu className=\"h-5 w-5\" />\n          </Button>\n        </SheetTrigger>\n        <SheetContent side=\"left\" className=\"w-64 p-0\">\n          <div className=\"flex h-14 items-center border-b px-4\">\n            <Activity className=\"mr-2 h-5 w-5 text-primary\" />\n            <span className=\"font-bold\">{t(\"app.title\")}</span>\n          </div>\n          <nav className=\"flex-1 py-4 px-2 space-y-1\">\n            {navItems.map((item) => {\n              const isActive = location === item.href;\n              return (\n                <Link \n                  key={item.href} \n                  href={item.href}\n                  onClick={() => setOpen(false)}\n                  className={cn(\n                    \"flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium transition-colors\",\n                    isActive ? \"bg-accent text-accent-foreground\" : \"text-muted-foreground hover:bg-accent\"\n                  )}\n                >\n                  <item.icon className=\"h-4 w-4\" />\n                  {item.label}\n                </Link>\n              );\n            })}\n          </nav>\n          <div className=\"border-t p-4 space-y-2\">\n            <LanguageToggle />\n            <div className=\"flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium text-muted-foreground\">\n              <Settings className=\"h-4 w-4\" />\n              {t(\"nav.settings\")}\n            </div>\n          </div>\n        </SheetContent>\n      </Sheet>\n    </div>\n  );\n}\n","path":null,"size_bytes":3004,"size_tokens":null},"server/ai/coachChat.ts":{"content":"import OpenAI from \"openai\";\nimport { tavily } from \"@tavily/core\";\nimport { searchKnowledge, formatKnowledgeContext } from \"./knowledgeProcessor\";\n\nconst openai = new OpenAI({\n  apiKey: process.env.OPENAI_API_KEY\n});\n\nconst tavilyClient = process.env.TAVILY_API_KEY \n  ? tavily({ apiKey: process.env.TAVILY_API_KEY })\n  : null;\n\nexport interface CoachChatResponse {\n  answer: string;\n  sources: Array<{ title: string; category: string }>;\n  webResults?: Array<{ title: string; url: string; snippet: string }>;\n}\n\nasync function performWebSearch(query: string): Promise<Array<{ title: string; url: string; snippet: string }>> {\n  if (!tavilyClient) {\n    console.log(\"Tavily API key not configured, skipping web search\");\n    return [];\n  }\n\n  try {\n    const germanQuery = `${query} Zahnarztpraxis Deutschland`;\n    \n    const response = await tavilyClient.search(germanQuery, {\n      searchDepth: \"basic\",\n      maxResults: 3,\n      includeAnswer: false,\n    });\n\n    return response.results.map((result) => ({\n      title: result.title || \"Brancheninfo\",\n      url: result.url || \"\",\n      snippet: result.content || \"\"\n    }));\n  } catch (error) {\n    console.error(\"Tavily web search error:\", error);\n    return [];\n  }\n}\n\nexport async function generateCoachResponse(question: string): Promise<CoachChatResponse> {\n  const knowledgeResults = await searchKnowledge(question, 5);\n  const coachKnowledge = formatKnowledgeContext(knowledgeResults);\n  \n  const sources = knowledgeResults.map(r => ({\n    title: r.source.title,\n    category: r.source.category\n  }));\n\n  const webResults = await performWebSearch(question);\n\n  const webContext = webResults.length > 0 \n    ? `\\n\\n=== AKTUELLE BRANCHENINFORMATIONEN ===\\n${webResults.map((r, i) => `${i + 1}. ${r.title}: ${r.snippet}`).join('\\n')}\\n=== ENDE BRANCHENINFO ===`\n    : \"\";\n\n  const systemPrompt = `Du bist ein erfahrener **AI Praxis-Coach** für Zahnarztpraxen. Deine Rolle:\n\n1. **Primäre Wissensbasis**: Nutze das Coach-Wissen aus den Dokumenten als Hauptquelle\n2. **Ergänzende Informationen**: Integriere aktuelle Brancheninfos wenn relevant\n3. **Deutsche Standards**: Berücksichtige ArbStättV, KV-Benchmarks, GOZ, QM-RL\n4. **Praxisnah**: Gib konkrete, umsetzbare Empfehlungen\n\n**Kommunikationsstil:**\n- Professionell aber freundlich\n- Strukturiert mit Aufzählungen wenn sinnvoll\n- Keine übermäßig langen Antworten (max. 200-300 Wörter)\n- Zitiere Quellen wenn du auf Coach-Wissen referenzierst\n\nDu berätst zu allen Themen rund um die Zahnarztpraxis: Effizienz, Personal, Abrechnung, Marketing, Kommunikation, Compliance, Raumplanung und mehr.`;\n\n  const userPrompt = `${coachKnowledge}${webContext}\n\nNUTZERFRAGE: ${question}\n\nGib eine hilfreiche, strukturierte Antwort basierend auf deinem Coach-Wissen. Wenn relevantes Coach-Wissen vorhanden ist, nutze es aktiv und verweise darauf.`;\n\n  try {\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt }\n      ],\n      max_tokens: 800,\n      temperature: 0.7\n    });\n\n    const answer = response.choices[0]?.message?.content || \"Entschuldigung, ich konnte keine Antwort generieren.\";\n\n    return {\n      answer,\n      sources,\n      webResults: webResults.length > 0 ? webResults : undefined\n    };\n  } catch (error) {\n    console.error(\"Coach chat error:\", error);\n    throw new Error(\"Fehler bei der KI-Antwort. Bitte versuchen Sie es erneut.\");\n  }\n}\n","path":null,"size_bytes":3515,"size_tokens":null},"client/src/pages/Knowledge.tsx":{"content":"import { useState, useRef, useEffect } from \"react\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Brain, Send, Loader2, User, Sparkles, RefreshCw } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface Message {\n  id: string;\n  role: \"user\" | \"assistant\";\n  content: string;\n  sources?: Array<{ title: string; category: string }>;\n  isStreaming?: boolean;\n}\n\nconst WELCOME_MESSAGE: Message = {\n  id: \"welcome\",\n  role: \"assistant\",\n  content: `Willkommen beim **AI Praxis-Coach**! \n\nIch bin Ihr persönlicher Berater für alle Fragen rund um die Zahnarztpraxis. Mein Wissen basiert auf umfangreicher Coaching-Erfahrung und aktuellen Branchenstandards.\n\n**Wie kann ich Ihnen helfen?** Fragen Sie mich zum Beispiel:\n- \"Wie kann ich die Wartezeiten in meiner Praxis reduzieren?\"\n- \"Welche KPIs sollte ich monatlich überwachen?\"\n- \"Tipps für effektives Personalrecruiting\"\n- \"Wie optimiere ich meine GOZ-Abrechnung?\"`,\n};\n\nexport default function Knowledge() {\n  const [messages, setMessages] = useState<Message[]>([WELCOME_MESSAGE]);\n  const [input, setInput] = useState(\"\");\n  const scrollRef = useRef<HTMLDivElement>(null);\n  const inputRef = useRef<HTMLInputElement>(null);\n\n  const scrollToBottom = () => {\n    if (scrollRef.current) {\n      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;\n    }\n  };\n\n  useEffect(() => {\n    scrollToBottom();\n  }, [messages]);\n\n  const chatMutation = useMutation({\n    mutationFn: async (question: string) => {\n      const response = await fetch(\"/api/ai/coach-chat\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ question }),\n      });\n      \n      if (!response.ok) {\n        throw new Error(\"Fehler bei der Anfrage\");\n      }\n      \n      return response.json() as Promise<{ \n        answer: string; \n        sources: Array<{ title: string; category: string }>;\n        webResults?: Array<{ title: string; url: string }>;\n      }>;\n    },\n    onMutate: (question) => {\n      const userMessage: Message = {\n        id: `user-${Date.now()}`,\n        role: \"user\",\n        content: question,\n      };\n      \n      const assistantMessage: Message = {\n        id: `assistant-${Date.now()}`,\n        role: \"assistant\",\n        content: \"\",\n        isStreaming: true,\n      };\n      \n      setMessages(prev => [...prev, userMessage, assistantMessage]);\n    },\n    onSuccess: (data) => {\n      setMessages(prev => \n        prev.map(msg => \n          msg.isStreaming \n            ? { ...msg, content: data.answer, sources: data.sources, isStreaming: false }\n            : msg\n        )\n      );\n    },\n    onError: (error) => {\n      setMessages(prev => \n        prev.map(msg => \n          msg.isStreaming \n            ? { ...msg, content: `Entschuldigung, es gab einen Fehler: ${error.message}`, isStreaming: false }\n            : msg\n        )\n      );\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!input.trim() || chatMutation.isPending) return;\n    \n    chatMutation.mutate(input.trim());\n    setInput(\"\");\n  };\n\n  const handleNewChat = () => {\n    setMessages([WELCOME_MESSAGE]);\n    inputRef.current?.focus();\n  };\n\n  return (\n    <div className=\"flex flex-col h-[calc(100vh-3.5rem)] md:h-[calc(100vh-4rem)]\" data-testid=\"page-knowledge\">\n      <div className=\"border-b p-3 md:p-4 flex items-center justify-between bg-background/95 backdrop-blur\">\n        <div className=\"flex items-center gap-2 md:gap-3\">\n          <div className=\"p-1.5 md:p-2 rounded-lg bg-primary/10\">\n            <Brain className=\"h-5 w-5 md:h-6 md:w-6 text-primary\" />\n          </div>\n          <div>\n            <h1 className=\"text-base md:text-lg font-semibold\" data-testid=\"heading-knowledge\">\n              AI Praxis-Coach\n            </h1>\n            <p className=\"text-[10px] md:text-xs text-muted-foreground hidden sm:block\">\n              Ihr persönlicher Berater für Praxisoptimierung\n            </p>\n          </div>\n        </div>\n        <Button \n          variant=\"outline\" \n          size=\"sm\" \n          onClick={handleNewChat}\n          data-testid=\"button-new-chat\"\n          className=\"text-xs md:text-sm\"\n        >\n          <RefreshCw className=\"h-4 w-4 md:mr-2\" />\n          <span className=\"hidden md:inline\">Neuer Chat</span>\n        </Button>\n      </div>\n\n      <ScrollArea className=\"flex-1 p-4\" ref={scrollRef}>\n        <div className=\"max-w-3xl mx-auto space-y-4\">\n          {messages.map((message) => (\n            <div\n              key={message.id}\n              className={cn(\n                \"flex gap-3\",\n                message.role === \"user\" ? \"justify-end\" : \"justify-start\"\n              )}\n              data-testid={`message-${message.id}`}\n            >\n              {message.role === \"assistant\" && (\n                <div className=\"p-2 rounded-full bg-primary/10 h-fit\">\n                  <Sparkles className=\"h-4 w-4 text-primary\" />\n                </div>\n              )}\n              \n              <Card className={cn(\n                \"max-w-[80%]\",\n                message.role === \"user\" \n                  ? \"bg-primary text-primary-foreground\" \n                  : \"bg-muted/50\"\n              )}>\n                <CardContent className=\"p-3\">\n                  {message.isStreaming ? (\n                    <div className=\"flex items-center gap-2 text-muted-foreground\">\n                      <Loader2 className=\"h-4 w-4 animate-spin\" />\n                      <span className=\"text-sm\">Denke nach...</span>\n                    </div>\n                  ) : (\n                    <div className=\"prose prose-sm dark:prose-invert max-w-none\">\n                      <div \n                        className=\"text-sm whitespace-pre-wrap\"\n                        dangerouslySetInnerHTML={{ \n                          __html: message.content\n                            .replace(/\\*\\*(.*?)\\*\\*/g, '<strong>$1</strong>')\n                            .replace(/\\n/g, '<br>')\n                        }} \n                      />\n                    </div>\n                  )}\n                  \n                  {message.sources && message.sources.length > 0 && (\n                    <div className=\"mt-3 pt-3 border-t border-border/50\">\n                      <p className=\"text-xs text-muted-foreground mb-1\">Basierend auf Coach-Wissen:</p>\n                      <div className=\"flex flex-wrap gap-1\">\n                        {message.sources.slice(0, 3).map((source, i) => (\n                          <span \n                            key={i} \n                            className=\"text-xs px-2 py-0.5 rounded bg-primary/10 text-foreground\"\n                            title={source.title}\n                          >\n                            {source.title.length > 30 ? source.title.substring(0, 30) + \"...\" : source.title}\n                          </span>\n                        ))}\n                      </div>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n              \n              {message.role === \"user\" && (\n                <div className=\"p-2 rounded-full bg-primary h-fit\">\n                  <User className=\"h-4 w-4 text-primary-foreground\" />\n                </div>\n              )}\n            </div>\n          ))}\n        </div>\n      </ScrollArea>\n\n      <div className=\"border-t p-4 bg-background/95 backdrop-blur\">\n        <form onSubmit={handleSubmit} className=\"max-w-3xl mx-auto flex gap-2\">\n          <Input\n            ref={inputRef}\n            value={input}\n            onChange={(e) => setInput(e.target.value)}\n            placeholder=\"Stellen Sie Ihre Frage...\"\n            disabled={chatMutation.isPending}\n            className=\"flex-1\"\n            data-testid=\"input-chat\"\n          />\n          <Button \n            type=\"submit\" \n            disabled={!input.trim() || chatMutation.isPending}\n            data-testid=\"button-send\"\n          >\n            {chatMutation.isPending ? (\n              <Loader2 className=\"h-4 w-4 animate-spin\" />\n            ) : (\n              <Send className=\"h-4 w-4\" />\n            )}\n          </Button>\n        </form>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":8417,"size_tokens":null},"server/ai/knowledgeProcessor.ts":{"content":"import mammoth from \"mammoth\";\nimport OpenAI from \"openai\";\nimport { storage } from \"../storage\";\nimport type { InsertKnowledgeChunk } from \"@shared/schema\";\n\nconst openai = new OpenAI({\n  apiKey: process.env.OPENAI_API_KEY\n});\n\nexport async function extractTextFromWord(buffer: Buffer): Promise<string> {\n  const result = await mammoth.extractRawText({ buffer });\n  return result.value;\n}\n\nexport function splitIntoChunks(text: string, maxTokens: number = 600): string[] {\n  const paragraphs = text.split(/\\n\\n+/);\n  const chunks: string[] = [];\n  let currentChunk = \"\";\n  let currentTokenEstimate = 0;\n\n  for (const paragraph of paragraphs) {\n    const paragraphTokens = Math.ceil(paragraph.length / 4);\n    \n    if (currentTokenEstimate + paragraphTokens > maxTokens && currentChunk) {\n      chunks.push(currentChunk.trim());\n      currentChunk = \"\";\n      currentTokenEstimate = 0;\n    }\n    \n    currentChunk += paragraph + \"\\n\\n\";\n    currentTokenEstimate += paragraphTokens;\n  }\n  \n  if (currentChunk.trim()) {\n    chunks.push(currentChunk.trim());\n  }\n  \n  return chunks;\n}\n\nexport async function generateEmbedding(text: string): Promise<number[]> {\n  const response = await openai.embeddings.create({\n    model: \"text-embedding-3-small\",\n    input: text,\n  });\n  return response.data[0].embedding;\n}\n\nexport async function extractKeyPoints(text: string): Promise<string[]> {\n  const response = await openai.chat.completions.create({\n    model: \"gpt-4o-mini\",\n    messages: [\n      {\n        role: \"system\",\n        content: \"Du bist ein Experte für Zahnarztpraxis-Management. Extrahiere die 2-4 wichtigsten Kernaussagen aus dem folgenden Text. Antworte nur mit einer JSON-Array von Strings.\"\n      },\n      {\n        role: \"user\",\n        content: text\n      }\n    ],\n    response_format: { type: \"json_object\" }\n  });\n\n  try {\n    const parsed = JSON.parse(response.choices[0].message.content || \"{}\");\n    return parsed.keyPoints || parsed.key_points || [];\n  } catch {\n    return [];\n  }\n}\n\nexport interface ProcessDocumentResult {\n  sourceId: string;\n  chunksProcessed: number;\n  totalTokens: number;\n}\n\nexport async function processDocument(\n  buffer: Buffer,\n  fileName: string,\n  title: string,\n  category: string,\n  tags: string[],\n  description?: string\n): Promise<ProcessDocumentResult> {\n  const text = await extractTextFromWord(buffer);\n  \n  const source = await storage.createKnowledgeSource({\n    title,\n    fileName,\n    category,\n    tags,\n    description: description || null,\n  });\n\n  const chunks = splitIntoChunks(text);\n  let totalTokens = 0;\n\n  for (let i = 0; i < chunks.length; i++) {\n    const chunkText = chunks[i];\n    const tokens = Math.ceil(chunkText.length / 4);\n    totalTokens += tokens;\n\n    const [embedding, keyPoints] = await Promise.all([\n      generateEmbedding(chunkText),\n      extractKeyPoints(chunkText)\n    ]);\n\n    const chunkData: InsertKnowledgeChunk = {\n      sourceId: source.id,\n      chunkIndex: i,\n      content: chunkText,\n      tokens,\n      embedding,\n      keyPoints,\n    };\n\n    await storage.createKnowledgeChunk(chunkData);\n  }\n\n  return {\n    sourceId: source.id,\n    chunksProcessed: chunks.length,\n    totalTokens,\n  };\n}\n\nexport async function searchKnowledge(query: string, limit: number = 5) {\n  const sources = await storage.getAllKnowledgeSources();\n  if (sources.length === 0) {\n    return [];\n  }\n  \n  const queryEmbedding = await generateEmbedding(query);\n  return storage.searchKnowledgeChunks(queryEmbedding, limit);\n}\n\nexport function formatKnowledgeContext(\n  chunks: Array<{ content: string; source: { title: string; category: string }; similarity: number }>\n): string {\n  if (chunks.length === 0) {\n    return \"\";\n  }\n\n  const context = chunks.map((chunk, i) => {\n    return `[Quelle ${i + 1}: \"${chunk.source.title}\" (${chunk.source.category})]\n${chunk.content}`;\n  }).join(\"\\n\\n---\\n\\n\");\n\n  return `\n=== COACH-WISSEN (Primäre Quelle) ===\nDie folgenden Informationen stammen aus der Expertise eines erfahrenen Zahnarztpraxis-Coaches und sollten als primäre Grundlage für alle Empfehlungen dienen:\n\n${context}\n\n=== ENDE COACH-WISSEN ===\n`;\n}\n","path":null,"size_bytes":4132,"size_tokens":null},"scripts/import-knowledge.ts":{"content":"import fs from \"fs\";\nimport path from \"path\";\nimport { processDocument } from \"../server/ai/knowledgeProcessor\";\nimport { storage } from \"../server/storage\";\n\nconst KNOWLEDGE_DIR = \"./knowledge-docs\";\n\ninterface DocumentConfig {\n  fileName: string;\n  title: string;\n  category: string;\n  tags: string[];\n  description?: string;\n}\n\nasync function importDocuments() {\n  console.log(\"🧠 Coach-Wissen Import Script\\n\");\n\n  if (!fs.existsSync(KNOWLEDGE_DIR)) {\n    console.log(`📁 Erstelle Ordner: ${KNOWLEDGE_DIR}`);\n    fs.mkdirSync(KNOWLEDGE_DIR, { recursive: true });\n  }\n\n  const files = fs.readdirSync(KNOWLEDGE_DIR).filter(f => \n    f.endsWith(\".docx\") || f.endsWith(\".doc\")\n  );\n\n  if (files.length === 0) {\n    console.log(`\\n⚠️  Keine Word-Dokumente gefunden in ${KNOWLEDGE_DIR}/`);\n    console.log(\"\\nBitte legen Sie Ihre .docx-Dateien in diesen Ordner.\");\n    console.log(\"\\nBeispiel-Dateistruktur:\");\n    console.log(\"  knowledge-docs/\");\n    console.log(\"    ├── terminplanung-grundlagen.docx\");\n    console.log(\"    ├── patientenfluss-optimierung.docx\");\n    console.log(\"    └── personalfuehrung-tipps.docx\");\n    return;\n  }\n\n  console.log(`📚 ${files.length} Dokument(e) gefunden:\\n`);\n\n  const existingSources = await storage.getAllKnowledgeSources();\n  const existingFileNames = new Set(existingSources.map(s => s.fileName));\n\n  for (const fileName of files) {\n    const filePath = path.join(KNOWLEDGE_DIR, fileName);\n    \n    if (existingFileNames.has(fileName)) {\n      console.log(`⏭️  ${fileName} - bereits importiert, überspringe...`);\n      continue;\n    }\n\n    console.log(`📄 Verarbeite: ${fileName}`);\n    \n    const title = fileName\n      .replace(/\\.(docx?|doc)$/i, \"\")\n      .replace(/[-_]/g, \" \")\n      .replace(/\\b\\w/g, c => c.toUpperCase());\n\n    const category = detectCategory(fileName, title);\n    const tags = extractTags(title);\n\n    try {\n      const buffer = fs.readFileSync(filePath);\n      const result = await processDocument(\n        buffer,\n        fileName,\n        title,\n        category,\n        tags,\n        `Automatisch importiert aus ${fileName}`\n      );\n      \n      console.log(`   ✅ ${result.chunksProcessed} Abschnitte verarbeitet (~${result.totalTokens} Tokens)`);\n    } catch (error) {\n      console.log(`   ❌ Fehler: ${error instanceof Error ? error.message : \"Unbekannter Fehler\"}`);\n    }\n  }\n\n  console.log(\"\\n✨ Import abgeschlossen!\");\n  \n  const allSources = await storage.getAllKnowledgeSources();\n  console.log(`\\n📊 Wissensbasis enthält jetzt ${allSources.length} Quelle(n).`);\n}\n\nfunction detectCategory(fileName: string, title: string): string {\n  const text = (fileName + \" \" + title).toLowerCase();\n  \n  if (text.includes(\"termin\") || text.includes(\"schedule\") || text.includes(\"booking\")) {\n    return \"scheduling\";\n  }\n  if (text.includes(\"patient\") || text.includes(\"flow\") || text.includes(\"fluss\")) {\n    return \"patient-flow\";\n  }\n  if (text.includes(\"personal\") || text.includes(\"staff\") || text.includes(\"team\") || text.includes(\"führung\")) {\n    return \"staff-management\";\n  }\n  if (text.includes(\"raum\") || text.includes(\"layout\") || text.includes(\"room\")) {\n    return \"room-layout\";\n  }\n  if (text.includes(\"effizienz\") || text.includes(\"efficiency\") || text.includes(\"produktiv\")) {\n    return \"efficiency\";\n  }\n  if (text.includes(\"wirtschaft\") || text.includes(\"profit\") || text.includes(\"umsatz\") || text.includes(\"kosten\")) {\n    return \"profitability\";\n  }\n  if (text.includes(\"kommunikation\") || text.includes(\"gespräch\") || text.includes(\"communication\")) {\n    return \"communication\";\n  }\n  if (text.includes(\"marketing\") || text.includes(\"werbung\")) {\n    return \"marketing\";\n  }\n  if (text.includes(\"hygiene\") || text.includes(\"steril\") || text.includes(\"desinfektion\")) {\n    return \"hygiene\";\n  }\n  if (text.includes(\"qualität\") || text.includes(\"quality\") || text.includes(\"qm\")) {\n    return \"quality\";\n  }\n  \n  return \"general\";\n}\n\nfunction extractTags(title: string): string[] {\n  const words = title.toLowerCase().split(/\\s+/);\n  const stopWords = new Set([\"und\", \"oder\", \"für\", \"mit\", \"in\", \"der\", \"die\", \"das\", \"den\", \"dem\", \"ein\", \"eine\", \"einer\"]);\n  \n  return words\n    .filter(w => w.length > 3 && !stopWords.has(w))\n    .slice(0, 5);\n}\n\nimportDocuments().catch(console.error);\n","path":null,"size_bytes":4332,"size_tokens":null},"server/ai/ragQuery.ts":{"content":"import OpenAI from \"openai\";\nimport { tavily } from \"@tavily/core\";\nimport { storage } from \"../storage\";\n\nconst openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });\nconst tavilyClient = process.env.TAVILY_API_KEY \n  ? tavily({ apiKey: process.env.TAVILY_API_KEY })\n  : null;\n\nconst TIME_SENSITIVE_KEYWORDS = [\n  \"aktuell\", \"neu\", \"2024\", \"2025\", \"gesetz\", \"richtlinie\", \"verordnung\",\n  \"gebühren\", \"goz\", \"bema\", \"frist\", \"deadline\", \"änderung\", \"reform\",\n  \"kv\", \"kassenzahnärztlich\", \"hygiene\", \"rki\", \"corona\", \"covid\"\n];\n\nconst AUTHORITATIVE_DOMAINS = [\n  \"kzbv.de\", \"bzaek.de\", \"dgzmk.de\", \"rki.de\", \"bundesgesundheitsministerium.de\",\n  \"gesetze-im-internet.de\", \"aok.de\", \"tk.de\", \"barmer.de\", \"kvwl.de\"\n];\n\nexport interface RetrievedChunk {\n  id: string;\n  docName: string;\n  headingPath: string | null;\n  content: string;\n  score: number;\n}\n\nexport interface WebResult {\n  title: string;\n  url: string;\n  snippet: string;\n  publisher?: string;\n  date?: string;\n}\n\nexport interface RAGQueryResult {\n  answer: string;\n  kbChunks: RetrievedChunk[];\n  webResults?: WebResult[];\n  kbCoverage: \"sufficient\" | \"partial\" | \"insufficient\";\n}\n\nasync function generateEmbedding(text: string): Promise<number[]> {\n  const response = await openai.embeddings.create({\n    model: \"text-embedding-3-small\",\n    input: text.slice(0, 8000),\n  });\n  return response.data[0].embedding;\n}\n\nexport async function retrieveKnowledgeChunks(\n  question: string,\n  topK: number = 5\n): Promise<RetrievedChunk[]> {\n  const queryEmbedding = await generateEmbedding(question);\n  const results = await storage.searchKnowledgeChunks(queryEmbedding, topK);\n\n  return results.map(row => ({\n    id: row.id,\n    docName: row.source.fileName,\n    headingPath: row.headingPath,\n    content: row.content,\n    score: row.similarity || 0\n  }));\n}\n\nfunction assessKBCoverage(chunks: RetrievedChunk[]): \"sufficient\" | \"partial\" | \"insufficient\" {\n  if (chunks.length === 0) return \"insufficient\";\n  \n  const avgScore = chunks.reduce((sum, c) => sum + c.score, 0) / chunks.length;\n  const topScore = chunks[0]?.score || 0;\n  \n  if (topScore >= 0.75 && avgScore >= 0.6) return \"sufficient\";\n  if (topScore >= 0.5 || avgScore >= 0.4) return \"partial\";\n  return \"insufficient\";\n}\n\nfunction isTimeSensitiveTopic(question: string): boolean {\n  const lowerQ = question.toLowerCase();\n  return TIME_SENSITIVE_KEYWORDS.some(kw => lowerQ.includes(kw));\n}\n\nfunction filterAuthoritativeDomains(results: WebResult[]): WebResult[] {\n  const authoritative = results.filter(r => \n    AUTHORITATIVE_DOMAINS.some(domain => r.url.includes(domain))\n  );\n  return authoritative.length > 0 ? authoritative : results.slice(0, 3);\n}\n\nasync function performWebSearch(question: string): Promise<WebResult[]> {\n  if (!tavilyClient) return [];\n  \n  try {\n    const response = await tavilyClient.search(\n      `${question} Zahnarztpraxis Deutschland`,\n      { searchDepth: \"basic\", maxResults: 5 }\n    );\n    \n    const results: WebResult[] = response.results\n      .filter(r => r.url && r.url.startsWith(\"http\"))\n      .map(r => {\n        let publisher = \"web\";\n        try {\n          publisher = new URL(r.url).hostname.replace(\"www.\", \"\");\n        } catch {}\n        return {\n          title: r.title || \"Webquelle\",\n          url: r.url,\n          snippet: (r.content || \"\").slice(0, 2500),\n          publisher,\n          date: new Date().toISOString().split(\"T\")[0]\n        };\n      });\n    \n    return filterAuthoritativeDomains(results);\n  } catch (error) {\n    console.error(\"Web search error:\", error);\n    return [];\n  }\n}\n\nfunction formatKBContext(chunks: RetrievedChunk[]): string {\n  if (chunks.length === 0) return \"\";\n  \n  return chunks.map((chunk, i) => {\n    const source = chunk.docName.replace(/\\.docx$/i, \"\").replace(/[_-]/g, \" \");\n    const heading = chunk.headingPath || \"Allgemein\";\n    return `[KB-Quelle ${i + 1}: \"${source}\" > ${heading}]\\n${chunk.content}`;\n  }).join(\"\\n\\n---\\n\\n\");\n}\n\nfunction formatWebContext(results: WebResult[]): string {\n  if (results.length === 0) return \"\";\n  \n  return results.map((r, i) => \n    `[Web-Quelle ${i + 1}: ${r.title} (${r.publisher}, ${r.date})]\\nURL: ${r.url}\\n${r.snippet}`\n  ).join(\"\\n\\n---\\n\\n\");\n}\n\nexport async function queryRAG(\n  question: string,\n  topK: number = 5\n): Promise<RAGQueryResult> {\n  const kbChunks = await retrieveKnowledgeChunks(question, topK);\n  const kbCoverage = assessKBCoverage(kbChunks);\n  \n  let webResults: WebResult[] = [];\n  const needsWebSearch = kbCoverage !== \"sufficient\" || isTimeSensitiveTopic(question);\n  \n  if (needsWebSearch) {\n    webResults = await performWebSearch(question);\n  }\n  \n  const kbContext = formatKBContext(kbChunks);\n  const webContext = formatWebContext(webResults);\n  \n  const systemPrompt = `Du bist ein erfahrener **AI Praxis-Coach** für Zahnarztpraxen.\n\n## Antwort-Regeln:\n1. **Primäre Quelle (KB)**: Nutze die Coach-Wissensbasis als Hauptquelle\n2. **Sekundäre Quelle (Web)**: Ergänze mit Web-Quellen nur wenn KB unzureichend oder Thema zeitkritisch\n3. **Zitierung PFLICHT**: Jede Aussage muss mit [KB-Quelle X] oder [Web-Quelle X] zitiert werden\n4. **Deutsche Standards**: Berücksichtige ArbStättV, KV-Benchmarks, GOZ, QM-RL, KZBV\n5. **Keine Personenbewertungen**: Keine individuellen Leistungs- oder Stress-Scores\n\n## Format:\n- Strukturierte Aufzählungspunkte\n- Max. 300 Wörter\n- Wenn Info fehlt: Klar benennen was fehlt\n- KB-Quellen vor Web-Quellen bevorzugen\n\n## Quellen-Trennung am Ende:\nFalls Web-Quellen genutzt:\n**Wissensbasis-Quellen:** [Liste der KB-Quellen]\n**Web-Quellen:** [Titel, Herausgeber, Datum, URL]`;\n\n  const userPrompt = `=== WISSENSBASIS (Primär) ===\n${kbContext || \"(Keine relevanten KB-Einträge gefunden)\"}\n\n${webContext ? `=== WEB-RECHERCHE (Sekundär) ===\n${webContext}` : \"\"}\n\nNUTZERFRAGE: ${question}\n\nGib eine strukturierte Antwort mit korrekten Zitierungen.`;\n\n  try {\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt }\n      ],\n      max_tokens: 1000,\n      temperature: 0.5\n    });\n\n    const answer = response.choices[0]?.message?.content || \n      \"Entschuldigung, ich konnte keine Antwort generieren.\";\n\n    return { answer, kbChunks, webResults: webResults.length > 0 ? webResults : undefined, kbCoverage };\n  } catch (error) {\n    console.error(\"RAG query error:\", error);\n    throw new Error(\"Fehler bei der KI-Antwort. Bitte versuchen Sie es erneut.\");\n  }\n}\n","path":null,"size_bytes":6537,"size_tokens":null},"server/artifactLoader.ts":{"content":"import { db } from \"./db\";\nimport { knowledgeArtifacts, knowledgeChunks } from \"@shared/schema\";\nimport { eq, and, sql } from \"drizzle-orm\";\nimport { MODULES } from \"../shared/taxonomy\";\nimport OpenAI from \"openai\";\n\nconst openai = new OpenAI({\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY\n});\n\nconst ARTIFACT_TOPICS: Record<string, string[]> = {\n  layout: [\"room_size_reception\", \"room_size_waiting\", \"room_size_treatment\", \"room_size_lab\", \"room_size_office\"],\n  staffing: [\"mfa_per_doctor\", \"support_per_physician\"],\n  scheduling: [\"service_time_checkup\", \"service_time_treatment\", \"service_time_cleaning\", \"buffer_minutes\", \"max_wait_time\"],\n  dashboard: [\"health_score_weights\"]\n};\n\nasync function extractArtifact(module: string, topic: string, chunks: any[]): Promise<any | null> {\n  if (chunks.length === 0) return null;\n\n  const context = chunks.map(c => c.content).join(\"\\n\\n---\\n\\n\");\n\n  const prompt = `Du bist ein Experte für die Extraktion strukturierter Daten aus deutschsprachigen medizinischen Praxisrichtlinien.\n\nKONTEXT (aus Wissensdokumenten):\n${context}\n\nAUFGABE: Extrahiere für das Modul \"${module}\" zum Thema \"${topic}\" strukturierte Benchmark-Daten.\n\nAntworte NUR mit einem gültigen JSON-Objekt in diesem Format:\n{\n  \"artifactType\": \"benchmark\",\n  \"metric\": \"Name der Metrik\",\n  \"unit\": \"Einheit (z.B. m², Minuten, Verhältnis)\",\n  \"min\": <minimaler Wert als Zahl>,\n  \"max\": <maximaler Wert als Zahl>,\n  \"optimal\": <optimaler Wert als Zahl>,\n  \"description\": \"Kurze Beschreibung\",\n  \"source\": \"Quellenangabe aus dem Dokument\"\n}\n\nFalls keine relevanten Daten gefunden werden, antworte mit: null`;\n\n  try {\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o-mini\",\n      messages: [{ role: \"user\", content: prompt }],\n      max_tokens: 500,\n      temperature: 0.1\n    });\n\n    const content = response.choices[0]?.message?.content?.trim();\n    if (!content || content === \"null\") return null;\n\n    const jsonMatch = content.match(/\\{[\\s\\S]*\\}/);\n    if (!jsonMatch) return null;\n\n    return JSON.parse(jsonMatch[0]);\n  } catch (error) {\n    console.log(`[ArtifactLoader] Failed to extract ${module}/${topic}:`, error);\n    return null;\n  }\n}\n\nasync function buildMissingArtifacts() {\n  console.log(\"[ArtifactLoader] Checking for missing artifacts...\");\n\n  const existingArtifacts = await db.select({\n    module: knowledgeArtifacts.module,\n    topic: knowledgeArtifacts.topic\n  }).from(knowledgeArtifacts);\n\n  const existingSet = new Set(existingArtifacts.map(a => `${a.module}:${a.topic}`));\n\n  const chunkCount = await db.select({ count: sql<number>`count(*)` }).from(knowledgeChunks);\n  if (!chunkCount[0]?.count || chunkCount[0].count === 0) {\n    console.log(\"[ArtifactLoader] No knowledge chunks found. Skipping artifact building.\");\n    return;\n  }\n\n  let built = 0;\n  const maxPerRun = 5;\n\n  for (const [module, topics] of Object.entries(ARTIFACT_TOPICS)) {\n    if (built >= maxPerRun) break;\n\n    for (const topic of topics) {\n      if (built >= maxPerRun) break;\n      if (existingSet.has(`${module}:${topic}`)) continue;\n\n      const searchTerms = topic.replace(/_/g, \" \");\n      const chunks = await db.select().from(knowledgeChunks)\n        .where(sql`to_tsvector('german', ${knowledgeChunks.content}) @@ plainto_tsquery('german', ${searchTerms})`)\n        .limit(3);\n\n      if (chunks.length === 0) {\n        const fallbackChunks = await db.select().from(knowledgeChunks)\n          .where(sql`${knowledgeChunks.content} ILIKE ${'%' + searchTerms.split(' ')[0] + '%'}`)\n          .limit(3);\n        \n        if (fallbackChunks.length === 0) continue;\n        chunks.push(...fallbackChunks);\n      }\n\n      const artifact = await extractArtifact(module, topic, chunks);\n      if (!artifact) continue;\n\n      const citations = chunks.map(c => ({\n        docName: c.sourceId,\n        headingPath: c.headingPath,\n        chunkId: c.id\n      }));\n\n      await db.insert(knowledgeArtifacts).values({\n        artifactType: artifact.artifactType || \"benchmark\",\n        module,\n        topic,\n        payloadJson: artifact,\n        sourceCitations: citations,\n        confidence: 0.8,\n        version: 1\n      });\n\n      console.log(`[ArtifactLoader] Built artifact: ${module}/${topic}`);\n      built++;\n    }\n  }\n\n  if (built > 0) {\n    console.log(`[ArtifactLoader] Built ${built} new artifacts`);\n  } else {\n    console.log(\"[ArtifactLoader] All artifacts up to date\");\n  }\n}\n\nexport async function initializeArtifacts() {\n  try {\n    await buildMissingArtifacts();\n  } catch (error) {\n    console.log(\"[ArtifactLoader] Artifact initialization skipped:\", error);\n  }\n}\n","path":null,"size_bytes":4695,"size_tokens":null},"server/benchmark.ts":{"content":"// Datei: shared/benchmarks.ts oder server/benchmarks.ts\n\nexport const DENTAL_BENCHMARKS = {\n  // 1. FINANZEN & KPI\n  financial: {\n    min_revenue_per_hour: 300.00,       // [EUR] Kritische Grenze\n    target_overhead_ratio: 0.60,        // 55-65% Gesamtausgabenquote\n    collection_ratio: 0.98,             // >98% Inkasso-Quote\n    skonto_max: 0.03,                   // 3% Maximaler Skonto-Abzug\n    break_even_crowns_cadcam: 30,       // Stück/Monat für Amortisation\n    marketing_budget_percent: 0.05,     // Ca. 3-7% vom Umsatz\n    min_case_acceptance: 0.75           // >75% Fallakzeptanz\n  },\n\n  // 2. STEUERN & RECHT\n  tax_rates: {\n    heilbehandlung: 0.00,               // § 4 Nr. 14 UStG\n    zahntechnik_eigen: 0.07,            // § 12 Abs. 2 Nr. 6 UStG\n    kosmetik_shop: 0.19,                // Regelsteuersatz\n    bagatellgrenze_geschenke: 5.00,     // [EUR] Streuartikel-Grenze\n    geschenke_steuerfrei_p_a: 50.00     // [EUR] Steuerfreie Sachbezüge\n  },\n\n  // 3. ZEIT-RICHTWERTE (STANDARD TIMES in Minuten)\n  standard_times_min: {\n    exam_new_patient: 60,               // 01 Untersuchung\n    prophylaxis_pzr: 50,                // PZR\n    prep_crown: 75,                     // Präp Krone\n    endo_root_canal: 105,               // Wurzelkanal\n    extraction_simple: 25,              // Extraktion\n    implant_placement: 90,              // Implantation\n    scan_intraoral: 5                   // Digitaler Scan\n  },\n\n  // 4. OPERATIVE SCHWELLENWERTE\n  operational_limits: {\n    max_waiting_time: 15,               // [Min] Kritische Grenze\n    inventory_turnover: 5,              // [x/Jahr] Lagerumschlag\n    no_show_rate_max: 0.05,             // <5% Ausfallquote\n    hygiene_rebooking: 0.90,            // >90% Neubuchungsrate\n    oee_target: 0.85                    // >85% OEE\n  },\n\n  // 5. STRUKTUR & INFRASTRUKTUR\n  structural: {\n    room_size_treatment_sqm: 12.0,      // Min. qm (RKI/DIN)\n    room_size_prophy_sqm: 10.0,\n    staff_ratio_zfa_per_dentist: 1.5,\n    chairs_per_dentist: 2,\n    steri_capacity_per_hour: 6\n  }\n};","path":null,"size_bytes":2057,"size_tokens":null},"scripts/build-artifacts.ts":{"content":"import crypto from \"crypto\";\nimport OpenAI from \"openai\";\nimport { db } from \"../server/db\";\nimport { knowledgeChunks, knowledgeSources, knowledgeArtifacts } from \"../shared/schema\";\nimport { eq, sql, and } from \"drizzle-orm\";\nimport { z } from \"zod\";\n\nconst openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });\n\nconst ARTIFACT_DEFINITIONS: ArtifactDefinition[] = [\n  // Dashboard artifacts (5)\n  {\n    module: \"dashboard\",\n    topic: \"health_score_weights\",\n    artifactType: \"config\",\n    prompt: `Extrahiere aus dem Wissenskontext die optimalen GEWICHTUNGEN für einen Praxis-Gesundheitsscore.\n    Liefere JSON mit: efficiency_weight, harmony_weight, patient_satisfaction_weight, staff_wellbeing_weight (alle 0-1, Summe = 1).`,\n    schema: z.object({\n      efficiency_weight: z.number().min(0).max(1),\n      harmony_weight: z.number().min(0).max(1),\n      patient_satisfaction_weight: z.number().min(0).max(1),\n      staff_wellbeing_weight: z.number().min(0).max(1)\n    }),\n    searchTerms: [\"Effizienz\", \"Kennzahl\", \"Performance\", \"Zufriedenheit\", \"Score\"]\n  },\n  {\n    module: \"dashboard\",\n    topic: \"kpi_benchmarks\",\n    artifactType: \"benchmark\",\n    prompt: `Extrahiere die wichtigsten KPIs und Benchmarks für Zahnarztpraxen.\n    Liefere JSON mit: revenue_per_hour (number), patients_per_day (number), recall_rate_target (number 0-1), new_patient_rate_target (number 0-1).`,\n    schema: z.object({\n      revenue_per_hour: z.number(),\n      patients_per_day: z.number(),\n      recall_rate_target: z.number(),\n      new_patient_rate_target: z.number()\n    }),\n    searchTerms: [\"Umsatz\", \"Patient\", \"Kennzahl\", \"Benchmark\", \"KPI\"]\n  },\n  {\n    module: \"dashboard\",\n    topic: \"efficiency_drivers\",\n    artifactType: \"insight\",\n    prompt: `Identifiziere die Haupttreiber für Praxiseffizienz.\n    Liefere JSON mit: drivers (Array von {name, impact_score 1-10, category, recommendation}).`,\n    schema: z.object({\n      drivers: z.array(z.object({\n        name: z.string(),\n        impact_score: z.number().min(1).max(10),\n        category: z.string(),\n        recommendation: z.string()\n      }))\n    }),\n    searchTerms: [\"Effizienz\", \"Optimierung\", \"Prozess\", \"Workflow\", \"Verbesserung\"]\n  },\n  {\n    module: \"dashboard\",\n    topic: \"patient_flow_metrics\",\n    artifactType: \"benchmark\",\n    prompt: `Extrahiere Patientenfluss-Metriken und optimale Durchlaufzeiten.\n    Liefere JSON mit: avg_appointment_duration_min, max_wait_time_min, optimal_schedule_buffer_percent, patients_per_treatment_room.`,\n    schema: z.object({\n      avg_appointment_duration_min: z.number(),\n      max_wait_time_min: z.number(),\n      optimal_schedule_buffer_percent: z.number(),\n      patients_per_treatment_room: z.number()\n    }),\n    searchTerms: [\"Wartezeit\", \"Termin\", \"Durchlauf\", \"Patient\", \"Zeitmanagement\"]\n  },\n  {\n    module: \"dashboard\",\n    topic: \"quality_indicators\",\n    artifactType: \"benchmark\",\n    prompt: `Extrahiere Qualitätsindikatoren für Zahnarztpraxen.\n    Liefere JSON mit: treatment_success_rate, patient_retention_rate, complaint_rate_max, recommendation_rate_target.`,\n    schema: z.object({\n      treatment_success_rate: z.number(),\n      patient_retention_rate: z.number(),\n      complaint_rate_max: z.number(),\n      recommendation_rate_target: z.number()\n    }),\n    searchTerms: [\"Qualität\", \"Erfolg\", \"Zufriedenheit\", \"Beschwerde\", \"Empfehlung\"]\n  },\n\n  // Staffing artifacts (3)\n  {\n    module: \"staffing\",\n    topic: \"role_ratios\",\n    artifactType: \"config\",\n    prompt: `Extrahiere optimale Personalverhältnisse für Zahnarztpraxen.\n    Liefere JSON mit: mfa_per_dentist (number), reception_per_dentist (number), prophylaxis_per_dentist (number), total_staff_per_dentist (number).`,\n    schema: z.object({\n      mfa_per_dentist: z.number(),\n      reception_per_dentist: z.number(),\n      prophylaxis_per_dentist: z.number(),\n      total_staff_per_dentist: z.number()\n    }),\n    searchTerms: [\"Personal\", \"MFA\", \"Zahnarzt\", \"Verhältnis\", \"Team\"]\n  },\n  {\n    module: \"staffing\",\n    topic: \"skill_requirements\",\n    artifactType: \"config\",\n    prompt: `Extrahiere Qualifikationsanforderungen pro Rolle.\n    Liefere JSON mit: roles (Array von {role, required_skills[], optional_skills[], certification_requirements[]}).`,\n    schema: z.object({\n      roles: z.array(z.object({\n        role: z.string(),\n        required_skills: z.array(z.string()),\n        optional_skills: z.array(z.string()),\n        certification_requirements: z.array(z.string())\n      }))\n    }),\n    searchTerms: [\"Qualifikation\", \"Ausbildung\", \"Kompetenz\", \"Fortbildung\", \"Zertifikat\"]\n  },\n  {\n    module: \"staffing\",\n    topic: \"scheduling_rules\",\n    artifactType: \"config\",\n    prompt: `Extrahiere Regeln für optimale Personalplanung.\n    Liefere JSON mit: min_staff_per_shift (number), peak_hours_multiplier (number), min_break_duration_min (number), max_continuous_work_hours (number), overlap_time_minutes (number).`,\n    schema: z.object({\n      min_staff_per_shift: z.number(),\n      peak_hours_multiplier: z.number(),\n      min_break_duration_min: z.number(),\n      max_continuous_work_hours: z.number(),\n      overlap_time_minutes: z.number()\n    }),\n    searchTerms: [\"Schicht\", \"Planung\", \"Pause\", \"Arbeitszeit\", \"Personal\"]\n  },\n\n  // Layout artifacts (3)\n  {\n    module: \"layout\",\n    topic: \"room_size_standards\",\n    artifactType: \"benchmark\",\n    prompt: `Extrahiere Raumgrößen-Standards gemäß deutscher Vorschriften.\n    Liefere JSON mit: room_types (Object mit Raumtyp als Key und {min_sqm, optimal_sqm, max_sqm, regulation_reference} als Value).`,\n    schema: z.object({\n      room_types: z.record(z.object({\n        min_sqm: z.number(),\n        optimal_sqm: z.number(),\n        max_sqm: z.number(),\n        regulation_reference: z.string()\n      }))\n    }),\n    searchTerms: [\"Raumgröße\", \"Quadratmeter\", \"Behandlungsraum\", \"Wartebereich\", \"Empfang\"]\n  },\n  {\n    module: \"layout\",\n    topic: \"proximity_rules\",\n    artifactType: \"config\",\n    prompt: `Extrahiere Regeln für optimale Raumanordnung und Laufwege.\n    Liefere JSON mit: proximity_pairs (Array von {room1, room2, max_distance_m, reason}).`,\n    schema: z.object({\n      proximity_pairs: z.array(z.object({\n        room1: z.string(),\n        room2: z.string(),\n        max_distance_m: z.number(),\n        reason: z.string()\n      }))\n    }),\n    searchTerms: [\"Laufweg\", \"Entfernung\", \"Anordnung\", \"Workflow\", \"Nähe\"]\n  },\n  {\n    module: \"layout\",\n    topic: \"workflow_zones\",\n    artifactType: \"config\",\n    prompt: `Extrahiere Empfehlungen für Praxis-Zonen und Workflow-Bereiche.\n    Liefere JSON mit: zones (Array von {zone_name, included_rooms[], accessibility_level, patient_flow_order}).`,\n    schema: z.object({\n      zones: z.array(z.object({\n        zone_name: z.string(),\n        included_rooms: z.array(z.string()),\n        accessibility_level: z.string(),\n        patient_flow_order: z.number()\n      }))\n    }),\n    searchTerms: [\"Zone\", \"Bereich\", \"Workflow\", \"Patient\", \"Ablauf\"]\n  }\n];\n\ninterface ArtifactDefinition {\n  module: string;\n  topic: string;\n  artifactType: string;\n  prompt: string;\n  schema: z.ZodSchema;\n  searchTerms: string[];\n}\n\ninterface ChunkWithSource {\n  id: string;\n  docName: string;\n  headingPath: string | null;\n  content: string;\n}\n\nfunction computeHash(content: string): string {\n  return crypto.createHash(\"sha256\").update(content).digest(\"hex\").slice(0, 16);\n}\n\nasync function searchRelevantChunks(searchTerms: string[], limit: number = 10): Promise<ChunkWithSource[]> {\n  const patterns = searchTerms.map(t => `%${t}%`);\n  const results = await db.execute(sql`\n    SELECT \n      kc.id,\n      ks.file_name as doc_name,\n      kc.heading_path,\n      kc.content\n    FROM knowledge_chunks kc\n    JOIN knowledge_sources ks ON kc.source_id = ks.id\n    WHERE kc.content ILIKE ANY(ARRAY[${sql.join(patterns.map(p => sql`${p}`), sql`, `)}])\n    LIMIT ${limit}\n  `);\n\n  return (results.rows as any[]).map(row => ({\n    id: row.id,\n    docName: row.doc_name,\n    headingPath: row.heading_path,\n    content: row.content\n  }));\n}\n\nasync function generateArtifact(\n  definition: ArtifactDefinition,\n  chunks: ChunkWithSource[]\n): Promise<{ payload: any; citations: any[] } | null> {\n  if (chunks.length === 0) {\n    console.log(`  ⚠️  No relevant chunks found for ${definition.module}/${definition.topic}`);\n    return null;\n  }\n\n  const context = chunks.map((c, i) => \n    `[Quelle ${i + 1}: ${c.docName} > ${c.headingPath || \"Allgemein\"}]\\n${c.content}`\n  ).join(\"\\n\\n---\\n\\n\");\n\n  const systemPrompt = `Du bist ein Experte für Zahnarztpraxis-Management.\nAnalysiere den Wissenskontext und extrahiere strukturierte Daten.\n\nWICHTIG:\n- Antworte NUR mit validem JSON (kein Markdown, keine Erklärungen)\n- Verwende realistische Werte basierend auf deutschen Standards\n- Wenn Werte nicht im Kontext stehen, nutze typische Branchenwerte`;\n\n  const userPrompt = `WISSENSKONTEXT:\n${context}\n\nAUFGABE:\n${definition.prompt}\n\nAntworte NUR mit dem JSON-Objekt:`;\n\n  try {\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt }\n      ],\n      max_tokens: 1500,\n      temperature: 0.3,\n      response_format: { type: \"json_object\" }\n    });\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) {\n      console.log(`  ❌ Empty response for ${definition.module}/${definition.topic}`);\n      return null;\n    }\n\n    const parsed = JSON.parse(content);\n    \n    // Validate with zod\n    const validated = definition.schema.safeParse(parsed);\n    if (!validated.success) {\n      console.log(`  ❌ Validation failed for ${definition.module}/${definition.topic}:`, validated.error.message);\n      return null;\n    }\n\n    const citations = chunks.map(c => ({\n      chunkId: c.id,\n      docName: c.docName.replace(/\\.docx$/i, \"\"),\n      headingPath: c.headingPath || \"Allgemein\"\n    }));\n\n    return { payload: validated.data, citations };\n  } catch (error) {\n    console.log(`  ❌ Error generating ${definition.module}/${definition.topic}:`, error);\n    return null;\n  }\n}\n\nasync function buildArtifact(definition: ArtifactDefinition): Promise<boolean> {\n  console.log(`\\n📦 Building: ${definition.module}/${definition.topic}`);\n  \n  // Search for relevant chunks\n  const chunks = await searchRelevantChunks(definition.searchTerms, 8);\n  \n  if (chunks.length === 0) {\n    console.log(`  ⏭️  Skipped: No relevant knowledge found`);\n    return false;\n  }\n\n  // Compute source hash for idempotency\n  const sourceContent = chunks.map(c => c.content).join(\"\");\n  const sourceHash = computeHash(sourceContent + definition.prompt);\n\n  // Check if artifact exists with same hash\n  const existing = await db.select()\n    .from(knowledgeArtifacts)\n    .where(and(\n      eq(knowledgeArtifacts.module, definition.module),\n      eq(knowledgeArtifacts.topic, definition.topic),\n      eq(knowledgeArtifacts.sourceHash, sourceHash)\n    ))\n    .limit(1);\n\n  if (existing.length > 0) {\n    console.log(`  ⏭️  Unchanged (hash match)`);\n    return true;\n  }\n\n  // Generate artifact\n  const result = await generateArtifact(definition, chunks);\n  if (!result) {\n    return false;\n  }\n\n  // Delete old versions\n  await db.delete(knowledgeArtifacts)\n    .where(and(\n      eq(knowledgeArtifacts.module, definition.module),\n      eq(knowledgeArtifacts.topic, definition.topic)\n    ));\n\n  // Insert new artifact\n  await db.insert(knowledgeArtifacts).values({\n    module: definition.module,\n    topic: definition.topic,\n    artifactType: definition.artifactType,\n    payloadJson: result.payload,\n    sourceCitations: result.citations,\n    sourceHash,\n    confidence: 0.85,\n    version: 1\n  });\n\n  console.log(`  ✅ Created with ${result.citations.length} citations`);\n  return true;\n}\n\nasync function main() {\n  console.log(\"🚀 Knowledge Artifacts Build Starting...\\n\");\n  console.log(\"=\".repeat(50));\n\n  const startTime = Date.now();\n  let success = 0;\n  let failed = 0;\n  let skipped = 0;\n\n  const dashboard = ARTIFACT_DEFINITIONS.filter(d => d.module === \"dashboard\");\n  const staffing = ARTIFACT_DEFINITIONS.filter(d => d.module === \"staffing\");\n  const layout = ARTIFACT_DEFINITIONS.filter(d => d.module === \"layout\");\n\n  console.log(`📊 Dashboard artifacts: ${dashboard.length}`);\n  console.log(`👥 Staffing artifacts: ${staffing.length}`);\n  console.log(`🏗️  Layout artifacts: ${layout.length}`);\n\n  for (const definition of ARTIFACT_DEFINITIONS) {\n    try {\n      const result = await buildArtifact(definition);\n      if (result) success++;\n      else failed++;\n    } catch (error) {\n      console.log(`  ❌ Error: ${error}`);\n      failed++;\n    }\n  }\n\n  const duration = ((Date.now() - startTime) / 1000).toFixed(1);\n\n  console.log(\"\\n\" + \"=\".repeat(50));\n  console.log(\"📊 Build Summary\");\n  console.log(\"=\".repeat(50));\n  console.log(`Total definitions: ${ARTIFACT_DEFINITIONS.length}`);\n  console.log(`Successful:        ${success}`);\n  console.log(`Failed:            ${failed}`);\n  console.log(`Duration:          ${duration}s`);\n  console.log(\"=\".repeat(50));\n\n  // Show artifact counts by module\n  const counts = await db.execute(sql`\n    SELECT module, COUNT(*) as count \n    FROM knowledge_artifacts \n    GROUP BY module\n  `);\n  console.log(\"\\n📦 Artifacts in database:\");\n  for (const row of counts.rows as any[]) {\n    console.log(`  ${row.module}: ${row.count}`);\n  }\n}\n\nmain().catch(console.error).finally(() => process.exit(0));\n","path":null,"size_bytes":13550,"size_tokens":null},"server/ai/artifactBenchmarks.ts":{"content":"import {\n  getRoomSizeBenchmarks,\n  getStaffingBenchmarks,\n  getSchedulingDefaults,\n  getDashboardRules,\n  getLayoutRules,\n  formatCitations,\n  type ArtifactResult\n} from \"./artifactService\";\nimport { SAFE_DEFAULTS, type SourceCitation, type RulePayload } from \"../../shared/taxonomy\";\nimport {\n  ROOM_SIZE_STANDARDS,\n  STAFFING_RATIOS,\n  PATIENT_FLOW_METRICS,\n  type RoomSizeStandard,\n  pixelsToSqM\n} from \"./benchmarks\";\n\nexport interface KnowledgePoweredRoomSize {\n  minSqM: number;\n  maxSqM: number;\n  optimalSqM: number;\n  source: string;\n  citations: SourceCitation[];\n  fromKnowledge: boolean;\n}\n\nexport interface KnowledgePoweredStaffing {\n  min: number;\n  max: number;\n  optimal: number;\n  source: string;\n  citations: SourceCitation[];\n  fromKnowledge: boolean;\n}\n\nexport interface KnowledgePoweredMetric {\n  value: number;\n  unit: string;\n  source: string;\n  citations: SourceCitation[];\n  fromKnowledge: boolean;\n}\n\nexport interface RecommendationWithCitation {\n  text: string;\n  priority: \"critical\" | \"high\" | \"medium\" | \"low\";\n  citations: SourceCitation[];\n  fromKnowledge: boolean;\n}\n\nlet cachedRoomSizes: Record<string, KnowledgePoweredRoomSize> | null = null;\nlet cachedStaffing: Record<string, KnowledgePoweredStaffing> | null = null;\nlet cachedScheduling: {\n  serviceTimes: Record<string, { min: number; max: number; optimal: number; citations: SourceCitation[] }>;\n  bufferMinutes: { value: number; citations: SourceCitation[] };\n  maxWaitTime: { value: number; citations: SourceCitation[] };\n} | null = null;\nlet cacheExpiry = 0;\nconst CACHE_TTL = 5 * 60 * 1000;\n\nasync function refreshCacheIfNeeded() {\n  if (Date.now() < cacheExpiry) return;\n\n  try {\n    const [roomSizes, staffing, scheduling] = await Promise.all([\n      getRoomSizeBenchmarks(),\n      getStaffingBenchmarks(),\n      getSchedulingDefaults()\n    ]);\n\n    cachedRoomSizes = {};\n    for (const [type, data] of Object.entries(roomSizes)) {\n      const normalizedType = normalizeRoomType(type);\n      // Use clean source name instead of full KB document paths\n      const cleanSource = data.citations.length > 0 \n        ? \"Praxis-Standards\" \n        : (ROOM_SIZE_STANDARDS[normalizedType]?.source || \"deutschen Standards\");\n      cachedRoomSizes[normalizedType] = {\n        minSqM: data.min,\n        maxSqM: data.max,\n        optimalSqM: data.optimal,\n        source: cleanSource,\n        citations: data.citations,\n        fromKnowledge: data.citations.length > 0\n      };\n    }\n\n    cachedStaffing = {\n      mfaPerDoctor: {\n        min: staffing.mfaPerDoctor.min,\n        max: staffing.mfaPerDoctor.max,\n        optimal: staffing.mfaPerDoctor.optimal,\n        source: staffing.mfaPerDoctor.citations.length > 0 ? \"Praxis-Standards\" : \"KZBV Praxis-Benchmarks\",\n        citations: staffing.mfaPerDoctor.citations,\n        fromKnowledge: staffing.mfaPerDoctor.citations.length > 0\n      },\n      supportPerPhysician: {\n        min: staffing.supportPerPhysician.min,\n        max: staffing.supportPerPhysician.max,\n        optimal: staffing.supportPerPhysician.optimal,\n        source: staffing.supportPerPhysician.citations.length > 0 ? \"Praxis-Standards\" : \"KV Praxisorganisation\",\n        citations: staffing.supportPerPhysician.citations,\n        fromKnowledge: staffing.supportPerPhysician.citations.length > 0\n      }\n    };\n\n    cachedScheduling = scheduling;\n    cacheExpiry = Date.now() + CACHE_TTL;\n  } catch (error) {\n    console.error(\"Failed to refresh artifact cache:\", error);\n  }\n}\n\nexport async function getKnowledgePoweredRoomSizes(): Promise<Record<string, KnowledgePoweredRoomSize>> {\n  await refreshCacheIfNeeded();\n  \n  if (cachedRoomSizes && Object.keys(cachedRoomSizes).length > 0) {\n    return cachedRoomSizes;\n  }\n\n  const fallback: Record<string, KnowledgePoweredRoomSize> = {};\n  for (const [type, standard] of Object.entries(ROOM_SIZE_STANDARDS)) {\n    fallback[type] = {\n      minSqM: standard.minSqM,\n      maxSqM: standard.maxSqM,\n      optimalSqM: standard.optimalSqM,\n      source: standard.source,\n      citations: [],\n      fromKnowledge: false\n    };\n  }\n  return fallback;\n}\n\nexport async function getKnowledgePoweredStaffing(): Promise<Record<string, KnowledgePoweredStaffing>> {\n  await refreshCacheIfNeeded();\n  \n  if (cachedStaffing) {\n    return cachedStaffing;\n  }\n\n  return {\n    mfaPerDoctor: {\n      min: STAFFING_RATIOS.nursePerDoctor.min,\n      max: STAFFING_RATIOS.nursePerDoctor.max,\n      optimal: STAFFING_RATIOS.nursePerDoctor.optimal,\n      source: STAFFING_RATIOS.nursePerDoctor.source,\n      citations: [],\n      fromKnowledge: false\n    },\n    supportPerPhysician: {\n      min: STAFFING_RATIOS.supportStaffPerPhysician.min,\n      max: STAFFING_RATIOS.supportStaffPerPhysician.max,\n      optimal: STAFFING_RATIOS.supportStaffPerPhysician.optimal,\n      source: STAFFING_RATIOS.supportStaffPerPhysician.source,\n      citations: [],\n      fromKnowledge: false\n    }\n  };\n}\n\nexport async function getKnowledgePoweredScheduling(): Promise<{\n  serviceTimes: Record<string, KnowledgePoweredMetric>;\n  bufferMinutes: KnowledgePoweredMetric;\n  maxWaitTime: KnowledgePoweredMetric;\n}> {\n  await refreshCacheIfNeeded();\n  \n  const serviceTimes: Record<string, KnowledgePoweredMetric> = {};\n  \n  if (cachedScheduling) {\n    for (const [type, data] of Object.entries(cachedScheduling.serviceTimes)) {\n      serviceTimes[type] = {\n        value: data.optimal,\n        unit: \"Minuten\",\n        source: data.citations.length > 0 ? formatCitations(data.citations).join(\", \") : \"Safe Default\",\n        citations: data.citations,\n        fromKnowledge: data.citations.length > 0\n      };\n    }\n    \n    return {\n      serviceTimes,\n      bufferMinutes: {\n        value: cachedScheduling.bufferMinutes.value,\n        unit: \"Minuten\",\n        source: cachedScheduling.bufferMinutes.citations.length > 0 ? formatCitations(cachedScheduling.bufferMinutes.citations).join(\", \") : \"Safe Default\",\n        citations: cachedScheduling.bufferMinutes.citations,\n        fromKnowledge: cachedScheduling.bufferMinutes.citations.length > 0\n      },\n      maxWaitTime: {\n        value: cachedScheduling.maxWaitTime.value,\n        unit: \"Minuten\",\n        source: cachedScheduling.maxWaitTime.citations.length > 0 ? formatCitations(cachedScheduling.maxWaitTime.citations).join(\", \") : \"Safe Default\",\n        citations: cachedScheduling.maxWaitTime.citations,\n        fromKnowledge: cachedScheduling.maxWaitTime.citations.length > 0\n      }\n    };\n  }\n\n  return {\n    serviceTimes: {\n      checkup: { value: 20, unit: \"Minuten\", source: \"Safe Default\", citations: [], fromKnowledge: false },\n      treatment: { value: 45, unit: \"Minuten\", source: \"Safe Default\", citations: [], fromKnowledge: false },\n      cleaning: { value: 30, unit: \"Minuten\", source: \"Safe Default\", citations: [], fromKnowledge: false }\n    },\n    bufferMinutes: { value: 5, unit: \"Minuten\", source: \"Safe Default\", citations: [], fromKnowledge: false },\n    maxWaitTime: { value: 15, unit: \"Minuten\", source: \"Safe Default\", citations: [], fromKnowledge: false }\n  };\n}\n\nexport async function getKnowledgePoweredRecommendations(\n  hasReception: boolean,\n  hasWaiting: boolean,\n  examRoomCount: number,\n  hasLab: boolean,\n  hasOffice: boolean\n): Promise<RecommendationWithCitation[]> {\n  const recommendations: RecommendationWithCitation[] = [];\n  \n  const layoutRules = await getLayoutRules();\n  \n  if (!hasReception) {\n    const rule = layoutRules.find(r => \n      r.payload.condition?.toLowerCase().includes(\"empfang\") ||\n      r.topic.toLowerCase().includes(\"empfang\") ||\n      r.topic.toLowerCase().includes(\"reception\")\n    );\n    \n    recommendations.push({\n      text: rule?.payload.action || \"KRITISCH: Empfangsbereich hinzufügen. Unerlässlich für Patientenanmeldung und ersten Eindruck.\",\n      priority: \"critical\",\n      citations: rule?.citations || [],\n      fromKnowledge: !!rule\n    });\n  }\n\n  if (!hasWaiting) {\n    const rule = layoutRules.find(r => \n      r.payload.condition?.toLowerCase().includes(\"warte\") ||\n      r.topic.toLowerCase().includes(\"warte\") ||\n      r.topic.toLowerCase().includes(\"waiting\")\n    );\n    \n    recommendations.push({\n      text: rule?.payload.action || \"KRITISCH: Wartebereich hinzufügen. Patienten benötigen einen komfortablen Raum während der Wartezeit.\",\n      priority: \"critical\",\n      citations: rule?.citations || [],\n      fromKnowledge: !!rule\n    });\n  }\n\n  if (examRoomCount === 0) {\n    const rule = layoutRules.find(r => \n      r.payload.condition?.toLowerCase().includes(\"behandlungsraum\") ||\n      r.topic.toLowerCase().includes(\"behandlungsraum\") ||\n      r.topic.toLowerCase().includes(\"exam\")\n    );\n    \n    recommendations.push({\n      text: rule?.payload.action || \"KRITISCH: Behandlungsräume hinzufügen. Diese sind der Kern Ihrer Praxistätigkeit.\",\n      priority: \"critical\",\n      citations: rule?.citations || [],\n      fromKnowledge: !!rule\n    });\n  } else if (examRoomCount === 1) {\n    const rule = layoutRules.find(r => \n      r.payload.condition?.toLowerCase().includes(\"behandlungsräume\") ||\n      r.topic.toLowerCase().includes(\"anzahl\")\n    );\n    \n    recommendations.push({\n      text: rule?.payload.action || \"Erwägen Sie weitere Behandlungsräume. Standard ist 3-4 pro Arzt für optimale Effizienz (KV-Empfehlung).\",\n      priority: \"high\",\n      citations: rule?.citations || [],\n      fromKnowledge: !!rule\n    });\n  }\n\n  if (!hasLab && examRoomCount > 0) {\n    const rule = layoutRules.find(r => \n      r.payload.condition?.toLowerCase().includes(\"labor\") ||\n      r.topic.toLowerCase().includes(\"labor\") ||\n      r.topic.toLowerCase().includes(\"lab\")\n    );\n    \n    recommendations.push({\n      text: rule?.payload.action || \"Erwägen Sie einen Laborbereich. Ein Labor neben den Behandlungsräumen reduziert Wartezeiten um 15-20%.\",\n      priority: \"medium\",\n      citations: rule?.citations || [],\n      fromKnowledge: !!rule\n    });\n  }\n\n  if (!hasOffice) {\n    recommendations.push({\n      text: \"Erwägen Sie ein Büro für Beratungsgespräche und Verwaltungsarbeit.\",\n      priority: \"low\",\n      citations: [],\n      fromKnowledge: false\n    });\n  }\n\n  if (recommendations.length === 0) {\n    recommendations.push({\n      text: \"Ihr Layout enthält alle wesentlichen Raumtypen. Fokussieren Sie auf Optimierung der Raumplatzierung und -größen.\",\n      priority: \"low\",\n      citations: [],\n      fromKnowledge: false\n    });\n  }\n\n  return recommendations;\n}\n\nimport { DEFAULT_LAYOUT_SCALE_PX_PER_METER, normalizeRoomType } from \"@shared/roomTypes\";\n\nexport async function evaluateRoomSizeWithKnowledge(\n  type: string,\n  widthPx: number,\n  heightPx: number,\n  scalePxPerMeter: number = DEFAULT_LAYOUT_SCALE_PX_PER_METER\n): Promise<{\n  score: number;\n  assessment: \"undersized\" | \"optimal\" | \"oversized\";\n  actualSqM: number;\n  recommendation: string;\n  citations: SourceCitation[];\n  fromKnowledge: boolean;\n}> {\n  const roomSizes = await getKnowledgePoweredRoomSizes();\n  const normalizedType = normalizeRoomType(type);\n  const standard = roomSizes[normalizedType];\n  \n  if (!standard) {\n    return {\n      score: 50,\n      assessment: \"optimal\",\n      actualSqM: 0,\n      recommendation: \"Unbekannter Raumtyp\",\n      citations: [],\n      fromKnowledge: false\n    };\n  }\n\n  const actualSqM = pixelsToSqM(widthPx, heightPx, scalePxPerMeter);\n\n  let score: number;\n  let assessment: \"undersized\" | \"optimal\" | \"oversized\";\n  let recommendation: string;\n\n  if (actualSqM < standard.minSqM) {\n    const deficit = ((standard.minSqM - actualSqM) / standard.minSqM) * 100;\n    score = Math.max(0, 50 - deficit);\n    assessment = \"undersized\";\n    recommendation = `Raum ist ${Math.round(deficit)}% unter dem Minimum. Empfehlung: mindestens ${standard.minSqM} m² gemäß ${standard.source}.`;\n  } else if (actualSqM > standard.maxSqM) {\n    const excess = ((actualSqM - standard.maxSqM) / standard.maxSqM) * 100;\n    score = Math.max(60, 90 - (excess * 0.5));\n    assessment = \"oversized\";\n    recommendation = `Raum ist ${Math.round(excess)}% über dem Maximum. Raumnutzung optimieren.`;\n  } else {\n    const distanceFromOptimal = Math.abs(actualSqM - standard.optimalSqM);\n    const range = standard.maxSqM - standard.minSqM;\n    score = 100 - ((distanceFromOptimal / range) * 20);\n    assessment = \"optimal\";\n    recommendation = `Raumgröße entspricht den Standards. Optimale Größe: ${standard.optimalSqM} m².`;\n  }\n\n  return {\n    score: Math.round(score),\n    assessment,\n    actualSqM,\n    recommendation,\n    citations: standard.citations,\n    fromKnowledge: standard.fromKnowledge\n  };\n}\n\nexport async function getHealthScoreDrivers(): Promise<{\n  weights: Record<string, number>;\n  rules: ArtifactResult<RulePayload>[];\n  citations: SourceCitation[];\n  fromKnowledge: boolean;\n}> {\n  const rules = await getDashboardRules();\n  \n  const weightRule = rules.find(r => \n    r.topic.toLowerCase().includes(\"gewichtung\") ||\n    r.topic.toLowerCase().includes(\"score\") ||\n    r.topic.toLowerCase().includes(\"health\")\n  );\n\n  if (weightRule && typeof weightRule.payload === 'object') {\n    const allCitations = rules.flatMap(r => r.citations);\n    return {\n      weights: (weightRule.payload as any).weights || SAFE_DEFAULTS.dashboard.healthScoreWeights,\n      rules,\n      citations: allCitations,\n      fromKnowledge: true\n    };\n  }\n\n  return {\n    weights: SAFE_DEFAULTS.dashboard.healthScoreWeights,\n    rules,\n    citations: [],\n    fromKnowledge: false\n  };\n}\n\nexport interface DistanceGuideline {\n  maxMeters: number;\n  optimal: number;\n  source: string;\n  citations: SourceCitation[];\n  fromKnowledge: boolean;\n}\n\nexport interface ZoningRule {\n  zones: string[];\n  description: string;\n  citations: SourceCitation[];\n  fromKnowledge: boolean;\n}\n\nexport interface KnowledgePoweredLayout {\n  roomSizes: Record<string, KnowledgePoweredRoomSize>;\n  distanceGuidelines: {\n    receptionToWaiting: DistanceGuideline;\n    waitingToExam: DistanceGuideline;\n    examToLab: DistanceGuideline;\n    examToExam: DistanceGuideline;\n  };\n  zoningRules: {\n    onStage: ZoningRule;\n    offStage: ZoningRule;\n    clinical: ZoningRule;\n  };\n  fromKnowledge: boolean;\n}\n\nlet cachedLayout: KnowledgePoweredLayout | null = null;\nlet layoutCacheExpiry = 0;\n\nexport async function getKnowledgePoweredLayout(): Promise<KnowledgePoweredLayout> {\n  if (Date.now() < layoutCacheExpiry && cachedLayout) {\n    return cachedLayout;\n  }\n\n  const [roomSizes, layoutArtifacts] = await Promise.all([\n    getKnowledgePoweredRoomSizes(),\n    getLayoutRules()\n  ]);\n\n  const distanceArtifact = layoutArtifacts.find(a => \n    a.topic.toLowerCase().includes(\"distance\") || \n    a.topic.toLowerCase().includes(\"entfernung\") ||\n    a.topic.toLowerCase().includes(\"laufweg\")\n  );\n\n  const zoningArtifact = layoutArtifacts.find(a => \n    a.topic.toLowerCase().includes(\"zoning\") || \n    a.topic.toLowerCase().includes(\"bereich\") ||\n    a.topic.toLowerCase().includes(\"zone\")\n  );\n\n  const hasKnowledgeDistances = !!distanceArtifact;\n  const hasKnowledgeZoning = !!zoningArtifact;\n\n  const distanceGuidelines = {\n    receptionToWaiting: buildDistanceGuideline(\n      distanceArtifact?.payload?.receptionToWaiting,\n      SAFE_DEFAULTS.layout.distanceGuidelines.receptionToWaiting,\n      distanceArtifact?.citations || []\n    ),\n    waitingToExam: buildDistanceGuideline(\n      distanceArtifact?.payload?.waitingToExam,\n      SAFE_DEFAULTS.layout.distanceGuidelines.waitingToExam,\n      distanceArtifact?.citations || []\n    ),\n    examToLab: buildDistanceGuideline(\n      distanceArtifact?.payload?.examToLab,\n      SAFE_DEFAULTS.layout.distanceGuidelines.examToLab,\n      distanceArtifact?.citations || []\n    ),\n    examToExam: buildDistanceGuideline(\n      distanceArtifact?.payload?.examToExam,\n      SAFE_DEFAULTS.layout.distanceGuidelines.examToExam,\n      distanceArtifact?.citations || []\n    )\n  };\n\n  const zoningRules = {\n    onStage: buildZoningRule(\n      zoningArtifact?.payload?.onStage,\n      SAFE_DEFAULTS.layout.zoningRules.onStage,\n      zoningArtifact?.citations || []\n    ),\n    offStage: buildZoningRule(\n      zoningArtifact?.payload?.offStage,\n      SAFE_DEFAULTS.layout.zoningRules.offStage,\n      zoningArtifact?.citations || []\n    ),\n    clinical: buildZoningRule(\n      zoningArtifact?.payload?.clinical,\n      SAFE_DEFAULTS.layout.zoningRules.clinical,\n      zoningArtifact?.citations || []\n    )\n  };\n\n  cachedLayout = {\n    roomSizes,\n    distanceGuidelines,\n    zoningRules,\n    fromKnowledge: hasKnowledgeDistances || hasKnowledgeZoning || Object.values(roomSizes).some(r => r.fromKnowledge)\n  };\n\n  layoutCacheExpiry = Date.now() + CACHE_TTL;\n  return cachedLayout;\n}\n\nfunction buildDistanceGuideline(\n  knowledgeData: { maxMeters?: number; optimal?: number; source?: string } | undefined,\n  fallback: { maxMeters: number; optimal: number; source: string },\n  citations: SourceCitation[]\n): DistanceGuideline {\n  if (knowledgeData && (knowledgeData.maxMeters || knowledgeData.optimal)) {\n    return {\n      maxMeters: knowledgeData.maxMeters ?? fallback.maxMeters,\n      optimal: knowledgeData.optimal ?? fallback.optimal,\n      source: knowledgeData.source ?? (formatCitations(citations).join(\", \") || fallback.source),\n      citations,\n      fromKnowledge: true\n    };\n  }\n  return {\n    ...fallback,\n    citations: [],\n    fromKnowledge: false\n  };\n}\n\nfunction buildZoningRule(\n  knowledgeData: { zones?: string[]; description?: string } | undefined,\n  fallback: { zones: string[]; description: string },\n  citations: SourceCitation[]\n): ZoningRule {\n  if (knowledgeData && knowledgeData.zones) {\n    return {\n      zones: knowledgeData.zones,\n      description: knowledgeData.description ?? fallback.description,\n      citations,\n      fromKnowledge: true\n    };\n  }\n  return {\n    ...fallback,\n    citations: [],\n    fromKnowledge: false\n  };\n}\n\nexport function clearCache() {\n  cachedRoomSizes = null;\n  cachedStaffing = null;\n  cachedScheduling = null;\n  cachedLayout = null;\n  cacheExpiry = 0;\n  layoutCacheExpiry = 0;\n}\n","path":null,"size_bytes":18020,"size_tokens":null},"tests/artifacts-smoke.test.ts":{"content":"import { z } from \"zod\";\nimport { ARTIFACT_TYPES, MODULES, type SourceCitation, type BenchmarkPayload, type RulePayload } from \"../shared/taxonomy\";\nimport { runSimulation, type SimulationParameters } from \"../server/simulation\";\nimport type { Room, Staff } from \"../shared/schema\";\n\nconst SourceCitationSchema = z.object({\n  docName: z.string(),\n  headingPath: z.string().nullable(),\n  chunkId: z.string()\n});\n\nconst BenchmarkPayloadSchema = z.object({\n  metric: z.string(),\n  unit: z.string(),\n  min: z.number().optional(),\n  max: z.number().optional(),\n  optimal: z.number().optional(),\n  description: z.string(),\n  source: z.string()\n});\n\nconst RulePayloadSchema = z.object({\n  condition: z.string(),\n  action: z.string(),\n  priority: z.enum([\"critical\", \"high\", \"medium\", \"low\"]),\n  description: z.string()\n});\n\nconst ArtifactSchema = z.object({\n  id: z.string().optional(),\n  tenantId: z.string().nullable().optional(),\n  artifactType: z.enum(ARTIFACT_TYPES),\n  module: z.enum(MODULES),\n  topic: z.string(),\n  payloadJson: z.union([BenchmarkPayloadSchema, RulePayloadSchema, z.record(z.any())]),\n  sourceCitations: z.array(SourceCitationSchema),\n  confidence: z.number().min(0).max(1),\n  version: z.number().int().positive(),\n  sourceHash: z.string().nullable().optional()\n});\n\nasync function testArtifactSchemaValidation(): Promise<boolean> {\n  console.log(\"Testing artifact schema validation...\");\n\n  const validBenchmark = {\n    artifactType: \"benchmark\" as const,\n    module: \"layout\" as const,\n    topic: \"Behandlungsraum Größe\",\n    payloadJson: {\n      metric: \"Raumgröße\",\n      unit: \"m²\",\n      min: 9,\n      max: 12,\n      optimal: 10,\n      description: \"Behandlungsraum Mindest- und Maximalgröße gemäß ArbStättV\",\n      source: \"ArbStättV\"\n    },\n    sourceCitations: [{\n      docName: \"coaching-guide.docx\",\n      headingPath: \"Layout > Raumgrößen\",\n      chunkId: \"chunk-123\"\n    }],\n    confidence: 0.85,\n    version: 1\n  };\n\n  const validRule = {\n    artifactType: \"rule\" as const,\n    module: \"layout\" as const,\n    topic: \"Wartebereich Pflicht\",\n    payloadJson: {\n      condition: \"Kein Wartebereich vorhanden\",\n      action: \"Wartebereich hinzufügen (mind. 15m²)\",\n      priority: \"critical\" as const,\n      description: \"Wartebereich ist für Patientenkomfort essenziell\"\n    },\n    sourceCitations: [],\n    confidence: 0.9,\n    version: 1\n  };\n\n  const invalidArtifact = {\n    artifactType: \"unknown_type\",\n    module: \"layout\",\n    topic: \"Test\"\n  };\n\n  try {\n    const result1 = ArtifactSchema.safeParse(validBenchmark);\n    if (!result1.success) {\n      console.error(\"  FAIL: Valid benchmark should pass validation\", result1.error.issues);\n      return false;\n    }\n    console.log(\"  PASS: Benchmark artifact validated\");\n\n    const result2 = ArtifactSchema.safeParse(validRule);\n    if (!result2.success) {\n      console.error(\"  FAIL: Valid rule should pass validation\", result2.error.issues);\n      return false;\n    }\n    console.log(\"  PASS: Rule artifact validated\");\n\n    const result3 = ArtifactSchema.safeParse(invalidArtifact);\n    if (result3.success) {\n      console.error(\"  FAIL: Invalid artifact should fail validation\");\n      return false;\n    }\n    console.log(\"  PASS: Invalid artifact correctly rejected\");\n\n    return true;\n  } catch (error) {\n    console.error(\"  ERROR:\", error);\n    return false;\n  }\n}\n\nasync function testSimulatorWithMockData(): Promise<boolean> {\n  console.log(\"\\nTesting simulator with mock practice data...\");\n\n  const mockRooms: Room[] = [\n    { id: \"1\", practiceId: \"test\", type: \"reception\", name: \"Empfang\", x: 0, y: 0, width: 150, height: 120 },\n    { id: \"2\", practiceId: \"test\", type: \"waiting\", name: \"Wartebereich\", x: 200, y: 0, width: 200, height: 180 },\n    { id: \"3\", practiceId: \"test\", type: \"exam\", name: \"Behandlungsraum 1\", x: 0, y: 200, width: 180, height: 150 },\n    { id: \"4\", practiceId: \"test\", type: \"exam\", name: \"Behandlungsraum 2\", x: 200, y: 200, width: 180, height: 150 },\n    { id: \"5\", practiceId: \"test\", type: \"lab\", name: \"Labor\", x: 400, y: 200, width: 150, height: 120 }\n  ];\n\n  const mockStaff: Staff[] = [\n    { id: \"1\", practiceId: \"test\", name: \"Dr. Müller\", role: \"dentist\", avatar: \"doctor-1\", experienceLevel: 4, specializations: [\"Implantologie\"] },\n    { id: \"2\", practiceId: \"test\", name: \"MFA Schmidt\", role: \"nurse\", avatar: \"nurse-1\", experienceLevel: 3, specializations: [] },\n    { id: \"3\", practiceId: \"test\", name: \"MFA Weber\", role: \"nurse\", avatar: \"nurse-2\", experienceLevel: 5, specializations: [] },\n    { id: \"4\", practiceId: \"test\", name: \"Frau Klein\", role: \"receptionist\", avatar: \"receptionist-1\", experienceLevel: 3, specializations: [] }\n  ];\n\n  const parameters: SimulationParameters = {\n    patientVolume: 25,\n    operatingHours: 8\n  };\n\n  try {\n    const result = await runSimulation(mockRooms, mockStaff, parameters);\n\n    if (typeof result.efficiencyScore !== 'number' || isNaN(result.efficiencyScore)) {\n      console.error(\"  FAIL: efficiencyScore is not a valid number\");\n      return false;\n    }\n    console.log(`  efficiencyScore: ${result.efficiencyScore}`);\n\n    if (typeof result.harmonyScore !== 'number' || isNaN(result.harmonyScore)) {\n      console.error(\"  FAIL: harmonyScore is not a valid number\");\n      return false;\n    }\n    console.log(`  harmonyScore: ${result.harmonyScore}`);\n\n    if (typeof result.waitTime !== 'number' || isNaN(result.waitTime)) {\n      console.error(\"  FAIL: waitTime is not a valid number\");\n      return false;\n    }\n    console.log(`  waitTime: ${result.waitTime} min`);\n\n    if (typeof result.patientCapacity !== 'number' || isNaN(result.patientCapacity)) {\n      console.error(\"  FAIL: patientCapacity is not a valid number\");\n      return false;\n    }\n    console.log(`  patientCapacity: ${result.patientCapacity} patients/day`);\n\n    if (result.efficiencyScore < 0 || result.efficiencyScore > 100) {\n      console.error(\"  FAIL: efficiencyScore out of range [0-100]\");\n      return false;\n    }\n\n    if (result.harmonyScore < 0 || result.harmonyScore > 100) {\n      console.error(\"  FAIL: harmonyScore out of range [0-100]\");\n      return false;\n    }\n\n    if (result.waitTime < 5 || result.waitTime > 60) {\n      console.error(\"  FAIL: waitTime out of expected range [5-60]\");\n      return false;\n    }\n\n    console.log(\"  PASS: Simulator returned valid results\");\n    return true;\n  } catch (error) {\n    console.error(\"  ERROR:\", error);\n    return false;\n  }\n}\n\nasync function testSimulatorWithEmptyData(): Promise<boolean> {\n  console.log(\"\\nTesting simulator with empty practice data...\");\n\n  const emptyRooms: Room[] = [];\n  const emptyStaff: Staff[] = [];\n  const parameters: SimulationParameters = {\n    patientVolume: 10,\n    operatingHours: 8\n  };\n\n  try {\n    const result = await runSimulation(emptyRooms, emptyStaff, parameters);\n\n    if (result.efficiencyScore !== 0) {\n      console.log(`  Note: efficiencyScore for empty practice: ${result.efficiencyScore}`);\n    }\n\n    if (result.patientCapacity < 1) {\n      console.error(\"  FAIL: patientCapacity should be at least 1\");\n      return false;\n    }\n\n    console.log(\"  PASS: Simulator handles empty data gracefully\");\n    return true;\n  } catch (error) {\n    console.error(\"  ERROR:\", error);\n    return false;\n  }\n}\n\nasync function main() {\n  console.log(\"=== Phase 2.5 Smoke Tests ===\\n\");\n\n  let passed = 0;\n  let failed = 0;\n\n  if (await testArtifactSchemaValidation()) {\n    passed++;\n  } else {\n    failed++;\n  }\n\n  if (await testSimulatorWithMockData()) {\n    passed++;\n  } else {\n    failed++;\n  }\n\n  if (await testSimulatorWithEmptyData()) {\n    passed++;\n  } else {\n    failed++;\n  }\n\n  console.log(`\\n=== Results: ${passed} passed, ${failed} failed ===`);\n\n  if (failed > 0) {\n    process.exit(1);\n  }\n}\n\nmain().catch(console.error);\n","path":null,"size_bytes":7830,"size_tokens":null},"scripts/ingest-knowledge.ts":{"content":"import fs from \"fs\";\nimport path from \"path\";\nimport crypto from \"crypto\";\nimport mammoth from \"mammoth\";\nimport OpenAI from \"openai\";\nimport { db } from \"../server/db\";\nimport { knowledgeSources, knowledgeChunks } from \"../shared/schema\";\nimport { eq } from \"drizzle-orm\";\n\nconst openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });\n\nconst KNOWLEDGE_DOCS_DIR = \"./knowledge-docs\";\nconst TARGET_TOKENS = 750;\nconst MIN_TOKENS = 600;\nconst MAX_TOKENS = 900;\nconst OVERLAP_TOKENS = 100;\n\nconst FORCE_MODE = process.argv.includes(\"--force\") || process.env.FORCE_REINGEST === \"1\";\nconst DEBUG_MODE = process.argv.includes(\"--debug\");\n\ninterface ChunkInfo {\n  content: string;\n  headingPath: string;\n  tokens: number;\n}\n\ninterface IngestStats {\n  documentsProcessed: number;\n  documentsSkippedUnchanged: number;\n  chunksExisting: number;\n  chunksInserted: number;\n  chunksUpdated: number;\n  chunksSkipped: number;\n}\n\nfunction estimateTokens(text: string): number {\n  return Math.ceil(text.length / 4);\n}\n\nfunction computeFileHash(buffer: Buffer): string {\n  return crypto.createHash(\"sha256\").update(buffer).digest(\"hex\").slice(0, 16);\n}\n\nfunction computeContentHash(content: string): string {\n  return crypto.createHash(\"sha256\").update(content).digest(\"hex\").slice(0, 16);\n}\n\nasync function extractTextWithHeadings(buffer: Buffer): Promise<string> {\n  const result = await mammoth.convertToHtml({ buffer });\n  const html = result.value;\n  \n  let text = html\n    .replace(/<h1[^>]*>(.*?)<\\/h1>/gi, \"\\n\\n# $1\\n\\n\")\n    .replace(/<h2[^>]*>(.*?)<\\/h2>/gi, \"\\n\\n## $1\\n\\n\")\n    .replace(/<h3[^>]*>(.*?)<\\/h3>/gi, \"\\n\\n### $1\\n\\n\")\n    .replace(/<h4[^>]*>(.*?)<\\/h4>/gi, \"\\n\\n#### $1\\n\\n\")\n    .replace(/<p[^>]*>(.*?)<\\/p>/gi, \"$1\\n\\n\")\n    .replace(/<li[^>]*>(.*?)<\\/li>/gi, \"• $1\\n\")\n    .replace(/<br\\s*\\/?>/gi, \"\\n\")\n    .replace(/<[^>]+>/g, \"\")\n    .replace(/&nbsp;/g, \" \")\n    .replace(/&amp;/g, \"&\")\n    .replace(/&lt;/g, \"<\")\n    .replace(/&gt;/g, \">\")\n    .replace(/\\n{3,}/g, \"\\n\\n\")\n    .trim();\n  \n  return text;\n}\n\nfunction splitIntoHeadingBasedChunks(text: string): ChunkInfo[] {\n  const lines = text.split(\"\\n\");\n  const chunks: ChunkInfo[] = [];\n  \n  let currentHeadingPath = \"Dokument\";\n  let currentContent = \"\";\n  let headingStack: string[] = [];\n  \n  for (const line of lines) {\n    const h1Match = line.match(/^# (.+)$/);\n    const h2Match = line.match(/^## (.+)$/);\n    const h3Match = line.match(/^### (.+)$/);\n    const h4Match = line.match(/^#### (.+)$/);\n    \n    if (h1Match) {\n      if (currentContent.trim()) {\n        chunks.push(...splitLargeChunk(currentContent.trim(), currentHeadingPath));\n      }\n      headingStack = [h1Match[1]];\n      currentHeadingPath = headingStack.join(\" > \");\n      currentContent = \"\";\n    } else if (h2Match) {\n      if (currentContent.trim()) {\n        chunks.push(...splitLargeChunk(currentContent.trim(), currentHeadingPath));\n      }\n      headingStack = headingStack.slice(0, 1);\n      headingStack.push(h2Match[1]);\n      currentHeadingPath = headingStack.join(\" > \");\n      currentContent = \"\";\n    } else if (h3Match) {\n      if (currentContent.trim()) {\n        chunks.push(...splitLargeChunk(currentContent.trim(), currentHeadingPath));\n      }\n      headingStack = headingStack.slice(0, 2);\n      headingStack.push(h3Match[1]);\n      currentHeadingPath = headingStack.join(\" > \");\n      currentContent = \"\";\n    } else if (h4Match) {\n      if (currentContent.trim()) {\n        chunks.push(...splitLargeChunk(currentContent.trim(), currentHeadingPath));\n      }\n      headingStack = headingStack.slice(0, 3);\n      headingStack.push(h4Match[1]);\n      currentHeadingPath = headingStack.join(\" > \");\n      currentContent = \"\";\n    } else {\n      currentContent += line + \"\\n\";\n    }\n  }\n  \n  if (currentContent.trim()) {\n    chunks.push(...splitLargeChunk(currentContent.trim(), currentHeadingPath));\n  }\n  \n  return chunks;\n}\n\nfunction splitLargeChunk(content: string, headingPath: string): ChunkInfo[] {\n  const tokens = estimateTokens(content);\n  \n  if (tokens <= MAX_TOKENS) {\n    return [{ content, headingPath, tokens }];\n  }\n  \n  const paragraphs = content.split(/\\n\\n+/);\n  const chunks: ChunkInfo[] = [];\n  let currentChunk = \"\";\n  let currentTokens = 0;\n  \n  for (const para of paragraphs) {\n    const paraTokens = estimateTokens(para);\n    \n    if (currentTokens + paraTokens > TARGET_TOKENS && currentChunk) {\n      chunks.push({\n        content: currentChunk.trim(),\n        headingPath,\n        tokens: currentTokens\n      });\n      \n      const overlapText = currentChunk.slice(-OVERLAP_TOKENS * 4);\n      currentChunk = overlapText + \"\\n\\n\" + para;\n      currentTokens = estimateTokens(currentChunk);\n    } else {\n      currentChunk += (currentChunk ? \"\\n\\n\" : \"\") + para;\n      currentTokens += paraTokens;\n    }\n  }\n  \n  if (currentChunk.trim()) {\n    chunks.push({\n      content: currentChunk.trim(),\n      headingPath,\n      tokens: estimateTokens(currentChunk.trim())\n    });\n  }\n  \n  return chunks;\n}\n\nasync function generateEmbedding(text: string): Promise<number[]> {\n  const response = await openai.embeddings.create({\n    model: \"text-embedding-3-small\",\n    input: text.slice(0, 8000),\n  });\n  return response.data[0].embedding;\n}\n\nasync function ingestDocument(filePath: string, stats: IngestStats): Promise<void> {\n  const fileName = path.basename(filePath);\n  const buffer = fs.readFileSync(filePath);\n  const fileHash = computeFileHash(buffer);\n  \n  if (DEBUG_MODE) {\n    console.log(`  📋 ${fileName} → hash: ${fileHash}`);\n  }\n  \n  const existingSource = await db.select()\n    .from(knowledgeSources)\n    .where(eq(knowledgeSources.fileName, fileName))\n    .limit(1);\n  \n  let sourceId: string;\n  const isUnchanged = existingSource.length > 0 && existingSource[0].fileHash === fileHash;\n  \n  if (isUnchanged && !FORCE_MODE) {\n    console.log(`  ⏭️  Unchanged: ${fileName}`);\n    stats.documentsSkippedUnchanged++;\n    return;\n  }\n  \n  stats.documentsProcessed++;\n  \n  if (existingSource.length > 0) {\n    sourceId = existingSource[0].id;\n    if (!isUnchanged) {\n      await db.update(knowledgeSources)\n        .set({ fileHash, updatedAt: new Date() })\n        .where(eq(knowledgeSources.id, sourceId));\n      console.log(`  🔄 Updating: ${fileName}`);\n    } else {\n      console.log(`  🔁 Force re-ingesting: ${fileName}`);\n    }\n  } else {\n    const title = fileName.replace(/\\.docx$/i, \"\").replace(/[_-]/g, \" \");\n    const [newSource] = await db.insert(knowledgeSources).values({\n      title,\n      fileName,\n      fileHash,\n      category: \"training\",\n      tags: [\"dental\", \"praxis\", \"coaching\"],\n    }).returning();\n    sourceId = newSource.id;\n    console.log(`  ➕ New: ${fileName}`);\n  }\n  \n  const text = await extractTextWithHeadings(buffer);\n  const chunkInfos = splitIntoHeadingBasedChunks(text);\n  \n  for (let i = 0; i < chunkInfos.length; i++) {\n    const chunk = chunkInfos[i];\n    const contentHash = computeContentHash(chunk.content);\n    \n    const existingChunk = await db.select()\n      .from(knowledgeChunks)\n      .where(eq(knowledgeChunks.contentHash, contentHash))\n      .limit(1);\n    \n    if (existingChunk.length > 0) {\n      if (existingChunk[0].sourceId !== sourceId) {\n        await db.update(knowledgeChunks)\n          .set({ sourceId, headingPath: chunk.headingPath, chunkIndex: i })\n          .where(eq(knowledgeChunks.id, existingChunk[0].id));\n        stats.chunksUpdated++;\n      } else {\n        stats.chunksExisting++;\n      }\n      continue;\n    }\n    \n    const embedding = await generateEmbedding(chunk.content);\n    \n    await db.insert(knowledgeChunks).values({\n      sourceId,\n      headingPath: chunk.headingPath,\n      chunkIndex: i,\n      content: chunk.content,\n      contentHash,\n      tokens: chunk.tokens,\n      embedding,\n    });\n    \n    stats.chunksInserted++;\n  }\n}\n\nasync function main() {\n  console.log(\"🚀 Knowledge Ingestion Starting...\\n\");\n  \n  if (FORCE_MODE) {\n    console.log(\"⚡ FORCE MODE ENABLED - Re-processing all documents\\n\");\n  }\n  if (DEBUG_MODE) {\n    console.log(\"🔍 DEBUG MODE ENABLED - Showing hash details\\n\");\n  }\n  \n  const startTime = Date.now();\n  \n  const files = fs.readdirSync(KNOWLEDGE_DOCS_DIR)\n    .filter(f => f.endsWith(\".docx\"))\n    .map(f => path.join(KNOWLEDGE_DOCS_DIR, f));\n  \n  console.log(`📚 Found ${files.length} documents\\n`);\n  \n  const stats: IngestStats = {\n    documentsProcessed: 0,\n    documentsSkippedUnchanged: 0,\n    chunksExisting: 0,\n    chunksInserted: 0,\n    chunksUpdated: 0,\n    chunksSkipped: 0,\n  };\n  \n  for (const file of files) {\n    try {\n      await ingestDocument(file, stats);\n    } catch (error) {\n      console.error(`  ❌ Error: ${path.basename(file)}:`, error);\n    }\n  }\n  \n  const duration = ((Date.now() - startTime) / 1000).toFixed(1);\n  \n  console.log(\"\\n\" + \"=\".repeat(50));\n  console.log(\"📊 Ingestion Summary\");\n  console.log(\"=\".repeat(50));\n  console.log(`Documents found:              ${files.length}`);\n  console.log(`Documents processed:          ${stats.documentsProcessed}`);\n  console.log(`Documents skipped (unchanged):${stats.documentsSkippedUnchanged}`);\n  console.log(\"-\".repeat(50));\n  console.log(`Chunks inserted (new):        ${stats.chunksInserted}`);\n  console.log(`Chunks updated (moved):       ${stats.chunksUpdated}`);\n  console.log(`Chunks existing (unchanged):  ${stats.chunksExisting}`);\n  console.log(\"-\".repeat(50));\n  console.log(`Duration: ${duration}s`);\n  console.log(\"=\".repeat(50));\n}\n\nmain().catch(console.error).finally(() => process.exit(0));\n","path":null,"size_bytes":9541,"size_tokens":null},"PHASE_2_5_NOTES.md":{"content":"# Phase 2.5: Knowledge Artifact System\n\nThis document describes the knowledge artifact system implemented in Phase 2.5, which enables extracting structured knowledge from coaching documents and using it to power the simulation and dashboard with data-driven defaults.\n\n## Overview\n\nThe artifact system consists of three main components:\n1. **Knowledge Ingestion** - Extract text chunks from documents and store with embeddings\n2. **Artifact Building** - Use AI to extract structured artifacts from knowledge chunks\n3. **Runtime Integration** - Use artifacts as dynamic defaults in simulation and dashboard\n\n## HOWTO: End-to-End Usage\n\n### 1. Ingest Knowledge Documents\n\nPlace `.docx` files in the `/knowledge-docs/` directory, then run:\n\n```bash\nnpx tsx scripts/ingest-knowledge.ts\n```\n\nThis will:\n- Parse each document into chunks with heading hierarchy\n- Generate embeddings using OpenAI text-embedding-3-small\n- Store chunks in `knowledge_chunks` table with hash-based upsert (skips unchanged content)\n\n### 2. Build Artifacts\n\nRun the artifact builder (processes 20 artifacts per batch to stay within rate limits):\n\n```bash\nnpx tsx scripts/build-artifacts.ts\n```\n\nThis will:\n- Query knowledge chunks for each module/topic combination\n- Use GPT-4o to extract structured benchmarks, rules, formulas\n- Store in `knowledge_artifacts` table with source citations\n- Use hash-based upsert to avoid duplicate processing\n\nRepeat until all expected artifacts are built. Check progress with:\n\n```bash\ncurl http://localhost:5000/api/benchmarks\n```\n\n### 3. Run the Application\n\n```bash\nnpm run dev\n```\n\nThe application will automatically:\n- Load artifacts from the database with 5-minute cache\n- Use knowledge-powered defaults in simulation calculations\n- Display citations inline with recommendations on the dashboard\n\n### 4. Verify Integration\n\nRun smoke tests:\n\n```bash\nnpx tsx tests/artifacts-smoke.test.ts\n```\n\nTest the benchmarks endpoint:\n\n```bash\ncurl http://localhost:5000/api/benchmarks | jq\n```\n\n## Changed Files\n\n### New Files\n- `shared/taxonomy.ts` - Artifact types, modules, and SAFE_DEFAULTS\n- `scripts/build-artifacts.ts` - Batch artifact extraction script\n- `server/ai/artifactService.ts` - Query artifacts with caching and citations\n- `server/ai/artifactBenchmarks.ts` - Knowledge-powered benchmark wrappers\n- `tests/artifacts-smoke.test.ts` - Zod schema and simulator smoke tests\n\n### Modified Files\n- `shared/schema.ts` - Added `knowledge_artifacts` table\n- `server/simulation.ts` - Made async, uses `getKnowledgePoweredScheduling()`\n- `server/routes.ts` - Added `/api/benchmarks` endpoint, awaits async simulation\n- `server/ai/advisor.ts` - Uses `evaluateRoomSizeWithKnowledge()` and `getKnowledgePoweredRecommendations()`\n\n## Database Schema\n\n### knowledge_artifacts Table\n```sql\nCREATE TABLE knowledge_artifacts (\n  id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid(),\n  tenant_id VARCHAR,\n  artifact_type TEXT NOT NULL,  -- rule, benchmark, formula, template, checklist, playbook\n  module TEXT NOT NULL,         -- dashboard, layout, staffing, scheduling, hygiene, billing, marketing, qm\n  topic TEXT NOT NULL,\n  payload_json JSONB NOT NULL,\n  source_citations JSONB NOT NULL,\n  confidence REAL NOT NULL DEFAULT 0.8,\n  version INTEGER NOT NULL DEFAULT 1,\n  source_hash TEXT,\n  created_at TIMESTAMP NOT NULL DEFAULT NOW()\n);\n```\n\n## Artifact Types\n\n| Type | Payload Fields | Use Case |\n|------|---------------|----------|\n| benchmark | metric, unit, min, max, optimal, description, source | Room sizes, staffing ratios |\n| rule | condition, action, priority, description | Layout recommendations |\n| formula | name, formula, variables, description | Capacity calculations |\n| checklist | name, items, frequency, description | QM checklists |\n| template | name, template, variables, description | Document templates |\n| playbook | name, steps, description | Process workflows |\n\n## Modules\n\n- `dashboard` - Health score weights and display rules\n- `layout` - Room sizes, distances, placement rules\n- `staffing` - MFA per doctor, support ratios\n- `scheduling` - Service times, buffers, max wait times\n- `hygiene` - RKI guidelines, Hygieneverordnung\n- `billing` - EBM codes, GOZ procedures\n- `marketing` - Patient retention, acquisition\n- `qm` - QM-RL compliance, audit requirements\n\n## Safe Defaults\n\nIf no artifacts are found, the system falls back to `SAFE_DEFAULTS` defined in `shared/taxonomy.ts`:\n\n- Room sizes: Reception 8-14m², Waiting 15-35m², Treatment 9-12m², Lab 8-15m², Office 10-18m²\n- Staffing: 1.0-2.0 MFA per doctor, 2.5-4.0 support per physician\n- Scheduling: Checkup 20min, Treatment 45min, Cleaning 30min, Buffer 5min, Max wait 15min\n\n## Caching Strategy\n\nArtifacts are cached for 5 minutes in-memory (`CACHE_TTL = 5 * 60 * 1000`). The cache is refreshed automatically when:\n- Cache expires\n- Application restarts\n- `clearCache()` is called explicitly\n\n## Environment Variables Required\n\n- `DATABASE_URL` - PostgreSQL connection string\n- `OPENAI_API_KEY` (or `AI_INTEGRATIONS_OPENAI_API_KEY`) - For embeddings and artifact extraction\n- `TAVILY_API_KEY` (optional) - For web search augmentation in coach chat\n\n## Assumptions\n\n1. Documents are in German, matching the medical practice domain\n2. Embeddings use OpenAI text-embedding-3-small (1536 dimensions)\n3. Artifacts are tenant-agnostic (tenant_id is null) for now\n4. Confidence threshold for artifact usage is 0.8 (below this, falls back to defaults)\n5. The build script processes 20 artifacts per run to avoid API rate limits\n","path":null,"size_bytes":5512,"size_tokens":null},"shared/taxonomy.ts":{"content":"export const ARTIFACT_TYPES = [\n  \"rule\",\n  \"benchmark\",\n  \"formula\",\n  \"template\",\n  \"checklist\",\n  \"playbook\"\n] as const;\n\nexport type ArtifactType = typeof ARTIFACT_TYPES[number];\n\nexport const MODULES = [\n  \"dashboard\",\n  \"layout\",\n  \"staffing\",\n  \"scheduling\",\n  \"hygiene\",\n  \"billing\",\n  \"marketing\",\n  \"qm\"\n] as const;\n\nexport type Module = typeof MODULES[number];\n\nexport interface SourceCitation {\n  docName: string;\n  headingPath: string | null;\n  chunkId: string;\n}\n\nexport interface BenchmarkPayload {\n  metric: string;\n  unit: string;\n  min?: number;\n  max?: number;\n  optimal?: number;\n  description: string;\n  source: string;\n}\n\nexport interface RulePayload {\n  condition: string;\n  action: string;\n  priority: \"critical\" | \"high\" | \"medium\" | \"low\";\n  description: string;\n}\n\nexport interface FormulaPayload {\n  name: string;\n  formula: string;\n  variables: Record<string, string>;\n  description: string;\n}\n\nexport interface ChecklistPayload {\n  name: string;\n  items: string[];\n  frequency?: string;\n  description: string;\n}\n\nexport interface TemplatePayload {\n  name: string;\n  template: string;\n  variables: string[];\n  description: string;\n}\n\nexport interface PlaybookPayload {\n  name: string;\n  steps: Array<{\n    order: number;\n    action: string;\n    details: string;\n  }>;\n  description: string;\n}\n\nexport type ArtifactPayload = \n  | BenchmarkPayload \n  | RulePayload \n  | FormulaPayload \n  | ChecklistPayload \n  | TemplatePayload \n  | PlaybookPayload;\n\nexport const SAFE_DEFAULTS = {\n  dashboard: {\n    healthScoreWeights: {\n      layout: 0.25,\n      staffing: 0.25,\n      scheduling: 0.25,\n      qm: 0.25\n    }\n  },\n  layout: {\n    roomSizes: {\n      reception: { min: 8, max: 14, optimal: 10 },\n      waiting: { min: 15, max: 35, optimal: 22 },\n      treatment: { min: 9, max: 12, optimal: 10 },\n      exam: { min: 9, max: 12, optimal: 10 },\n      lab: { min: 8, max: 15, optimal: 10 },\n      office: { min: 10, max: 18, optimal: 14 },\n      storage: { min: 4, max: 10, optimal: 6 }\n    },\n    distanceGuidelines: {\n      receptionToWaiting: { maxMeters: 10, optimal: 5, source: \"DIN 18040 Barrierefreies Bauen\" },\n      waitingToExam: { maxMeters: 25, optimal: 12, source: \"Praxisbegehung Laufwege\" },\n      examToLab: { maxMeters: 15, optimal: 8, source: \"RKI Probenhandhabung Richtlinien\" },\n      examToExam: { maxMeters: 10, optimal: 5, source: \"Praxiseffizienz Standards\" }\n    },\n    zoningRules: {\n      onStage: {\n        zones: [\"reception\", \"waiting\"],\n        description: \"Patientenkontaktbereich - gepflegt, einladend, ruhig\"\n      },\n      offStage: {\n        zones: [\"lab\", \"storage\", \"office\"],\n        description: \"Interne Arbeitsbereiche - effizient, funktional\"\n      },\n      clinical: {\n        zones: [\"exam\", \"treatment\"],\n        description: \"Klinische Bereiche - steril, professionell\"\n      }\n    }\n  },\n  staffing: {\n    ratios: {\n      mfaPerDoctor: { min: 1.0, max: 2.0, optimal: 1.5 },\n      supportPerPhysician: { min: 2.5, max: 4.0, optimal: 3.0 }\n    }\n  },\n  scheduling: {\n    serviceTimes: {\n      checkup: { min: 15, max: 30, optimal: 20 },\n      treatment: { min: 30, max: 60, optimal: 45 },\n      cleaning: { min: 20, max: 40, optimal: 30 }\n    },\n    bufferMinutes: 5,\n    maxWaitTime: 15\n  }\n};\n","path":null,"size_bytes":3265,"size_tokens":null},"server/ai/artifactService.ts":{"content":"import { db } from \"../db\";\nimport { knowledgeArtifacts } from \"../../shared/schema\";\nimport { eq, and, sql } from \"drizzle-orm\";\nimport { SAFE_DEFAULTS, type SourceCitation, type BenchmarkPayload, type RulePayload } from \"../../shared/taxonomy\";\n\nexport interface ArtifactResult<T = any> {\n  id: string;\n  topic: string;\n  payload: T;\n  citations: SourceCitation[];\n  confidence: number;\n  fromKnowledge: boolean;\n}\n\nexport interface ArtifactQueryOptions {\n  module?: string;\n  artifactType?: string;\n  topic?: string;\n  minConfidence?: number;\n}\n\nconst missingTopicsLog: Set<string> = new Set();\n\nexport async function getArtifacts(options: ArtifactQueryOptions): Promise<ArtifactResult[]> {\n  const conditions = [];\n  \n  if (options.module) {\n    conditions.push(eq(knowledgeArtifacts.module, options.module));\n  }\n  if (options.artifactType) {\n    conditions.push(eq(knowledgeArtifacts.artifactType, options.artifactType));\n  }\n  if (options.topic) {\n    conditions.push(sql`${knowledgeArtifacts.topic} ILIKE ${`%${options.topic}%`}`);\n  }\n  if (options.minConfidence) {\n    conditions.push(sql`${knowledgeArtifacts.confidence} >= ${options.minConfidence}`);\n  }\n\n  const results = await db\n    .select()\n    .from(knowledgeArtifacts)\n    .where(conditions.length > 0 ? and(...conditions) : undefined)\n    .orderBy(sql`${knowledgeArtifacts.confidence} DESC`);\n\n  return results.map(r => ({\n    id: r.id,\n    topic: r.topic,\n    payload: r.payloadJson as any,\n    citations: r.sourceCitations as SourceCitation[],\n    confidence: r.confidence,\n    fromKnowledge: true\n  }));\n}\n\nexport async function getBenchmarks(module: string): Promise<ArtifactResult<BenchmarkPayload>[]> {\n  return getArtifacts({ module, artifactType: \"benchmark\" }) as Promise<ArtifactResult<BenchmarkPayload>[]>;\n}\n\nexport async function getRules(module: string): Promise<ArtifactResult<RulePayload>[]> {\n  return getArtifacts({ module, artifactType: \"rule\" }) as Promise<ArtifactResult<RulePayload>[]>;\n}\n\nexport function logMissingTopic(module: string, topic: string) {\n  const key = `${module}:${topic}`;\n  if (!missingTopicsLog.has(key)) {\n    missingTopicsLog.add(key);\n    console.warn(`[ArtifactService] Missing artifact: module=${module}, topic=${topic}`);\n  }\n}\n\nconst GERMAN_TO_ENGLISH_ROOM: Record<string, string> = {\n  \"empfangsbereich\": \"reception\",\n  \"empfang\": \"reception\",\n  \"wartezimmer\": \"waiting\",\n  \"wartebereich\": \"waiting\",\n  \"behandlungszimmer\": \"treatment\",\n  \"behandlungsraum\": \"treatment\",\n  \"untersuchungsraum\": \"exam\",\n  \"labor\": \"lab\",\n  \"personalraum\": \"office\",\n  \"büro\": \"office\",\n  \"sterilisationsraum\": \"storage\",\n  \"lager\": \"storage\"\n};\n\nexport async function getRoomSizeBenchmarks(): Promise<Record<string, { min: number; max: number; optimal: number; citations: SourceCitation[] }>> {\n  const artifacts = await getArtifacts({ module: \"layout\", topic: \"room_size_standards\" });\n  const result: Record<string, { min: number; max: number; optimal: number; citations: SourceCitation[] }> = {};\n  \n  const roomSizesArtifact = artifacts.find(a => a.topic === \"room_size_standards\");\n  \n  if (roomSizesArtifact && roomSizesArtifact.payload.room_types) {\n    const roomTypes = roomSizesArtifact.payload.room_types as Record<string, { min_sqm: number; max_sqm: number; optimal_sqm: number }>;\n    \n    for (const [germanName, sizes] of Object.entries(roomTypes)) {\n      const englishName = GERMAN_TO_ENGLISH_ROOM[germanName.toLowerCase()] || germanName.toLowerCase();\n      result[englishName] = {\n        min: sizes.min_sqm,\n        max: sizes.max_sqm,\n        optimal: sizes.optimal_sqm,\n        citations: roomSizesArtifact.citations\n      };\n    }\n  }\n  \n  const fallbackTypes = [\"reception\", \"waiting\", \"treatment\", \"exam\", \"lab\", \"office\", \"storage\"];\n  for (const type of fallbackTypes) {\n    if (!result[type]) {\n      const fallback = (SAFE_DEFAULTS.layout.roomSizes as any)[type];\n      if (fallback) {\n        logMissingTopic(\"layout\", `room_size_${type}`);\n        result[type] = { ...fallback, citations: [] };\n      }\n    }\n  }\n  \n  return result;\n}\n\nexport async function getStaffingBenchmarks(): Promise<{\n  mfaPerDoctor: { min: number; max: number; optimal: number; citations: SourceCitation[] };\n  supportPerPhysician: { min: number; max: number; optimal: number; citations: SourceCitation[] };\n}> {\n  const artifacts = await getArtifacts({ module: \"staffing\", topic: \"role_ratios\" });\n  const roleRatiosArtifact = artifacts.find(a => a.topic === \"role_ratios\");\n  \n  if (roleRatiosArtifact && roleRatiosArtifact.payload) {\n    const payload = roleRatiosArtifact.payload as {\n      mfa_per_dentist?: number;\n      total_staff_per_dentist?: number;\n      reception_per_dentist?: number;\n      prophylaxis_per_dentist?: number;\n    };\n    \n    const mfaValue = payload.mfa_per_dentist || 2;\n    const totalValue = payload.total_staff_per_dentist || 4;\n    \n    return {\n      mfaPerDoctor: {\n        min: Math.max(1, mfaValue - 0.5),\n        max: mfaValue + 1,\n        optimal: mfaValue,\n        citations: roleRatiosArtifact.citations\n      },\n      supportPerPhysician: {\n        min: Math.max(2.5, totalValue - 1),\n        max: totalValue + 1,\n        optimal: totalValue,\n        citations: roleRatiosArtifact.citations\n      }\n    };\n  }\n\n  return {\n    mfaPerDoctor: { ...SAFE_DEFAULTS.staffing.ratios.mfaPerDoctor, citations: [] },\n    supportPerPhysician: { ...SAFE_DEFAULTS.staffing.ratios.supportPerPhysician, citations: [] }\n  };\n}\n\nexport async function getSchedulingDefaults(): Promise<{\n  serviceTimes: Record<string, { min: number; max: number; optimal: number; citations: SourceCitation[] }>;\n  bufferMinutes: { value: number; citations: SourceCitation[] };\n  maxWaitTime: { value: number; citations: SourceCitation[] };\n}> {\n  const [schedulingArtifacts, dashboardArtifacts] = await Promise.all([\n    getArtifacts({ module: \"scheduling\" }),\n    getArtifacts({ module: \"dashboard\", topic: \"patient_flow_metrics\" })\n  ]);\n  \n  const serviceTimes: Record<string, { min: number; max: number; optimal: number; citations: SourceCitation[] }> = {};\n  \n  for (const artifact of schedulingArtifacts) {\n    if (artifact.topic.startsWith(\"service_time_\")) {\n      const serviceType = artifact.topic.replace(\"service_time_\", \"\");\n      serviceTimes[serviceType] = {\n        min: artifact.payload.min || 15,\n        max: artifact.payload.max || 60,\n        optimal: artifact.payload.optimal || 30,\n        citations: artifact.citations\n      };\n    }\n  }\n  \n  const serviceTypes = [\"checkup\", \"treatment\", \"cleaning\", \"consultation\", \"xray\"];\n  for (const type of serviceTypes) {\n    if (!serviceTimes[type]) {\n      const fallback = (SAFE_DEFAULTS.scheduling.serviceTimes as any)[type];\n      if (fallback) {\n        serviceTimes[type] = { ...fallback, citations: [] };\n      }\n    }\n  }\n\n  const maxWaitArtifact = schedulingArtifacts.find(a => a.topic === \"max_wait_time\");\n  const patientFlowArtifact = dashboardArtifacts.find(a => a.topic === \"patient_flow_metrics\");\n  \n  let bufferValue = SAFE_DEFAULTS.scheduling.bufferMinutes;\n  let bufferCitations: SourceCitation[] = [];\n  \n  if (patientFlowArtifact?.payload?.optimal_schedule_buffer_percent) {\n    bufferValue = Math.round(30 * (patientFlowArtifact.payload.optimal_schedule_buffer_percent / 100));\n    bufferCitations = patientFlowArtifact.citations;\n  }\n\n  return {\n    serviceTimes,\n    bufferMinutes: { value: bufferValue, citations: bufferCitations },\n    maxWaitTime: maxWaitArtifact ? {\n      value: maxWaitArtifact.payload.optimal || maxWaitArtifact.payload.max || 15,\n      citations: maxWaitArtifact.citations\n    } : { value: SAFE_DEFAULTS.scheduling.maxWaitTime, citations: [] }\n  };\n}\n\nexport async function getDashboardRules(): Promise<ArtifactResult[]> {\n  const artifacts = await getArtifacts({ module: \"dashboard\" });\n  \n  if (artifacts.length === 0) {\n    logMissingTopic(\"dashboard\", \"health_score_weights\");\n  }\n  \n  return artifacts;\n}\n\nexport async function getLayoutRules(): Promise<ArtifactResult[]> {\n  const artifacts = await getArtifacts({ module: \"layout\" });\n  return artifacts.filter(a => a.topic !== \"room_size_standards\");\n}\n\nexport async function getAllArtifactsByModule(module: string): Promise<{\n  benchmarks: ArtifactResult<BenchmarkPayload>[];\n  rules: ArtifactResult<RulePayload>[];\n}> {\n  const [benchmarks, rules] = await Promise.all([\n    getBenchmarks(module),\n    getRules(module)\n  ]);\n  \n  return { benchmarks, rules };\n}\n\nexport function formatCitation(citation: SourceCitation): string {\n  const docName = citation.docName.replace(/\\.docx$/i, \"\").replace(/[_-]/g, \" \");\n  return citation.headingPath \n    ? `${docName} > ${citation.headingPath}`\n    : docName;\n}\n\nexport function formatCitations(citations: SourceCitation[]): string[] {\n  return Array.from(new Set(citations.map(formatCitation)));\n}\n","path":null,"size_bytes":8833,"size_tokens":null},"shared/roomTypes.ts":{"content":"import { PX_PER_METER, pxToM, mToPx, px2ToM2 } from \"./units\";\n\nexport const CANONICAL_ROOM_TYPES = [\n  \"reception\",\n  \"waiting\", \n  \"exam\",\n  \"xray\",\n  \"lab\",\n  \"office\",\n  \"sterilization\",\n  \"storage\",\n  \"toilet\",\n  \"kitchen\",\n  \"changing\"\n] as const;\n\nexport type CanonicalRoomType = typeof CANONICAL_ROOM_TYPES[number];\n\nconst ROOM_TYPE_ALIASES: Record<string, CanonicalRoomType> = {\n  \"reception\": \"reception\",\n  \"empfang\": \"reception\",\n  \"empfangsbereich\": \"reception\",\n  \"rezeption\": \"reception\",\n  \n  \"waiting\": \"waiting\",\n  \"wartebereich\": \"waiting\",\n  \"wartezimmer\": \"waiting\",\n  \"warten\": \"waiting\",\n  \n  \"exam\": \"exam\",\n  \"treatment\": \"exam\",\n  \"behandlung\": \"exam\",\n  \"behandlungsraum\": \"exam\",\n  \"behandlungszimmer\": \"exam\",\n  \"untersuchung\": \"exam\",\n  \"untersuchungsraum\": \"exam\",\n  \n  \"lab\": \"lab\",\n  \"labor\": \"lab\",\n  \"laboratory\": \"lab\",\n  \n  \"xray\": \"xray\",\n  \"röntgen\": \"xray\",\n  \"roentgen\": \"xray\",\n  \"röntgenraum\": \"xray\",\n  \"x-ray\": \"xray\",\n  \n  \"office\": \"office\",\n  \"büro\": \"office\",\n  \"buero\": \"office\",\n  \"verwaltung\": \"office\",\n  \"personalraum\": \"office\",\n  \n  \"sterilization\": \"sterilization\",\n  \"sterilisation\": \"sterilization\",\n  \"sterilisationsraum\": \"sterilization\",\n  \"steri\": \"sterilization\",\n  \n  \"storage\": \"storage\",\n  \"lager\": \"storage\",\n  \"lagerraum\": \"storage\",\n  \n  \"toilet\": \"toilet\",\n  \"toilette\": \"toilet\",\n  \"wc\": \"toilet\",\n  \"badezimmer\": \"toilet\",\n  \"sanitär\": \"toilet\",\n  \n  \"kitchen\": \"kitchen\",\n  \"küche\": \"kitchen\",\n  \"kueche\": \"kitchen\",\n  \"pausenraum\": \"kitchen\",\n  \"teeküche\": \"kitchen\",\n  \n  \"changing\": \"changing\",\n  \"umkleide\": \"changing\",\n  \"umkleideraum\": \"changing\",\n  \"garderobe\": \"changing\"\n};\n\nexport function normalizeRoomType(type: string): CanonicalRoomType {\n  const normalized = type.toLowerCase().trim();\n  return ROOM_TYPE_ALIASES[normalized] || \"exam\";\n}\n\nexport function isValidRoomType(type: string): boolean {\n  const normalized = type.toLowerCase().trim();\n  return normalized in ROOM_TYPE_ALIASES;\n}\n\n/** @deprecated Use PX_PER_METER from shared/units.ts */\nexport const DEFAULT_LAYOUT_SCALE_PX_PER_METER = PX_PER_METER;\n\n/** @deprecated Use pxToM from shared/units.ts */\nexport function pxToMeters(px: number, scalePxPerMeter: number = PX_PER_METER): number {\n  return px / scalePxPerMeter;\n}\n\n/** @deprecated Use mToPx from shared/units.ts */\nexport function metersToPx(meters: number, scalePxPerMeter: number = PX_PER_METER): number {\n  return meters * scalePxPerMeter;\n}\n\n/** @deprecated Use px2ToM2 from shared/units.ts */\nexport function pxAreaToSqM(widthPx: number, heightPx: number, scalePxPerMeter: number = PX_PER_METER): number {\n  const widthM = widthPx / scalePxPerMeter;\n  const heightM = heightPx / scalePxPerMeter;\n  return Math.round(widthM * heightM * 10) / 10;\n}\n","path":null,"size_bytes":2765,"size_tokens":null},"server/ai/layoutEfficiency.ts":{"content":"import type { Room, WorkflowConnection } from \"@shared/schema\";\nimport { pxToM } from \"@shared/units\";\nimport { normalizeRoomType } from \"@shared/roomTypes\";\n\nexport interface WorkflowMetrics {\n  totalDistanceMeters: number;\n  avgStepDistanceMeters: number;\n  backtrackingCount: number;\n  longestConnections: Array<{ fromName: string; toName: string; distanceMeters: number }>;\n  motionWasteScore: number;\n  crossingConnections: Array<{ conn1: string; conn2: string }>;\n  coreRoomDistanceIssue: boolean;\n  coreRoomDistanceMeters: number;\n}\n\nexport interface LayoutFlowBreakdown {\n  patientFlowMeters: number;\n  staffMotionMeters: number;\n  steriLoopMeters: number;\n  labLoopMeters: number;\n  crossFloorPenaltyMeters: number;\n  privacyRisk: boolean;\n}\n\nexport interface LayoutIssue {\n  severity: \"critical\" | \"high\" | \"medium\" | \"low\";\n  code: string;\n  title: string;\n  detail: string;\n  current: number;\n  target?: number;\n  unit: string;\n}\n\nexport interface LayoutEfficiencyResult {\n  score: number;\n  breakdown: LayoutFlowBreakdown;\n  issues: LayoutIssue[];\n  tips: string[];\n  workflowMetrics?: WorkflowMetrics;\n}\n\ninterface RoomM {\n  id: string;\n  type: string;\n  name: string;\n  x: number;\n  y: number;\n  width: number;\n  height: number;\n  floor: number;\n}\n\nconst FLOOR_PENALTY_METERS = 15;\nconst PRIVACY_MIN_DISTANCE_M = 1.5;\n\nconst FLOW_WEIGHTS = {\n  patient: 0.35,\n  steri: 0.35,\n  staff: 0.2,\n  lab: 0.1,\n};\n\nfunction convertToMeters(room: Room): RoomM {\n  return {\n    id: room.id,\n    type: normalizeRoomType(room.type),\n    name: room.name,\n    x: pxToM(room.x),\n    y: pxToM(room.y),\n    width: pxToM(room.width),\n    height: pxToM(room.height),\n    floor: room.floor,\n  };\n}\n\nfunction getRoomCenter(room: RoomM): { x: number; y: number } {\n  return {\n    x: room.x + room.width / 2,\n    y: room.y + room.height / 2,\n  };\n}\n\nfunction calculateDistance(r1: RoomM, r2: RoomM): number {\n  const c1 = getRoomCenter(r1);\n  const c2 = getRoomCenter(r2);\n  const horizontalDist = Math.sqrt(\n    Math.pow(c2.x - c1.x, 2) + Math.pow(c2.y - c1.y, 2)\n  );\n  const floorDiff = Math.abs(r1.floor - r2.floor);\n  return horizontalDist + floorDiff * FLOOR_PENALTY_METERS;\n}\n\nfunction doSegmentsIntersect(\n  p1: { x: number; y: number },\n  p2: { x: number; y: number },\n  p3: { x: number; y: number },\n  p4: { x: number; y: number }\n): boolean {\n  const ccw = (A: { x: number; y: number }, B: { x: number; y: number }, C: { x: number; y: number }) =>\n    (C.y - A.y) * (B.x - A.x) > (B.y - A.y) * (C.x - A.x);\n  \n  if ((p1.x === p3.x && p1.y === p3.y) || (p1.x === p4.x && p1.y === p4.y) ||\n      (p2.x === p3.x && p2.y === p3.y) || (p2.x === p4.x && p2.y === p4.y)) {\n    return false;\n  }\n  \n  return (\n    ccw(p1, p3, p4) !== ccw(p2, p3, p4) && ccw(p1, p2, p3) !== ccw(p1, p2, p4)\n  );\n}\n\nfunction findClosestRoom(from: RoomM, candidates: RoomM[]): { room: RoomM; distance: number } | null {\n  if (candidates.length === 0) return null;\n  let closest = candidates[0];\n  let minDist = calculateDistance(from, closest);\n  for (let i = 1; i < candidates.length; i++) {\n    const dist = calculateDistance(from, candidates[i]);\n    if (dist < minDist) {\n      minDist = dist;\n      closest = candidates[i];\n    }\n  }\n  return { room: closest, distance: minDist };\n}\n\nfunction calculateFlowDistance(\n  roomsM: RoomM[],\n  sequence: string[]\n): { totalMeters: number; crossFloorMeters: number } {\n  const roomsByType = new Map<string, RoomM[]>();\n  roomsM.forEach((r) => {\n    if (!roomsByType.has(r.type)) roomsByType.set(r.type, []);\n    roomsByType.get(r.type)!.push(r);\n  });\n\n  let totalMeters = 0;\n  let crossFloorMeters = 0;\n\n  for (let i = 0; i < sequence.length - 1; i++) {\n    const fromType = sequence[i];\n    const toType = sequence[i + 1];\n    const fromRooms = roomsByType.get(fromType) || [];\n    const toRooms = roomsByType.get(toType) || [];\n\n    if (fromRooms.length === 0 || toRooms.length === 0) continue;\n\n    let segmentTotal = 0;\n    let segmentCrossFloor = 0;\n    let count = 0;\n\n    for (const from of fromRooms) {\n      const closest = findClosestRoom(from, toRooms);\n      if (closest) {\n        segmentTotal += closest.distance;\n        if (from.floor !== closest.room.floor) {\n          segmentCrossFloor += Math.abs(from.floor - closest.room.floor) * FLOOR_PENALTY_METERS;\n        }\n        count++;\n      }\n    }\n\n    if (count > 0) {\n      totalMeters += segmentTotal / count;\n      crossFloorMeters += segmentCrossFloor / count;\n    }\n  }\n\n  return { totalMeters, crossFloorMeters };\n}\n\nexport function computeWorkflowMetrics(\n  rooms: Room[],\n  connections: WorkflowConnection[]\n): WorkflowMetrics | null {\n  if (connections.length === 0) return null;\n\n  const roomsM = rooms.map(convertToMeters);\n  const roomMap = new Map(roomsM.map((r) => [r.id, r]));\n\n  const validConnections = connections.filter(\n    (c) => roomMap.has(c.fromRoomId) && roomMap.has(c.toRoomId)\n  );\n  \n  if (validConnections.length === 0) return null;\n\n  const connectionDistances: Array<{\n    fromName: string;\n    toName: string;\n    distanceMeters: number;\n    fromRoomId: string;\n    toRoomId: string;\n    fromCenter: { x: number; y: number };\n    toCenter: { x: number; y: number };\n    fromFloor: number;\n    toFloor: number;\n  }> = [];\n\n  let totalDistanceMeters = 0;\n  let backtrackingCount = 0;\n  const visitedPairs = new Set<string>();\n\n  for (const conn of validConnections) {\n    const fromRoom = roomMap.get(conn.fromRoomId)!;\n    const toRoom = roomMap.get(conn.toRoomId)!;\n\n    const distance = calculateDistance(fromRoom, toRoom);\n    totalDistanceMeters += distance;\n\n    connectionDistances.push({\n      fromName: fromRoom.name || fromRoom.type,\n      toName: toRoom.name || toRoom.type,\n      distanceMeters: Math.round(distance * 10) / 10,\n      fromRoomId: conn.fromRoomId,\n      toRoomId: conn.toRoomId,\n      fromCenter: getRoomCenter(fromRoom),\n      toCenter: getRoomCenter(toRoom),\n      fromFloor: fromRoom.floor,\n      toFloor: toRoom.floor,\n    });\n\n    const pairKey = [conn.fromRoomId, conn.toRoomId].sort().join(\"-\");\n    const reversePairKey = [conn.toRoomId, conn.fromRoomId].sort().join(\"-\");\n    if (visitedPairs.has(pairKey) || visitedPairs.has(reversePairKey)) {\n      backtrackingCount++;\n    }\n    visitedPairs.add(pairKey);\n  }\n\n  const crossingConnections: Array<{ conn1: string; conn2: string }> = [];\n  for (let i = 0; i < connectionDistances.length; i++) {\n    for (let j = i + 1; j < connectionDistances.length; j++) {\n      const c1 = connectionDistances[i];\n      const c2 = connectionDistances[j];\n      const c1SameFloor = c1.fromFloor === c1.toFloor;\n      const c2SameFloor = c2.fromFloor === c2.toFloor;\n      const bothOnSameFloor = c1SameFloor && c2SameFloor && c1.fromFloor === c2.fromFloor;\n      \n      if (bothOnSameFloor && doSegmentsIntersect(c1.fromCenter, c1.toCenter, c2.fromCenter, c2.toCenter)) {\n        crossingConnections.push({\n          conn1: `${c1.fromName} → ${c1.toName}`,\n          conn2: `${c2.fromName} → ${c2.toName}`,\n        });\n      }\n    }\n  }\n\n  const roomsByType = new Map<string, RoomM[]>();\n  roomsM.forEach((r) => {\n    if (!roomsByType.has(r.type)) roomsByType.set(r.type, []);\n    roomsByType.get(r.type)!.push(r);\n  });\n\n  const CORE_ROOM_MAX_DISTANCE = 8;\n  let coreRoomDistanceMeters = 0;\n  let coreRoomDistanceIssue = false;\n\n  const receptions = roomsByType.get(\"reception\") || [];\n  const waitings = roomsByType.get(\"waiting\") || [];\n  const exams = roomsByType.get(\"exam\") || [];\n\n  if (receptions.length > 0 && waitings.length > 0 && exams.length > 0) {\n    let minChainDistance = Infinity;\n    \n    for (const reception of receptions) {\n      for (const waiting of waitings) {\n        for (const exam of exams) {\n          const recToWait = calculateDistance(reception, waiting);\n          const waitToExam = calculateDistance(waiting, exam);\n          const chainDistance = recToWait + waitToExam;\n          if (chainDistance < minChainDistance) {\n            minChainDistance = chainDistance;\n          }\n        }\n      }\n    }\n    \n    coreRoomDistanceMeters = Math.round(minChainDistance * 10) / 10;\n\n    if (coreRoomDistanceMeters > CORE_ROOM_MAX_DISTANCE) {\n      coreRoomDistanceIssue = true;\n    }\n  }\n\n  const avgStepDistanceMeters =\n    connectionDistances.length > 0\n      ? Math.round((totalDistanceMeters / connectionDistances.length) * 10) / 10\n      : 0;\n\n  const longestConnections = connectionDistances\n    .sort((a, b) => b.distanceMeters - a.distanceMeters)\n    .slice(0, 3)\n    .map(({ fromName, toName, distanceMeters }) => ({\n      fromName,\n      toName,\n      distanceMeters,\n    }));\n\n  const OPTIMAL_TOTAL_DISTANCE = 20;\n  const OPTIMAL_AVG_STEP = 4;\n\n  let motionWasteScore = 0;\n  if (totalDistanceMeters > OPTIMAL_TOTAL_DISTANCE) {\n    motionWasteScore += Math.min(50, (totalDistanceMeters - OPTIMAL_TOTAL_DISTANCE) * 2);\n  }\n  if (avgStepDistanceMeters > OPTIMAL_AVG_STEP) {\n    motionWasteScore += Math.min(30, (avgStepDistanceMeters - OPTIMAL_AVG_STEP) * 5);\n  }\n  motionWasteScore += backtrackingCount * 5;\n  motionWasteScore += crossingConnections.length * 3;\n  if (coreRoomDistanceIssue) motionWasteScore += 10;\n  motionWasteScore = Math.min(100, Math.round(motionWasteScore));\n\n  return {\n    totalDistanceMeters: Math.round(totalDistanceMeters * 10) / 10,\n    avgStepDistanceMeters,\n    backtrackingCount,\n    longestConnections,\n    motionWasteScore,\n    crossingConnections,\n    coreRoomDistanceIssue,\n    coreRoomDistanceMeters,\n  };\n}\n\nexport function computeLayoutEfficiency(rooms: Room[]): LayoutEfficiencyResult {\n  const roomsM = rooms.map(convertToMeters);\n  const issues: LayoutIssue[] = [];\n  const tips: string[] = [];\n\n  const roomsByType = new Map<string, RoomM[]>();\n  roomsM.forEach((r) => {\n    if (!roomsByType.has(r.type)) roomsByType.set(r.type, []);\n    roomsByType.get(r.type)!.push(r);\n  });\n\n  const hasReception = (roomsByType.get(\"reception\")?.length || 0) > 0;\n  const hasWaiting = (roomsByType.get(\"waiting\")?.length || 0) > 0;\n  const hasExam = (roomsByType.get(\"exam\")?.length || 0) > 0;\n  const hasSteri = (roomsByType.get(\"sterilization\")?.length || 0) > 0;\n  const hasLab = (roomsByType.get(\"lab\")?.length || 0) > 0;\n  const hasOffice = (roomsByType.get(\"office\")?.length || 0) > 0;\n\n  if (!hasReception) {\n    issues.push({\n      severity: \"critical\",\n      code: \"MISSING_RECEPTION\",\n      title: \"Empfang fehlt\",\n      detail: \"Kein Empfangsbereich vorhanden. Patientenfluss nicht berechenbar.\",\n      current: 0,\n      target: 1,\n      unit: \"Räume\",\n    });\n    tips.push(\"Fügen Sie einen Empfangsbereich hinzu.\");\n  }\n\n  if (!hasWaiting) {\n    issues.push({\n      severity: \"critical\",\n      code: \"MISSING_WAITING\",\n      title: \"Wartezimmer fehlt\",\n      detail: \"Kein Wartebereich vorhanden.\",\n      current: 0,\n      target: 1,\n      unit: \"Räume\",\n    });\n    tips.push(\"Fügen Sie ein Wartezimmer hinzu.\");\n  }\n\n  if (!hasExam) {\n    issues.push({\n      severity: \"critical\",\n      code: \"MISSING_EXAM\",\n      title: \"Behandlungsraum fehlt\",\n      detail: \"Keine Behandlungsräume vorhanden.\",\n      current: 0,\n      target: 1,\n      unit: \"Räume\",\n    });\n    tips.push(\"Fügen Sie mindestens einen Behandlungsraum hinzu.\");\n  }\n\n  const patientFlow = calculateFlowDistance(roomsM, [\"reception\", \"waiting\", \"exam\", \"reception\"]);\n  const staffFlow = calculateFlowDistance(roomsM, [\"exam\", \"office\", \"exam\"]);\n  \n  const steriType = hasSteri ? \"sterilization\" : hasLab ? \"lab\" : null;\n  const steriFlow = steriType\n    ? calculateFlowDistance(roomsM, [\"exam\", steriType, \"exam\"])\n    : { totalMeters: 0, crossFloorMeters: 0 };\n  \n  const labFlow = hasLab\n    ? calculateFlowDistance(roomsM, [\"exam\", \"lab\", \"exam\"])\n    : { totalMeters: 0, crossFloorMeters: 0 };\n\n  const crossFloorPenaltyMeters =\n    patientFlow.crossFloorMeters +\n    staffFlow.crossFloorMeters +\n    steriFlow.crossFloorMeters +\n    labFlow.crossFloorMeters;\n\n  let privacyRisk = false;\n  const receptions = roomsByType.get(\"reception\") || [];\n  const waitings = roomsByType.get(\"waiting\") || [];\n  \n  for (const rec of receptions) {\n    for (const wait of waitings) {\n      if (rec.floor === wait.floor) {\n        const c1 = getRoomCenter(rec);\n        const c2 = getRoomCenter(wait);\n        const dist = Math.sqrt(Math.pow(c2.x - c1.x, 2) + Math.pow(c2.y - c1.y, 2));\n        if (dist < PRIVACY_MIN_DISTANCE_M) {\n          privacyRisk = true;\n          issues.push({\n            severity: \"high\",\n            code: \"PRIVACY_RISK\",\n            title: \"Diskretionszone fehlt\",\n            detail: `Wartezimmer zu nah am Empfang (${dist.toFixed(1)}m). Mindestabstand: ${PRIVACY_MIN_DISTANCE_M}m.`,\n            current: Math.round(dist * 10) / 10,\n            target: PRIVACY_MIN_DISTANCE_M,\n            unit: \"m\",\n          });\n        }\n      }\n    }\n  }\n\n  if (crossFloorPenaltyMeters > 0) {\n    issues.push({\n      severity: \"medium\",\n      code: \"CROSS_FLOOR_PENALTY\",\n      title: \"Etagenwechsel erhöht Laufwege\",\n      detail: `Räume auf verschiedenen Etagen verursachen ${crossFloorPenaltyMeters.toFixed(0)}m zusätzliche Wege.`,\n      current: Math.round(crossFloorPenaltyMeters),\n      unit: \"m\",\n    });\n    tips.push(\"Platzieren Sie zusammengehörige Räume auf derselben Etage.\");\n  }\n\n  if (!hasSteri && !hasLab) {\n    issues.push({\n      severity: \"medium\",\n      code: \"NO_STERI_OR_LAB\",\n      title: \"Sterilisation/Labor fehlt\",\n      detail: \"Kein Sterilisations- oder Laborraum vorhanden.\",\n      current: 0,\n      target: 1,\n      unit: \"Räume\",\n    });\n  }\n\n  if (!hasOffice) {\n    issues.push({\n      severity: \"low\",\n      code: \"NO_OFFICE\",\n      title: \"Arztzimmer fehlt\",\n      detail: \"Kein Büro/Arztzimmer für administrative Aufgaben.\",\n      current: 0,\n      target: 1,\n      unit: \"Räume\",\n    });\n  }\n\n  const OPTIMAL_PATIENT_FLOW = 15;\n  const OPTIMAL_STAFF_FLOW = 8;\n  const OPTIMAL_STERI_FLOW = 10;\n  const OPTIMAL_LAB_FLOW = 10;\n\n  let score = 100;\n\n  const patientPenalty = Math.max(0, patientFlow.totalMeters - OPTIMAL_PATIENT_FLOW);\n  const staffPenalty = Math.max(0, staffFlow.totalMeters - OPTIMAL_STAFF_FLOW);\n  const steriPenalty = Math.max(0, steriFlow.totalMeters - OPTIMAL_STERI_FLOW);\n  const labPenalty = Math.max(0, labFlow.totalMeters - OPTIMAL_LAB_FLOW);\n\n  score -= patientPenalty * FLOW_WEIGHTS.patient * 2;\n  score -= staffPenalty * FLOW_WEIGHTS.staff * 2;\n  score -= steriPenalty * FLOW_WEIGHTS.steri * 2;\n  score -= labPenalty * FLOW_WEIGHTS.lab * 2;\n\n  if (!hasReception) score -= 20;\n  if (!hasWaiting) score -= 15;\n  if (!hasExam) score -= 25;\n  if (privacyRisk) score -= 10;\n\n  score = Math.max(0, Math.min(100, Math.round(score)));\n\n  if (patientFlow.totalMeters > OPTIMAL_PATIENT_FLOW && tips.length < 6) {\n    tips.push(`Verkürzen Sie den Patientenweg (aktuell ${patientFlow.totalMeters.toFixed(0)}m, optimal <${OPTIMAL_PATIENT_FLOW}m).`);\n  }\n  if (privacyRisk && tips.length < 6) {\n    tips.push(\"Vergrößern Sie den Abstand zwischen Empfang und Wartezimmer für mehr Diskretion.\");\n  }\n  if (steriFlow.totalMeters > OPTIMAL_STERI_FLOW && tips.length < 6) {\n    tips.push(\"Platzieren Sie die Sterilisation näher an den Behandlungsräumen.\");\n  }\n\n  return {\n    score,\n    breakdown: {\n      patientFlowMeters: Math.round(patientFlow.totalMeters * 10) / 10,\n      staffMotionMeters: Math.round(staffFlow.totalMeters * 10) / 10,\n      steriLoopMeters: Math.round(steriFlow.totalMeters * 10) / 10,\n      labLoopMeters: Math.round(labFlow.totalMeters * 10) / 10,\n      crossFloorPenaltyMeters: Math.round(crossFloorPenaltyMeters * 10) / 10,\n      privacyRisk,\n    },\n    issues,\n    tips: tips.slice(0, 6),\n  };\n}\n","path":null,"size_bytes":15643,"size_tokens":null},"shared/units.ts":{"content":"export const GRID_PX = 40;\nexport const PX_PER_METER = GRID_PX;\nexport const GRID_M = 1.0;\n\nexport function pxToM(px: number): number {\n  return px / PX_PER_METER;\n}\n\nexport function mToPx(m: number): number {\n  return m * PX_PER_METER;\n}\n\nexport function px2ToM2(widthPx: number, heightPx: number): number {\n  const widthM = pxToM(widthPx);\n  const heightM = pxToM(heightPx);\n  return Math.round(widthM * heightM * 10) / 10;\n}\n\nexport function sqM(widthM: number, heightM: number): number {\n  return Math.round(widthM * heightM * 10) / 10;\n}\n\nexport function snapToGridM(m: number): number {\n  return Math.round(m / GRID_M) * GRID_M;\n}\n\nexport function clampM(val: number, min: number, max: number): number {\n  return Math.max(min, Math.min(max, val));\n}\n\nexport function normalizeToMeters(value: number): number {\n  const LEGACY_PIXEL_THRESHOLD = 30;\n  return value >= LEGACY_PIXEL_THRESHOLD ? value / PX_PER_METER : value;\n}\n\nexport function formatM(value: number, decimals: number = 1): string {\n  return `${value.toFixed(decimals)} m`;\n}\n\nexport function formatSqM(value: number, decimals: number = 1): string {\n  return `${value.toFixed(decimals)} m²`;\n}\n","path":null,"size_bytes":1162,"size_tokens":null},"shared/layoutUnits.ts":{"content":"export const GRID_SIZE_PX = 40;\nexport const METERS_PER_TILE = 1.0;\n\nexport function pxToTiles(px: number): number {\n  return Math.round(px / GRID_SIZE_PX * 10) / 10;\n}\n\nexport function tilesToPx(tiles: number): number {\n  return tiles * GRID_SIZE_PX;\n}\n\nexport function tilesToApproxMeters(tiles: number): number {\n  return Math.round(tiles * METERS_PER_TILE * 10) / 10;\n}\n\nexport function pxToApproxMeters(px: number): number {\n  return Math.round(px / GRID_SIZE_PX * METERS_PER_TILE * 10) / 10;\n}\n\nexport type DistanceBucket = \"short\" | \"medium\" | \"long\";\n\nexport function classifyDistanceBucket(tiles: number): DistanceBucket {\n  if (tiles <= 3) return \"short\";\n  if (tiles <= 8) return \"medium\";\n  return \"long\";\n}\n\nexport function distanceBucketLabel(bucket: DistanceBucket, lang: \"de\" | \"en\" = \"de\"): string {\n  const labels = {\n    de: { short: \"kurz\", medium: \"mittel\", long: \"lang\" },\n    en: { short: \"short\", medium: \"medium\", long: \"long\" },\n  };\n  return labels[lang][bucket];\n}\n\nexport function roomAreaTiles(widthPx: number, heightPx: number): number {\n  return pxToTiles(widthPx) * pxToTiles(heightPx);\n}\n\nexport function roomAreaApproxSqm(widthPx: number, heightPx: number): number {\n  const widthM = (widthPx / GRID_SIZE_PX) * METERS_PER_TILE;\n  const heightM = (heightPx / GRID_SIZE_PX) * METERS_PER_TILE;\n  return Math.round(widthM * heightM * 10) / 10;\n}\n\nexport type RoomSizeBucket = \"undersized\" | \"ok\" | \"optimal\" | \"oversized\";\n\nexport interface RoomSizeStandard {\n  minSqM: number;\n  maxSqM: number;\n  optimalSqM: number;\n}\n\nconst ROOM_SIZE_DEFAULTS: Record<string, RoomSizeStandard> = {\n  reception: { minSqM: 8, maxSqM: 14, optimalSqM: 10 },\n  waiting: { minSqM: 15, maxSqM: 35, optimalSqM: 22 },\n  exam: { minSqM: 9, maxSqM: 12, optimalSqM: 10 },\n  lab: { minSqM: 8, maxSqM: 15, optimalSqM: 10 },\n  office: { minSqM: 10, maxSqM: 18, optimalSqM: 14 },\n  sterilization: { minSqM: 8, maxSqM: 14, optimalSqM: 10.5 },\n  storage: { minSqM: 4, maxSqM: 10, optimalSqM: 6 },\n  toilet: { minSqM: 3, maxSqM: 6, optimalSqM: 4.4 },\n  kitchen: { minSqM: 6, maxSqM: 12, optimalSqM: 7.5 },\n  changing: { minSqM: 5, maxSqM: 10, optimalSqM: 6.6 },\n};\n\nexport function classifyRoomSize(roomType: string, areaSqm: number): RoomSizeBucket {\n  const normalized = roomType.toLowerCase().trim();\n  const standards = ROOM_SIZE_DEFAULTS[normalized];\n  \n  if (!standards) {\n    if (areaSqm < 6) return \"undersized\";\n    if (areaSqm > 20) return \"oversized\";\n    return \"ok\";\n  }\n  \n  const { minSqM, maxSqM, optimalSqM } = standards;\n  \n  if (areaSqm < minSqM) return \"undersized\";\n  if (areaSqm > maxSqM) return \"oversized\";\n  \n  const optimalRange = optimalSqM * 0.15;\n  if (areaSqm >= optimalSqM - optimalRange && areaSqm <= optimalSqM + optimalRange) {\n    return \"optimal\";\n  }\n  \n  return \"ok\";\n}\n\nexport function roomSizeBucketLabel(bucket: RoomSizeBucket, lang: \"de\" | \"en\" = \"de\"): string {\n  const labels = {\n    de: { undersized: \"zu klein\", ok: \"ok\", optimal: \"optimal\", oversized: \"zu groß\" },\n    en: { undersized: \"too small\", ok: \"ok\", optimal: \"optimal\", oversized: \"too large\" },\n  };\n  return labels[lang][bucket];\n}\n\nexport function roomSizeBucketColor(bucket: RoomSizeBucket): string {\n  switch (bucket) {\n    case \"undersized\": return \"text-orange-600 bg-orange-100\";\n    case \"ok\": return \"text-blue-600 bg-blue-100\";\n    case \"optimal\": return \"text-green-600 bg-green-100\";\n    case \"oversized\": return \"text-red-600 bg-red-100\";\n  }\n}\n\nexport function distanceBucketColor(bucket: DistanceBucket): string {\n  switch (bucket) {\n    case \"short\": return \"text-green-600 bg-green-100\";\n    case \"medium\": return \"text-yellow-600 bg-yellow-100\";\n    case \"long\": return \"text-red-600 bg-red-100\";\n  }\n}\n\nexport function distanceInTiles(\n  x1: number, y1: number, w1: number, h1: number,\n  x2: number, y2: number, w2: number, h2: number\n): number {\n  const cx1 = x1 + w1 / 2;\n  const cy1 = y1 + h1 / 2;\n  const cx2 = x2 + w2 / 2;\n  const cy2 = y2 + h2 / 2;\n  const distPx = Math.sqrt(Math.pow(cx2 - cx1, 2) + Math.pow(cy2 - cy1, 2));\n  return Math.round(distPx / GRID_SIZE_PX * 10) / 10;\n}\n","path":null,"size_bytes":4114,"size_tokens":null},"client/src/pages/Playbooks.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from \"@/components/ui/accordion\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Loader2, BookOpen, CheckCircle2 } from \"lucide-react\";\n\ninterface PlaybookStep {\n  order: number;\n  action: string;\n  details: string;\n}\n\ninterface PlaybookPayload {\n  name: string;\n  description: string;\n  steps: PlaybookStep[];\n}\n\ninterface Playbook {\n  id: string;\n  topic: string;\n  payload: PlaybookPayload;\n  confidence: number;\n}\n\nexport default function Playbooks() {\n  const { data: playbooks, isLoading, error } = useQuery<Playbook[]>({\n    queryKey: [\"playbooks\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/playbooks\");\n      if (!response.ok) {\n        throw new Error(\"Fehler beim Laden der Playbooks\");\n      }\n      return response.json();\n    },\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-[calc(100vh-4rem)]\" data-testid=\"loading-playbooks\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className=\"p-4 md:p-6\" data-testid=\"error-playbooks\">\n        <Card className=\"border-destructive\">\n          <CardContent className=\"pt-6\">\n            <p className=\"text-destructive\">Fehler beim Laden der Playbooks. Bitte versuchen Sie es später erneut.</p>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-4 md:p-6 space-y-6\" data-testid=\"page-playbooks\">\n      <div className=\"flex items-center gap-3\">\n        <div className=\"p-2 rounded-lg bg-primary/10\">\n          <BookOpen className=\"h-6 w-6 text-primary\" />\n        </div>\n        <div>\n          <h1 className=\"text-xl md:text-2xl font-semibold\" data-testid=\"heading-playbooks\">\n            Praxis-Playbooks\n          </h1>\n          <p className=\"text-sm text-muted-foreground\">\n            Standard-Abläufe und Checklisten für Ihre Praxis\n          </p>\n        </div>\n      </div>\n\n      {!playbooks || playbooks.length === 0 ? (\n        <Card data-testid=\"empty-playbooks\">\n          <CardContent className=\"pt-6\">\n            <p className=\"text-muted-foreground text-center py-8\">\n              Keine Playbooks vorhanden. Führen Sie zuerst das Sync-Skript aus.\n            </p>\n          </CardContent>\n        </Card>\n      ) : (\n        <Accordion type=\"single\" collapsible className=\"space-y-3\" data-testid=\"playbooks-list\">\n          {playbooks.map((playbook) => (\n            <AccordionItem\n              key={playbook.id}\n              value={playbook.id}\n              className=\"border rounded-lg px-4 bg-card\"\n              data-testid={`playbook-${playbook.topic}`}\n            >\n              <AccordionTrigger className=\"hover:no-underline py-4\" data-testid={`trigger-playbook-${playbook.topic}`}>\n                <div className=\"flex items-center gap-3 text-left\">\n                  <div className=\"flex-1\">\n                    <div className=\"font-medium\">{playbook.payload.name}</div>\n                    <div className=\"text-sm text-muted-foreground mt-1\">\n                      {playbook.payload.description}\n                    </div>\n                  </div>\n                  <Badge variant=\"secondary\" className=\"ml-2\">\n                    {playbook.payload.steps.length} Schritte\n                  </Badge>\n                </div>\n              </AccordionTrigger>\n              <AccordionContent className=\"pb-4\">\n                <div className=\"space-y-3 mt-2\">\n                  {playbook.payload.steps\n                    .sort((a, b) => a.order - b.order)\n                    .map((step, index) => (\n                      <div\n                        key={index}\n                        className=\"flex gap-3 p-3 rounded-lg bg-muted/50\"\n                        data-testid={`step-${playbook.topic}-${step.order}`}\n                      >\n                        <div className=\"flex-shrink-0 w-7 h-7 rounded-full bg-primary/10 flex items-center justify-center\">\n                          <span className=\"text-sm font-medium text-primary\">{step.order}</span>\n                        </div>\n                        <div className=\"flex-1\">\n                          <div className=\"font-medium text-sm\">{step.action}</div>\n                          <div className=\"text-sm text-muted-foreground mt-0.5\">\n                            {step.details}\n                          </div>\n                        </div>\n                        <CheckCircle2 className=\"h-4 w-4 text-muted-foreground/40 flex-shrink-0 mt-0.5\" />\n                      </div>\n                    ))}\n                </div>\n              </AccordionContent>\n            </AccordionItem>\n          ))}\n        </Accordion>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":4924,"size_tokens":null},"scripts/sync-playbooks.ts":{"content":"import crypto from \"crypto\";\nimport OpenAI from \"openai\";\nimport { db } from \"../server/db\";\nimport { knowledgeChunks, knowledgeSources, knowledgeArtifacts } from \"../shared/schema\";\nimport { eq, sql, and, or, ilike } from \"drizzle-orm\";\nimport { z } from \"zod\";\n\nconst openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });\n\nconst PlaybookSchema = z.object({\n  name: z.string(),\n  steps: z.array(z.object({\n    order: z.number(),\n    action: z.string(),\n    details: z.string()\n  })),\n  description: z.string()\n});\n\nconst PLAYBOOK_DEFINITIONS = [\n  {\n    topic: \"neupatient_aufnahme\",\n    searchTerms: [\"Neupatient\", \"Ersttermin\", \"Aufnahme\", \"Anamnese\", \"Erstgespräch\"],\n    prompt: `Extrahiere einen Playbook für den Neupatient-Aufnahmeprozess.\n    Liefere JSON mit: name (string), description (string), steps (Array von {order: number, action: string, details: string}).\n    Die Schritte sollten den kompletten Ablauf von Ankunft bis Behandlungsstart abdecken.`\n  },\n  {\n    topic: \"behandlungsablauf_standard\",\n    searchTerms: [\"Behandlung\", \"Ablauf\", \"Prozess\", \"Workflow\", \"Standard\"],\n    prompt: `Extrahiere einen Playbook für den Standard-Behandlungsablauf.\n    Liefere JSON mit: name (string), description (string), steps (Array von {order: number, action: string, details: string}).\n    Die Schritte sollten vom Behandlungsbeginn bis zum Abschluss reichen.`\n  },\n  {\n    topic: \"hygiene_tagesroutine\",\n    searchTerms: [\"Hygiene\", \"Desinfektion\", \"Sterilisation\", \"Reinigung\", \"RKI\"],\n    prompt: `Extrahiere einen Playbook für die tägliche Hygiene-Routine.\n    Liefere JSON mit: name (string), description (string), steps (Array von {order: number, action: string, details: string}).\n    Die Schritte sollten alle wichtigen Hygienemaßnahmen enthalten.`\n  },\n  {\n    topic: \"notfall_protokoll\",\n    searchTerms: [\"Notfall\", \"Erste Hilfe\", \"Notruf\", \"Reanimation\", \"Allergie\"],\n    prompt: `Extrahiere einen Playbook für Notfallsituationen in der Praxis.\n    Liefere JSON mit: name (string), description (string), steps (Array von {order: number, action: string, details: string}).\n    Die Schritte sollten die wichtigsten Notfall-Reaktionen abdecken.`\n  },\n  {\n    topic: \"tagesbeginn_checkliste\",\n    searchTerms: [\"Morgen\", \"Tagesbeginn\", \"Vorbereitung\", \"Öffnung\", \"Start\"],\n    prompt: `Extrahiere einen Playbook für den Tagesbeginn/Praxisöffnung.\n    Liefere JSON mit: name (string), description (string), steps (Array von {order: number, action: string, details: string}).\n    Die Schritte sollten alle Vorbereitungen vor dem ersten Patienten enthalten.`\n  },\n  {\n    topic: \"tagesende_checkliste\",\n    searchTerms: [\"Abend\", \"Tagesende\", \"Schließung\", \"Feierabend\", \"Ende\"],\n    prompt: `Extrahiere einen Playbook für den Tagesabschluss/Praxisschließung.\n    Liefere JSON mit: name (string), description (string), steps (Array von {order: number, action: string, details: string}).\n    Die Schritte sollten alle Aufgaben nach dem letzten Patienten enthalten.`\n  }\n];\n\nasync function searchRelevantChunks(searchTerms: string[]): Promise<{ content: string; docName: string; headingPath: string | null; id: string }[]> {\n  const conditions = searchTerms.map(term => \n    ilike(knowledgeChunks.content, `%${term}%`)\n  );\n\n  const results = await db\n    .select({\n      id: knowledgeChunks.id,\n      content: knowledgeChunks.content,\n      headingPath: knowledgeChunks.headingPath,\n      docName: knowledgeSources.fileName\n    })\n    .from(knowledgeChunks)\n    .leftJoin(knowledgeSources, eq(knowledgeChunks.sourceId, knowledgeSources.id))\n    .where(or(...conditions))\n    .limit(10);\n\n  return results.map(r => ({\n    id: r.id,\n    content: r.content,\n    docName: r.docName || \"unknown\",\n    headingPath: r.headingPath\n  }));\n}\n\nfunction computeHash(content: string): string {\n  return crypto.createHash(\"sha256\").update(content).digest(\"hex\").slice(0, 16);\n}\n\nasync function extractPlaybook(definition: typeof PLAYBOOK_DEFINITIONS[0], chunks: { content: string; docName: string; headingPath: string | null; id: string }[]): Promise<{\n  payload: z.infer<typeof PlaybookSchema>;\n  citations: { docName: string; headingPath: string | null; chunkId: string }[];\n} | null> {\n  if (chunks.length === 0) {\n    console.log(`  No relevant chunks found for ${definition.topic}`);\n    return null;\n  }\n\n  const context = chunks.map((c, i) => `[Chunk ${i + 1}]\\n${c.content}`).join(\"\\n\\n---\\n\\n\");\n\n  const systemPrompt = `Du bist ein Experte für Praxismanagement und Workflow-Optimierung.\nExtrahiere strukturierte Playbook-Daten aus dem gegebenen Wissenskontext.\nAntworte NUR mit validem JSON, keine Erklärungen.\nWenn du nicht genug Informationen findest, erstelle ein sinnvolles Playbook basierend auf Best Practices.`;\n\n  const userPrompt = `=== WISSENSKONTEXT ===\n${context}\n\n=== AUFGABE ===\n${definition.prompt}\n\nAntworte nur mit JSON:`;\n\n  try {\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt }\n      ],\n      max_tokens: 1500,\n      temperature: 0.3,\n      response_format: { type: \"json_object\" }\n    });\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) return null;\n\n    const parsed = JSON.parse(content);\n    const validated = PlaybookSchema.parse(parsed);\n\n    return {\n      payload: validated,\n      citations: chunks.slice(0, 3).map(c => ({\n        docName: c.docName,\n        headingPath: c.headingPath,\n        chunkId: c.id\n      }))\n    };\n  } catch (error) {\n    console.error(`  Error extracting ${definition.topic}:`, error);\n    return null;\n  }\n}\n\nasync function upsertPlaybookArtifact(\n  topic: string,\n  payload: z.infer<typeof PlaybookSchema>,\n  citations: { docName: string; headingPath: string | null; chunkId: string }[],\n  sourceHash: string\n) {\n  const existing = await db\n    .select()\n    .from(knowledgeArtifacts)\n    .where(and(\n      eq(knowledgeArtifacts.module, \"qm\"),\n      eq(knowledgeArtifacts.topic, topic),\n      eq(knowledgeArtifacts.artifactType, \"playbook\")\n    ))\n    .limit(1);\n\n  if (existing.length > 0 && existing[0].sourceHash === sourceHash) {\n    console.log(`  Playbook ${topic} already up-to-date, skipping`);\n    return;\n  }\n\n  if (existing.length > 0) {\n    await db\n      .update(knowledgeArtifacts)\n      .set({\n        payloadJson: payload,\n        sourceCitations: citations,\n        sourceHash,\n        version: existing[0].version + 1\n      })\n      .where(eq(knowledgeArtifacts.id, existing[0].id));\n    console.log(`  Updated playbook: ${topic}`);\n  } else {\n    await db.insert(knowledgeArtifacts).values({\n      id: crypto.randomUUID(),\n      module: \"qm\",\n      topic,\n      artifactType: \"playbook\",\n      payloadJson: payload,\n      sourceCitations: citations,\n      confidence: 0.85,\n      version: 1,\n      sourceHash\n    });\n    console.log(`  Created playbook: ${topic}`);\n  }\n}\n\nasync function main() {\n  console.log(\"🔄 Starting Playbook Sync...\\n\");\n\n  let created = 0;\n  let skipped = 0;\n  let failed = 0;\n\n  for (const definition of PLAYBOOK_DEFINITIONS) {\n    console.log(`\\n📋 Processing: ${definition.topic}`);\n    \n    const chunks = await searchRelevantChunks(definition.searchTerms);\n    console.log(`  Found ${chunks.length} relevant chunks`);\n    \n    if (chunks.length === 0) {\n      console.log(`  Creating default playbook for ${definition.topic}...`);\n      const defaultPayload = await createDefaultPlaybook(definition);\n      if (defaultPayload) {\n        const hash = computeHash(JSON.stringify(defaultPayload));\n        await upsertPlaybookArtifact(definition.topic, defaultPayload, [], hash);\n        created++;\n      } else {\n        failed++;\n      }\n      continue;\n    }\n\n    const result = await extractPlaybook(definition, chunks);\n    \n    if (result) {\n      const hash = computeHash(chunks.map(c => c.content).join(\"\"));\n      await upsertPlaybookArtifact(definition.topic, result.payload, result.citations, hash);\n      created++;\n    } else {\n      failed++;\n    }\n\n    await new Promise(resolve => setTimeout(resolve, 500));\n  }\n\n  console.log(`\\n✅ Sync complete!`);\n  console.log(`   Created/Updated: ${created}`);\n  console.log(`   Skipped: ${skipped}`);\n  console.log(`   Failed: ${failed}`);\n\n  process.exit(0);\n}\n\nasync function createDefaultPlaybook(definition: typeof PLAYBOOK_DEFINITIONS[0]): Promise<z.infer<typeof PlaybookSchema> | null> {\n  const defaults: Record<string, z.infer<typeof PlaybookSchema>> = {\n    neupatient_aufnahme: {\n      name: \"Neupatient-Aufnahme\",\n      description: \"Standard-Ablauf für die Aufnahme neuer Patienten\",\n      steps: [\n        { order: 1, action: \"Begrüßung\", details: \"Patient freundlich empfangen und Termin bestätigen\" },\n        { order: 2, action: \"Anmeldung\", details: \"Personalien aufnehmen und Versicherungsdaten erfassen\" },\n        { order: 3, action: \"Anamnesebogen\", details: \"Gesundheitsfragebogen aushändigen und erklären\" },\n        { order: 4, action: \"Wartebereich\", details: \"Patient in Wartebereich begleiten\" },\n        { order: 5, action: \"Aufklärung\", details: \"Datenschutz und Behandlungsablauf erläutern\" }\n      ]\n    },\n    behandlungsablauf_standard: {\n      name: \"Standard-Behandlungsablauf\",\n      description: \"Allgemeiner Ablauf einer Behandlung\",\n      steps: [\n        { order: 1, action: \"Vorbereitung\", details: \"Behandlungsraum vorbereiten und Instrumente prüfen\" },\n        { order: 2, action: \"Patient abholen\", details: \"Patient aus Wartebereich begleiten\" },\n        { order: 3, action: \"Befunderhebung\", details: \"Aktuelle Beschwerden erfragen\" },\n        { order: 4, action: \"Behandlung\", details: \"Geplante Behandlung durchführen\" },\n        { order: 5, action: \"Nachsorge\", details: \"Pflegehinweise geben und Folgetermin vereinbaren\" }\n      ]\n    },\n    hygiene_tagesroutine: {\n      name: \"Tägliche Hygiene-Routine\",\n      description: \"Hygienemaßnahmen gemäß RKI-Richtlinien\",\n      steps: [\n        { order: 1, action: \"Flächendesinfektion\", details: \"Alle Kontaktflächen vor Arbeitsbeginn desinfizieren\" },\n        { order: 2, action: \"Instrumentenaufbereitung\", details: \"Sterilisator befüllen und Chargenkontrolle\" },\n        { order: 3, action: \"Zwischendesinfektion\", details: \"Nach jedem Patienten Behandlungseinheit desinfizieren\" },\n        { order: 4, action: \"Händehygiene\", details: \"Protokoll für Händedesinfektion befolgen\" },\n        { order: 5, action: \"Dokumentation\", details: \"Hygienemaßnahmen im Hygieneplan dokumentieren\" }\n      ]\n    },\n    notfall_protokoll: {\n      name: \"Notfall-Protokoll\",\n      description: \"Sofortmaßnahmen bei medizinischen Notfällen\",\n      steps: [\n        { order: 1, action: \"Erkennen\", details: \"Notfallsituation erkennen und bewerten\" },\n        { order: 2, action: \"Notruf\", details: \"112 anrufen - Wer, Was, Wo, Wie viele\" },\n        { order: 3, action: \"Erste Hilfe\", details: \"Lebensrettende Sofortmaßnahmen einleiten\" },\n        { order: 4, action: \"Notfallkoffer\", details: \"Notfallausrüstung bereitstellen\" },\n        { order: 5, action: \"Rettungsdienst\", details: \"Einweisung und Übergabe an Rettungsdienst\" }\n      ]\n    },\n    tagesbeginn_checkliste: {\n      name: \"Tagesbeginn-Checkliste\",\n      description: \"Vorbereitungen vor dem ersten Patienten\",\n      steps: [\n        { order: 1, action: \"Praxis öffnen\", details: \"Schlüsselverwaltung und Alarm deaktivieren\" },\n        { order: 2, action: \"Systeme starten\", details: \"Computer, Praxissoftware und Geräte hochfahren\" },\n        { order: 3, action: \"Terminplan prüfen\", details: \"Tagesplan durchgehen und Vorbereitungen treffen\" },\n        { order: 4, action: \"Material prüfen\", details: \"Verbrauchsmaterial und Instrumente kontrollieren\" },\n        { order: 5, action: \"Empfangsbereich\", details: \"Wartebereich aufräumen und vorbereiten\" }\n      ]\n    },\n    tagesende_checkliste: {\n      name: \"Tagesende-Checkliste\",\n      description: \"Aufgaben nach dem letzten Patienten\",\n      steps: [\n        { order: 1, action: \"Abrechnung\", details: \"Tagesabrechnungen abschließen\" },\n        { order: 2, action: \"Aufräumen\", details: \"Behandlungsräume aufräumen und desinfizieren\" },\n        { order: 3, action: \"Geräte ausschalten\", details: \"Alle Geräte ordnungsgemäß abschalten\" },\n        { order: 4, action: \"Sicherheit\", details: \"Fenster und Türen kontrollieren\" },\n        { order: 5, action: \"Alarm aktivieren\", details: \"Alarmanlage aktivieren und Praxis verschließen\" }\n      ]\n    }\n  };\n\n  return defaults[definition.topic] || null;\n}\n\nmain().catch(console.error);\n","path":null,"size_bytes":12654,"size_tokens":null},"server/ai/workflowEfficiency.ts":{"content":"import type { Room, Workflow, WorkflowStep } from \"@shared/schema\";\n\nconst PX_PER_METER = 40;\n\nconst DISTANCE_BANDS = {\n  short: 3,\n  medium: 8,\n} as const;\n\nconst FLOOR_PENALTY_METERS = 10;\n\nexport interface StepAnalysis {\n  stepIndex: number;\n  stepId: string;\n  fromRoomId: string;\n  toRoomId: string;\n  fromRoomName: string;\n  toRoomName: string;\n  distanceM: number;\n  distanceBand: \"short\" | \"medium\" | \"long\";\n  isFloorChange: boolean;\n  frictionScore: number;\n}\n\nexport interface WorkflowAnalysisResult {\n  workflowId: string;\n  workflowName: string;\n  actorType: string;\n  totalDistanceM: number;\n  distanceBandCounts: {\n    short: number;\n    medium: number;\n    long: number;\n  };\n  floorChangeCount: number;\n  frictionIndex: number;\n  score: number;\n  top3ExpensiveSteps: StepAnalysis[];\n  allSteps: StepAnalysis[];\n}\n\nexport interface AnalyzeWorkflowsResult {\n  practiceId: string;\n  workflows: WorkflowAnalysisResult[];\n  overallScore: number;\n  overallFrictionIndex: number;\n  recommendations: Recommendation[];\n}\n\nexport interface Recommendation {\n  id: string;\n  priority: \"high\" | \"medium\" | \"low\";\n  title: string;\n  description: string;\n  category: \"backtracking\" | \"distance\" | \"floor\" | \"process\" | \"digital\";\n}\n\nfunction computeDistance(\n  room1: Room,\n  room2: Room,\n  pxPerMeter: number = PX_PER_METER\n): { distanceM: number; isFloorChange: boolean } {\n  const isFloorChange = room1.floor !== room2.floor;\n  \n  const center1X = room1.x + room1.width / 2;\n  const center1Y = room1.y + room1.height / 2;\n  const center2X = room2.x + room2.width / 2;\n  const center2Y = room2.y + room2.height / 2;\n  \n  const dxPx = Math.abs(center2X - center1X);\n  const dyPx = Math.abs(center2Y - center1Y);\n  \n  let distancePx = Math.sqrt(dxPx * dxPx + dyPx * dyPx);\n  let distanceM = distancePx / pxPerMeter;\n  \n  if (isFloorChange) {\n    distanceM += FLOOR_PENALTY_METERS;\n  }\n  \n  return { distanceM: Math.round(distanceM * 10) / 10, isFloorChange };\n}\n\nfunction classifyDistance(distanceM: number): \"short\" | \"medium\" | \"long\" {\n  if (distanceM <= DISTANCE_BANDS.short) return \"short\";\n  if (distanceM <= DISTANCE_BANDS.medium) return \"medium\";\n  return \"long\";\n}\n\nfunction computeFrictionScore(step: { distanceM: number; isFloorChange: boolean; weight: number }): number {\n  const baseFriction = step.distanceM;\n  const weightMultiplier = step.weight || 1;\n  const floorPenalty = step.isFloorChange ? 1.5 : 1;\n  \n  return Math.round(baseFriction * weightMultiplier * floorPenalty * 10) / 10;\n}\n\nfunction getRoomName(room: Room, roomTypes: Record<string, string>): string {\n  if (room.name && room.name.trim()) return room.name;\n  return roomTypes[room.type] || room.type;\n}\n\nconst ROOM_TYPE_LABELS: Record<string, string> = {\n  reception: \"Empfang\",\n  waiting: \"Wartebereich\",\n  exam: \"Behandlung\",\n  xray: \"Röntgen\",\n  office: \"Büro\",\n  sterilization: \"Sterilisation\",\n  lab: \"Labor\",\n  storage: \"Lager\",\n  toilet: \"WC\",\n  kitchen: \"Küche\",\n  changing: \"Umkleide\",\n};\n\nexport function analyzeWorkflow(\n  workflow: Workflow,\n  steps: WorkflowStep[],\n  rooms: Room[],\n  pxPerMeter: number = PX_PER_METER\n): WorkflowAnalysisResult {\n  const roomMap = new Map(rooms.map(r => [r.id, r]));\n  const sortedSteps = [...steps].sort((a, b) => a.stepIndex - b.stepIndex);\n  \n  const distanceBandCounts = { short: 0, medium: 0, long: 0 };\n  let totalDistanceM = 0;\n  let totalFriction = 0;\n  let floorChangeCount = 0;\n  \n  const analyzedSteps: StepAnalysis[] = sortedSteps.map(step => {\n    const fromRoom = roomMap.get(step.fromRoomId);\n    const toRoom = roomMap.get(step.toRoomId);\n    \n    if (!fromRoom || !toRoom) {\n      return {\n        stepIndex: step.stepIndex,\n        stepId: step.id,\n        fromRoomId: step.fromRoomId,\n        toRoomId: step.toRoomId,\n        fromRoomName: \"Unbekannt\",\n        toRoomName: \"Unbekannt\",\n        distanceM: 0,\n        distanceBand: \"short\" as const,\n        isFloorChange: false,\n        frictionScore: 0,\n      };\n    }\n    \n    const { distanceM, isFloorChange } = computeDistance(fromRoom, toRoom, pxPerMeter);\n    const distanceBand = classifyDistance(distanceM);\n    const frictionScore = computeFrictionScore({ \n      distanceM, \n      isFloorChange, \n      weight: step.weight \n    });\n    \n    totalDistanceM += distanceM;\n    totalFriction += frictionScore;\n    distanceBandCounts[distanceBand]++;\n    if (isFloorChange) floorChangeCount++;\n    \n    return {\n      stepIndex: step.stepIndex,\n      stepId: step.id,\n      fromRoomId: step.fromRoomId,\n      toRoomId: step.toRoomId,\n      fromRoomName: getRoomName(fromRoom, ROOM_TYPE_LABELS),\n      toRoomName: getRoomName(toRoom, ROOM_TYPE_LABELS),\n      distanceM,\n      distanceBand,\n      isFloorChange,\n      frictionScore,\n    };\n  });\n  \n  const stepCount = analyzedSteps.length;\n  const avgFriction = stepCount > 0 ? totalFriction / stepCount : 0;\n  const maxReasonableFriction = 15;\n  const frictionIndex = Math.min(avgFriction / maxReasonableFriction, 1) * 100;\n  \n  const score = Math.max(0, Math.round(100 - frictionIndex));\n  \n  const top3ExpensiveSteps = [...analyzedSteps]\n    .sort((a, b) => b.frictionScore - a.frictionScore)\n    .slice(0, 3);\n  \n  return {\n    workflowId: workflow.id,\n    workflowName: workflow.name,\n    actorType: workflow.actorType,\n    totalDistanceM: Math.round(totalDistanceM * 10) / 10,\n    distanceBandCounts,\n    floorChangeCount,\n    frictionIndex: Math.round(frictionIndex),\n    score,\n    top3ExpensiveSteps,\n    allSteps: analyzedSteps,\n  };\n}\n\nexport function generateRuleBasedRecommendations(\n  workflowResults: WorkflowAnalysisResult[]\n): Recommendation[] {\n  const recommendations: Recommendation[] = [];\n  \n  for (const wf of workflowResults) {\n    const longDistanceSteps = wf.allSteps.filter(s => s.distanceBand === \"long\");\n    if (longDistanceSteps.length > 0) {\n      const topLong = longDistanceSteps[0];\n      recommendations.push({\n        id: `long-distance-${wf.workflowId}`,\n        priority: \"high\",\n        title: \"Lange Wege reduzieren\",\n        description: `Der Weg von \"${topLong.fromRoomName}\" zu \"${topLong.toRoomName}\" ist ${topLong.distanceM}m lang. Erwägen Sie, diese Räume näher zusammen zu platzieren oder Materialien dezentral vorzuhalten.`,\n        category: \"distance\",\n      });\n    }\n    \n    if (wf.floorChangeCount > 0) {\n      recommendations.push({\n        id: `floor-change-${wf.workflowId}`,\n        priority: \"high\",\n        title: \"Etagenwechsel minimieren\",\n        description: `${wf.floorChangeCount} Etagenwechsel im Workflow \"${wf.workflowName}\". Jeder Wechsel kostet ca. ${FLOOR_PENALTY_METERS}m Zusatzweg. Prüfen Sie, ob alle Schritte auf einer Etage möglich sind.`,\n        category: \"floor\",\n      });\n    }\n    \n    const visitedRooms = new Set<string>();\n    let backtrackCount = 0;\n    for (const step of wf.allSteps) {\n      if (visitedRooms.has(step.toRoomId)) {\n        backtrackCount++;\n      }\n      visitedRooms.add(step.fromRoomId);\n      visitedRooms.add(step.toRoomId);\n    }\n    \n    if (backtrackCount > 0) {\n      recommendations.push({\n        id: `backtrack-${wf.workflowId}`,\n        priority: \"medium\",\n        title: \"Rückläufe vermeiden\",\n        description: `${backtrackCount}x wird ein bereits besuchter Raum erneut angelaufen. Überlegen Sie, ob Arbeitsschritte gebündelt werden können.`,\n        category: \"backtracking\",\n      });\n    }\n  }\n  \n  const hasReception = workflowResults.some(wf => \n    wf.allSteps.some(s => \n      s.fromRoomName.toLowerCase().includes(\"empfang\") || \n      s.toRoomName.toLowerCase().includes(\"empfang\")\n    )\n  );\n  \n  if (hasReception) {\n    recommendations.push({\n      id: \"digital-intake\",\n      priority: \"low\",\n      title: \"Digitale Anamnese\",\n      description: \"Patienten können Formulare vorab online ausfüllen. Das spart Wartezeit und reduziert Laufwege am Empfang.\",\n      category: \"digital\",\n    });\n  }\n  \n  if (workflowResults.some(wf => wf.score < 70)) {\n    recommendations.push({\n      id: \"satellite-materials\",\n      priority: \"medium\",\n      title: \"Material-Satelliten einrichten\",\n      description: \"Häufig benötigte Materialien dezentral in der Nähe der Behandlungsräume lagern, um Wege zur Sterilisation/Lager zu reduzieren.\",\n      category: \"process\",\n    });\n  }\n  \n  return recommendations.slice(0, 5);\n}\n\nexport async function analyzeWorkflows(\n  practiceId: string,\n  rooms: Room[],\n  workflows: Workflow[],\n  workflowStepsMap: Map<string, WorkflowStep[]>,\n  pxPerMeter: number = PX_PER_METER\n): Promise<AnalyzeWorkflowsResult> {\n  const workflowResults: WorkflowAnalysisResult[] = [];\n  \n  for (const workflow of workflows) {\n    const steps = workflowStepsMap.get(workflow.id) || [];\n    if (steps.length === 0) continue;\n    \n    const analysis = analyzeWorkflow(workflow, steps, rooms, pxPerMeter);\n    workflowResults.push(analysis);\n  }\n  \n  let overallScore = 100;\n  let overallFriction = 0;\n  \n  if (workflowResults.length > 0) {\n    const totalScore = workflowResults.reduce((sum, w) => sum + w.score, 0);\n    overallScore = Math.round(totalScore / workflowResults.length);\n    \n    const totalFriction = workflowResults.reduce((sum, w) => sum + w.frictionIndex, 0);\n    overallFriction = Math.round(totalFriction / workflowResults.length);\n  }\n  \n  const recommendations = generateRuleBasedRecommendations(workflowResults);\n  \n  return {\n    practiceId,\n    workflows: workflowResults,\n    overallScore,\n    overallFrictionIndex: overallFriction,\n    recommendations,\n  };\n}\n","path":null,"size_bytes":9500,"size_tokens":null},"server/auth.ts":{"content":"import { Router, Request, Response, NextFunction } from \"express\";\nimport bcrypt from \"bcrypt\";\nimport { storage } from \"./storage\";\nimport { insertUserSchema } from \"@shared/schema\";\nimport { z } from \"zod\";\n\nexport const authRouter = Router();\n\nconst registerSchema = z.object({\n  username: z.string().min(3).max(50),\n  password: z.string().min(6).max(100),\n});\n\nconst loginSchema = z.object({\n  username: z.string(),\n  password: z.string(),\n});\n\nauthRouter.post(\"/register\", async (req: Request, res: Response) => {\n  try {\n    const { username, password } = registerSchema.parse(req.body);\n\n    const existing = await storage.getUserByUsername(username);\n    if (existing) {\n      return res.status(400).json({ error: \"Username already exists\" });\n    }\n\n    const hashedPassword = await bcrypt.hash(password, 10);\n    const user = await storage.createUser({ username, password: hashedPassword });\n\n    req.session.userId = user.id;\n\n    res.json({ id: user.id, username: user.username });\n  } catch (error) {\n    if (error instanceof z.ZodError) {\n      return res.status(400).json({ error: \"Invalid registration data\" });\n    }\n    console.error(\"Registration error:\", error);\n    res.status(500).json({ error: \"Registration failed\" });\n  }\n});\n\nauthRouter.post(\"/login\", async (req: Request, res: Response) => {\n  try {\n    const { username, password } = loginSchema.parse(req.body);\n\n    const user = await storage.getUserByUsername(username);\n    if (!user) {\n      return res.status(401).json({ error: \"Invalid credentials\" });\n    }\n\n    const valid = await bcrypt.compare(password, user.password);\n    if (!valid) {\n      return res.status(401).json({ error: \"Invalid credentials\" });\n    }\n\n    req.session.userId = user.id;\n\n    res.json({ id: user.id, username: user.username });\n  } catch (error) {\n    if (error instanceof z.ZodError) {\n      return res.status(400).json({ error: \"Invalid login data\" });\n    }\n    console.error(\"Login error:\", error);\n    res.status(500).json({ error: \"Login failed\" });\n  }\n});\n\nauthRouter.post(\"/logout\", (req: Request, res: Response) => {\n  req.session.destroy((err) => {\n    if (err) {\n      return res.status(500).json({ error: \"Logout failed\" });\n    }\n    res.clearCookie(\"connect.sid\");\n    res.json({ success: true });\n  });\n});\n\nauthRouter.get(\"/me\", async (req: Request, res: Response) => {\n  if (!req.session.userId) {\n    return res.status(401).json({ error: \"Not authenticated\" });\n  }\n\n  const user = await storage.getUser(req.session.userId);\n  if (!user) {\n    return res.status(401).json({ error: \"User not found\" });\n  }\n\n  res.json({ id: user.id, username: user.username });\n});\n\nexport function requireAuth(req: Request, res: Response, next: NextFunction) {\n  if (!req.session.userId) {\n    return res.status(401).json({ error: \"Authentication required\" });\n  }\n  next();\n}\n\nexport async function requirePracticeAccess(req: Request, res: Response, next: NextFunction) {\n  const practiceId = req.params.id || req.params.practiceId || req.body?.practiceId;\n  if (!practiceId) {\n    return next();\n  }\n\n  const practice = await storage.getPractice(practiceId);\n  if (!practice) {\n    return res.status(404).json({ error: \"Practice not found\" });\n  }\n\n  if (practice.ownerId && practice.ownerId !== req.session.userId) {\n    return res.status(403).json({ error: \"Access denied\" });\n  }\n\n  next();\n}\n\nexport async function requireRoomAccess(req: Request, res: Response, next: NextFunction) {\n  const roomId = req.params.id;\n  if (!roomId) {\n    return next();\n  }\n\n  const result = await storage.getRoomWithPractice(roomId);\n  if (!result) {\n    return res.status(404).json({ error: \"Room not found\" });\n  }\n\n  if (result.practice.ownerId && result.practice.ownerId !== req.session.userId) {\n    return res.status(403).json({ error: \"Access denied\" });\n  }\n\n  next();\n}\n\nexport async function requireStaffAccess(req: Request, res: Response, next: NextFunction) {\n  const staffId = req.params.id;\n  if (!staffId) {\n    return next();\n  }\n\n  const result = await storage.getStaffWithPractice(staffId);\n  if (!result) {\n    return res.status(404).json({ error: \"Staff member not found\" });\n  }\n\n  if (result.practice.ownerId && result.practice.ownerId !== req.session.userId) {\n    return res.status(403).json({ error: \"Access denied\" });\n  }\n\n  next();\n}\n\nexport async function requireWorkflowAccess(req: Request, res: Response, next: NextFunction) {\n  const workflowId = req.params.id;\n  if (!workflowId) {\n    return next();\n  }\n\n  const result = await storage.getWorkflowWithPractice(workflowId);\n  if (!result) {\n    return res.status(404).json({ error: \"Workflow not found\" });\n  }\n\n  if (result.practice.ownerId && result.practice.ownerId !== req.session.userId) {\n    return res.status(403).json({ error: \"Access denied\" });\n  }\n\n  next();\n}\n\nexport async function requireConnectionAccess(req: Request, res: Response, next: NextFunction) {\n  const connectionId = req.params.id;\n  if (!connectionId) {\n    return next();\n  }\n\n  const result = await storage.getConnectionWithPractice(connectionId);\n  if (!result) {\n    return res.status(404).json({ error: \"Connection not found\" });\n  }\n\n  if (result.practice.ownerId && result.practice.ownerId !== req.session.userId) {\n    return res.status(403).json({ error: \"Access denied\" });\n  }\n\n  next();\n}\n\nexport async function requireStepAccess(req: Request, res: Response, next: NextFunction) {\n  const stepId = req.params.id;\n  if (!stepId) {\n    return next();\n  }\n\n  const result = await storage.getStepWithPractice(stepId);\n  if (!result) {\n    return res.status(404).json({ error: \"Step not found\" });\n  }\n\n  if (result.practice.ownerId && result.practice.ownerId !== req.session.userId) {\n    return res.status(403).json({ error: \"Access denied\" });\n  }\n\n  next();\n}\n","path":null,"size_bytes":5791,"size_tokens":null},"client/src/pages/Auth.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { api } from \"@/lib/api\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nexport default function Auth() {\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  \n  useEffect(() => {\n    api.auth.me().then(() => {\n      setLocation(\"/\");\n    }).catch(() => {\n    });\n  }, [setLocation]);\n  const [isLoading, setIsLoading] = useState(false);\n\n  const [loginForm, setLoginForm] = useState({ username: \"\", password: \"\" });\n  const [registerForm, setRegisterForm] = useState({ username: \"\", password: \"\" });\n\n  const handleLogin = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setIsLoading(true);\n    try {\n      await api.auth.login(loginForm);\n      toast({ title: \"Erfolgreich angemeldet\" });\n      setLocation(\"/\");\n    } catch (error) {\n      toast({\n        title: \"Anmeldung fehlgeschlagen\",\n        description: error instanceof Error ? error.message : \"Unbekannter Fehler\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const handleRegister = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setIsLoading(true);\n    try {\n      await api.auth.register(registerForm);\n      toast({ title: \"Registrierung erfolgreich\" });\n      setLocation(\"/\");\n    } catch (error) {\n      toast({\n        title: \"Registrierung fehlgeschlagen\",\n        description: error instanceof Error ? error.message : \"Unbekannter Fehler\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-gray-50 px-4\" data-testid=\"auth-page\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"text-center\">\n          <CardTitle className=\"text-2xl\">PraxisFlow AI</CardTitle>\n          <CardDescription>Melden Sie sich an oder erstellen Sie ein Konto</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Tabs defaultValue=\"login\" className=\"w-full\">\n            <TabsList className=\"grid w-full grid-cols-2\">\n              <TabsTrigger value=\"login\" data-testid=\"tab-login\">Anmelden</TabsTrigger>\n              <TabsTrigger value=\"register\" data-testid=\"tab-register\">Registrieren</TabsTrigger>\n            </TabsList>\n\n            <TabsContent value=\"login\">\n              <form onSubmit={handleLogin} className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"login-username\">Benutzername</Label>\n                  <Input\n                    id=\"login-username\"\n                    data-testid=\"input-login-username\"\n                    value={loginForm.username}\n                    onChange={(e) => setLoginForm({ ...loginForm, username: e.target.value })}\n                    required\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"login-password\">Passwort</Label>\n                  <Input\n                    id=\"login-password\"\n                    type=\"password\"\n                    data-testid=\"input-login-password\"\n                    value={loginForm.password}\n                    onChange={(e) => setLoginForm({ ...loginForm, password: e.target.value })}\n                    required\n                  />\n                </div>\n                <Button type=\"submit\" className=\"w-full\" disabled={isLoading} data-testid=\"button-login\">\n                  {isLoading ? \"Wird angemeldet...\" : \"Anmelden\"}\n                </Button>\n              </form>\n            </TabsContent>\n\n            <TabsContent value=\"register\">\n              <form onSubmit={handleRegister} className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"register-username\">Benutzername</Label>\n                  <Input\n                    id=\"register-username\"\n                    data-testid=\"input-register-username\"\n                    value={registerForm.username}\n                    onChange={(e) => setRegisterForm({ ...registerForm, username: e.target.value })}\n                    required\n                    minLength={3}\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"register-password\">Passwort</Label>\n                  <Input\n                    id=\"register-password\"\n                    type=\"password\"\n                    data-testid=\"input-register-password\"\n                    value={registerForm.password}\n                    onChange={(e) => setRegisterForm({ ...registerForm, password: e.target.value })}\n                    required\n                    minLength={6}\n                  />\n                </div>\n                <Button type=\"submit\" className=\"w-full\" disabled={isLoading} data-testid=\"button-register\">\n                  {isLoading ? \"Wird registriert...\" : \"Registrieren\"}\n                </Button>\n              </form>\n            </TabsContent>\n          </Tabs>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":5421,"size_tokens":null},"client/src/pages/Debug.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Loader2, RefreshCw, Database, Brain, AlertTriangle, Clock } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\n\ninterface TableStats {\n  count: number;\n  latestCreatedAt?: string | null;\n  latestUpdatedAt?: string | null;\n}\n\ninterface DebugStats {\n  tables: {\n    users: TableStats;\n    practices: TableStats;\n    rooms: TableStats;\n    staff: TableStats;\n    simulations: TableStats;\n    knowledgeSources: TableStats;\n    knowledgeChunks: TableStats;\n    knowledgeArtifacts: TableStats;\n    workflows: TableStats;\n    workflowConnections: TableStats;\n    workflowSteps: TableStats;\n  };\n  ragConfig: {\n    embeddingModel: string;\n    vectorDimensions: number;\n    targetChunkTokens: string;\n    overlap: number;\n  };\n  workflowDuplicates: { slug: string; practiceId: string; count: number }[];\n  timestamp: string;\n  environment: string;\n}\n\nfunction formatDate(dateStr: string | null | undefined): string {\n  if (!dateStr) return \"-\";\n  const d = new Date(dateStr);\n  return d.toLocaleDateString(\"de-DE\") + \" \" + d.toLocaleTimeString(\"de-DE\", { hour: \"2-digit\", minute: \"2-digit\" });\n}\n\nexport default function Debug() {\n  const { data, isLoading, error, refetch } = useQuery<DebugStats>({\n    queryKey: [\"/api/debug/status\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/debug/status\");\n      if (!res.ok) throw new Error(\"Failed to fetch debug stats\");\n      return res.json();\n    },\n    refetchInterval: 30000,\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen\" data-testid=\"debug-loading\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className=\"flex flex-col items-center justify-center min-h-screen gap-4\" data-testid=\"debug-error\">\n        <AlertTriangle className=\"h-12 w-12 text-destructive\" />\n        <p className=\"text-destructive\">Debug endpoint nicht verfügbar</p>\n        <p className=\"text-sm text-muted-foreground\">Möglicherweise ist DEBUG_STATUS nicht aktiviert.</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto py-8 px-4 space-y-6\" data-testid=\"debug-page\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-2xl font-bold\" data-testid=\"debug-title\">System Debug Status</h1>\n          <p className=\"text-sm text-muted-foreground\">\n            Letzte Aktualisierung: {formatDate(data?.timestamp)}\n          </p>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Badge variant={data?.environment === \"production\" ? \"destructive\" : \"secondary\"} data-testid=\"debug-env\">\n            {data?.environment}\n          </Badge>\n          <Button variant=\"outline\" size=\"sm\" onClick={() => refetch()} data-testid=\"debug-refresh\">\n            <RefreshCw className=\"h-4 w-4 mr-2\" />\n            Aktualisieren\n          </Button>\n        </div>\n      </div>\n\n      <div className=\"grid gap-6 lg:grid-cols-2\">\n        <Card data-testid=\"debug-tables-card\" className=\"lg:col-span-2\">\n          <CardHeader className=\"flex flex-row items-center gap-2\">\n            <Database className=\"h-5 w-5 text-primary\" />\n            <CardTitle className=\"text-lg\">Datenbank Tabellen</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"overflow-x-auto\">\n              <table className=\"w-full text-sm\">\n                <thead>\n                  <tr className=\"border-b\">\n                    <th className=\"text-left py-2 px-2\">Tabelle</th>\n                    <th className=\"text-right py-2 px-2\">Count</th>\n                    <th className=\"text-right py-2 px-2\">Letzte Erstellung</th>\n                    <th className=\"text-right py-2 px-2\">Letztes Update</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  {data?.tables && Object.entries(data.tables).map(([key, stats]) => (\n                    <tr key={key} className=\"border-b last:border-0 hover:bg-muted/50\" data-testid={`table-${key}`}>\n                      <td className=\"py-2 px-2 font-medium\">{key}</td>\n                      <td className=\"py-2 px-2 text-right font-mono\">{stats.count}</td>\n                      <td className=\"py-2 px-2 text-right text-muted-foreground text-xs\">\n                        {formatDate(stats.latestCreatedAt)}\n                      </td>\n                      <td className=\"py-2 px-2 text-right text-muted-foreground text-xs\">\n                        {formatDate(stats.latestUpdatedAt)}\n                      </td>\n                    </tr>\n                  ))}\n                </tbody>\n              </table>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"debug-rag-card\">\n          <CardHeader className=\"flex flex-row items-center gap-2\">\n            <Brain className=\"h-5 w-5 text-primary\" />\n            <CardTitle className=\"text-lg\">RAG Konfiguration</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-2 text-sm\">\n              {data?.ragConfig && Object.entries(data.ragConfig).map(([key, value]) => (\n                <div key={key} className=\"flex justify-between\" data-testid={`rag-${key}`}>\n                  <span className=\"text-muted-foreground\">{key}</span>\n                  <span className=\"font-mono font-medium\">{String(value)}</span>\n                </div>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card data-testid=\"debug-duplicates-card\">\n          <CardHeader className=\"flex flex-row items-center gap-2\">\n            <AlertTriangle className=\"h-5 w-5 text-orange-500\" />\n            <CardTitle className=\"text-lg\">Workflow Duplikate</CardTitle>\n          </CardHeader>\n          <CardContent>\n            {data?.workflowDuplicates && data.workflowDuplicates.length > 0 ? (\n              <div className=\"space-y-2 text-sm\">\n                {data.workflowDuplicates.map((dup, i) => (\n                  <div key={i} className=\"flex justify-between text-orange-600\" data-testid={`duplicate-${i}`}>\n                    <span>{dup.slug}</span>\n                    <span className=\"font-mono\">{dup.count}x</span>\n                  </div>\n                ))}\n              </div>\n            ) : (\n              <p className=\"text-sm text-green-600\" data-testid=\"no-duplicates\">\n                Keine Duplikate gefunden\n              </p>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card data-testid=\"debug-raw-card\">\n        <CardHeader>\n          <CardTitle className=\"text-lg\">Raw JSON</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <pre className=\"bg-muted p-4 rounded-lg overflow-auto text-xs max-h-96\" data-testid=\"debug-raw-json\">\n            {JSON.stringify(data, null, 2)}\n          </pre>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":7109,"size_tokens":null}},"version":2}